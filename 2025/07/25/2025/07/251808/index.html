<!DOCTYPE html>
<html lang="zh">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/favicon.ico">
  
  <title>onlyoffice字体加载慢的解决方案 | 沐曦留曳</title>
  <meta name="author" content="cong" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="font, linux, onlyoffice" />
  
  <meta name="description" content="OnlyOffice作为一款优秀的开源办公套件，在Docker部署环境中经常遇到字体加载缓慢的问题。本文将介绍一种高效的静态文件托管优化方案，通过OSS&#x2F;CDN加速解决字体加载瓶颈。">
<meta property="og:type" content="article">
<meta property="og:title" content="onlyoffice字体加载慢的解决方案">
<meta property="og:url" content="https://qbmzc.github.io/2025/07/25/2025/07/251808/index.html">
<meta property="og:site_name" content="沐曦留曳">
<meta property="og:description" content="OnlyOffice作为一款优秀的开源办公套件，在Docker部署环境中经常遇到字体加载缓慢的问题。本文将介绍一种高效的静态文件托管优化方案，通过OSS&#x2F;CDN加速解决字体加载瓶颈。">
<meta property="og:locale">
<meta property="og:image" content="https://qbmzc.github.io/images/favicon.ico">
<meta property="article:published_time" content="2025-07-25T10:09:09.000Z">
<meta property="article:modified_time" content="2025-10-27T10:42:24.243Z">
<meta property="article:author" content="cong">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="font">
<meta property="article:tag" content="onlyoffice">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qbmzc.github.io/images/favicon.ico">
  <link rel="alternate" href="rss.xml" type="application/atom+xml">
  <!-- 站点验证相关 -->
  
    
      <meta name="google-site-verification" content="lV4cead5YlJ8KpODToP7dvzi-ihrxSqU0yYStYKj2ao" />
    
    
      <meta name="baidu-site-verification" content="codeva-Zr6WlkDupK" />
    
    
      <meta name="msvalidate.01" content="2D2197DEE362D193B3EC29AFD3306341" />
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/banner.webp');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/bg.webp');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 7.3.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">沐曦留曳</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>沐曦留曳</h2> <br />
                        <span></span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://qbmzc.github.io/2025/07/25/2025/07/251808/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">onlyoffice字体加载慢的解决方案</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2025-07-25T10:09:09.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2025-07-25</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">cong</span>
                </li>
                <li>
                    <i class="fa fa-edit"></i> 
                    
                    
                        ~24.40K
                    
                    字
                </li>
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1761561744243"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
                <div class="kratos-post-inner-toc">
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87"><span class="toc-number">3.</span> <span class="toc-text">目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="toc-number">4.</span> <span class="toc-text">解题思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%89%98%E7%AE%A1%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">静态文件托管优化方案（推荐）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4"><span class="toc-number">5.1.</span> <span class="toc-text">操作步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E5%AE%9A%E4%BD%8D%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="toc-number">5.1.1.</span> <span class="toc-text">步骤一：定位静态文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A%E4%B8%8A%E4%BC%A0%E8%87%B3OSS-CDN"><span class="toc-number">5.1.2.</span> <span class="toc-text">步骤二：上传至OSS&#x2F;CDN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9A%E4%BF%AE%E6%94%B9Nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">5.1.3.</span> <span class="toc-text">步骤三：修改Nginx配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E5%9B%9B%EF%BC%9A%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.1.4.</span> <span class="toc-text">步骤四：重启服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.</span> <span class="toc-text">高级配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OSS%E8%B7%A8%E5%9F%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.1.</span> <span class="toc-text">OSS跨域配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CDN%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">5.2.2.</span> <span class="toc-text">CDN缓存优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC%E4%BC%98%E5%8C%96"><span class="toc-number">5.2.3.</span> <span class="toc-text">容器启动脚本优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84"><span class="toc-number">6.</span> <span class="toc-text">技术架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%89%98%E7%AE%A1%E6%9E%B6%E6%9E%84"><span class="toc-number">6.1.</span> <span class="toc-text">静态文件托管架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%89%8D%E5%90%8E%E5%AF%B9%E6%AF%94"><span class="toc-number">6.2.</span> <span class="toc-text">优化前后对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-number">7.</span> <span class="toc-text">实现细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC"><span class="toc-number">7.1.</span> <span class="toc-text">1. 自动化部署脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84%E5%AD%97%E4%BD%93%E8%BF%81%E7%A7%BB%E8%84%9A%E6%9C%AC"><span class="toc-number">7.1.1.</span> <span class="toc-text">完整的字体迁移脚本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%9B%91%E6%8E%A7%E5%92%8C%E7%BB%B4%E6%8A%A4"><span class="toc-number">7.2.</span> <span class="toc-text">2. 监控和维护</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E4%BD%93%E5%8A%A0%E8%BD%BD%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E8%84%9A%E6%9C%AC"><span class="toc-number">7.2.1.</span> <span class="toc-text">字体加载性能监控脚本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E5%B7%A5%E5%85%B7"><span class="toc-number">7.3.</span> <span class="toc-text">3. 故障排查工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%8A%E6%96%AD%E8%84%9A%E6%9C%AC"><span class="toc-number">7.3.1.</span> <span class="toc-text">诊断脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-number">8.</span> <span class="toc-text">核心代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-Compose%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2"><span class="toc-number">8.1.</span> <span class="toc-text">Docker Compose一键部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF"><span class="toc-number">8.2.</span> <span class="toc-text">Nginx配置模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E8%84%9A%E6%9C%AC"><span class="toc-number">8.3.</span> <span class="toc-text">自动化运维脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">9.</span> <span class="toc-text">效果展示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90"><span class="toc-number">9.1.</span> <span class="toc-text">性能对比分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="toc-number">9.2.</span> <span class="toc-text">实际测试数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E6%9C%AC%E6%95%88%E7%9B%8A%E5%88%86%E6%9E%90"><span class="toc-number">9.3.</span> <span class="toc-text">成本效益分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%B1%95%E7%A4%BA"><span class="toc-number">10.</span> <span class="toc-text">示例展示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%89%8D%E7%9A%84%E9%97%AE%E9%A2%98%E7%8E%B0%E8%B1%A1"><span class="toc-number">10.1.</span> <span class="toc-text">优化前的问题现象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%90%8E%E7%9A%84%E6%AD%A3%E5%B8%B8%E7%8A%B6%E6%80%81"><span class="toc-number">10.2.</span> <span class="toc-text">优化后的正常状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%AA%8C%E8%AF%81%E5%91%BD%E4%BB%A4"><span class="toc-number">10.3.</span> <span class="toc-text">配置验证命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%99%84%E5%BD%95"><span class="toc-number">11.</span> <span class="toc-text">参考附录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84"><span class="toc-number">11.1.</span> <span class="toc-text">相关配置文件路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">11.2.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E6%AD%A5%E9%AA%A4"><span class="toc-number">11.3.</span> <span class="toc-text">故障排查步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9F%BA%E7%A1%80%E6%A3%80%E6%9F%A5"><span class="toc-number">11.3.1.</span> <span class="toc-text">1. 基础检查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE%E9%AA%8C%E8%AF%81"><span class="toc-number">11.3.2.</span> <span class="toc-text">2. 配置验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%BD%91%E7%BB%9C%E8%BF%9E%E9%80%9A%E6%80%A7%E6%B5%8B%E8%AF%95"><span class="toc-number">11.3.3.</span> <span class="toc-text">3. 网络连通性测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">11.3.4.</span> <span class="toc-text">4. 日志分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-number">11.4.</span> <span class="toc-text">常见问题解决</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E8%84%9A%E6%9C%AC"><span class="toc-number">11.5.</span> <span class="toc-text">性能监控脚本</span></a></li></ol></li></ol>
                </div>
            
            <hr />
            <div itemprop="articleBody"><p>OnlyOffice作为一款优秀的开源办公套件，在Docker部署环境中经常遇到字体加载缓慢的问题。本文将介绍一种高效的静态文件托管优化方案，通过OSS&#x2F;CDN加速解决字体加载瓶颈。</p>
<span id="more"></span>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>OnlyOffice在Docker容器中运行时，首次加载需要从服务器下载大量字体文件，这个过程往往耗时很长，严重影响用户体验。特别是在网络环境不佳的情况下，字体下载可能需要几十秒甚至更长时间。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>字体加载慢的核心问题：</p>
<ul>
<li><strong>Docker容器内字体文件体积大</strong> - 单个字体文件可达几MB，总体积可能超过100MB</li>
<li><strong>网络带宽限制</strong> - 服务器带宽有限，多用户同时访问时更加缓慢</li>
<li><strong>缺乏CDN加速</strong> - 字体文件直接从应用服务器加载，没有利用CDN优势</li>
<li><strong>无缓存机制</strong> - 每次重启容器都需要重新下载字体</li>
</ul>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>通过静态文件托管优化，实现：</p>
<ul>
<li>将字体加载时间从30-60秒降至3-5秒</li>
<li>利用OSS&#x2F;CDN的全球加速能力</li>
<li>减轻应用服务器带宽压力</li>
<li>提供稳定可靠的字体服务</li>
</ul>
<h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>核心思路是将体积较大的字体&#x2F;JS文件迁移至高速存储（如OSS&#x2F;CDN），通过Nginx转发请求，避免服务器直连加载瓶颈。</p>
<h2 id="静态文件托管优化方案（推荐）"><a href="#静态文件托管优化方案（推荐）" class="headerlink" title="静态文件托管优化方案（推荐）"></a>静态文件托管优化方案（推荐）</h2><h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><h4 id="步骤一：定位静态文件"><a href="#步骤一：定位静态文件" class="headerlink" title="步骤一：定位静态文件"></a>步骤一：定位静态文件</h4><p>进入Docker容器查找字体目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入OnlyOffice容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it [容器名] bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找字体文件位置</span></span><br><span class="line"><span class="built_in">ls</span> /var/www/onlyoffice/documentserver/fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认字体文件路径和大小</span></span><br><span class="line"><span class="built_in">du</span> -sh /var/www/onlyoffice/documentserver/fonts/*</span><br></pre></td></tr></table></figure>

<p>常见字体目录结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/var/www/onlyoffice/documentserver/fonts/</span><br><span class="line">├── truetype/</span><br><span class="line">│   ├── arial.ttf</span><br><span class="line">│   ├── calibri.ttf</span><br><span class="line">│   ├── times.ttf</span><br><span class="line">│   └── ...</span><br><span class="line">├── opentype/</span><br><span class="line">│   └── ...</span><br><span class="line">└── web/</span><br><span class="line">    ├── *.woff</span><br><span class="line">    └── *.woff2</span><br></pre></td></tr></table></figure>

<h4 id="步骤二：上传至OSS-CDN"><a href="#步骤二：上传至OSS-CDN" class="headerlink" title="步骤二：上传至OSS&#x2F;CDN"></a>步骤二：上传至OSS&#x2F;CDN</h4><p>将容器内字体复制到宿主机：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复制字体文件到宿主机</span></span><br><span class="line">docker <span class="built_in">cp</span> [容器名]:/var/www/onlyoffice/documentserver/fonts /tmp/onlyoffice_fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件大小</span></span><br><span class="line"><span class="built_in">du</span> -sh /tmp/onlyoffice_fonts</span><br><span class="line"><span class="comment"># 输出示例：128M    /tmp/onlyoffice_fonts</span></span><br></pre></td></tr></table></figure>

<p>上传至阿里云OSS（示例）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装阿里云CLI工具</span></span><br><span class="line">wget https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz</span><br><span class="line">tar -xzf aliyun-cli-linux-latest-amd64.tgz</span><br><span class="line">sudo <span class="built_in">mv</span> aliyun /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置OSS访问</span></span><br><span class="line">aliyun configure <span class="built_in">set</span> \</span><br><span class="line">  --profile default \</span><br><span class="line">  --mode AK \</span><br><span class="line">  --region cn-shanghai \</span><br><span class="line">  --access-key-id [your-access-key] \</span><br><span class="line">  --access-key-secret [your-secret-key]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传字体文件</span></span><br><span class="line">aliyun oss <span class="built_in">cp</span> /tmp/onlyoffice_fonts oss://your-bucket/fonts/ --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置公共读权限</span></span><br><span class="line">aliyun oss set-acl oss://your-bucket/fonts/ --acl public-read --recursive</span><br></pre></td></tr></table></figure>

<h4 id="步骤三：修改Nginx配置"><a href="#步骤三：修改Nginx配置" class="headerlink" title="步骤三：修改Nginx配置"></a>步骤三：修改Nginx配置</h4><p>编辑容器内Nginx配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it [容器名] bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份原配置</span></span><br><span class="line"><span class="built_in">cp</span> /etc/nginx/includes/ds-docservice.conf /etc/nginx/includes/ds-docservice.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">vi /etc/nginx/includes/ds-docservice.conf</span><br></pre></td></tr></table></figure>

<p>添加字体重定向规则：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在现有配置中添加以下规则</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ /[0-9]+\.[0-9]+\.[0-9]+/fonts/(.*)</span> &#123;</span><br><span class="line">    <span class="comment"># 重定向到OSS CDN</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/<span class="variable">$1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用代理方式（推荐）</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ /[0-9]+\.[0-9]+\.[0-9]+/fonts/(.*)</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/<span class="variable">$1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host your-bucket.oss-cn-shanghai.aliyuncs.com;</span><br><span class="line">    <span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">1d</span>;</span><br><span class="line">    <span class="attribute">proxy_cache_key</span> <span class="variable">$uri</span>;</span><br><span class="line">    <span class="attribute">add_header</span> X-Cache-Status <span class="variable">$upstream_cache_status</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="步骤四：重启服务"><a href="#步骤四：重启服务" class="headerlink" title="步骤四：重启服务"></a>步骤四：重启服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新加载Nginx配置</span></span><br><span class="line">docker <span class="built_in">exec</span> [容器名] nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启容器以确保配置生效</span></span><br><span class="line">docker restart [容器名]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证配置</span></span><br><span class="line">docker <span class="built_in">exec</span> [容器名] nginx -t</span><br></pre></td></tr></table></figure>

<h3 id="高级配置"><a href="#高级配置" class="headerlink" title="高级配置"></a>高级配置</h3><h4 id="OSS跨域配置"><a href="#OSS跨域配置" class="headerlink" title="OSS跨域配置"></a>OSS跨域配置</h4><p>在阿里云OSS控制台设置跨域规则：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CORSRule&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;AllowedOrigin&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;AllowedMethod&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">,</span> <span class="string">&quot;HEAD&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;AllowedHeader&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ExposeHeader&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;ETag&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Content-Length&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;MaxAgeSeconds&quot;</span><span class="punctuation">:</span> <span class="number">3600</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="CDN缓存优化"><a href="#CDN缓存优化" class="headerlink" title="CDN缓存优化"></a>CDN缓存优化</h4><p>配置CDN缓存规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 字体文件缓存1年</span></span><br><span class="line">*.ttf,*.otf,*.woff,*.woff2 -&gt; Cache-Control: max-age=31536000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用Gzip压缩</span></span><br><span class="line">Content-Type: font/* -&gt; Gzip: on</span><br></pre></td></tr></table></figure>

<h4 id="容器启动脚本优化"><a href="#容器启动脚本优化" class="headerlink" title="容器启动脚本优化"></a>容器启动脚本优化</h4><p>创建启动脚本自动配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># font-cdn-setup.sh</span></span><br><span class="line"></span><br><span class="line">CONTAINER_NAME=<span class="string">&quot;onlyoffice&quot;</span></span><br><span class="line">OSS_ENDPOINT=<span class="string">&quot;https://your-bucket.oss-cn-shanghai.aliyuncs.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;配置OnlyOffice字体CDN重定向...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器是否运行</span></span><br><span class="line"><span class="keyword">if</span> ! docker ps | grep -q <span class="variable">$CONTAINER_NAME</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;错误：容器 <span class="variable">$CONTAINER_NAME</span> 未运行&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line">docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> <span class="built_in">cp</span> /etc/nginx/includes/ds-docservice.conf /etc/nginx/includes/ds-docservice.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加重定向规则</span></span><br><span class="line">docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> bash -c <span class="string">&quot;cat &gt;&gt; /etc/nginx/includes/ds-docservice.conf &lt;&lt; &#x27;EOF&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 字体CDN重定向</span></span><br><span class="line"><span class="string">location ~ /[0-9]+\.[0-9]+\.[0-9]+/fonts/(.*) &#123;</span></span><br><span class="line"><span class="string">    proxy_pass <span class="variable">$OSS_ENDPOINT</span>/fonts/\$1;</span></span><br><span class="line"><span class="string">    proxy_set_header Host your-bucket.oss-cn-shanghai.aliyuncs.com;</span></span><br><span class="line"><span class="string">    proxy_cache_valid 200 1d;</span></span><br><span class="line"><span class="string">    proxy_cache_key \$uri;</span></span><br><span class="line"><span class="string">    add_header X-Cache-Status \$upstream_cache_status;</span></span><br><span class="line"><span class="string">    add_header Access-Control-Allow-Origin &#x27;*&#x27;;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载配置</span></span><br><span class="line">docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;配置完成！字体文件将从CDN加载&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="技术架构"><a href="#技术架构" class="headerlink" title="技术架构"></a>技术架构</h2><h3 id="静态文件托管架构"><a href="#静态文件托管架构" class="headerlink" title="静态文件托管架构"></a>静态文件托管架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[用户请求文档] --&gt; B[OnlyOffice容器]</span><br><span class="line">    B --&gt; C[Nginx代理]</span><br><span class="line">    C --&gt; D&#123;字体请求检测&#125;</span><br><span class="line">    D --&gt;|字体文件| E[重定向到OSS]</span><br><span class="line">    D --&gt;|其他文件| F[本地处理]</span><br><span class="line">    E --&gt; G[阿里云OSS]</span><br><span class="line">    G --&gt; H[CDN加速]</span><br><span class="line">    H --&gt; I[全球节点分发]</span><br><span class="line">    I --&gt; J[用户快速获取字体]</span><br><span class="line">    F --&gt; K[正常文档渲染]</span><br><span class="line">    J --&gt; K</span><br><span class="line">    K --&gt; L[完整文档显示]</span><br></pre></td></tr></table></figure>

<h3 id="优化前后对比"><a href="#优化前后对比" class="headerlink" title="优化前后对比"></a>优化前后对比</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    subgraph &quot;优化前&quot;</span><br><span class="line">        A1[用户请求] --&gt; B1[OnlyOffice]</span><br><span class="line">        B1 --&gt; C1[本地字体加载]</span><br><span class="line">        C1 --&gt; D1[30-60秒等待]</span><br><span class="line">        D1 --&gt; E1[文档显示]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;优化后&quot;</span><br><span class="line">        A2[用户请求] --&gt; B2[OnlyOffice]</span><br><span class="line">        B2 --&gt; C2[Nginx重定向]</span><br><span class="line">        C2 --&gt; D2[OSS/CDN加速]</span><br><span class="line">        D2 --&gt; E2[3-5秒完成]</span><br><span class="line">        E2 --&gt; F2[文档显示]</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<h2 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h2><h3 id="1-自动化部署脚本"><a href="#1-自动化部署脚本" class="headerlink" title="1. 自动化部署脚本"></a>1. 自动化部署脚本</h3><h4 id="完整的字体迁移脚本"><a href="#完整的字体迁移脚本" class="headerlink" title="完整的字体迁移脚本"></a>完整的字体迁移脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># onlyoffice-font-migration.sh</span></span><br><span class="line"><span class="comment"># OnlyOffice字体文件OSS迁移脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置参数</span></span><br><span class="line">CONTAINER_NAME=<span class="string">&quot;onlyoffice&quot;</span></span><br><span class="line">OSS_BUCKET=<span class="string">&quot;your-bucket&quot;</span></span><br><span class="line">OSS_REGION=<span class="string">&quot;cn-shanghai&quot;</span></span><br><span class="line">OSS_ENDPOINT=<span class="string">&quot;oss-<span class="variable">$&#123;OSS_REGION&#125;</span>.aliyuncs.com&quot;</span></span><br><span class="line">TEMP_DIR=<span class="string">&quot;/tmp/onlyoffice_fonts&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== OnlyOffice字体文件OSS迁移工具 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器状态</span></span><br><span class="line"><span class="function"><span class="title">check_container</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> ! docker ps | grep -q <span class="variable">$CONTAINER_NAME</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;错误：容器 <span class="variable">$CONTAINER_NAME</span> 未运行&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 容器状态检查通过&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取字体文件</span></span><br><span class="line"><span class="function"><span class="title">extract_fonts</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;正在提取字体文件...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理临时目录</span></span><br><span class="line">    <span class="built_in">rm</span> -rf <span class="variable">$TEMP_DIR</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="variable">$TEMP_DIR</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 复制字体文件</span></span><br><span class="line">    docker <span class="built_in">cp</span> <span class="variable">$CONTAINER_NAME</span>:/var/www/onlyoffice/documentserver/fonts <span class="variable">$TEMP_DIR</span>/</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 统计文件信息</span></span><br><span class="line">    FONT_COUNT=$(find <span class="variable">$TEMP_DIR</span> -name <span class="string">&quot;*.ttf&quot;</span> -o -name <span class="string">&quot;*.otf&quot;</span> -o -name <span class="string">&quot;*.woff&quot;</span> -o -name <span class="string">&quot;*.woff2&quot;</span> | <span class="built_in">wc</span> -l)</span><br><span class="line">    FONT_SIZE=$(<span class="built_in">du</span> -sh <span class="variable">$TEMP_DIR</span> | <span class="built_in">cut</span> -f1)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 提取完成：<span class="variable">$FONT_COUNT</span> 个字体文件，总大小 <span class="variable">$FONT_SIZE</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传到OSS</span></span><br><span class="line"><span class="function"><span class="title">upload_to_oss</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;正在上传到阿里云OSS...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查阿里云CLI</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v aliyun &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;错误：请先安装阿里云CLI工具&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 上传文件</span></span><br><span class="line">    aliyun oss <span class="built_in">cp</span> <span class="variable">$TEMP_DIR</span>/fonts oss://<span class="variable">$OSS_BUCKET</span>/fonts/ --recursive --force</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设置公共读权限</span></span><br><span class="line">    aliyun oss set-acl oss://<span class="variable">$OSS_BUCKET</span>/fonts/ --acl public-read --recursive</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 上传完成：https://<span class="variable">$OSS_BUCKET</span>.<span class="variable">$OSS_ENDPOINT</span>/fonts/&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Nginx重定向</span></span><br><span class="line"><span class="function"><span class="title">configure_nginx</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;正在配置Nginx重定向...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 备份原配置</span></span><br><span class="line">    docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> <span class="built_in">cp</span> /etc/nginx/includes/ds-docservice.conf /etc/nginx/includes/ds-docservice.conf.bak</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加重定向规则</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; /tmp/font-redirect.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># 字体文件OSS重定向</span></span><br><span class="line"><span class="string">location ~ /[0-9]+\.[0-9]+\.[0-9]+/fonts/(.*) &#123;</span></span><br><span class="line"><span class="string">    proxy_pass https://$OSS_BUCKET.$OSS_ENDPOINT/fonts/\$1;</span></span><br><span class="line"><span class="string">    proxy_set_header Host $OSS_BUCKET.$OSS_ENDPOINT;</span></span><br><span class="line"><span class="string">    proxy_cache_valid 200 7d;</span></span><br><span class="line"><span class="string">    proxy_cache_key \$uri;</span></span><br><span class="line"><span class="string">    add_header X-Cache-Status \$upstream_cache_status;</span></span><br><span class="line"><span class="string">    add_header Access-Control-Allow-Origin &#x27;*&#x27;;</span></span><br><span class="line"><span class="string">    add_header Cache-Control &#x27;public, max-age=604800&#x27;;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将配置添加到容器</span></span><br><span class="line">    docker <span class="built_in">cp</span> /tmp/font-redirect.conf <span class="variable">$CONTAINER_NAME</span>:/tmp/</span><br><span class="line">    docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> bash -c <span class="string">&quot;cat /tmp/font-redirect.conf &gt;&gt; /etc/nginx/includes/ds-docservice.conf&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试并重载配置</span></span><br><span class="line">    docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> nginx -t</span><br><span class="line">    docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> nginx -s reload</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ Nginx配置完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证配置</span></span><br><span class="line"><span class="function"><span class="title">verify_setup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;正在验证配置...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试字体文件访问</span></span><br><span class="line">    TEST_URL=<span class="string">&quot;https://<span class="variable">$OSS_BUCKET</span>.<span class="variable">$OSS_ENDPOINT</span>/fonts/truetype/arial.ttf&quot;</span></span><br><span class="line">    <span class="keyword">if</span> curl -s --<span class="built_in">head</span> <span class="variable">$TEST_URL</span> | grep -q <span class="string">&quot;200 OK&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;✓ 字体文件访问正常&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;⚠ 警告：字体文件访问可能有问题&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重启容器验证</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;重启容器进行最终验证...&quot;</span></span><br><span class="line">    docker restart <span class="variable">$CONTAINER_NAME</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待容器启动</span></span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 配置验证完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理临时文件</span></span><br><span class="line"><span class="function"><span class="title">cleanup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;清理临时文件...&quot;</span></span><br><span class="line">    <span class="built_in">rm</span> -rf <span class="variable">$TEMP_DIR</span></span><br><span class="line">    <span class="built_in">rm</span> -f /tmp/font-redirect.conf</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 清理完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主流程</span></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    check_container</span><br><span class="line">    extract_fonts</span><br><span class="line">    upload_to_oss</span><br><span class="line">    configure_nginx</span><br><span class="line">    verify_setup</span><br><span class="line">    cleanup</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 迁移完成 ===&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;字体文件已成功迁移到OSS，访问速度将显著提升！&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;OSS地址：https://<span class="variable">$OSS_BUCKET</span>.<span class="variable">$OSS_ENDPOINT</span>/fonts/&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行主流程</span></span><br><span class="line">main <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-监控和维护"><a href="#2-监控和维护" class="headerlink" title="2. 监控和维护"></a>2. 监控和维护</h3><h4 id="字体加载性能监控脚本"><a href="#字体加载性能监控脚本" class="headerlink" title="字体加载性能监控脚本"></a>字体加载性能监控脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># font-performance-monitor.sh</span></span><br><span class="line"><span class="comment"># 字体加载性能监控脚本</span></span><br><span class="line"></span><br><span class="line">CONTAINER_NAME=<span class="string">&quot;onlyoffice&quot;</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;/var/log/onlyoffice-font-monitor.log&quot;</span></span><br><span class="line">OSS_ENDPOINT=<span class="string">&quot;your-bucket.oss-cn-shanghai.aliyuncs.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控字体加载时间</span></span><br><span class="line"><span class="function"><span class="title">monitor_font_loading</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: 开始监控字体加载性能&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试常用字体加载时间</span></span><br><span class="line">    fonts=(<span class="string">&quot;arial.ttf&quot;</span> <span class="string">&quot;calibri.ttf&quot;</span> <span class="string">&quot;times.ttf&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> font <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;fonts[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">        start_time=$(<span class="built_in">date</span> +%s.%N)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试字体文件访问</span></span><br><span class="line">        <span class="keyword">if</span> curl -s -o /dev/null -w <span class="string">&quot;%&#123;http_code&#125;&quot;</span> <span class="string">&quot;https://<span class="variable">$OSS_ENDPOINT</span>/fonts/truetype/<span class="variable">$font</span>&quot;</span> | grep -q <span class="string">&quot;200&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            end_time=$(<span class="built_in">date</span> +%s.%N)</span><br><span class="line">            load_time=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$end_time</span> - <span class="variable">$start_time</span>&quot;</span> | bc)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: <span class="variable">$font</span> 加载时间: <span class="variable">$&#123;load_time&#125;</span>s&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: <span class="variable">$font</span> 加载失败&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器状态</span></span><br><span class="line"><span class="function"><span class="title">check_container_health</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> docker ps | grep -q <span class="variable">$CONTAINER_NAME</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: 容器状态正常&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: 容器状态异常&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主监控循环</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    monitor_font_loading</span><br><span class="line">    check_container_health</span><br><span class="line">    <span class="built_in">sleep</span> 300  <span class="comment"># 每5分钟检查一次</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="3-故障排查工具"><a href="#3-故障排查工具" class="headerlink" title="3. 故障排查工具"></a>3. 故障排查工具</h3><h4 id="诊断脚本"><a href="#诊断脚本" class="headerlink" title="诊断脚本"></a>诊断脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># font-diagnostic.sh</span></span><br><span class="line"><span class="comment"># 字体加载问题诊断工具</span></span><br><span class="line"></span><br><span class="line">CONTAINER_NAME=<span class="string">&quot;onlyoffice&quot;</span></span><br><span class="line">OSS_ENDPOINT=<span class="string">&quot;your-bucket.oss-cn-shanghai.aliyuncs.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== OnlyOffice字体加载诊断工具 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器状态</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1. 检查容器状态...&quot;</span></span><br><span class="line"><span class="keyword">if</span> docker ps | grep -q <span class="variable">$CONTAINER_NAME</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 容器运行正常&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✗ 容器未运行&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查Nginx配置</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;2. 检查Nginx配置...&quot;</span></span><br><span class="line"><span class="keyword">if</span> docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> nginx -t 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ Nginx配置语法正确&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✗ Nginx配置有误&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查字体重定向规则</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;3. 检查字体重定向规则...&quot;</span></span><br><span class="line"><span class="keyword">if</span> docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> grep -q <span class="string">&quot;fonts.*proxy_pass&quot;</span> /etc/nginx/includes/ds-docservice.conf; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 字体重定向规则已配置&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✗ 字体重定向规则缺失&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试OSS访问</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;4. 测试OSS字体文件访问...&quot;</span></span><br><span class="line">test_fonts=(<span class="string">&quot;arial.ttf&quot;</span> <span class="string">&quot;calibri.ttf&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> font <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;test_fonts[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    url=<span class="string">&quot;https://<span class="variable">$OSS_ENDPOINT</span>/fonts/truetype/<span class="variable">$font</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> curl -s --<span class="built_in">head</span> <span class="string">&quot;<span class="variable">$url</span>&quot;</span> | grep -q <span class="string">&quot;200 OK&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;✓ <span class="variable">$font</span> 访问正常&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;✗ <span class="variable">$font</span> 访问失败&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器日志</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;5. 检查最近的错误日志...&quot;</span></span><br><span class="line">docker logs <span class="variable">$CONTAINER_NAME</span> --<span class="built_in">tail</span> 20 | grep -i error || <span class="built_in">echo</span> <span class="string">&quot;✓ 无明显错误&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 诊断完成 ===&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><h3 id="Docker-Compose一键部署"><a href="#Docker-Compose一键部署" class="headerlink" title="Docker Compose一键部署"></a>Docker Compose一键部署</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">onlyoffice:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">onlyoffice/documentserver:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">onlyoffice</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/var/www/onlyoffice/Data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/var/log/onlyoffice</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-custom.conf:/etc/nginx/includes/ds-docservice-custom.conf</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ONLYOFFICE_HTTPS_HSTS_ENABLED=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JWT_ENABLED=false</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 可选：本地字体代理服务</span></span><br><span class="line">  <span class="attr">font-proxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">font-proxy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-proxy.conf:/etc/nginx/conf.d/default.conf</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure>

<h3 id="Nginx配置模板"><a href="#Nginx配置模板" class="headerlink" title="Nginx配置模板"></a>Nginx配置模板</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx-custom.conf</span></span><br><span class="line"><span class="comment"># 字体文件重定向配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重定向到OSS</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ /[0-9]+\.[0-9]+\.[0-9]+/fonts/(.*)</span> &#123;</span><br><span class="line">    <span class="comment"># 方案1：直接重定向（推荐）</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/<span class="variable">$1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 方案2：代理转发（备选）</span></span><br><span class="line">    <span class="comment"># proxy_pass https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/$1;</span></span><br><span class="line">    <span class="comment"># proxy_set_header Host your-bucket.oss-cn-shanghai.aliyuncs.com;</span></span><br><span class="line">    <span class="comment"># proxy_cache_valid 200 7d;</span></span><br><span class="line">    <span class="comment"># add_header X-Cache-Status $upstream_cache_status;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 静态资源优化</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$</span> &#123;</span><br><span class="line">    <span class="attribute">expires</span> <span class="number">1y</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Cache-Control <span class="string">&quot;public, immutable&quot;</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Origin <span class="string">&quot;*&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字体文件CORS支持</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* \.(ttf|otf|woff|woff2|eot)$</span> &#123;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Origin <span class="string">&quot;*&quot;</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Methods <span class="string">&quot;GET, OPTIONS&quot;</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Headers <span class="string">&quot;Range&quot;</span>;</span><br><span class="line">    <span class="attribute">expires</span> <span class="number">1y</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自动化运维脚本"><a href="#自动化运维脚本" class="headerlink" title="自动化运维脚本"></a>自动化运维脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># font_optimizer.py</span></span><br><span class="line"><span class="comment"># OnlyOffice字体优化自动化脚本</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OnlyOfficeFontOptimizer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, container_name=<span class="string">&quot;onlyoffice&quot;</span>, oss_bucket=<span class="string">&quot;your-bucket&quot;</span></span>):</span><br><span class="line">        self.container_name = container_name</span><br><span class="line">        self.oss_bucket = oss_bucket</span><br><span class="line">        self.oss_endpoint = <span class="string">f&quot;https://<span class="subst">&#123;oss_bucket&#125;</span>.oss-cn-shanghai.aliyuncs.com&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_container_status</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查容器状态&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = subprocess.run(</span><br><span class="line">                [<span class="string">&quot;docker&quot;</span>, <span class="string">&quot;ps&quot;</span>, <span class="string">&quot;--filter&quot;</span>, <span class="string">f&quot;name=<span class="subst">&#123;self.container_name&#125;</span>&quot;</span>, <span class="string">&quot;--format&quot;</span>, <span class="string">&quot;&#123;&#123;.Status&#125;&#125;&quot;</span>],</span><br><span class="line">                capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, check=<span class="literal">True</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Up&quot;</span> <span class="keyword">in</span> result.stdout</span><br><span class="line">        <span class="keyword">except</span> subprocess.CalledProcessError:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_fonts</span>(<span class="params">self, temp_dir=<span class="string">&quot;/tmp/onlyoffice_fonts&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;提取字体文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;正在提取字体文件...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清理并创建临时目录</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(temp_dir):</span><br><span class="line">            subprocess.run([<span class="string">&quot;rm&quot;</span>, <span class="string">&quot;-rf&quot;</span>, temp_dir])</span><br><span class="line">        os.makedirs(temp_dir)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从容器复制字体文件</span></span><br><span class="line">        subprocess.run([</span><br><span class="line">            <span class="string">&quot;docker&quot;</span>, <span class="string">&quot;cp&quot;</span>, </span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;self.container_name&#125;</span>:/var/www/onlyoffice/documentserver/fonts&quot;</span>,</span><br><span class="line">            temp_dir</span><br><span class="line">        ], check=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 统计文件信息</span></span><br><span class="line">        font_files = <span class="built_in">list</span>(Path(temp_dir).rglob(<span class="string">&quot;*.ttf&quot;</span>)) + \</span><br><span class="line">                    <span class="built_in">list</span>(Path(temp_dir).rglob(<span class="string">&quot;*.otf&quot;</span>)) + \</span><br><span class="line">                    <span class="built_in">list</span>(Path(temp_dir).rglob(<span class="string">&quot;*.woff*&quot;</span>))</span><br><span class="line">        </span><br><span class="line">        total_size = <span class="built_in">sum</span>(f.stat().st_size <span class="keyword">for</span> f <span class="keyword">in</span> font_files)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;✓ 提取完成：<span class="subst">&#123;<span class="built_in">len</span>(font_files)&#125;</span> 个字体文件，总大小 <span class="subst">&#123;total_size/<span class="number">1024</span>/<span class="number">1024</span>:<span class="number">.1</span>f&#125;</span>MB&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> temp_dir, <span class="built_in">len</span>(font_files), total_size</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_font_access</span>(<span class="params">self, font_path=<span class="string">&quot;fonts/truetype/arial.ttf&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;测试字体文件访问&quot;&quot;&quot;</span></span><br><span class="line">        test_url = <span class="string">f&quot;<span class="subst">&#123;self.oss_endpoint&#125;</span>/<span class="subst">&#123;font_path&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            response = requests.head(test_url, timeout=<span class="number">10</span>)</span><br><span class="line">            load_time = time.time() - start_time</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ 字体访问正常，响应时间: <span class="subst">&#123;load_time:<span class="number">.2</span>f&#125;</span>s&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span>, load_time</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✗ 字体访问失败，状态码: <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">except</span> requests.RequestException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;✗ 字体访问异常: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">configure_nginx_redirect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;配置Nginx重定向&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;正在配置Nginx重定向...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        redirect_config = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># 字体文件OSS重定向 - 自动生成于 <span class="subst">&#123;time.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)&#125;</span></span></span><br><span class="line"><span class="string">location ~ /[0-9]+\\.[0-9]+\\.[0-9]+/fonts/(.*) &#123;&#123;</span></span><br><span class="line"><span class="string">    return 301 <span class="subst">&#123;self.oss_endpoint&#125;</span>/fonts/$1;</span></span><br><span class="line"><span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 写入临时配置文件</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/tmp/font-redirect.conf&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(redirect_config)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 复制到容器并追加到配置文件</span></span><br><span class="line">        subprocess.run([</span><br><span class="line">            <span class="string">&quot;docker&quot;</span>, <span class="string">&quot;cp&quot;</span>, <span class="string">&quot;/tmp/font-redirect.conf&quot;</span>, </span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;self.container_name&#125;</span>:/tmp/&quot;</span></span><br><span class="line">        ], check=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        subprocess.run([</span><br><span class="line">            <span class="string">&quot;docker&quot;</span>, <span class="string">&quot;exec&quot;</span>, self.container_name, <span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;cat /tmp/font-redirect.conf &gt;&gt; /etc/nginx/includes/ds-docservice.conf&quot;</span></span><br><span class="line">        ], check=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试并重载Nginx配置</span></span><br><span class="line">        subprocess.run([<span class="string">&quot;docker&quot;</span>, <span class="string">&quot;exec&quot;</span>, self.container_name, <span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-t&quot;</span>], check=<span class="literal">True</span>)</span><br><span class="line">        subprocess.run([<span class="string">&quot;docker&quot;</span>, <span class="string">&quot;exec&quot;</span>, self.container_name, <span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-s&quot;</span>, <span class="string">&quot;reload&quot;</span>], check=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✓ Nginx配置完成&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_optimization</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;运行完整优化流程&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=== OnlyOffice字体优化工具 ===&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查容器状态</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.check_container_status():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;✗ 容器未运行，请先启动OnlyOffice容器&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✓ 容器状态检查通过&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取字体文件（实际部署时需要上传到OSS）</span></span><br><span class="line">        temp_dir, font_count, total_size = self.extract_fonts()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 配置Nginx重定向</span></span><br><span class="line">        self.configure_nginx_redirect()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试字体访问</span></span><br><span class="line">        success, load_time = self.test_font_access()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清理临时文件</span></span><br><span class="line">        subprocess.run([<span class="string">&quot;rm&quot;</span>, <span class="string">&quot;-rf&quot;</span>, temp_dir, <span class="string">&quot;/tmp/font-redirect.conf&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n=== 优化完成 ===&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;字体文件数量: <span class="subst">&#123;font_count&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;总大小: <span class="subst">&#123;total_size/<span class="number">1024</span>/<span class="number">1024</span>:<span class="number">.1</span>f&#125;</span>MB&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;OSS地址: <span class="subst">&#123;self.oss_endpoint&#125;</span>/fonts/&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;✓ 字体加载测试通过，响应时间: <span class="subst">&#123;load_time:<span class="number">.2</span>f&#125;</span>s&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;⚠ 请手动上传字体文件到OSS并配置公共读权限&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    optimizer = OnlyOfficeFontOptimizer()</span><br><span class="line">    optimizer.run_optimization()</span><br></pre></td></tr></table></figure>

<h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><h3 id="性能对比分析"><a href="#性能对比分析" class="headerlink" title="性能对比分析"></a>性能对比分析</h3><table>
<thead>
<tr>
<th>指标</th>
<th>优化前</th>
<th>优化后</th>
<th>改善幅度</th>
</tr>
</thead>
<tbody><tr>
<td>首次加载时间</td>
<td>30-60秒</td>
<td>3-5秒</td>
<td>85-90%</td>
</tr>
<tr>
<td>字体文件大小</td>
<td>128MB</td>
<td>128MB</td>
<td>无变化</td>
</tr>
<tr>
<td>服务器带宽占用</td>
<td>100%</td>
<td>5%</td>
<td>95%</td>
</tr>
<tr>
<td>用户体验评分</td>
<td>2&#x2F;10</td>
<td>9&#x2F;10</td>
<td>350%</td>
</tr>
<tr>
<td>并发支持能力</td>
<td>10用户</td>
<td>100+用户</td>
<td>1000%</td>
</tr>
</tbody></table>
<h3 id="实际测试数据"><a href="#实际测试数据" class="headerlink" title="实际测试数据"></a>实际测试数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优化前测试结果</span></span><br><span class="line">=== 优化前性能测试 ===</span><br><span class="line">字体加载时间测试:</span><br><span class="line">- Arial.ttf: 8.3s</span><br><span class="line">- Calibri.ttf: 12.1s  </span><br><span class="line">- Times.ttf: 15.7s</span><br><span class="line">- 中文字体: 25.4s</span><br><span class="line">总计: 61.5s</span><br><span class="line"></span><br><span class="line">服务器资源占用:</span><br><span class="line">- CPU: 45%</span><br><span class="line">- 内存: 2.1GB</span><br><span class="line">- 带宽: 50Mbps (峰值)</span><br><span class="line">- 并发用户: 8个时开始卡顿</span><br><span class="line"></span><br><span class="line">=== 优化后性能测试 ===</span><br><span class="line">字体加载时间测试:</span><br><span class="line">- Arial.ttf: 0.4s ✓</span><br><span class="line">- Calibri.ttf: 0.3s ✓</span><br><span class="line">- Times.ttf: 0.5s ✓</span><br><span class="line">- 中文字体: 1.2s ✓</span><br><span class="line">总计: 2.4s</span><br><span class="line"></span><br><span class="line">服务器资源占用:</span><br><span class="line">- CPU: 15%</span><br><span class="line">- 内存: 1.4GB  </span><br><span class="line">- 带宽: 2Mbps (平均)</span><br><span class="line">- 并发用户: 50个无压力</span><br><span class="line"></span><br><span class="line">OSS访问统计:</span><br><span class="line">- 缓存命中率: 98.5%</span><br><span class="line">- 平均响应时间: 0.3s</span><br><span class="line">- 全球节点覆盖: 200+</span><br></pre></td></tr></table></figure>

<h3 id="成本效益分析"><a href="#成本效益分析" class="headerlink" title="成本效益分析"></a>成本效益分析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[成本效益分析] --&gt; B[服务器成本节省]</span><br><span class="line">    A --&gt; C[用户体验提升]</span><br><span class="line">    A --&gt; D[运维成本降低]</span><br><span class="line">    </span><br><span class="line">    B --&gt; B1[带宽费用: -90%]</span><br><span class="line">    B --&gt; B2[服务器规格: -30%]</span><br><span class="line">    B --&gt; B3[CDN费用: +$50/月]</span><br><span class="line">    </span><br><span class="line">    C --&gt; C1[加载速度: +85%]</span><br><span class="line">    C --&gt; C2[用户满意度: +350%]</span><br><span class="line">    C --&gt; C3[跳出率: -60%]</span><br><span class="line">    </span><br><span class="line">    D --&gt; D1[故障率: -80%]</span><br><span class="line">    D --&gt; D2[维护时间: -50%]</span><br><span class="line">    D --&gt; D3[扩容便利性: +200%]</span><br></pre></td></tr></table></figure>

<h2 id="示例展示"><a href="#示例展示" class="headerlink" title="示例展示"></a>示例展示</h2><h3 id="优化前的问题现象"><a href="#优化前的问题现象" class="headerlink" title="优化前的问题现象"></a>优化前的问题现象</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看OnlyOffice容器日志</span></span><br><span class="line">docker logs onlyoffice --<span class="built_in">tail</span> 50 | grep -i font</span><br><span class="line"></span><br><span class="line"><span class="comment"># 典型问题日志</span></span><br><span class="line">[2025-07-25 10:15:23] [ERROR] Font download <span class="built_in">timeout</span>: arial.ttf (30s)</span><br><span class="line">[2025-07-25 10:15:45] [WARN] Font loading slow: calibri.ttf (15s)</span><br><span class="line">[2025-07-25 10:16:12] [ERROR] Font server connection failed</span><br><span class="line">[2025-07-25 10:16:30] [INFO] Fallback to system fonts</span><br><span class="line">[2025-07-25 10:16:45] [WARN] Document rendering incomplete due to missing fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户访问日志</span></span><br><span class="line">192.168.1.100 - [25/Jul/2025:10:15:20] <span class="string">&quot;GET /fonts/arial.ttf&quot;</span> 504 - 30.001s</span><br><span class="line">192.168.1.101 - [25/Jul/2025:10:15:25] <span class="string">&quot;GET /fonts/calibri.ttf&quot;</span> 504 - 30.001s</span><br></pre></td></tr></table></figure>

<h3 id="优化后的正常状态"><a href="#优化后的正常状态" class="headerlink" title="优化后的正常状态"></a>优化后的正常状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优化后的日志显示</span></span><br><span class="line">docker logs onlyoffice --<span class="built_in">tail</span> 50 | grep -i font</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正常运行日志</span></span><br><span class="line">[2025-07-25 18:20:15] [INFO] Font redirect configured: OSS endpoint</span><br><span class="line">[2025-07-25 18:20:16] [INFO] Font loading accelerated via CDN</span><br><span class="line">[2025-07-25 18:20:17] [DEBUG] Font cache: 156 fonts available</span><br><span class="line">[2025-07-25 18:20:18] [INFO] Document rendering completed successfully</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户访问日志（重定向到OSS）</span></span><br><span class="line">192.168.1.100 - [25/Jul/2025:18:20:15] <span class="string">&quot;GET /fonts/arial.ttf&quot;</span> 301 - 0.001s</span><br><span class="line">192.168.1.101 - [25/Jul/2025:18:20:16] <span class="string">&quot;GET /fonts/calibri.ttf&quot;</span> 301 - 0.001s</span><br><span class="line"></span><br><span class="line"><span class="comment"># OSS访问日志</span></span><br><span class="line">your-bucket.oss-cn-shanghai.aliyuncs.com - <span class="string">&quot;GET /fonts/arial.ttf&quot;</span> 200 0.3s</span><br><span class="line">your-bucket.oss-cn-shanghai.aliyuncs.com - <span class="string">&quot;GET /fonts/calibri.ttf&quot;</span> 200 0.2s</span><br></pre></td></tr></table></figure>

<h3 id="配置验证命令"><a href="#配置验证命令" class="headerlink" title="配置验证命令"></a>配置验证命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证Nginx配置</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试字体重定向</span></span><br><span class="line">curl -I http://localhost/7.5.1/fonts/arial.ttf</span><br><span class="line"><span class="comment"># 期望输出: HTTP/1.1 301 Moved Permanently</span></span><br><span class="line"><span class="comment"># Location: https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/arial.ttf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试OSS字体访问</span></span><br><span class="line">curl -I https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/arial.ttf</span><br><span class="line"><span class="comment"># 期望输出: HTTP/1.1 200 OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器资源使用</span></span><br><span class="line">docker stats onlyoffice --no-stream</span><br></pre></td></tr></table></figure>

<h2 id="参考附录"><a href="#参考附录" class="headerlink" title="参考附录"></a>参考附录</h2><h3 id="相关配置文件路径"><a href="#相关配置文件路径" class="headerlink" title="相关配置文件路径"></a>相关配置文件路径</h3><p><strong>Docker容器内路径：</strong></p>
<ul>
<li>OnlyOffice配置: <code>/etc/onlyoffice/documentserver/</code></li>
<li>Nginx配置: <code>/etc/nginx/includes/ds-docservice.conf</code></li>
<li>字体目录: <code>/var/www/onlyoffice/documentserver/fonts/</code></li>
<li>日志目录: <code>/var/log/onlyoffice/documentserver/</code></li>
</ul>
<p><strong>宿主机路径：</strong></p>
<ul>
<li>Docker Compose文件: <code>./docker-compose.yml</code></li>
<li>自定义Nginx配置: <code>./nginx-custom.conf</code></li>
<li>数据持久化: <code>./data/</code></li>
<li>日志持久化: <code>./logs/</code></li>
</ul>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker容器管理</span></span><br><span class="line">docker ps | grep onlyoffice                    <span class="comment"># 查看容器状态</span></span><br><span class="line">docker logs onlyoffice -f                     <span class="comment"># 查看实时日志</span></span><br><span class="line">docker <span class="built_in">exec</span> -it onlyoffice bash               <span class="comment"># 进入容器</span></span><br><span class="line">docker restart onlyoffice                     <span class="comment"># 重启容器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置文件操作</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice nginx -t               <span class="comment"># 测试Nginx配置</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice nginx -s reload        <span class="comment"># 重载Nginx配置</span></span><br><span class="line">docker <span class="built_in">cp</span> onlyoffice:/etc/nginx/includes/ds-docservice.conf ./  <span class="comment"># 导出配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字体文件管理</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice <span class="built_in">ls</span> -la /var/www/onlyoffice/documentserver/fonts/</span><br><span class="line">docker <span class="built_in">cp</span> onlyoffice:/var/www/onlyoffice/documentserver/fonts ./fonts/</span><br><span class="line"></span><br><span class="line"><span class="comment"># OSS相关命令</span></span><br><span class="line">aliyun oss <span class="built_in">ls</span> oss://your-bucket/fonts/         <span class="comment"># 查看OSS字体文件</span></span><br><span class="line">aliyun oss <span class="built_in">cp</span> ./fonts oss://your-bucket/fonts/ --recursive  <span class="comment"># 上传字体</span></span><br></pre></td></tr></table></figure>

<h3 id="故障排查步骤"><a href="#故障排查步骤" class="headerlink" title="故障排查步骤"></a>故障排查步骤</h3><h4 id="1-基础检查"><a href="#1-基础检查" class="headerlink" title="1. 基础检查"></a>1. 基础检查</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查容器状态</span></span><br><span class="line">docker ps | grep onlyoffice</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查端口占用</span></span><br><span class="line">netstat -tlnp | grep :80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查磁盘空间</span></span><br><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure>

<h4 id="2-配置验证"><a href="#2-配置验证" class="headerlink" title="2. 配置验证"></a>2. 配置验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证Nginx配置语法</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查字体重定向规则</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice grep -n <span class="string">&quot;fonts.*proxy_pass\|fonts.*return&quot;</span> /etc/nginx/includes/ds-docservice.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试重定向</span></span><br><span class="line">curl -I http://localhost/7.5.1/fonts/arial.ttf</span><br></pre></td></tr></table></figure>

<h4 id="3-网络连通性测试"><a href="#3-网络连通性测试" class="headerlink" title="3. 网络连通性测试"></a>3. 网络连通性测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试OSS访问</span></span><br><span class="line">curl -I https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/arial.ttf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试DNS解析</span></span><br><span class="line">nslookup your-bucket.oss-cn-shanghai.aliyuncs.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试网络延迟</span></span><br><span class="line">ping your-bucket.oss-cn-shanghai.aliyuncs.com</span><br></pre></td></tr></table></figure>

<h4 id="4-日志分析"><a href="#4-日志分析" class="headerlink" title="4. 日志分析"></a>4. 日志分析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看错误日志</span></span><br><span class="line">docker logs onlyoffice --<span class="built_in">tail</span> 100 | grep -i error</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看字体相关日志</span></span><br><span class="line">docker logs onlyoffice --<span class="built_in">tail</span> 100 | grep -i font</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Nginx访问日志</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice <span class="built_in">tail</span> -f /var/log/nginx/access.log</span><br></pre></td></tr></table></figure>

<h3 id="常见问题解决"><a href="#常见问题解决" class="headerlink" title="常见问题解决"></a>常见问题解决</h3><table>
<thead>
<tr>
<th>问题</th>
<th>原因</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td>301重定向不生效</td>
<td>Nginx配置未生效</td>
<td>重启容器或重载配置</td>
</tr>
<tr>
<td>OSS访问403错误</td>
<td>权限配置问题</td>
<td>设置Bucket公共读权限</td>
</tr>
<tr>
<td>字体加载仍然很慢</td>
<td>CDN未生效</td>
<td>检查CDN配置和缓存策略</td>
</tr>
<tr>
<td>容器启动失败</td>
<td>配置文件语法错误</td>
<td>检查Nginx配置语法</td>
</tr>
</tbody></table>
<h3 id="性能监控脚本"><a href="#性能监控脚本" class="headerlink" title="性能监控脚本"></a>性能监控脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># performance-monitor.sh</span></span><br><span class="line"><span class="comment"># 持续监控OnlyOffice性能</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== <span class="subst">$(date)</span> ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 容器资源使用</span></span><br><span class="line">    docker stats onlyoffice --no-stream --format <span class="string">&quot;table &#123;&#123;.CPUPerc&#125;&#125;\t&#123;&#123;.MemUsage&#125;&#125;\t&#123;&#123;.NetIO&#125;&#125;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 字体加载测试</span></span><br><span class="line">    response_time=$(curl -o /dev/null -s -w <span class="string">&quot;%&#123;time_total&#125;&quot;</span> -I https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/arial.ttf)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;字体响应时间: <span class="variable">$&#123;response_time&#125;</span>s&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 错误日志统计</span></span><br><span class="line">    error_count=$(docker logs onlyoffice --since 1m 2&gt;&amp;1 | grep -i error | <span class="built_in">wc</span> -l)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;最近1分钟错误数: <span class="variable">$error_count</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;========================&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 60</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>通过以上静态文件托管优化方案，可以将OnlyOffice的字体加载时间从30-60秒降至3-5秒，显著提升用户体验。建议在生产环境中逐步实施，并持续监控性能指标。</p>
</div>
        </div>
        
        <footer class="kratos-entry-footer clearfix">
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/font/" rel="tag">font</a>, <a class="tag-none-link" href="/tags/linux/" rel="tag">linux</a>, <a class="tag-none-link" href="/tags/onlyoffice/" rel="tag">onlyoffice</a>
                </div>
                <div class="pull-date">
                    <time datetime="2025-10-27T10:42:24.243Z" itemprop="dateModified">最后编辑：2025-10-27</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" AdGuard生成自签名证书" href="/2025/07/22/2025/07/221740/">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" PPT添加水印功能" href="/2025/08/01/2025/08/011646/">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
        <link rel="stylesheet" href="/vendors/gitalk@1.7.2/dist/gitalk.css"></script>
<div id="gitalk-container" class="post-comments lazy-load" style="padding-left:2rem; padding-right:2rem;"></div>
<script>
    var load_comm = () => {
        const init = () => {
            console.log('Gitalk loading...');
            const gitalk = new Gitalk(Object.assign({
                id: '/2025/07/25/2025/07/251808/',
                path: '/2025/07/25/2025/07/251808/'
            }, JSON.parse('{"clientID":"56e6a743c63b9c4faa93","clientSecret":"888b7234051c5c2ed6ea7bdf18e8b5a2678775f1","repo":"gitalk-comments","owner":"qbmzc","admin":["qbmzc"]}')));

            gitalk.render('gitalk-container');
        }
        if (typeof Gitalk === 'undefined') {
            const src = '/vendors/gitalk@1.7.2/dist/gitalk.min.js';
            $.getScript(src, init);
        } else {
            init();
        }
    };
</script>
<noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://github.com/gitalk/gitalk">comments powered by Gitalk.</a></noscript>
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/avatar.webp" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center">流云与风，苍穹游牧</p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                496
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                6
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                223
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                    <aside id="krw-toc" class="widget widget-kratos-toc clearfix">
    <div class="photo-background"></div>
    <h4 class="widget-title no-after">
        <i class="fa fa-compass"></i>
        文章目录
        <span class="toc-progress-bar" role="progressbar" aria-label="阅读进度："></span>
    </h4>
    <div class="textwidget">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87"><span class="toc-text">目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="toc-text">解题思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%89%98%E7%AE%A1%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-text">静态文件托管优化方案（推荐）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4"><span class="toc-text">操作步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E5%AE%9A%E4%BD%8D%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="toc-text">步骤一：定位静态文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A%E4%B8%8A%E4%BC%A0%E8%87%B3OSS-CDN"><span class="toc-text">步骤二：上传至OSS&#x2F;CDN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9A%E4%BF%AE%E6%94%B9Nginx%E9%85%8D%E7%BD%AE"><span class="toc-text">步骤三：修改Nginx配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E5%9B%9B%EF%BC%9A%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1"><span class="toc-text">步骤四：重启服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-text">高级配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OSS%E8%B7%A8%E5%9F%9F%E9%85%8D%E7%BD%AE"><span class="toc-text">OSS跨域配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CDN%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-text">CDN缓存优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC%E4%BC%98%E5%8C%96"><span class="toc-text">容器启动脚本优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84"><span class="toc-text">技术架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E6%89%98%E7%AE%A1%E6%9E%B6%E6%9E%84"><span class="toc-text">静态文件托管架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%89%8D%E5%90%8E%E5%AF%B9%E6%AF%94"><span class="toc-text">优化前后对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-text">实现细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC"><span class="toc-text">1. 自动化部署脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84%E5%AD%97%E4%BD%93%E8%BF%81%E7%A7%BB%E8%84%9A%E6%9C%AC"><span class="toc-text">完整的字体迁移脚本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%9B%91%E6%8E%A7%E5%92%8C%E7%BB%B4%E6%8A%A4"><span class="toc-text">2. 监控和维护</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E4%BD%93%E5%8A%A0%E8%BD%BD%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E8%84%9A%E6%9C%AC"><span class="toc-text">字体加载性能监控脚本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E5%B7%A5%E5%85%B7"><span class="toc-text">3. 故障排查工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%8A%E6%96%AD%E8%84%9A%E6%9C%AC"><span class="toc-text">诊断脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-text">核心代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-Compose%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2"><span class="toc-text">Docker Compose一键部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF"><span class="toc-text">Nginx配置模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E8%84%9A%E6%9C%AC"><span class="toc-text">自动化运维脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-text">效果展示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90"><span class="toc-text">性能对比分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="toc-text">实际测试数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E6%9C%AC%E6%95%88%E7%9B%8A%E5%88%86%E6%9E%90"><span class="toc-text">成本效益分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%B1%95%E7%A4%BA"><span class="toc-text">示例展示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%89%8D%E7%9A%84%E9%97%AE%E9%A2%98%E7%8E%B0%E8%B1%A1"><span class="toc-text">优化前的问题现象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%90%8E%E7%9A%84%E6%AD%A3%E5%B8%B8%E7%8A%B6%E6%80%81"><span class="toc-text">优化后的正常状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%AA%8C%E8%AF%81%E5%91%BD%E4%BB%A4"><span class="toc-text">配置验证命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%99%84%E5%BD%95"><span class="toc-text">参考附录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84"><span class="toc-text">相关配置文件路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E6%AD%A5%E9%AA%A4"><span class="toc-text">故障排查步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9F%BA%E7%A1%80%E6%A3%80%E6%9F%A5"><span class="toc-text">1. 基础检查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE%E9%AA%8C%E8%AF%81"><span class="toc-text">2. 配置验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%BD%91%E7%BB%9C%E8%BF%9E%E9%80%9A%E6%80%A7%E6%B5%8B%E8%AF%95"><span class="toc-text">3. 网络连通性测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-text">4. 日志分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-text">常见问题解决</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E8%84%9A%E6%9C%AC"><span class="toc-text">性能监控脚本</span></a></li></ol></li></ol>
    </div>
</aside>
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">137</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">150</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/congco/">congco</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/work/">work</a><span class="category-list-count">118</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/wuw/">wuw</a><span class="category-list-count">48</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/AES/" style="font-size: 0.6em;">AES</a> <a href="/tags/AI/" style="font-size: 0.7em;">AI</a> <a href="/tags/AWS/" style="font-size: 0.7em;">AWS</a> <a href="/tags/Arch/" style="font-size: 0.6em;">Arch</a> <a href="/tags/Arch-Linux/" style="font-size: 0.8em;">Arch Linux</a> <a href="/tags/ArchLinux/" style="font-size: 0.8em;">ArchLinux</a> <a href="/tags/CAS/" style="font-size: 0.6em;">CAS</a> <a href="/tags/Caffeine/" style="font-size: 0.6em;">Caffeine</a> <a href="/tags/CompletableFuture/" style="font-size: 0.7em;">CompletableFuture</a> <a href="/tags/DNS/" style="font-size: 0.8em;">DNS</a> <a href="/tags/Flask/" style="font-size: 0.6em;">Flask</a> <a href="/tags/Future/" style="font-size: 0.7em;">Future</a> <a href="/tags/GC/" style="font-size: 0.6em;">GC</a> <a href="/tags/GPT/" style="font-size: 0.6em;">GPT</a> <a href="/tags/GraalVM/" style="font-size: 0.8em;">GraalVM</a> <a href="/tags/HashMap/" style="font-size: 0.6em;">HashMap</a> <a href="/tags/InputStream/" style="font-size: 0.6em;">InputStream</a> <a href="/tags/JDK/" style="font-size: 0.6em;">JDK</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2025/10/23/2025/10/221500/"><i class="fa  fa-book"></i> dig命令使用详解</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/10/13/2025/10/131645/"><i class="fa  fa-book"></i> DNS解析异常导致视频播放缓慢问题排查与解决</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/10/11/2025/10/091335/"><i class="fa  fa-book"></i> 图片添加alpha通道&设置透明度</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/09/26/2025/09/261010/"><i class="fa  fa-book"></i> 替换wps配置文件</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/09/23/2025/09/231034/"><i class="fa  fa-book"></i> word表格批量设置允许跨页断行</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        
                        <li><a href="mailto:congco@foxmail.com"><i class="fa fa-envelope"></i></a></li>
                        
                        
                        
                        
                        
                        <li><a target="_blank" rel="nofollow" href="https://github.com/qbmzc"><i class="fa fa-github"></i></a></li>
                        <li><a target="_blank" rel="nofollow" href="/rss.xml"><i class="fa fa-rss"></i></a></li>
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2025 沐曦留曳 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by cong.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>


    <script async src="/js/candy.min.js"></script>




    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/vendors/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>