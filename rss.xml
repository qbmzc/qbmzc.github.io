<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>沐曦留曳</title>
  
  
  <link href="https://qbmzc.github.io/rss.xml" rel="self"/>
  
  <link href="https://qbmzc.github.io/"/>
  <updated>2025-11-21T06:36:31.567Z</updated>
  <id>https://qbmzc.github.io/</id>
  
  <author>
    <name>cong</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>karakeep</title>
    <link href="https://qbmzc.github.io/2025/11/14/2025/11/141727/"/>
    <id>https://qbmzc.github.io/2025/11/14/2025/11/141727/</id>
    <published>2025-11-14T06:06:09.000Z</published>
    <updated>2025-11-21T06:36:31.567Z</updated>
    
    <content type="html"><![CDATA[<p>karakeep</p><span id="more"></span><h2 id="docker-compose安装"><a href="#docker-compose安装" class="headerlink" title="docker compose安装"></a>docker compose安装</h2><ol><li>创建目录</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir karakeep-app</span><br></pre></td></tr></table></figure><ol start="2"><li>下载<code>docker-compose.yaml</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/karakeep-app/karakeep/main/docker/docker-compose.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="3"><li>设置环境变量<code>.env</code></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KARAKEEP_VERSION=release</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">openssl rand -<span class="built_in">base64</span> 36</span></span><br><span class="line">NEXTAUTH_SECRET=super_random_string</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">openssl rand -<span class="built_in">base64</span> 36</span></span><br><span class="line">MEILI_MASTER_KEY=another_random_string</span><br><span class="line">NEXTAUTH_URL=http://localhost:3000</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;karakeep&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://qbmzc.github.io/categories/Linux/"/>
    
    
    <category term="openssl" scheme="https://qbmzc.github.io/tags/openssl/"/>
    
  </entry>
  
  <entry>
    <title>SonarQube 扫描支持多 JDK 版本的实践方案</title>
    <link href="https://qbmzc.github.io/2025/11/11/2025/11/111335/"/>
    <id>https://qbmzc.github.io/2025/11/11/2025/11/111335/</id>
    <published>2025-11-11T05:36:09.000Z</published>
    <updated>2025-11-21T06:36:31.567Z</updated>
    
    <content type="html"><![CDATA[<p>在企业级项目中，不同的应用可能使用不同的 JDK 版本。如何在 CI&#x2F;CD 流程中优雅地支持多版本 JDK 的 SonarQube 代码扫描？本文分享一套基于 Docker 的实践方案。</p><span id="more"></span><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>随着 Java 生态的发展，企业内部往往存在多个 JDK 版本并行的情况：</p><ul><li>老项目仍在使用 JDK 8</li><li>新项目已经升级到 JDK 17 或 21</li><li>部分项目尝鲜 JDK 23&#x2F;25</li></ul><p>在 CI&#x2F;CD 流程中，我们需要根据项目的 JDK 版本选择对应的编译和扫描环境，确保代码质量检查的准确性。</p><h2 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h2><h3 id="核心思路"><a href="#核心思路" class="headerlink" title="核心思路"></a>核心思路</h3><p>为每个 JDK 版本构建独立的 Docker 镜像，镜像中包含：</p><ul><li>对应版本的 JDK</li><li>Maven 构建工具</li><li>SonarQube Scanner</li></ul><p>在 CI&#x2F;CD 流程中，根据项目配置动态选择对应的镜像进行构建和扫描。</p><h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><ul><li><strong>隔离性好</strong>：每个版本独立，互不干扰</li><li><strong>镜像体积小</strong>：单个镜像只包含一个 JDK 版本</li><li><strong>易于维护</strong>：版本升级只需重新构建对应镜像</li><li><strong>灵活性高</strong>：可以为不同版本配置不同的工具链</li></ul><h2 id="实施步骤"><a href="#实施步骤" class="headerlink" title="实施步骤"></a>实施步骤</h2><h3 id="1-构建基础镜像"><a href="#1-构建基础镜像" class="headerlink" title="1. 构建基础镜像"></a>1. 构建基础镜像</h3><p>以 JDK 21 为例，创建 <code>Dockerfile.jdk21</code>：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像已经包含了 Maven 和 Sonar Scanner</span></span><br><span class="line"><span class="keyword">FROM</span> java-maven-builder:sonar-jdk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 JDK 21</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> jdk21.tar.gz /tmp/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> tar -xzf /tmp/jdk21.tar.gz -C /opt/ &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> /opt/jdk-21* /opt/jdk21 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> /tmp/jdk21.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：这里不设置 JAVA_HOME，在运行时通过环境变量动态指定</span></span><br><span class="line"><span class="comment"># 这样可以保持镜像的灵活性</span></span><br><span class="line"><span class="comment"># ENV JAVA_HOME=/opt/jdk21</span></span><br><span class="line"><span class="comment"># ENV PATH=$JAVA_HOME/bin:$PATH</span></span><br></pre></td></tr></table></figure><p><strong>说明</strong>：</p><ul><li>基础镜像 <code>java-maven-builder:sonar-jdk</code> 已包含 Maven 和 SonarQube Scanner</li><li>只需添加对应版本的 JDK</li><li>不在镜像中固定 <code>JAVA_HOME</code>，保持运行时的灵活性</li></ul><h3 id="2-批量构建脚本"><a href="#2-批量构建脚本" class="headerlink" title="2. 批量构建脚本"></a>2. 批量构建脚本</h3><p>创建 <code>build-all.sh</code> 脚本，一键构建所有版本的镜像：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 构建脚本 - 为每个 JDK 版本构建独立镜像</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置参数</span></span><br><span class="line">REGISTRY=<span class="string">&quot;images.cc.com/library&quot;</span></span><br><span class="line">IMAGE_NAME=<span class="string">&quot;sonar-scanner&quot;</span></span><br><span class="line">VERSIONS=(<span class="string">&quot;1.8&quot;</span> <span class="string">&quot;11&quot;</span> <span class="string">&quot;17&quot;</span> <span class="string">&quot;21&quot;</span> <span class="string">&quot;23&quot;</span> <span class="string">&quot;25&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始构建 Sonar Scanner 镜像&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历所有版本进行构建</span></span><br><span class="line"><span class="keyword">for</span> version <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;VERSIONS[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt;&gt; 构建 JDK <span class="variable">$&#123;version&#125;</span> 镜像...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 构建镜像，同时打上版本标签和日期标签</span></span><br><span class="line">    docker build \</span><br><span class="line">        -f Dockerfile.jdk<span class="variable">$&#123;version&#125;</span> \</span><br><span class="line">        -t <span class="variable">$&#123;REGISTRY&#125;</span>/<span class="variable">$&#123;IMAGE_NAME&#125;</span>:jdk<span class="variable">$&#123;version&#125;</span> \</span><br><span class="line">        -t <span class="variable">$&#123;REGISTRY&#125;</span>/<span class="variable">$&#123;IMAGE_NAME&#125;</span>:jdk<span class="variable">$&#123;version&#125;</span>-$(<span class="built_in">date</span> +%Y%m%d) \</span><br><span class="line">        .</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ JDK <span class="variable">$&#123;version&#125;</span> 镜像构建完成&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;所有镜像构建完成！&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;镜像列表：&quot;</span></span><br><span class="line"><span class="keyword">for</span> version <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;VERSIONS[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  - <span class="variable">$&#123;REGISTRY&#125;</span>/<span class="variable">$&#123;IMAGE_NAME&#125;</span>:jdk<span class="variable">$&#123;version&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  - <span class="variable">$&#123;REGISTRY&#125;</span>/<span class="variable">$&#123;IMAGE_NAME&#125;</span>:jdk<span class="variable">$&#123;version&#125;</span>-<span class="subst">$(date +%Y%m%d)</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;推送镜像到仓库：&quot;</span></span><br><span class="line"><span class="keyword">for</span> version <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;VERSIONS[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  docker push <span class="variable">$&#123;REGISTRY&#125;</span>/<span class="variable">$&#123;IMAGE_NAME&#125;</span>:jdk<span class="variable">$&#123;version&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p><strong>使用方法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 赋予执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x build-all.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行构建</span></span><br><span class="line">./build-all.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送到镜像仓库</span></span><br><span class="line">docker push images.cc.com/library/sonar-scanner:jdk1.8</span><br><span class="line">docker push images.cc.com/library/sonar-scanner:jdk11</span><br><span class="line"><span class="comment"># ... 其他版本</span></span><br></pre></td></tr></table></figure><h3 id="3-集成到-CI-CD-流程"><a href="#3-集成到-CI-CD-流程" class="headerlink" title="3. 集成到 CI&#x2F;CD 流程"></a>3. 集成到 CI&#x2F;CD 流程</h3><p>在 CI&#x2F;CD 代码中，根据项目的 JDK 版本动态选择镜像和配置环境变量：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据 JDK 版本配置构建环境</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> jdkVersion JDK 版本号（如 &quot;1.8&quot;, &quot;11&quot;, &quot;17&quot; 等）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 镜像名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">configureBuildEnvironment</span><span class="params">(String jdkVersion)</span> &#123;</span><br><span class="line">    String sourceJavaHome;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据 JDK 版本设置 JAVA_HOME 路径</span></span><br><span class="line">    <span class="keyword">switch</span> (jdkVersion) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;1.8&quot;</span>:</span><br><span class="line">            sourceJavaHome = <span class="string">&quot;/usr/java/jdk1.8.0_202&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;11&quot;</span>:</span><br><span class="line">            sourceJavaHome = <span class="string">&quot;/opt/jdk11&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;17&quot;</span>:</span><br><span class="line">            sourceJavaHome = <span class="string">&quot;/usr/java/jdk-17.0.5&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;21&quot;</span>:</span><br><span class="line">            sourceJavaHome = <span class="string">&quot;/opt/jdk21&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;23&quot;</span>:</span><br><span class="line">            sourceJavaHome = <span class="string">&quot;/opt/jdk23&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;25&quot;</span>:</span><br><span class="line">            sourceJavaHome = <span class="string">&quot;/opt/jdk25&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// 默认使用 JDK 8</span></span><br><span class="line">            sourceJavaHome = <span class="string">&quot;/usr/java/jdk1.8.0_202&quot;</span>;</span><br><span class="line">            log.warn(<span class="string">&quot;未识别的 JDK 版本: &#123;&#125;, 使用默认版本 1.8&quot;</span>, jdkVersion);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置环境变量</span></span><br><span class="line">    System.setProperty(<span class="string">&quot;JAVA_HOME&quot;</span>, sourceJavaHome);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 动态选择镜像</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">imageName</span> <span class="operator">=</span> <span class="string">&quot;images.cc.com/library/sonar-scanner:jdk&quot;</span> + jdkVersion;</span><br><span class="line">    log.info(<span class="string">&quot;使用镜像: &#123;&#125;, JAVA_HOME: &#123;&#125;&quot;</span>, imageName, sourceJavaHome);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> imageName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>GitLab CI 配置示例</strong>：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sonar-scan:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">$&#123;SONAR_IMAGE&#125;</span></span><br><span class="line">  <span class="attr">variables:</span></span><br><span class="line">    <span class="attr">JAVA_HOME:</span> <span class="string">$&#123;JAVA_HOME_PATH&#125;</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mvn</span> <span class="string">clean</span> <span class="string">verify</span> <span class="string">sonar:sonar</span></span><br><span class="line">      <span class="string">-Dsonar.projectKey=$&#123;CI_PROJECT_NAME&#125;</span></span><br><span class="line">      <span class="string">-Dsonar.host.url=$&#123;SONAR_HOST_URL&#125;</span></span><br><span class="line">      <span class="string">-Dsonar.login=$&#123;SONAR_TOKEN&#125;</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">merge_requests</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br></pre></td></tr></table></figure><h2 id="方案对比"><a href="#方案对比" class="headerlink" title="方案对比"></a>方案对比</h2><p>在实际应用中，还有其他几种可选方案，各有优劣：</p><h3 id="方案一：单镜像包含所有-JDK-版本"><a href="#方案一：单镜像包含所有-JDK-版本" class="headerlink" title="方案一：单镜像包含所有 JDK 版本"></a>方案一：单镜像包含所有 JDK 版本</h3><p><strong>实现方式</strong>：在一个镜像中安装所有需要的 JDK 版本。</p><p><strong>优点</strong>：</p><ul><li>只需维护一个镜像</li><li>切换版本只需修改环境变量</li></ul><p><strong>缺点</strong>：</p><ul><li>❌ 镜像体积非常大（可能超过 2GB）</li><li>❌ 构建时间长</li><li>❌ 拉取镜像慢，影响 CI&#x2F;CD 效率</li><li>❌ 资源浪费，每次只用一个 JDK</li></ul><h3 id="方案二：挂载-JDK-目录"><a href="#方案二：挂载-JDK-目录" class="headerlink" title="方案二：挂载 JDK 目录"></a>方案二：挂载 JDK 目录</h3><p><strong>实现方式</strong>：在宿主机或 PVC 中预先上传 JDK，容器启动时挂载。</p><p><strong>优点</strong>：</p><ul><li>镜像体积小</li><li>灵活性高</li></ul><p><strong>缺点</strong>：</p><ul><li>❌ 需要在每个构建节点上维护 JDK 文件</li><li>❌ 依赖外部存储，增加复杂度</li><li>❌ 权限管理复杂</li><li>❌ 不适合云原生环境</li></ul><h3 id="方案三：使用官方-JDK-镜像从头构建"><a href="#方案三：使用官方-JDK-镜像从头构建" class="headerlink" title="方案三：使用官方 JDK 镜像从头构建"></a>方案三：使用官方 JDK 镜像从头构建</h3><p><strong>实现方式</strong>：基于官方 JDK 镜像，每次构建时安装 Maven 和 SonarQube Scanner。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> eclipse-temurin:<span class="number">17</span>-jdk-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装构建工具</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --no-cache \</span></span><br><span class="line"><span class="language-bash">    maven \</span></span><br><span class="line"><span class="language-bash">    sonar-scanner-cli \</span></span><br><span class="line"><span class="language-bash">    git \</span></span><br><span class="line"><span class="language-bash">    bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /workspace</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Maven 镜像源（可选）</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> settings.xml /root/.m2/settings.xml</span></span><br></pre></td></tr></table></figure><p><strong>优点</strong>：</p><ul><li>✅ 使用官方维护的 JDK 镜像，安全性高</li><li>✅ 镜像体积相对较小</li><li>✅ 易于理解和维护</li></ul><p><strong>缺点</strong>：</p><ul><li>❌ 每次构建需要下载依赖</li><li>❌ 构建时间较长</li><li>❌ 需要为每个版本维护独立的 Dockerfile</li></ul><h3 id="方案四：多阶段构建（推荐）"><a href="#方案四：多阶段构建（推荐）" class="headerlink" title="方案四：多阶段构建（推荐）"></a>方案四：多阶段构建（推荐）</h3><p><strong>实现方式</strong>：结合本文方案，使用 Docker 多阶段构建优化镜像。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建阶段</span></span><br><span class="line"><span class="keyword">FROM</span> maven:<span class="number">3.8</span>-eclipse-temurin-<span class="number">17</span> AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /build</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> pom.xml .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn dependency:go-offline</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行阶段</span></span><br><span class="line"><span class="keyword">FROM</span> eclipse-temurin:<span class="number">17</span>-jdk-slim</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /root/.m2 /root/.m2</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y maven sonar-scanner &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br></pre></td></tr></table></figure><p><strong>优点</strong>：</p><ul><li>✅ 镜像体积最小</li><li>✅ 构建速度快</li><li>✅ 安全性高</li></ul><h2 id="方案选择建议"><a href="#方案选择建议" class="headerlink" title="方案选择建议"></a>方案选择建议</h2><table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td>企业内部，版本固定</td><td>本文方案（独立镜像）</td></tr><tr><td>云原生环境</td><td>方案四（多阶段构建）</td></tr><tr><td>快速验证</td><td>方案三（官方镜像）</td></tr><tr><td>资源受限</td><td>方案二（挂载目录）</td></tr></tbody></table><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="1-镜像标签管理"><a href="#1-镜像标签管理" class="headerlink" title="1. 镜像标签管理"></a>1. 镜像标签管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用语义化版本标签</span></span><br><span class="line">images.cc.com/library/sonar-scanner:jdk17-v1.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同时维护 latest 标签</span></span><br><span class="line">images.cc.com/library/sonar-scanner:jdk17-latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加构建日期标签便于追溯</span></span><br><span class="line">images.cc.com/library/sonar-scanner:jdk17-20251111</span><br></pre></td></tr></table></figure><h3 id="2-镜像安全扫描"><a href="#2-镜像安全扫描" class="headerlink" title="2. 镜像安全扫描"></a>2. 镜像安全扫描</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Trivy 扫描镜像漏洞</span></span><br><span class="line">trivy image images.cc.com/library/sonar-scanner:jdk17</span><br><span class="line"></span><br><span class="line"><span class="comment"># 集成到 CI/CD 流程</span></span><br><span class="line">docker scan images.cc.com/library/sonar-scanner:jdk17</span><br></pre></td></tr></table></figure><h3 id="3-缓存优化"><a href="#3-缓存优化" class="headerlink" title="3. 缓存优化"></a>3. 缓存优化</h3><p>在 Dockerfile 中合理利用缓存层：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先复制依赖配置文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> pom.xml /workspace/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn dependency:go-offline</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再复制源代码</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> src /workspace/src</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn package</span></span><br></pre></td></tr></table></figure><h3 id="4-环境变量配置"><a href="#4-环境变量配置" class="headerlink" title="4. 环境变量配置"></a>4. 环境变量配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 CI/CD 中统一管理环境变量</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/jdk17</span><br><span class="line"><span class="built_in">export</span> MAVEN_OPTS=<span class="string">&quot;-Xmx2048m -XX:MaxPermSize=512m&quot;</span></span><br><span class="line"><span class="built_in">export</span> SONAR_SCANNER_OPTS=<span class="string">&quot;-Xmx1024m&quot;</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过为每个 JDK 版本构建独立的 Docker 镜像，我们实现了：</p><ol><li><strong>灵活的版本管理</strong>：支持多个 JDK 版本并行使用</li><li><strong>高效的 CI&#x2F;CD 流程</strong>：镜像体积小，拉取速度快</li><li><strong>良好的可维护性</strong>：版本隔离，互不影响</li><li><strong>标准化的构建环境</strong>：确保构建结果的一致性</li></ol><p>这套方案已在生产环境稳定运行，有效支撑了企业内部多版本 Java 项目的代码质量管理。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://docs.sonarqube.org/">SonarQube 官方文档</a></li><li><a href="https://docs.docker.com/build/building/multi-stage/">Docker 多阶段构建最佳实践</a></li><li><a href="https://hub.docker.com/_/eclipse-temurin">Eclipse Temurin JDK 镜像</a></li><li><a href="https://hub.docker.com/_/maven">Maven Docker 镜像</a></li></ul><hr><p><em>如果你的团队也面临多 JDK 版本管理的挑战，希望这篇文章能给你一些启发！</em></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;在企业级项目中，不同的应用可能使用不同的 JDK 版本。如何在 CI&amp;#x2F;CD 流程中优雅地支持多版本 JDK 的 SonarQube 代码扫描？本文分享一套基于 Docker 的实践方案。&lt;/p&gt;</summary>
    
    
    
    <category term="DevOps" scheme="https://qbmzc.github.io/categories/DevOps/"/>
    
    
    <category term="JDK" scheme="https://qbmzc.github.io/tags/JDK/"/>
    
    <category term="SonarQube" scheme="https://qbmzc.github.io/tags/SonarQube/"/>
    
    <category term="CI/CD" scheme="https://qbmzc.github.io/tags/CI-CD/"/>
    
    <category term="Docker" scheme="https://qbmzc.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>一次修复 PDF 中文乱码的排查记录</title>
    <link href="https://qbmzc.github.io/2025/11/11/2025/11/111045/"/>
    <id>https://qbmzc.github.io/2025/11/11/2025/11/111045/</id>
    <published>2025-11-11T02:46:09.000Z</published>
    <updated>2025-11-21T06:36:31.567Z</updated>
    
    <content type="html"><![CDATA[<p>最近遇到一个有趣的问题：客户反馈 PDF 文件预览时出现中文乱码，无论使用 WPS 还是浏览器都无法正常显示。经过一番排查，最终定位到是字符编码问题。</p><span id="more"></span><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>客户提供的 PDF 文件在多个阅读器中都显示为乱码：</p><ul><li>WPS Office：中文显示异常</li><li>浏览器（Chrome&#x2F;Edge）：中文显示异常</li><li>其他 PDF 阅读器：同样存在问题</li></ul><h2 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h2><h3 id="1-验证文件类型"><a href="#1-验证文件类型" class="headerlink" title="1. 验证文件类型"></a>1. 验证文件类型</h3><p>首先怀疑文件本身可能不是标准的 PDF 格式，或者文件损坏。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 file 命令检查文件类型</span></span><br><span class="line">file a.pdf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出：a.pdf: PDF document, version 1.x</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以使用 Apache Tika 进行更详细的类型检测</span></span><br></pre></td></tr></table></figure><p><strong>结论</strong>：文件类型正常，是标准的 PDF 文档。</p><h3 id="2-检查字体缺失"><a href="#2-检查字体缺失" class="headerlink" title="2. 检查字体缺失"></a>2. 检查字体缺失</h3><p>考虑到可能是 PDF 中使用的中文字体在系统中不存在，导致无法正常渲染。</p><p><strong>测试方法</strong>：</p><ul><li>在不同操作系统（Windows、macOS、Linux）上测试</li><li>使用不同的 PDF 阅读器打开</li></ul><p><strong>结论</strong>：问题依然存在，排除字体缺失的可能性。</p><h3 id="3-定位编码问题"><a href="#3-定位编码问题" class="headerlink" title="3. 定位编码问题"></a>3. 定位编码问题</h3><p>最后怀疑是字符编码问题，PDF 内部的文本流编码与阅读器预期不一致。</p><h4 id="3-1-检查-PDF-结构"><a href="#3-1-检查-PDF-结构" class="headerlink" title="3.1 检查 PDF 结构"></a>3.1 检查 PDF 结构</h4><p>使用文本编辑器（如 Vim、Notepad++）以二进制模式打开 PDF：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%PDF-1.4</span><br><span class="line">...</span><br><span class="line">%%EOF</span><br></pre></td></tr></table></figure><p>文件头和文件尾都正常，说明 PDF 结构完整。</p><h4 id="3-2-尝试修复"><a href="#3-2-尝试修复" class="headerlink" title="3.2 尝试修复"></a>3.2 尝试修复</h4><p><strong>操作步骤</strong>：</p><ol><li><strong>备份原文件</strong>（重要！避免数据丢失）</li><li>使用支持编码转换的文本编辑器打开 PDF</li><li>将文件编码从 UTF-8 转换为 GBK</li><li>保存后重新用 PDF 阅读器打开</li></ol><p><strong>结果</strong>：✅ 中文显示正常！</p><h2 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h2><p>经过分析，问题的根本原因是：</p><p><strong>PDF 生成时的编码不一致</strong>：</p><ul><li>PDF 内部用于存储中文文本的字符流使用了 <strong>GBK</strong>（或 GB2312）编码</li><li>但 PDF 阅读器默认按照 <strong>UTF-8</strong> 或其他编码方式解析</li><li>导致中文字符无法正确映射，显示为乱码</li></ul><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="临时方案"><a href="#临时方案" class="headerlink" title="临时方案"></a>临时方案</h3><p>对于已经生成的乱码 PDF：</p><ol><li>备份原文件</li><li>使用文本编辑器转换编码为 GBK</li><li>验证修复效果</li></ol><h3 id="根本方案"><a href="#根本方案" class="headerlink" title="根本方案"></a>根本方案</h3><p>从源头避免问题：</p><ol><li><strong>统一编码标准</strong>：在生成 PDF 时明确指定使用 UTF-8 编码</li><li><strong>嵌入字体</strong>：在 PDF 中嵌入所需的中文字体，避免依赖系统字体</li><li><strong>使用标准库</strong>：使用成熟的 PDF 生成库（如 iText、PDFBox、wkhtmltopdf）并正确配置编码参数</li></ol><h2 id="经验总结"><a href="#经验总结" class="headerlink" title="经验总结"></a>经验总结</h2><ol><li><strong>编码问题是中文环境下的常见坑</strong>：UTF-8、GBK、GB2312 等编码混用容易导致乱码</li><li><strong>排查要有条理</strong>：从文件完整性 → 字体 → 编码，逐步缩小问题范围</li><li><strong>备份很重要</strong>：在尝试修复前一定要备份原文件</li><li><strong>预防胜于治疗</strong>：在开发阶段就应该规范编码标准，避免后期出现问题</li></ol><h2 id="相关工具"><a href="#相关工具" class="headerlink" title="相关工具"></a>相关工具</h2><ul><li><code>file</code>：Linux 文件类型检测工具</li><li>Apache Tika：文件类型和元数据提取工具</li><li>PDFBox：Java PDF 处理库</li><li>iText：强大的 PDF 生成和处理库</li></ul><hr><p><em>如果你也遇到类似的 PDF 乱码问题，希望这篇文章能帮到你！</em></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近遇到一个有趣的问题：客户反馈 PDF 文件预览时出现中文乱码，无论使用 WPS 还是浏览器都无法正常显示。经过一番排查，最终定位到是字符编码问题。&lt;/p&gt;</summary>
    
    
    
    <category term="技术笔记" scheme="https://qbmzc.github.io/categories/%E6%8A%80%E6%9C%AF%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="PDF" scheme="https://qbmzc.github.io/tags/PDF/"/>
    
    <category term="编码问题" scheme="https://qbmzc.github.io/tags/%E7%BC%96%E7%A0%81%E9%97%AE%E9%A2%98/"/>
    
    <category term="故障排查" scheme="https://qbmzc.github.io/tags/%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/"/>
    
  </entry>
  
  <entry>
    <title>dig命令使用详解</title>
    <link href="https://qbmzc.github.io/2025/10/23/2025/10/221500/"/>
    <id>https://qbmzc.github.io/2025/10/23/2025/10/221500/</id>
    <published>2025-10-23T01:46:09.000Z</published>
    <updated>2025-11-21T06:36:31.567Z</updated>
    
    <content type="html"><![CDATA[<p>dig（Domain Information Groper）是一个强大的命令行工具，用于查询 DNS 域名系统。它是网络管理员和开发人员诊断 DNS 问题的首选工具之一。本文将从基础到高级，全面介绍 dig 命令的使用方法。</p><h2 id="什么是-dig-命令"><a href="#什么是-dig-命令" class="headerlink" title="什么是 dig 命令"></a>什么是 dig 命令</h2><p>dig 是 BIND DNS 服务器软件包提供的 DNS 查询工具，可以用来查询 DNS 服务器的响应信息。相比传统的 nslookup 工具，dig 提供更详细的输出和更灵活的功能。</p><h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><h3 id="最简单的查询"><a href="#最简单的查询" class="headerlink" title="最简单的查询"></a>最简单的查询</h3><p>查询域名的 A 记录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig baidu.com</span><br></pre></td></tr></table></figure><p>这个命令会返回有关 baidu.com 域名的详细信息，包括：</p><ul><li>DNS 查询头部信息</li><li>ANSWER 部分（查询结果）</li><li>AUTHORITY 部分（权威 DNS 服务器）</li><li>ADDITIONAL 部分（额外信息）</li></ul><h3 id="查询特定记录类型"><a href="#查询特定记录类型" class="headerlink" title="查询特定记录类型"></a>查询特定记录类型</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dig baidu.com A      <span class="comment"># 查询 A 记录（IPv4 地址）</span></span><br><span class="line">dig baidu.com AAAA   <span class="comment"># 查询 AAAA 记录（IPv6 地址）</span></span><br><span class="line">dig baidu.com MX     <span class="comment"># 查询邮件交换记录</span></span><br><span class="line">dig baidu.com NS     <span class="comment"># 查询名称服务器记录</span></span><br><span class="line">dig baidu.com CNAME  <span class="comment"># 查询别名记录</span></span><br><span class="line">dig baidu.com TXT    <span class="comment"># 查询文本记录</span></span><br></pre></td></tr></table></figure><h2 id="常见参数详解"><a href="#常见参数详解" class="headerlink" title="常见参数详解"></a>常见参数详解</h2><h3 id="指定-DNS-服务器"><a href="#指定-DNS-服务器" class="headerlink" title="-@ 指定 DNS 服务器"></a>-@ 指定 DNS 服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dig @8.8.8.8 baidu.com</span><br><span class="line">dig @1.1.1.1 baidu.com</span><br><span class="line">dig @ns1.google.com baidu.com</span><br></pre></td></tr></table></figure><p>使用 <code>-@</code> 参数可以指定 DNS 服务器进行查询，这对于测试特定 DNS 服务器的响应非常有用。</p><h3 id="short-简短输出"><a href="#short-简短输出" class="headerlink" title="+short 简短输出"></a>+short 简短输出</h3><p>默认情况下，dig 会输出很多详细信息。如果只想要 IP 地址：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dig +short baidu.com</span><br><span class="line"><span class="comment"># 输出：220.181.38.148</span></span><br><span class="line"><span class="comment"># 输出：39.156.66.10</span></span><br></pre></td></tr></table></figure><h3 id="noall-answer-只显示答案"><a href="#noall-answer-只显示答案" class="headerlink" title="+noall +answer 只显示答案"></a>+noall +answer 只显示答案</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +noall +answer baidu.com</span><br></pre></td></tr></table></figure><p>这个组合参数只显示查询结果，不显示头部和统计信息。</p><h3 id="trace-跟踪查询过程"><a href="#trace-跟踪查询过程" class="headerlink" title="+trace 跟踪查询过程"></a>+trace 跟踪查询过程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +trace baidu.com</span><br></pre></td></tr></table></figure><p>从根域名服务器开始，完整显示 DNS 查询的完整路径，包括每一步的查询过程。</p><h3 id="recurse-递归查询"><a href="#recurse-递归查询" class="headerlink" title="+recurse 递归查询"></a>+recurse 递归查询</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +recurse baidu.com</span><br></pre></td></tr></table></figure><p>这是默认行为，让本地 DNS 服务器递归查询。</p><h3 id="norecurse-非递归查询"><a href="#norecurse-非递归查询" class="headerlink" title="+norecurse 非递归查询"></a>+norecurse 非递归查询</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +norecurse baidu.com</span><br></pre></td></tr></table></figure><p>只查询指定的 DNS 服务器，不进行递归查询。</p><h3 id="x-反向查询"><a href="#x-反向查询" class="headerlink" title="-x 反向查询"></a>-x 反向查询</h3><p>查询 IP 地址对应的域名：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dig -x 8.8.8.8</span><br><span class="line"><span class="comment"># 输出 dns.google</span></span><br></pre></td></tr></table></figure><h3 id="p-指定端口"><a href="#p-指定端口" class="headerlink" title="-p 指定端口"></a>-p 指定端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig -p 5353 baidu.com</span><br></pre></td></tr></table></figure><p>指定 DNS 查询使用的端口号（默认是 53）。</p><h3 id="time-设置超时"><a href="#time-设置超时" class="headerlink" title="+time&#x3D; 设置超时"></a>+time&#x3D; 设置超时</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +time=1 baidu.com</span><br></pre></td></tr></table></figure><p>设置查询超时时间（秒）。</p><h3 id="tries-设置重试次数"><a href="#tries-设置重试次数" class="headerlink" title="+tries 设置重试次数"></a>+tries 设置重试次数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +tries=3 baidu.com</span><br></pre></td></tr></table></figure><p>设置查询重试次数。</p><h2 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h2><h3 id="1-批量查询多个域名"><a href="#1-批量查询多个域名" class="headerlink" title="1. 批量查询多个域名"></a>1. 批量查询多个域名</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> domain <span class="keyword">in</span> baidu.com google.com github.com; <span class="keyword">do</span></span><br><span class="line">    dig +short <span class="variable">$domain</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="2-监控-DNS-响应时间"><a href="#2-监控-DNS-响应时间" class="headerlink" title="2. 监控 DNS 响应时间"></a>2. 监控 DNS 响应时间</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig baidu.com | grep <span class="string">&quot;Query time:&quot;</span></span><br></pre></td></tr></table></figure><h3 id="3-只获取-IPv4-地址"><a href="#3-只获取-IPv4-地址" class="headerlink" title="3. 只获取 IPv4 地址"></a>3. 只获取 IPv4 地址</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +short baidu.com A</span><br></pre></td></tr></table></figure><h3 id="4-只获取-IPv6-地址"><a href="#4-只获取-IPv6-地址" class="headerlink" title="4. 只获取 IPv6 地址"></a>4. 只获取 IPv6 地址</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +short baidu.com AAAA</span><br></pre></td></tr></table></figure><h3 id="5-查询-TXT-记录（常用于验证域名所有权）"><a href="#5-查询-TXT-记录（常用于验证域名所有权）" class="headerlink" title="5. 查询 TXT 记录（常用于验证域名所有权）"></a>5. 查询 TXT 记录（常用于验证域名所有权）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +short baidu.com TXT</span><br></pre></td></tr></table></figure><h3 id="6-查询-MX-记录（邮件服务器）"><a href="#6-查询-MX-记录（邮件服务器）" class="headerlink" title="6. 查询 MX 记录（邮件服务器）"></a>6. 查询 MX 记录（邮件服务器）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dig +short baidu.com MX</span><br><span class="line"><span class="comment"># 输出优先级和邮件服务器</span></span><br></pre></td></tr></table></figure><h3 id="7-测试-DNS-解析速度"><a href="#7-测试-DNS-解析速度" class="headerlink" title="7. 测试 DNS 解析速度"></a>7. 测试 DNS 解析速度</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dig @1.1.1.1 baidu.com | grep <span class="string">&quot;Query time&quot;</span></span><br><span class="line">dig @8.8.8.8 baidu.com | grep <span class="string">&quot;Query time&quot;</span></span><br></pre></td></tr></table></figure><h3 id="8-查看详细统计信息"><a href="#8-查看详细统计信息" class="headerlink" title="8. 查看详细统计信息"></a>8. 查看详细统计信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig baidu.com +stats</span><br></pre></td></tr></table></figure><h2 id="高级用法"><a href="#高级用法" class="headerlink" title="高级用法"></a>高级用法</h2><h3 id="查找域名解析的完整路径"><a href="#查找域名解析的完整路径" class="headerlink" title="查找域名解析的完整路径"></a>查找域名解析的完整路径</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +trace google.com</span><br></pre></td></tr></table></figure><p>这显示了从根服务器到权威服务器的完整解析路径。</p><h3 id="查询-SOA-记录"><a href="#查询-SOA-记录" class="headerlink" title="查询 SOA 记录"></a>查询 SOA 记录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +short baidu.com SOA</span><br></pre></td></tr></table></figure><p>获取域名的起始授权机构记录，包含管理邮箱、序列号等信息。</p><h3 id="使用-dig-调试-DNS"><a href="#使用-dig-调试-DNS" class="headerlink" title="使用 dig 调试 DNS"></a>使用 dig 调试 DNS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dig -4 baidu.com      <span class="comment"># 只使用 IPv4</span></span><br><span class="line">dig -6 baidu.com      <span class="comment"># 只使用 IPv6</span></span><br><span class="line">dig baidu.com +cdflag <span class="comment"># 设置检查禁用标志</span></span><br></pre></td></tr></table></figure><h3 id="保存查询结果到文件"><a href="#保存查询结果到文件" class="headerlink" title="保存查询结果到文件"></a>保存查询结果到文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig baidu.com &gt; result.txt</span><br></pre></td></tr></table></figure><h3 id="组合多个选项"><a href="#组合多个选项" class="headerlink" title="组合多个选项"></a>组合多个选项</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +noall +answer +short baidu.com A</span><br></pre></td></tr></table></figure><p>这个命令结合了 <code>+noall</code>（不显示标题）、<code>+answer</code>（显示答案）、<code>+short</code>（简短输出），只返回 IP 地址。</p><h2 id="实际应用场景"><a href="#实际应用场景" class="headerlink" title="实际应用场景"></a>实际应用场景</h2><h3 id="场景-1：DNS-故障排查"><a href="#场景-1：DNS-故障排查" class="headerlink" title="场景 1：DNS 故障排查"></a>场景 1：DNS 故障排查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查询本地 DNS 能否解析</span></span><br><span class="line">dig baidu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查询公共 DNS 能否解析</span></span><br><span class="line">dig @8.8.8.8 baidu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 对比结果找出问题</span></span><br></pre></td></tr></table></figure><h3 id="场景-2：CDN-节点测试"><a href="#场景-2：CDN-节点测试" class="headerlink" title="场景 2：CDN 节点测试"></a>场景 2：CDN 节点测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试不同 DNS 服务器返回的 IP 是否不同</span></span><br><span class="line">dig @8.8.8.8 baidu.com +short</span><br><span class="line">dig @1.1.1.1 baidu.com +short</span><br><span class="line">dig @223.5.5.5 baidu.com +short</span><br></pre></td></tr></table></figure><h3 id="场景-3：验证-DNS-记录修改"><a href="#场景-3：验证-DNS-记录修改" class="headerlink" title="场景 3：验证 DNS 记录修改"></a>场景 3：验证 DNS 记录修改</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询修改后的 DNS 记录是否生效</span></span><br><span class="line">dig newrecord.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果本地有缓存，指定权威 DNS 服务器查询</span></span><br><span class="line">dig @ns1.example.com newrecord.example.com</span><br></pre></td></tr></table></figure><h3 id="场景-4：检查邮件服务器配置"><a href="#场景-4：检查邮件服务器配置" class="headerlink" title="场景 4：检查邮件服务器配置"></a>场景 4：检查邮件服务器配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询 MX 记录</span></span><br><span class="line">dig example.com MX</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 A 记录和 CNAME 记录</span></span><br><span class="line">dig mail.example.com</span><br><span class="line">dig mail.example.com CNAME</span><br></pre></td></tr></table></figure><h2 id="输出信息解读"><a href="#输出信息解读" class="headerlink" title="输出信息解读"></a>输出信息解读</h2><p>理解 dig 的输出信息很重要：</p><ul><li><strong>QUESTION SECTION</strong>：查询的问题</li><li><strong>ANSWER SECTION</strong>：DNS 服务器的回答</li><li><strong>AUTHORITY SECTION</strong>：权威 DNS 服务器信息</li><li><strong>ADDITIONAL SECTION</strong>：额外的记录</li><li><strong>Query time</strong>：查询耗时</li><li><strong>SERVER</strong>：查询的 DNS 服务器</li><li><strong>WHEN</strong>：查询时间</li></ul><h2 id="常见问题排查"><a href="#常见问题排查" class="headerlink" title="常见问题排查"></a>常见问题排查</h2><h3 id="1-DNS-解析缓慢"><a href="#1-DNS-解析缓慢" class="headerlink" title="1. DNS 解析缓慢"></a>1. DNS 解析缓慢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig baidu.com +stats</span><br></pre></td></tr></table></figure><p>查看各个阶段的耗时，定位瓶颈。</p><h3 id="2-DNS-污染检测"><a href="#2-DNS-污染检测" class="headerlink" title="2. DNS 污染检测"></a>2. DNS 污染检测</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dig baidu.com @8.8.8.8</span><br><span class="line">dig baidu.com @1.1.1.1</span><br><span class="line">dig baidu.com @114.114.114.114</span><br></pre></td></tr></table></figure><p>对比不同 DNS 服务器返回的结果。</p><h3 id="3-解析异常"><a href="#3-解析异常" class="headerlink" title="3. 解析异常"></a>3. 解析异常</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +trace baidu.com</span><br></pre></td></tr></table></figure><p>使用 trace 模式查看完整的解析路径，找出在哪一步出现问题。</p><h2 id="dig-vs-其他工具"><a href="#dig-vs-其他工具" class="headerlink" title="dig vs 其他工具"></a>dig vs 其他工具</h2><h3 id="dig-vs-nslookup"><a href="#dig-vs-nslookup" class="headerlink" title="dig vs nslookup"></a>dig vs nslookup</h3><ul><li>dig：输出更详细，更适合调试</li><li>nslookup：交互式，但输出不够详细</li></ul><h3 id="dig-vs-host"><a href="#dig-vs-host" class="headerlink" title="dig vs host"></a>dig vs host</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">host baidu.com</span><br><span class="line">dig baidu.com</span><br></pre></td></tr></table></figure><p>dig 提供更详细的信息，host 输出更简洁。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>dig 命令是 DNS 查询的强大工具，掌握它可以：</p><ul><li>快速诊断 DNS 问题</li><li>测试 DNS 配置</li><li>分析网络性能</li><li>调试 DNS 相关故障</li></ul><p>通过本文的介绍，相信你已经掌握了 dig 命令的基础和高级用法。在日常工作中，灵活运用这些技巧，能够大大提高 DNS 故障排查的效率。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;dig（Domain Information Groper）是一个强大的命令行工具，用于查询 DNS 域名系统。它是网络管理员和开发人员诊断 DNS 问题的首选工具之一。本文将从基础到高级，全面介绍 dig 命令的使用方法。&lt;/p&gt;
&lt;h2 id=&quot;什么是-dig-命令&quot;&gt;</summary>
      
    
    
    
    <category term="Linux" scheme="https://qbmzc.github.io/categories/Linux/"/>
    
    
    <category term="DNS" scheme="https://qbmzc.github.io/tags/DNS/"/>
    
  </entry>
  
  <entry>
    <title>DNS解析异常导致视频播放缓慢问题排查与解决</title>
    <link href="https://qbmzc.github.io/2025/10/13/2025/10/131645/"/>
    <id>https://qbmzc.github.io/2025/10/13/2025/10/131645/</id>
    <published>2025-10-13T05:42:34.000Z</published>
    <updated>2025-11-21T06:36:31.567Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>测试环境HLS视频播放出现严重延迟问题，用户反馈视频需要多次重试才能正常播放。通过排查发现是DNS解析异常导致的网络延迟问题。</p><span id="more"></span><h3 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h3><p>业务线同学反馈测试环境的m3u8文件访问异常缓慢，视频播放需要多次重试才能成功。</p><p><strong>问题URL：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://hls.itaimei.test.taimei.com/resources/hls/8ac0804d99eb075b019a0495da090003/8ac0804d99eb075b019a0495da090003_1080p.m3u8</span><br></pre></td></tr></table></figure><h2 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h2><h3 id="1-初步验证"><a href="#1-初步验证" class="headerlink" title="1. 初步验证"></a>1. 初步验证</h3><ul><li><strong>本地播放器测试</strong>：使用IINA或VLC播放器无法复现问题</li><li><strong>命令行测试</strong>：使用curl访问速度正常</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模拟浏览器请求测试</span></span><br><span class="line">curl -o a.m3u8 -v <span class="string">&#x27;http://hls.itaimei.test.taimei.com/resources/hls/8ac0804d99eb075b019a0495da090003/8ac0804d99eb075b019a0495da090003_1080p.m3u8&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Accept: */*&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Cache-Control: no-cache&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Connection: keep-alive&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;DNT: 1&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Origin: http://trialos.test.com&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Pragma: no-cache&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Referer: http://trialos.test.com/&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36 Edg/141.0.0.0&#x27;</span> \</span><br><span class="line">  --insecure</span><br></pre></td></tr></table></figure><h3 id="2-网络层排查"><a href="#2-网络层排查" class="headerlink" title="2. 网络层排查"></a>2. 网络层排查</h3><ul><li><strong>Ping测试</strong>：<code>ping -c 5 hls.itaimei.test.taimei.com</code> 速度正常</li><li><strong>关键发现</strong>：不同环境返回的解析IP不一致，怀疑DNS解析问题</li></ul><h3 id="3-浏览器性能分析"><a href="#3-浏览器性能分析" class="headerlink" title="3. 浏览器性能分析"></a>3. 浏览器性能分析</h3><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2025/20251022134836170.png"></p><p><strong>性能分析结果：</strong></p><ul><li><strong>DNS 查找</strong>：0 μs（正常）</li><li><strong>初始连接</strong>：40.56秒 ⚠️</li><li><strong>请求&#x2F;响应</strong>：40.56秒 ⚠️</li></ul><p><strong>问题定位</strong>：DNS解析耗时过长，导致整个请求延迟。</p><h2 id="DNS问题排查"><a href="#DNS问题排查" class="headerlink" title="DNS问题排查"></a>DNS问题排查</h2><h3 id="1-DNS解析测试"><a href="#1-DNS解析测试" class="headerlink" title="1. DNS解析测试"></a>1. DNS解析测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查 DNS 解析时间</span></span><br><span class="line">nslookup hls.itaimei.test.taimei.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用dig获取更详细信息</span></span><br><span class="line">dig hls.itaimei.test.taimei.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查解析时间</span></span><br><span class="line">dig +trace hls.itaimei.test.taimei.com</span><br></pre></td></tr></table></figure><h3 id="2-问题确认"><a href="#2-问题确认" class="headerlink" title="2. 问题确认"></a>2. 问题确认</h3><p>通过DNS解析测试发现：</p><ul><li>不同DNS服务器返回不同的IP地址</li><li>部分DNS服务器解析速度极慢</li><li>存在异常的DNS记录</li></ul><h3 id="3-解决方案"><a href="#3-解决方案" class="headerlink" title="3. 解决方案"></a>3. 解决方案</h3><p><strong>临时解决</strong>：修改本地hosts文件，直接指定IP地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 /etc/hosts</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;10.64.11.116 hls.itaimei.test.taimei.com&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure><p><strong>根本解决</strong>：联系运维团队清理异常的DNS记录</p><h2 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h2><h3 id="根本原因"><a href="#根本原因" class="headerlink" title="根本原因"></a>根本原因</h3><p>DNS服务器配置异常，存在多个解析记录，其中部分记录指向了不可达或响应缓慢的服务器。</p><h3 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h3><ul><li>主要影响浏览器访问</li><li>命令行工具（curl）和本地播放器不受影响</li><li>不同网络环境表现不一致</li></ul><h3 id="预防措施"><a href="#预防措施" class="headerlink" title="预防措施"></a>预防措施</h3><ol><li><strong>DNS监控</strong>：建立DNS解析时间监控</li><li><strong>多环境测试</strong>：在不同网络环境下进行测试</li><li><strong>DNS记录管理</strong>：定期清理无效DNS记录</li><li><strong>备用方案</strong>：配置CDN或负载均衡</li></ol><h3 id="排查经验"><a href="#排查经验" class="headerlink" title="排查经验"></a>排查经验</h3><ol><li><strong>分层排查</strong>：从应用层到网络层逐步排查</li><li><strong>对比测试</strong>：使用不同工具验证问题</li><li><strong>环境差异</strong>：关注不同环境下的表现差异</li><li><strong>性能分析</strong>：利用浏览器开发者工具分析网络性能</li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;测试环境HLS视频播放出现严重延迟问题，用户反馈视频需要多次重试才能正常播放。通过排查发现是DNS解析异常导致的网络延迟问题。&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://qbmzc.github.io/categories/Linux/"/>
    
    
    <category term="dns" scheme="https://qbmzc.github.io/tags/dns/"/>
    
    <category term="网络排查" scheme="https://qbmzc.github.io/tags/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5/"/>
    
    <category term="视频播放" scheme="https://qbmzc.github.io/tags/%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE/"/>
    
  </entry>
  
  <entry>
    <title>图片添加alpha通道&amp;设置透明度</title>
    <link href="https://qbmzc.github.io/2025/10/11/2025/10/091335/"/>
    <id>https://qbmzc.github.io/2025/10/11/2025/10/091335/</id>
    <published>2025-10-11T09:28:09.000Z</published>
    <updated>2025-11-21T06:36:31.567Z</updated>
    
    <content type="html"><![CDATA[<p>如果原图片没有alpha通道，你需要先添加alpha通道，然后设置透明度。以下是几种方法：</p><span id="more"></span><h2 id="方法1：添加alpha通道并设置透明度（一步完成）"><a href="#方法1：添加alpha通道并设置透明度（一步完成）" class="headerlink" title="方法1：添加alpha通道并设置透明度（一步完成）"></a>方法1：添加alpha通道并设置透明度（一步完成）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.png -vf <span class="string">&quot;format=rgba,colorchannelmixer=aa=0.3&quot;</span> output.png</span><br></pre></td></tr></table></figure><h2 id="方法2：分步处理"><a href="#方法2：分步处理" class="headerlink" title="方法2：分步处理"></a>方法2：分步处理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先添加完全不透明的alpha通道</span></span><br><span class="line">ffmpeg -i input.png -vf <span class="string">&quot;format=rgba&quot;</span> temp_with_alpha.png</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再设置透明度</span></span><br><span class="line">ffmpeg -i temp_with_alpha.png -vf <span class="string">&quot;colorchannelmixer=aa=0.3&quot;</span> output.png</span><br></pre></td></tr></table></figure><h2 id="方法3：使用alpha选项添加alpha通道"><a href="#方法3：使用alpha选项添加alpha通道" class="headerlink" title="方法3：使用alpha选项添加alpha通道"></a>方法3：使用alpha选项添加alpha通道</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.png -vf <span class="string">&quot;format=rgba,alphaextract,format=gray,lut=a=val*0.3[alpha];[0]format=rgba[color];[color][alpha]alphamerge&quot;</span> output.png</span><br></pre></td></tr></table></figure><h2 id="方法4：为不同格式的图片添加alpha通道"><a href="#方法4：为不同格式的图片添加alpha通道" class="headerlink" title="方法4：为不同格式的图片添加alpha通道"></a>方法4：为不同格式的图片添加alpha通道</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对于JPG等没有alpha通道的格式同样适用</span></span><br><span class="line">ffmpeg -i input.jpg -vf <span class="string">&quot;format=rgba,colorchannelmixer=aa=0.3&quot;</span> output.png</span><br></pre></td></tr></table></figure><h2 id="方法5：使用colorkey创建alpha通道（适合纯色背景）"><a href="#方法5：使用colorkey创建alpha通道（适合纯色背景）" class="headerlink" title="方法5：使用colorkey创建alpha通道（适合纯色背景）"></a>方法5：使用colorkey创建alpha通道（适合纯色背景）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果原图有纯色背景，可以先去除背景色</span></span><br><span class="line">ffmpeg -i input.png -vf <span class="string">&quot;colorkey=0xFFFFFF:0.1:0.5,format=rgba,colorchannelmixer=aa=0.3&quot;</span> output.png</span><br></pre></td></tr></table></figure><h2 id="关键参数说明："><a href="#关键参数说明：" class="headerlink" title="关键参数说明："></a>关键参数说明：</h2><ul><li><code>format=rgba</code>：将图像转换为包含alpha通道的RGBA格式</li><li>如果原图是RGB格式，这一步会自动添加完全不透明的alpha通道</li><li>然后<code>colorchannelmixer=aa=0.3</code>将alpha值设置为30%</li></ul><h2 id="推荐命令："><a href="#推荐命令：" class="headerlink" title="推荐命令："></a>推荐命令：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.png -vf <span class="string">&quot;format=rgba,colorchannelmixer=aa=0.3&quot;</span> output.png</span><br></pre></td></tr></table></figure><p>这个命令会：</p><ol><li>将图像转换为RGBA格式（自动添加alpha通道）</li><li>设置alpha通道值为0.3（30%透明度）</li><li>输出为包含透明度的PNG文件</li></ol><p>处理完成后，建议用图像查看器检查透明度效果是否符合预期。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;如果原图片没有alpha通道，你需要先添加alpha通道，然后设置透明度。以下是几种方法：&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://qbmzc.github.io/categories/Linux/"/>
    
    
    <category term="ffmpeg" scheme="https://qbmzc.github.io/tags/ffmpeg/"/>
    
  </entry>
  
  <entry>
    <title>替换wps配置文件</title>
    <link href="https://qbmzc.github.io/2025/09/26/2025/09/261010/"/>
    <id>https://qbmzc.github.io/2025/09/26/2025/09/261010/</id>
    <published>2025-09-25T16:00:00.000Z</published>
    <updated>2025-11-21T06:36:31.567Z</updated>
    
    <content type="html"><![CDATA[<p>替换wps配置文件</p><span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>wps转换pdf时每次都会记录打开的文件到最近历史中,历史文件记录在配置文件中<br>随着文件越来越多,配置文件也会越来越大,造成wps打开过慢.</p><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>解决wps打开过慢的问题</p><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>因为会每次写入配置文件,那么在每次任务完成之后,还原配置文件即可</p><p>而且wps每次写入文件也是写入到临时文件,完成之后使用临时文件替换原文件.</p><h2 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h2><ol><li>复制一份原始文件到指定目录</li><li>任务完成之后,将原始文件复制到配置文件夹覆盖</li></ol><h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.copy(Paths.get(FIXED_CONFIG_FILE_PATH), Paths.get(CONFIG_FILE_PATH), StandardCopyOption.REPLACE_EXISTING);</span><br></pre></td></tr></table></figure><h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2025-09-17 10:45:54.627  INFO [TID: N/A] --- [enerContainer-1] c.t.c.s.i.Wps2Pdf                        : convert time:1647  ms : &#123;span_id=7a1673d083423be1, trace_flags=01, trace_id=320f6db02f9b81d609aa2a5b0ec5ae08&#125;</span><br><span class="line">2025-09-17 10:45:54.627  INFO [TID: N/A] --- [enerContainer-1] c.t.c.u.RecentFilesCleaner               : 还原配置文件 : &#123;span_id=7a1673d083423be1, trace_flags=01, trace_id=320f6db02f9b81d609aa2a5b0ec5ae08&#125;</span><br></pre></td></tr></table></figure><h2 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.taimei.convert.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.StandardCopyOption;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RecentFilesCleaner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIG_FILE_PATH</span> <span class="operator">=</span> <span class="string">&quot;/root/.config/Kingsoft/Office.conf&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIXED_CONFIG_FILE_PATH</span> <span class="operator">=</span> <span class="string">&quot;/opt/Office.conf&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(RecentFilesCleaner.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    public static void main(String[] args) &#123;</span></span><br><span class="line"><span class="comment">//        String filePath = System.getProperty(&quot;user.dir&quot;) + File.separator + configFilePath;</span></span><br><span class="line"><span class="comment">//        String filePath = &quot;/Users/cong/IdeaProjects/new-doc-convert/Office.conf&quot;;</span></span><br><span class="line"><span class="comment">//        long start = System.currentTimeMillis();</span></span><br><span class="line"><span class="comment">//        clean(filePath);</span></span><br><span class="line"><span class="comment">//        long end = System.currentTimeMillis();</span></span><br><span class="line"><span class="comment">//        System.out.println(end - start);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 检查文件是否存在</span></span><br><span class="line">        LOGGER.info(<span class="string">&quot;配置文件: &#123;&#125;&quot;</span>, CONFIG_FILE_PATH);</span><br><span class="line">        <span class="type">File</span> <span class="variable">configFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(CONFIG_FILE_PATH);</span><br><span class="line">        <span class="keyword">if</span> (!configFile.exists()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;配置文件不存在: &#123;&#125;&quot;</span>, CONFIG_FILE_PATH);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 读取配置文件</span></span><br><span class="line">            List&lt;String&gt; fileContent = Files.readAllLines(configFile.toPath());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 提取路径并更新文件内容</span></span><br><span class="line">            List&lt;String&gt; extractedPaths = extractPaths(fileContent);</span><br><span class="line">            updateFileSafely(CONFIG_FILE_PATH, fileContent);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 删除提取的文件</span></span><br><span class="line"><span class="comment">//            deleteFiles(extractedPaths);</span></span><br><span class="line"></span><br><span class="line">            LOGGER.info(<span class="string">&quot;文件及记录删除完成！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">&quot;操作失败: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提取路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">extractPaths</span><span class="params">(List&lt;String&gt; lines)</span> &#123;</span><br><span class="line">        List&lt;String&gt; paths = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;^(wpp|et|wps)\\\\RecentFiles\\\\.*[=:](.+)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Iterator&lt;String&gt; iterator = lines.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">            <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> pattern.matcher(line);</span><br><span class="line">            <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">                paths.add(matcher.group(<span class="number">2</span>).trim());</span><br><span class="line">                iterator.remove(); <span class="comment">// 从内容中移除匹配的行</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOGGER.info(<span class="string">&quot;提取的路径：&#123;&#125;&quot;</span>, paths);</span><br><span class="line">        <span class="keyword">return</span> paths;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除文件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deleteFiles</span><span class="params">(List&lt;String&gt; paths)</span> &#123;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;正在删除文件...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String path : paths) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Path</span> <span class="variable">decodedPath</span> <span class="operator">=</span> Paths.get(path);</span><br><span class="line">                <span class="keyword">if</span> (decodedPath.toFile().exists()) &#123;</span><br><span class="line">                    Files.deleteIfExists(decodedPath);</span><br><span class="line">                    LOGGER.info(<span class="string">&quot;已删除：&#123;&#125;&quot;</span>, decodedPath);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOGGER.info(<span class="string">&quot;路径不存在：&#123;&#125;&quot;</span>, decodedPath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                LOGGER.info(<span class="string">&quot;无法删除文件: &#123;&#125; - &#123;&#125;&quot;</span>, path, e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新配置文件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updateConfigFile</span><span class="params">(File configFile, List&lt;String&gt; updatedContent)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;正在更新配置文件...&quot;</span>);</span><br><span class="line">        Files.write(configFile.toPath(), updatedContent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用临时文件安全更新配置文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> originalFilePath 原文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newContent       新内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否更新成功</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 如果发生 IO 错误</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">updateFileSafely</span><span class="params">(String originalFilePath, List&lt;String&gt; newContent)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">originalPath</span> <span class="operator">=</span> Paths.get(originalFilePath);</span><br><span class="line">        <span class="type">Path</span> <span class="variable">tempPath</span> <span class="operator">=</span> Paths.get(originalFilePath + <span class="string">&quot;.tmp&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入临时文件</span></span><br><span class="line">        Files.write(tempPath, newContent);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 替换原文件</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.move(tempPath, originalPath, StandardCopyOption.REPLACE_EXISTING);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// 删除临时文件</span></span><br><span class="line">            Files.deleteIfExists(tempPath);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直接替换文件</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">replaceFileSafely</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(FIXED_CONFIG_FILE_PATH);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            <span class="comment">// 文件不存在</span></span><br><span class="line">            LOGGER.warn(<span class="string">&quot;固定配置文件不存在 &#123;&#125;&quot;</span>, FIXED_CONFIG_FILE_PATH);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 替换原文件</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;还原配置文件&quot;</span>);</span><br><span class="line">            Files.copy(Paths.get(FIXED_CONFIG_FILE_PATH), Paths.get(CONFIG_FILE_PATH), StandardCopyOption.REPLACE_EXISTING);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;文件覆盖失败,请手动替换&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="配置文件Office-conf"><a href="#配置文件Office-conf" class="headerlink" title="配置文件Office.conf"></a><a href="https://gist.github.com/qbmzc/70e1874e2998e3487b768f1197394cd0">配置文件<code>Office.conf</code></a></h2><script src="https://gist.github.com/qbmzc/70e1874e2998e3487b768f1197394cd0.js"></script><p>[6.0]<br>common\WindowCount&#x3D;5<br>wps\Application%20Settings\AutoRecoverAppInfo&#x3D;<br>wps\Application%20Settings\BackupSuccess&#x3D;1<br>wps\Application%20Settings\RestartAppInfo&#x3D;11552<br>wps\Application%20Settings\UpdateRecoverCheckTag&#x3D;true<br>common\infoGUID&#x3D;{92F3D667-1E3B-31A5-D123-4664AFFE8F77}<br>common\lastwpsact&#x3D;1737535769638<br>common\AcceptedEULA&#x3D;true<br>common\Backup\AutoRecoverFilePath&#x3D;&#x2F;root&#x2F;.local&#x2F;share&#x2F;Kingsoft&#x2F;office6&#x2F;data&#x2F;backup<br>common\Backup\BackupInitMode&#x3D;0<br>common\Backup\EnableBackup&#x3D;1<br>common\Backup\EnableIncBackup&#x3D;1<br>common\Backup\EnableTimeBackup&#x3D;0<br>common\Backup\TimeBackupInterval&#x3D;1<br>common\LastClearBKTime&#x3D;2025-01-22 10:50:24<br>common\UserInfo\AccountId&#x3D;<br>common\UserInfo\AccountInitials&#x3D;<br>common\UserInfo\AccountName&#x3D;<br>common\UserInfo\KSOFirstStartFlag&#x3D;101<br>plugins\GrabScreen\HideWhileGrabbingScreen&#x3D;false<br>plugins\officespace\RoamingStyleIndex&#x3D;2<br>plugins\officespace\tempfiles&#x3D;<br>plugins\protecteyes\wps\nightmodealpha&#x3D;120<br>plugins\protecteyes\wps\type&#x3D;0<br>plugins\workarea\ActivePid&#x3D;0<br>wps\Application%20Settings\DocumentSaveAsMaintainCompatibility&#x3D;0<br>wps\Application%20Settings\PrintHiddenText&#x3D;0<br>wps\uifile&#x3D;res&#x2F;wpsongmani.kui<br>wps\wpsongmani\TaskPanelSize&#x3D;@Size(0 0)<br>wps\wpsongmani\ToolBarStates&#x3D;@ByteArray(\0\0\0\xff\0\0\0\0\xfd\0\0\0\x1\0\0\0\x1\0\0\0\0\0\0\0\0\xfc\x1\0\0\0\x1\xfb\0\0\0&amp;\0K\0x\0T\0\x61\0s\0k\0P\0\x61\0n\0\x65\0\x43\0o\0n\0t\0\x61\0i\0n\0\x65\0r\0\0\0\0\0\xff\xff\xff\xff\0\0\0\x1e\0\xff\xff\xff\0\0\b\0\0\0\x4\t\0\0\0\x4\0\0\0\x4\0\0\0\b\0\0\0\b\xfc\0\0\0\0)<br>plugins\kstartpage\officenav_new_v1\seqEntry\CommonEntrys\newfromtemplate&#x3D;1<br>plugins\protecteyes\wps\shownightmode&#x3D;0<br>wps\Application%20Settings\PrintFieldCodes&#x3D;0<br>plugins\kstartpage\officenav_new_v1\seqEntry\CommonEntrys\openfiledialog&#x3D;2<br>wps\Application%20Settings\PrintDrawingObjects&#x3D;1<br>plugins\kstartpage\officenav_new_v1\seqEntry\CommonEntrys\filelist_noref&#x3D;3<br>wps\Application%20Settings\UpdateFieldsAtPrint&#x3D;0<br>plugins\kstartpage\officenav_new_v1\seqEntry\CommonEntrys\companymanage&#x3D;4<br>wps\Application%20Settings\UpdateLinksAtPrint&#x3D;0<br>plugins\kstartpage\officenav_new_v1\seqEntry\CommonEntrys\separator&#x3D;5<br>wps\Application%20Settings\PrintReverse&#x3D;0<br>plugins\kstartpage\officenav_new_v1\seqEntry\AppcenterEntrys\docershop&#x3D;0<br>wps\Application%20Settings\DocumentsPath&#x3D;&#x2F;root&#x2F;Documents<br>plugins\kstartpage\officenav_new_v1\seqEntry\AppcenterEntrys\kpromeeducourse&#x3D;1<br>wps\Application%20Settings\UserTemplatePath&#x3D;&#x2F;root&#x2F;.local&#x2F;share&#x2F;Kingsoft&#x2F;office6&#x2F;templates&#x2F;wps&#x2F;en_US<br>plugins\kstartpage\officenav_new_v1\seqEntry\AppcenterEntrys\kpromecompanyintro&#x3D;2<br>wps\Application%20Settings\ReplaceSelection&#x3D;1<br>plugins\kstartpage\officenav_new_v1\seqEntry\AppcenterEntrys\konlinemeeting&#x3D;3<br>wps\Application%20Settings\AllowDragAndDrop&#x3D;1<br>plugins\kstartpage\officenav_new_v1\seqEntry\AppcenterEntrys\docerchuangkit&#x3D;4<br>wps\Application%20Settings\TabIndentKey&#x3D;1<br>plugins\kstartpage\officenav_new_v1\seqEntry\AppcenterEntrys\mywallet&#x3D;5<br>wps\Application%20Settings\DefaultHighlightColor&#x3D;65535<br>wps\Application%20Settings\DisplayGridLines&#x3D;0<br>wps\Application%20Settings\MapPaperSize&#x3D;1<br>wps\Application%20Settings\CommentsColor&#x3D;-16777216<br>wps\Application%20Settings\CtrlClickHyperlinkToOpen&#x3D;1<br>wps\Application%20Settings\UseCharacterUnit&#x3D;1<br>wps\Application%20Settings\UserName&#x3D;<br>wps\Application%20Settings\UserInitials&#x3D;<br>wps\Application%20Settings\UserAddress&#x3D;<br>wps\Application%20Settings\PrintEvenPagesInAscendingOrder&#x3D;1<br>wps\Application%20Settings\PrintOddPagesInAscendingOrder&#x3D;0<br>wps\Application%20Settings\DisplayStatusBar&#x3D;1<br>wps\Application%20Settings\DisplayTaskPaneAtStartup&#x3D;0<br>wps\Application%20Settings\DisplayRecentFiles&#x3D;1<br>wps\Application%20Settings\DefaultSaveFormat&#x3D;MSWORD12<br>wps\Application%20Settings\BookmarksHidden&#x3D;0<br>wps\Application%20Settings\BrowserTarget&#x3D;1<br>wps\Application%20Settings\ShowWhat&#x3D;73<br>wps\Application%20Settings\ShowEscChar&#x3D;0<br>wps\Application%20Settings\FieldShadingShow&#x3D;2<br>wps\Application%20Settings\ShowPageBorder&#x3D;0<br>wps\Application%20Settings\TOCTabLeader&#x3D;1<br>wps\Application%20Settings\SnapToGrid&#x3D;0<br>wps\Application%20Settings\SnapToOtherShape&#x3D;0<br>wps\Application%20Settings\DisplayRulers&#x3D;0<br>wps\Application%20Settings\DisplayVerticalRuler&#x3D;1<br>wps\Application%20Settings\PreviewZoom&#x3D;100<br>wps\Application%20Settings\PreviewPageFit&#x3D;0<br>wps\Application%20Settings\PreviewPageColumns&#x3D;99<br>wps\Application%20Settings\PreviewPageRows&#x3D;1<br>wps\Application%20Settings\BlueScreen&#x3D;0<br>wps\Application%20Settings\BlueScreenBkColor&#x3D;4278190208<br>wps\Application%20Settings\BlueScreenFrColor&#x3D;4294967295<br>wps\Application%20Settings\InsertedTextMark&#x3D;3<br>wps\Application%20Settings\InsertedTextColor&#x3D;-16777216<br>wps\Application%20Settings\DeletedTextMark&#x3D;1<br>wps\Application%20Settings\DeletedTextColor&#x3D;-16777216<br>wps\Application%20Settings\RevisedPropertiesMark&#x3D;0<br>wps\Application%20Settings\RevisedPropertiesColor&#x3D;-16777216<br>wps\Application%20Settings\RevisedLinesMark&#x3D;3<br>wps\Application%20Settings\RevisedLinesColor&#x3D;0<br>wps\Application%20Settings\RevisionsBalloonPrintOrientation&#x3D;1<br>wps\Application%20Settings\RevisionsBalloonTitle&#x3D;2<br>wps\Application%20Settings\RevisionMode&#x3D;0<br>wps\Application%20Settings\BalloonWidthAbs&#x3D;1<br>wps\Application%20Settings\BalloonWidth&#x3D;5329<br>wps\Application%20Settings\BalloonSide&#x3D;1<br>wps\Application%20Settings\BalloonShowConnectLine&#x3D;1<br>wps\Application%20Settings\DefaultTemplateFile&#x3D;&#x2F;root&#x2F;.local&#x2F;share&#x2F;Kingsoft&#x2F;office6&#x2F;templates&#x2F;wps&#x2F;en_US&#x2F;Normal.dotm<br>wps\Application%20Settings\CreateBackupOnFirstSave&#x3D;1<br>wps\Application%20Settings\ViewPdfAfterExport&#x3D;0<br>wps\Application%20Settings\ExportTOC&#x3D;1<br>wps\Application%20Settings\ExportHyperlinks&#x3D;1<br>wps\Application%20Settings\ExportCommentsMode&#x3D;3<br>wps\Application%20Settings\ExportFootnotes&#x3D;1<br>wps\Application%20Settings\ExportEndnotes&#x3D;1<br>wps\Application%20Settings\ExportSummaryInfo&#x3D;1<br>wps\Application%20Settings\PdfPrintRight&#x3D;0<br>wps\Application%20Settings\PdfEditRight&#x3D;0<br>wps\Application%20Settings\PdfRights&#x3D;0<br>wps\Application%20Settings\ExportTitleStyle&#x3D;1<br>wps\Application%20Settings\ExportBuildinStyle&#x3D;0<br>wps\Application%20Settings\ExportCustomStyle&#x3D;0<br>wps\Application%20Settings\BuildinStyleLevel&#x3D;-1<br>wps\Application%20Settings\CustomStyleLevel&#x3D;-1<br>wps\Application%20Settings\ConvertBookmark&#x3D;0<br>wps\Application%20Settings\ConvertBookmarkLevel&#x3D;-1<br>wps\Application%20Settings\DisplayScreenTips&#x3D;1<br>wps\Application%20Settings\NewFileBehavior&#x3D;0<br>wps\Application%20Settings\TCSCDirection&#x3D;0<br>wps\Application%20Settings\TCSCTransUnit&#x3D;1<br>wps\Application%20Settings\TCSCUseVariants&#x3D;0<br>wps\Application%20Settings\SplChkIgnoreUppercase&#x3D;1<br>wps\Application%20Settings\SplChkIgnoreMixedDigits&#x3D;1<br>wps\Application%20Settings\SplChkSuggestFromMainDictionaryOnly&#x3D;1<br>wps\Application%20Settings\SplChkSuggestSpellingCorrections&#x3D;1<br>wps\Application%20Settings\SaveInterval&#x3D;60000<br>wps\Application%20Settings\NewDocumentDocmapCared&#x3D;0<br>wps\Application%20Settings\NewDocumentDocmapDrawLine&#x3D;1<br>wps\Application%20Settings\NewDocumentDocmapShowBmk&#x3D;0<br>wps\Application%20Settings\DisplayPageBoundaries&#x3D;1<br>wps\Application%20Settings\AllowClickAndType&#x3D;1<br>wps\Application%20Settings\DiscernPerson&#x3D;0<br>wps\Application%20Settings\DiscernLocation&#x3D;0<br>wps\Application%20Settings\MatchFuzzyCase&#x3D;1<br>wps\Application%20Settings\MatchFuzzyByte&#x3D;1<br>wps\Application%20Settings\MatchFuzzyHiragana&#x3D;1<br>wps\Application%20Settings\MatchFuzzySmallKana&#x3D;1<br>wps\Application%20Settings\MatchFuzzyDash&#x3D;1<br>wps\Application%20Settings\MatchFuzzyIterationMark&#x3D;1<br>wps\Application%20Settings\MatchFuzzyKanji&#x3D;1<br>wps\Application%20Settings\MatchFuzzyOldKana&#x3D;1<br>wps\Application%20Settings\MatchFuzzyProlongedSoundMark&#x3D;1<br>wps\Application%20Settings\MatchFuzzyDZ&#x3D;1<br>wps\Application%20Settings\MatchFuzzyBV&#x3D;1<br>wps\Application%20Settings\MatchFuzzyTC&#x3D;1<br>wps\Application%20Settings\MatchFuzzyHF&#x3D;1<br>wps\Application%20Settings\MatchFuzzyZJ&#x3D;1<br>wps\Application%20Settings\MatchFuzzyAY&#x3D;1<br>wps\Application%20Settings\MatchFuzzyKiKu&#x3D;1<br>wps\Application%20Settings\MatchFuzzyPunctuation&#x3D;1<br>wps\Application%20Settings\MatchFuzzySpace&#x3D;1<br>wps\Application%20Settings\AutoFormatApplyLists&#x3D;1<br>wps\Application%20Settings\CompareSideBySide_Wnd1_LeftTop&#x3D;0<br>wps\Application%20Settings\CompareSideBySide_Wnd1_WidthHeight&#x3D;0<br>wps\Application%20Settings\CompareSideBySide_Wnd2_LeftTop&#x3D;0<br>wps\Application%20Settings\CompareSideBySide_Wnd2_WidthHeight&#x3D;0<br>wps\Application%20Settings\AutoCorrect_CorrectSentenceCaps&#x3D;0<br>wps\Application%20Settings\AutoCorrect_CorrectCapsLock&#x3D;0<br>wps\Application%20Settings\DblClk_ToggleHeaderFooterView&#x3D;1<br>wps\Application%20Settings\AutoCorrect_CorrectDays&#x3D;0<br>wps\Application%20Settings\AutoFormatAsYouTypeReplaceOrdinals&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeReplaceHyperlinks&#x3D;1<br>wps\Application%20Settings\PasteType&#x3D;0<br>wps\Application%20Settings\AutoApplyAsYouTypeAdjustWordWrap&#x3D;1<br>wps\Application%20Settings\ShowSpellingIgnoredWords&#x3D;0<br>wps\Application%20Settings\CheckSpellingAsYouType&#x3D;0<br>wps\Application%20Settings\CheckSpellingIgnoreInternetAndFileAddresses&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeApplyNumberedLists&#x3D;1<br>wps\Application%20Settings\DisplayPasteOptions&#x3D;1<br>wps\Application%20Settings\PasteFormatMode&#x3D;16<br>wps\Application%20Settings\HideTaskPanelAfterDocumentOpen&#x3D;1<br>wps\Application%20Settings\NewDocumentDocmapShow&#x3D;0<br>wps\Application%20Settings\RecentPrintMode&#x3D;0<br>wps\Application%20Settings\SmartParaSelection&#x3D;1<br>wps\Application%20Settings\AutoCircleNumber&#x3D;1<br>wps\Application%20Settings\DocumentTab&#x3D;29<br>wps\Application%20Settings\ShowTableAdjustLabel&#x3D;1<br>wps\Application%20Settings\ShowParaAdjustButton&#x3D;1<br>wps\Application%20Settings\StartupShowNavigationPane&#x3D;0<br>wps\Application%20Settings\AutoFormatAsYouTypeReplaceQuotes&#x3D;1<br>wps\Application%20Settings\CheckGrammarWithSpelling&#x3D;1<br>wps\Application%20Settings\ShowMarkupOpenSave&#x3D;1<br>wps\Application%20Settings\CheckGrammarAsYouType&#x3D;1<br>wps\Application%20Settings\SmartCutPaste&#x3D;0<br>wps\Application%20Settings\UserCaptionLabels&#x3D;<br>wps\Application%20Settings\EnableBackup&#x3D;1<br>wps\Application%20Settings\PageNumVisible&#x3D;1<br>wps\Application%20Settings\PageAreaVisible&#x3D;1<br>wps\Application%20Settings\SectionVisible&#x3D;1<br>wps\Application%20Settings\LineNumVisible&#x3D;1<br>wps\Application%20Settings\ColumnVisible&#x3D;1<br>wps\Application%20Settings\WordCountVisible&#x3D;1<br>wps\Application%20Settings\OvertypeVisible&#x3D;0<br>wps\Application%20Settings\SpellCheckVisible&#x3D;1<br>wps\Application%20Settings\UnitVisible&#x3D;0<br>wps\Application%20Settings\ViewShortcutVisible&#x3D;1<br>wps\Application%20Settings\ZoomSliderVisible&#x3D;1<br>wps\Application%20Settings\ZoomRatioVisible&#x3D;1<br>wps\Application%20Settings\TrackVisible&#x3D;0<br>wps\Application%20Settings\ButtonFieldClicks&#x3D;2<br>wps\Application%20Settings\PictureWrapType&#x3D;0<br>wps\Application%20Settings\CheckHangulEndings&#x3D;1<br>wps\Application%20Settings\AutoCorrect_CorrectInitialCaps&#x3D;1<br>wps\Application%20Settings\AutoCorrect_CorrectKeyboardSetting&#x3D;0<br>wps\Application%20Settings\AutoCorrect_CorrectTableCells&#x3D;1<br>wps\Application%20Settings\AutoCorrect_DisplayAutoCorrectOptions&#x3D;1<br>wps\Application%20Settings\AutoCorrect_ReplaceText&#x3D;1<br>wps\Application%20Settings\AutoCorrect_ReplaceTextFromSpellingChecker&#x3D;1<br>wps\Application%20Settings\AutoCorrect_FirstLetterAutoAdd&#x3D;1<br>wps\Application%20Settings\AutoCorrect_TwoInitialCapsAutoAdd&#x3D;1<br>wps\Application%20Settings\AutoCorrect_CorrectHangulAndAlphabet&#x3D;0<br>wps\Application%20Settings\AutoCorrect_HangulAndAlphabetAutoAdd&#x3D;1<br>wps\Application%20Settings\AutoCorrect_OtherCorrectionsAutoAdd&#x3D;1<br>wps\Application%20Settings\WPHelp&#x3D;0<br>wps\Application%20Settings\WPDocNavKeys&#x3D;0<br>wps\Application%20Settings\Pagination&#x3D;0<br>wps\Application%20Settings\EnableSound&#x3D;0<br>wps\Application%20Settings\ConfirmConversions&#x3D;0<br>wps\Application%20Settings\UpdateLinksAtOpen&#x3D;1<br>wps\Application%20Settings\SendMailAttach&#x3D;1<br>wps\Application%20Settings\ShortMenuNames&#x3D;0<br>wps\Application%20Settings\RTFInClipboard&#x3D;1<br>wps\Application%20Settings\PrintProperties&#x3D;0<br>wps\Application%20Settings\EnvelopeFeederInstalled&#x3D;0<br>wps\Application%20Settings\PrintBackground&#x3D;1<br>wps\Application%20Settings\DefaultTray&#x3D;<br>wps\Application%20Settings\DefaultTrayID&#x3D;0<br>wps\Application%20Settings\AllowFastSave&#x3D;1<br>wps\Application%20Settings\SavePropertiesPrompt&#x3D;0<br>wps\Application%20Settings\SaveNormalPrompt&#x3D;0<br>wps\Application%20Settings\AutoWordSelection&#x3D;0<br>wps\Application%20Settings\INSKeyForPaste&#x3D;0<br>wps\Application%20Settings\PictureEditor&#x3D;<br>wps\Application%20Settings\AnimateScreenMovements&#x3D;1<br>wps\Application%20Settings\VirusProtection&#x3D;0<br>wps\Application%20Settings\SnapToShapes&#x3D;0<br>wps\Application%20Settings\InlineConversion&#x3D;1<br>wps\Application%20Settings\IMEAutomaticControl&#x3D;1<br>wps\Application%20Settings\AutoFormatApplyHeadings&#x3D;1<br>wps\Application%20Settings\AutoFormatApplyBulletedLists&#x3D;1<br>wps\Application%20Settings\AutoFormatApplyOtherParas&#x3D;1<br>wps\Application%20Settings\AutoFormatReplaceQuotes&#x3D;1<br>wps\Application%20Settings\AutoFormatReplaceSymbols&#x3D;1<br>wps\Application%20Settings\AutoFormatReplaceOrdinals&#x3D;1<br>wps\Application%20Settings\AutoFormatReplaceFractions&#x3D;0<br>wps\Application%20Settings\AutoFormatReplacePlainTextEmphasis&#x3D;1<br>wps\Application%20Settings\AutoFormatPreserveStyles&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeApplyHeadings&#x3D;0<br>wps\Application%20Settings\AutoFormatAsYouTypeApplyBorders&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeApplyBulletedLists&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeReplaceSymbols&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeReplaceFractions&#x3D;0<br>wps\Application%20Settings\AutoFormatAsYouTypeReplacePlainTextEmphasis&#x3D;0<br>wps\Application%20Settings\AutoFormatAsYouTypeFormatListItemBeginning&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeDefineStyles&#x3D;0<br>wps\Application%20Settings\AutoFormatPlainTextWordMail&#x3D;1<br>wps\Application%20Settings\AutoFormatReplaceHyperlinks&#x3D;1<br>wps\Application%20Settings\ShowReadabilityStatistics&#x3D;0<br>wps\Application%20Settings\PrintDraft&#x3D;0<br>wps\Application%20Settings\AutoFormatAsYouTypeApplyTables&#x3D;1<br>wps\Application%20Settings\AutoFormatApplyFirstIndents&#x3D;1<br>wps\Application%20Settings\AutoFormatMatchParentheses&#x3D;1<br>wps\Application%20Settings\AutoFormatReplaceFarEastDashes&#x3D;1<br>wps\Application%20Settings\AutoFormatDeleteAutoSpaces&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeApplyFirstIndents&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeApplyDates&#x3D;0<br>wps\Application%20Settings\AutoFormatAsYouTypeApplyClosings&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeMatchParentheses&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeReplaceFarEastDashes&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeDeleteAutoSpaces&#x3D;0<br>wps\Application%20Settings\AutoFormatAsYouTypeInsertClosings&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeAutoLetterWizard&#x3D;1<br>wps\Application%20Settings\AutoFormatAsYouTypeInsertOvers&#x3D;1<br>wps\Application%20Settings\ApplyFarEastFontsToAscii&#x3D;1<br>wps\Application%20Settings\ConvertHighAnsiToFarEast&#x3D;1<br>wps\Application%20Settings\EnableMisusedWordsDictionary&#x3D;1<br>wps\Application%20Settings\AllowCombinedAuxiliaryForms&#x3D;1<br>wps\Application%20Settings\HangulHanjaFastConversion&#x3D;1<br>wps\Application%20Settings\EnableHangulHanjaRecentOrdering&#x3D;1<br>wps\Application%20Settings\MultipleWordConversionsMode&#x3D;0<br>wps\Application%20Settings\AllowCompoundNounProcessing&#x3D;1<br>wps\Application%20Settings\AutoKeyboardSwitching&#x3D;1<br>wps\Application%20Settings\ShowDiacritics&#x3D;1<br>wps\Application%20Settings\ShowControlCharacters&#x3D;1<br>wps\Application%20Settings\AddControlCharacters&#x3D;1<br>wps\Application%20Settings\AddBiDirectionalMarksWhenSavingTextFile&#x3D;1<br>wps\Application%20Settings\StrictInitialAlefHamza&#x3D;1<br>wps\Application%20Settings\StrictFinalYaa&#x3D;1<br>wps\Application%20Settings\UseGermanSpellingReform&#x3D;1<br>wps\Application%20Settings\AddHebDoubleQuote&#x3D;1<br>wps\Application%20Settings\UseDiffDiacColor&#x3D;1<br>wps\Application%20Settings\DiacriticColorVal&#x3D;-16777216<br>wps\Application%20Settings\OptimizeForWord97byDefault&#x3D;1<br>wps\Application%20Settings\LocalNetworkFile&#x3D;1<br>wps\Application%20Settings\TypeNReplace&#x3D;1<br>wps\Application%20Settings\SequenceCheck&#x3D;1<br>wps\Application%20Settings\BackgroundOpen&#x3D;1<br>wps\Application%20Settings\DisableFeaturesbyDefault&#x3D;1<br>wps\Application%20Settings\PasteAdjustWordSpacing&#x3D;1<br>wps\Application%20Settings\PasteAdjustParagraphSpacing&#x3D;1<br>wps\Application%20Settings\PasteAdjustTableFormatting&#x3D;1<br>wps\Application%20Settings\PasteSmartStyleBehavior&#x3D;1<br>wps\Application%20Settings\PasteMergeFromPPT&#x3D;1<br>wps\Application%20Settings\PasteMergeFromXL&#x3D;1<br>wps\Application%20Settings\PasteSmartCutPaste&#x3D;1<br>wps\Application%20Settings\PromptUpdateStyle&#x3D;1<br>wps\Application%20Settings\LabelSmartTags&#x3D;0<br>wps\Application%20Settings\DisplaySmartTagButtons&#x3D;1<br>wps\Application%20Settings\WarnBeforeSavingPrintingSendingMarkup&#x3D;1<br>wps\Application%20Settings\StoreRSIDOnSave&#x3D;1<br>wps\Application%20Settings\ShowFormatError&#x3D;1<br>wps\Application%20Settings\FormatScanning&#x3D;1<br>wps\Application%20Settings\PasteMergeLists&#x3D;1<br>wps\Application%20Settings\AutoCreateNewDrawings&#x3D;1<br>wps\Application%20Settings\PrintXMLTag&#x3D;1<br>wps\Application%20Settings\PrintBackgrounds&#x3D;0<br>wps\Application%20Settings\AllowReadingMode&#x3D;1<br>wps\Application%20Settings\SmartCursoring&#x3D;1<br>wps\Application%20Settings\ShowSelectionFloaties&#x3D;1<br>wps\Application%20Settings\ShowMenuFloaties&#x3D;1<br>wps\Application%20Settings\ShowDevTools&#x3D;1<br>wps\Application%20Settings\EnableLivePreview&#x3D;1<br>wps\Application%20Settings\OMathAutoBuildUp&#x3D;1<br>wps\Application%20Settings\AlwaysUseClearType&#x3D;0<br>wps\Application%20Settings\PasteOptionKeepBulletsAndNumbers&#x3D;1<br>wps\Application%20Settings\INSKeyForOvertype&#x3D;1<br>wps\Application%20Settings\RepeatWord&#x3D;1<br>wps\Application%20Settings\ContextualSpeller&#x3D;1<br>wps\Application%20Settings\OMathCopyLF&#x3D;1<br>wps\Application%20Settings\UseNormalStyleForList&#x3D;0<br>wps\Application%20Settings\AllowOpenInDraftView&#x3D;0<br>wps\Application%20Settings\EnableLegacyIMEMode&#x3D;0<br>wps\Application%20Settings\DoNotPromptForConvert&#x3D;0<br>wps\Application%20Settings\PrecisePositioning&#x3D;0<br>wps\Application%20Settings\StrictTaaMarboota&#x3D;1<br>wps\Application%20Settings\StrictRussianE&#x3D;0<br>wps\Application%20Settings\UpdateFieldsWithTrackedChangesAtPrint&#x3D;1<br>wps\Application%20Settings\DisplayAlignmentGuides&#x3D;1<br>wps\Application%20Settings\PageAlignmentGuides&#x3D;1<br>wps\Application%20Settings\MarginAlignmentGuides&#x3D;1<br>wps\Application%20Settings\ParagraphAlignmentGuides&#x3D;1<br>wps\Application%20Settings\EnableLiveDrag&#x3D;1<br>wps\Application%20Settings\UseSubPixelPositioning&#x3D;1<br>wps\Application%20Settings\AlertIfNotDefault&#x3D;0<br>wps\Application%20Settings\EnableProofingToolsAdvertisement&#x3D;1<br>wps\Application%20Settings\PreferCloudSaveLocations&#x3D;1<br>wps\Application%20Settings\SkyDriveSignInOption&#x3D;1<br>wps\Application%20Settings\ExpandHeadingsOnOpen&#x3D;0<br>wps\Application%20Settings\UseLocalUserInfo&#x3D;0<br>wps\Application%20Settings\ArabicNumeral&#x3D;0<br>wps\Application%20Settings\MonthNames&#x3D;0<br>wps\Application%20Settings\CursorMovement&#x3D;0<br>wps\Application%20Settings\VisualSelection&#x3D;0<br>wps\Application%20Settings\HebrewMode&#x3D;0<br>wps\Application%20Settings\ArabicMode&#x3D;2<br>wps\Application%20Settings\InterpretHighAnsi&#x3D;2<br>wps\Application%20Settings\DisableFeaturesIntroducedAfterbyDefault&#x3D;-1<br>wps\Application%20Settings\DefaultTextEncoding&#x3D;936<br>wps\Application%20Settings\MoveToTextColor&#x3D;-1<br>wps\Application%20Settings\MoveFromTextColor&#x3D;-1<br>wps\Application%20Settings\PrintComments&#x3D;0<br>wps\Application%20Settings\CreateBackup&#x3D;0<br>wps\Application%20Settings\BackgroundSave&#x3D;0<br>wps\Application%20Settings\DefaultOpenFormat&#x3D;6<br>wps\Application%20Settings\AllowPixelUnits&#x3D;0<br>wps\Application%20Settings\AllowAccentedUppercase&#x3D;0<br>wps\Application%20Settings\AutoDeleteParaIndentOnAlignCenter&#x3D;0<br>wps\Application%20Settings\EmbedFontsRemind&#x3D;1<br>wps\Application%20Settings\DefaultTableSeparator&#x3D;<br>wps\Application%20Settings\IsUsingRecommendedBalloonWidth&#x3D;1<br>wps\Application%20Settings\MaxUndoStep&#x3D;128<br>wps\Application%20Settings\ShowMarkupAreaHighlight&#x3D;1<br>wps\Application%20Settings\ShowFontPreviewLabel&#x3D;1<br>wps\Application%20Settings\EmbedPrivateFonts&#x3D;0<br>wps\Application%20Settings\StyleAreaWidth&#x3D;0<br>wps\Application%20Settings\IndexTabLeader&#x3D;1<br>wps\Application%20Settings\ShowStylePreviews&#x3D;0<br>wps\Application%20Settings\RestrictLinkedStyles&#x3D;0<br>wps\Application%20Settings\OpenAttachmentsInFullScreen&#x3D;0<br>wps\Application%20Settings\CheckLanguage&#x3D;1<br>wps\Application%20Settings\DefaultLegalBlackline&#x3D;0<br>wps\Application%20Settings\DisplayAutoCompleteTips&#x3D;1<br>wps\Application%20Settings\MoveToTextMark&#x3D;2<br>wps\Application%20Settings\MoveFromTextMark&#x3D;6<br>wps\Application%20Settings\InsertedCellColor&#x3D;2<br>wps\Application%20Settings\DeletedCellColor&#x3D;1<br>wps\Application%20Settings\MergedCellColor&#x3D;3<br>wps\Application%20Settings\SplitCellColor&#x3D;5<br>wps\Application%20Settings\PasteFormatWithinDocument&#x3D;0<br>wps\Application%20Settings\PasteFormatBetweenDocuments&#x3D;0<br>wps\Application%20Settings\PasteFormatBetweenStyledDocuments&#x3D;3<br>wps\Application%20Settings\PasteFormatFromExternalSource&#x3D;0<br>wps\Application%20Settings\FrenchReform&#x3D;0<br>wps\Application%20Settings\SpanishMode&#x3D;0<br>wps\Application%20Settings\PortugalReform&#x3D;1<br>wps\Application%20Settings\BrazilReform&#x3D;2<br>wps\Application%20Settings\UpdateStyleListBehavior&#x3D;0<br>wps\Application%20Settings\StartupPath&#x3D;<br>wps\Application%20Settings\ReadingLayoutActualView&#x3D;1<br>wps\Application%20Settings\ReadingLayoutAllowMultiplePages&#x3D;1<br>wps\Application%20Settings\ReadingLayoutAllowEditing&#x3D;0<br>wps\Application%20Settings\ReadingLayoutTruncateMargins&#x3D;0<br>wps\Application%20Settings\ShowCropMarks&#x3D;1<br>wps\Application%20Settings\PageColor&#x3D;0<br>wps\Application%20Settings\ColumnWidth&#x3D;2<br>wps\Application%20Settings\WrapToWindowView&#x3D;0<br>wps\Application%20Settings\DraftView&#x3D;0<br>wps\Application%20Settings\EmbedFontsWhenNoRemind&#x3D;0<br>wps\Application%20Settings\OpCompareTables&#x3D;1<br>wps\Application%20Settings\OpCompareComments&#x3D;1<br>wps\Application%20Settings\OpCompareFootAndEndNotes&#x3D;1<br>wps\Application%20Settings\OpCompareTextBox&#x3D;1<br>wps\Application%20Settings\OpCompareCaseChange&#x3D;1<br>wps\Application%20Settings\OpCompareField&#x3D;1<br>wps\Application%20Settings\OpCompareBlankRegion&#x3D;1<br>wps\Application%20Settings\OpCompareLevel&#x3D;2<br>wps\Application%20Settings\OpCompareLocation&#x3D;3<br>wps\Application%20Settings\DisplayLeftScrollBar&#x3D;0<br>wps\Application%20Settings\ShowAnimation&#x3D;1<br>wps\Application%20Settings\ShowHyphens&#x3D;0<br>wps\Application%20Settings\AutoRecoverFilePath&#x3D;&#x2F;root&#x2F;.local&#x2F;share&#x2F;Kingsoft&#x2F;office6&#x2F;data&#x2F;backup<br>wps\Application%20Settings\ShowBalloonTitle&#x3D;15<br>wps\Application%20Settings\ShowWindowsInTaskbar&#x3D;0<br>wps\Application%20Settings\ShowXMLMarkup&#x3D;1<br>wps\Application%20Settings\XMLHideNamespaces&#x3D;0<br>wps\Application%20Settings\ShowSelectionMiniToolBar&#x3D;1<br>wps\Application%20Settings\ShowRightClickMiniToolBar&#x3D;1<br>wps\Application%20Settings\ShowTaskPane&#x3D;0<br>wps\Application%20Settings\ZoomOfFirstView&#x3D;100<br>wps\Application%20Settings\PageFitOfFirstView&#x3D;0<br>wps\Application%20Settings\PageColumnsOfFirstView&#x3D;99<br>wps\Application%20Settings\PageRowsOfFirstView&#x3D;1<br>wps\Application%20Settings\AutoCorrect_ReplaceAsYouType&#x3D;1<br>wps\Application%20Settings\PageIsMaxColumnsiPageFit&#x3D;0<br>wps\Application%20Settings\EnableAutoSave&#x3D;0<br>wps\Application%20Settings\ShowSourceDocumentsType&#x3D;3<br>wps\Application%20Settings\PrintHiddenUnderline&#x3D;1<br>wps\Application%20Settings\ShowDocumentField&#x3D;1<br>wps\Application%20Settings\InsertToDocFld&#x3D;1<br>wps\Application%20Settings\OfdViewOfdAfterExport&#x3D;0<br>wps\Application%20Settings\OfdExportFootnotes&#x3D;1<br>wps\Application%20Settings\OfdExportEndnote&#x3D;1<br>wps\Application%20Settings\OfdExportSummaryInfo&#x3D;1<br>wps\Application%20Settings\OfdExportHyperlinks&#x3D;1<br>wps\Application%20Settings\OfdConvertBookmark&#x3D;1<br>wps\Application%20Settings\OfdExportTitleStyle&#x3D;1<br>wps\Application%20Settings\OfdExportBuildinStyle&#x3D;0<br>wps\Application%20Settings\OfdExportCustomStyle&#x3D;0<br>wps\Application%20Settings\OfdExportCommentsMode&#x3D;3<br>wps\Application%20Settings\OfdRevisionMode&#x3D;1<br>wps\Application%20Settings\OfdRights&#x3D;0<br>wps\Application%20Settings\OfdServiceProvider&#x3D;0<br>wps\Application%20Settings\OfdUpdateFields&#x3D;0<br>wps\Application%20Settings\ShowEnterHeaderOrFooterTip&#x3D;1<br>wps\Application%20Settings\PrintBackgroundsEx&#x3D;0<br>wps\Application%20Settings\OfdEmbedFont&#x3D;1<br>wps\Application%20Settings\PagePositionVisible&#x3D;1<br>wps\Application%20Settings\ShowPlainWatermark&#x3D;0<br>wps\Application%20Settings\LastOpenFilePath&#x3D;<br>wps\Application%20Settings\SQLSecurityCheck&#x3D;1<br>wps\Application%20Settings\ShowCommentShading&#x3D;1<br>wps\Application%20Settings\OpenChineseSpellingCheck&#x3D;0<br>wps\Application%20Settings\ClickTheBoxToTick&#x3D;1<br>wps\Application%20Settings\ReadingDivision&#x3D;0<br>wps\Application%20Settings\ReadingZoom&#x3D;100<br>wps\Application%20Settings\ReadingBalloonWidthAbs&#x3D;1<br>wps\Application%20Settings\ReadingBalloonWidth&#x3D;5329<br>wps\Application%20Settings\HighQualityPrinting&#x3D;1<br>wps\Application%20Settings\NormalPageColumns&#x3D;3<br>wps\Application%20Settings\EnableMidBtnPaste&#x3D;0<br>wps\Application%20Settings\ForceAutoBackupEnabled&#x3D;1<br>wps\Application%20Settings\AutoBackupEnabled&#x3D;1<br>wps\Application%20Settings\OfdPreviewZoom&#x3D;100<br>wps\Application%20Settings\OpenAutoOfficialListSettings&#x3D;1<br>wps\Application%20Settings\OfdPreviewPageFit&#x3D;0<br>wps\Application%20Settings\OfdPreviewPageColumns&#x3D;99<br>wps\Application%20Settings\OfdPreviewPageRows&#x3D;1<br>wps\Application%20Settings\OfficialListLevel1FontName&#x3D;<br>wps\Application%20Settings\OfficialListLevel1FontSize&#x3D;-1<br>wps\Application%20Settings\OfficialListLevel2FontName&#x3D;<br>wps\Application%20Settings\OfficialListLevel2FontSize&#x3D;-1<br>wps\Application%20Settings\OfficialListLevel3FontName&#x3D;<br>wps\Application%20Settings\OfficialListLevel3FontSize&#x3D;-1<br>wps\Application%20Settings\OfficialListLevel4FontName&#x3D;<br>wps\Application%20Settings\OfficialListLevel4FontSize&#x3D;-1<br>wps\Application%20Settings\ShowNewOfficialDocumentDialog&#x3D;1<br>wps\Application%20Settings\OfficialSpecialWordsEnable&#x3D;1<br>wps\Application%20Settings\EmbedForceAutoBackupEnabled&#x3D;<br>wps\Application%20Settings\EmbedAutoBackupEnabled&#x3D;<br>wps\Application%20Settings\ShowSmartContentFileOpen&#x3D;0<br>wps\Application%20Settings\EnableIncBackup&#x3D;1<br>wps\Application%20Settings\BackupKeepCacheDays&#x3D;90<br>wps\Application%20Settings\IsShowPicCompressDlg&#x3D;1<br>wps\Application%20Settings\ProtectEyesBkColor&#x3D;4291619023<br>wps\Application%20Settings\AutoBackupVisible&#x3D;0<br>wps\Application%20Settings\OfdExportOleObject&#x3D;0<br>wps\Application%20Settings\OfdExportOriginOleObject&#x3D;0<br>common\loginSafeVersion&#x3D;true<br>plugins\officespace\netswitch_updatetime&#x3D;0<br>plugins\officespace\transformguide\withSrc&#x3D;0<br>plugins\wpsbox\DllExist&#x3D;true<br>plugins\DllPath&#x3D;&#x2F;opt&#x2F;kingsoft&#x2F;wps-office&#x2F;office6&#x2F;addons&#x2F;wpsbox&#x2F;libwpsbox.so<br>common\SymbolListOnTb\SymbolItem%200\DisplayChar&#x3D;\xff0b<br>et\Application%20Settings\AutoRecoverAppInfo&#x3D;<br>et\Application%20Settings\BackupSuccess&#x3D;1<br>et\Application%20Settings\DefaultDir&#x3D;&#x2F;root&#x2F;Documents<br>et\Application%20Settings\FmlNameBoxWidth&#x3D;150<br>et\Application%20Settings\RestartAppInfo&#x3D;0<br>et\Application%20Settings\UpdateRecoverCheckTag&#x3D;true<br>et\RecentFunction\RecentFunction&#x3D;”SUMIF;SIN;MAX;COUNT;IF;AVERAGE;SUM;”<br>et\etongmani\TaskPanelSize&#x3D;@Size(0 0)<br>et\etongmani\ToolBarStates&#x3D;@ByteArray(\0\0\0\xff\0\0\0\0\xfd\0\0\0\x1\0\0\0\x1\0\0\0\0\0\0\0\0\xfc\x1\0\0\0\x1\xfb\0\0\0&amp;\0K\0x\0T\0\x61\0s\0k\0P\0\x61\0n\0\x65\0\x43\0o\0n\0t\0\x61\0i\0n\0\x65\0r\0\0\0\0\0\xff\xff\xff\xff\0\0\0\x1e\0\xff\xff\xff\0\0\b\0\0\0\x4\n\0\0\0\x4\0\0\0\x4\0\0\0\b\0\0\0\b\xfc\0\0\0\0)<br>et\etongmani\taskpane\barTextShow_v2&#x3D;true<br>et\etongmani\taskpane\needRestore-v2&#x3D;false<br>et\uifile&#x3D;res&#x2F;etongmani.kui<br>plugins\konlinetaskpane\AIRecommend&#x3D;true<br>plugins\protecteyes\et\nightmodealpha&#x3D;190<br>plugins\protecteyes\et\type&#x3D;0<br>common\SymbolListOnTb\SymbolItem%200\FontName&#x3D;Arial<br>common\lastetact&#x3D;1686555464670<br>et\Application%20Settings\NextCellDirAfterEnter&#x3D;8<br>et\etongmani\taskpane\dragMenu&#x3D;3<br>plugins\protecteyes\et\shownightmode&#x3D;0<br>common\SymbolListOnTb\SymbolItem%200\InsertChar&#x3D;\xff0b<br>et\Application%20Settings\ShowStartupDialog&#x3D;0<br>et\etongmani\taskpane\custSeq&#x3D;false<br>common\SymbolListOnTb\SymbolItem%200\ShortcutKeys&#x3D;<br>et\Application%20Settings\DisplayFormulaBar&#x3D;1<br>et\etongmani\taskpane\custCmd\TpCloudLink&#x3D;true<br>common\SymbolListOnTb\SymbolItem%200\Visible&#x3D;-1<br>et\Application%20Settings\DisplayStatusBar&#x3D;1<br>et\etongmani\taskpane\custCmd\TpPivotTable&#x3D;true<br>common\SymbolListOnTb\SymbolItem%201\DisplayChar&#x3D;\xff0d<br>et\Application%20Settings\MaxIterations&#x3D;100<br>et\etongmani\taskpane\custCmd\TpFormatting&#x3D;true<br>common\SymbolListOnTb\SymbolItem%201\FontName&#x3D;Arial<br>et\Application%20Settings\MaxChange&#x3D;0.001000<br>et\etongmani\taskpane\custCmd\TpBackupFile&#x3D;true<br>common\SymbolListOnTb\SymbolItem%201\InsertChar&#x3D;\xff0d<br>et\Application%20Settings\MoveAfterReturn&#x3D;1<br>et\etongmani\taskpane\custCmd\TpSelectShape&#x3D;true<br>common\SymbolListOnTb\SymbolItem%201\ShortcutKeys&#x3D;<br>et\Application%20Settings\MoveAfterReturnDirection&#x3D;8<br>common\SymbolListOnTb\SymbolItem%201\Visible&#x3D;-1<br>et\Application%20Settings\FixedDecimal&#x3D;0<br>common\SymbolListOnTb\SymbolItem%202\DisplayChar&#x3D;\xd7<br>et\Application%20Settings\FixedDecimalPlaces&#x3D;2<br>common\SymbolListOnTb\SymbolItem%202\FontName&#x3D;Arial<br>et\Application%20Settings\CopyObjectsWithCells&#x3D;1<br>common\SymbolListOnTb\SymbolItem%202\InsertChar&#x3D;\xd7<br>et\Application%20Settings\StandardFont&#x3D;Calibri<br>common\SymbolListOnTb\SymbolItem%202\ShortcutKeys&#x3D;<br>et\Application%20Settings\StandardFontSize&#x3D;0<br>common\SymbolListOnTb\SymbolItem%202\Visible&#x3D;-1<br>et\Application%20Settings\SheetsInNewWorkbook&#x3D;1<br>common\SymbolListOnTb\SymbolItem%203\DisplayChar&#x3D;\xf7<br>et\Application%20Settings\ShowChartTipNames&#x3D;1<br>common\SymbolListOnTb\SymbolItem%203\FontName&#x3D;Arial<br>et\Application%20Settings\ShowChartTipValues&#x3D;1<br>common\SymbolListOnTb\SymbolItem%203\InsertChar&#x3D;\xf7<br>et\Application%20Settings\ReferenceStyle&#x3D;0<br>common\SymbolListOnTb\SymbolItem%203\ShortcutKeys&#x3D;<br>et\Application%20Settings\SmartTipsType&#x3D;560<br>common\SymbolListOnTb\SymbolItem%203\Visible&#x3D;-1<br>et\Application%20Settings\RecentFiles&#x3D;1<br>common\SymbolListOnTb\SymbolItem%204\DisplayChar&#x3D;\x338f<br>et\Application%20Settings\SaveAsFileType&#x3D;.xlsx<br>common\SymbolListOnTb\SymbolItem%204\FontName&#x3D;Arial<br>et\Application%20Settings\EnableSpecialDiagonal&#x3D;0<br>common\SymbolListOnTb\SymbolItem%204\InsertChar&#x3D;\x338f<br>et\Application%20Settings\DefaultBookName&#x3D;<br>common\SymbolListOnTb\SymbolItem%204\ShortcutKeys&#x3D;<br>et\Application%20Settings\DefaultSheetName&#x3D;<br>common\SymbolListOnTb\SymbolItem%204\Visible&#x3D;-1<br>et\Application%20Settings\SaveBackupFileOnFirstSave&#x3D;1<br>common\SymbolListOnTb\SymbolItem%205\DisplayChar&#x3D;\x339c<br>et\Application%20Settings\DefaultTemplateName&#x3D;<br>common\SymbolListOnTb\SymbolItem%205\FontName&#x3D;Arial<br>et\Application%20Settings\DefaultNewFileButtonIndex&#x3D;0<br>common\SymbolListOnTb\SymbolItem%205\InsertChar&#x3D;\x339c<br>et\Application%20Settings\EnableAutoSave&#x3D;0<br>common\SymbolListOnTb\SymbolItem%205\ShortcutKeys&#x3D;<br>et\Application%20Settings\AutoSaveTimeCycle&#x3D;1<br>common\SymbolListOnTb\SymbolItem%205\Visible&#x3D;-1<br>et\Application%20Settings\AutoListSwitch&#x3D;1<br>common\SymbolListOnTb\SymbolItem%206\DisplayChar&#x3D;\x339d<br>et\Application%20Settings\AlwaysSuggest&#x3D;1<br>common\SymbolListOnTb\SymbolItem%206\FontName&#x3D;Arial<br>et\Application%20Settings\IgnoreCaps&#x3D;1<br>common\SymbolListOnTb\SymbolItem%206\InsertChar&#x3D;\x339d<br>et\Application%20Settings\IgnoreMixedDigits&#x3D;1<br>common\SymbolListOnTb\SymbolItem%206\ShortcutKeys&#x3D;<br>et\Application%20Settings\DocumentTab&#x3D;29<br>common\SymbolListOnTb\SymbolItem%206\Visible&#x3D;-1<br>et\Application%20Settings\ReadingLayoutBackColor&#x3D;0<br>common\SymbolListOnTb\SymbolItem%207\DisplayChar&#x3D;\x33a1<br>et\Application%20Settings\ShowSelectionMiniToolBar&#x3D;1<br>common\SymbolListOnTb\SymbolItem%207\FontName&#x3D;Arial<br>et\Application%20Settings\ShowRightClickMiniToolBar&#x3D;1<br>common\SymbolListOnTb\SymbolItem%207\InsertChar&#x3D;\x33a1<br>et\Application%20Settings\ShowTaskPane&#x3D;0<br>common\SymbolListOnTb\SymbolItem%207\ShortcutKeys&#x3D;<br>et\Application%20Settings\ProtectEyes&#x3D;0<br>common\SymbolListOnTb\SymbolItem%207\Visible&#x3D;-1<br>et\Application%20Settings\ProtectEyesBkColor&#x3D;-3348273<br>common\SymbolListOnTb\SymbolItem%208\DisplayChar&#x3D;\x251<br>et\Application%20Settings\OfdRights&#x3D;0<br>common\SymbolListOnTb\SymbolItem%208\FontName&#x3D;Arial<br>et\Application%20Settings\OfdEmbedFont&#x3D;1<br>common\SymbolListOnTb\SymbolItem%208\InsertChar&#x3D;\x251<br>et\Application%20Settings\OfdOptions&#x3D;188<br>common\SymbolListOnTb\SymbolItem%208\ShortcutKeys&#x3D;<br>et\Application%20Settings\ShowSubwinInTaskbar&#x3D;0<br>common\SymbolListOnTb\SymbolItem%208\Visible&#x3D;-1<br>et\Application%20Settings\EnableLivePreview&#x3D;1<br>common\SymbolListOnTb\SymbolItem%209\DisplayChar&#x3D;\x261<br>et\Application%20Settings\EnableSmoothScroll&#x3D;1<br>common\SymbolListOnTb\SymbolItem%209\FontName&#x3D;Arial<br>et\Application%20Settings\ThemeStandardFont&#x3D;<br>common\SymbolListOnTb\SymbolItem%209\InsertChar&#x3D;\x261<br>common\SymbolListOnTb\SymbolItem%209\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%209\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2010\DisplayChar&#x3D;\x3b1<br>et\Application%20Settings\TextLoadType&#x3D;3<br>common\SymbolListOnTb\SymbolItem%2010\FontName&#x3D;Arial<br>et\Application%20Settings\TextLoadSwitch&#x3D;31<br>common\SymbolListOnTb\SymbolItem%2010\InsertChar&#x3D;\x3b1<br>et\Application%20Settings\CommentDisplayMode&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2010\ShortcutKeys&#x3D;<br>et\Application%20Settings\SmartTipsStyleShow&#x3D;4<br>common\SymbolListOnTb\SymbolItem%2010\Visible&#x3D;-1<br>et\Application%20Settings\CellDragAndDrop&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2011\DisplayChar&#x3D;\x3b2<br>et\Application%20Settings\RecentPrintMode&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2011\FontName&#x3D;Arial<br>et\Application%20Settings\PrintScope&#x3D;2<br>common\SymbolListOnTb\SymbolItem%2011\InsertChar&#x3D;\x3b2<br>et\Application%20Settings\ErrorCheckingOptions&#x3D;4294967167<br>common\SymbolListOnTb\SymbolItem%2011\ShortcutKeys&#x3D;<br>et\Application%20Settings\AutoIdentifyHyperlink&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2011\Visible&#x3D;-1<br>et\Application%20Settings\TraceHyperlinkWithAlt&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2012\DisplayChar&#x3D;\x3b8<br>et\Application%20Settings\AskToUpdateLinks&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2012\FontName&#x3D;Arial<br>et\Application%20Settings\EditDirectlyInCell&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2012\InsertChar&#x3D;\x3b8<br>et\Application%20Settings\IsCommaAsDec&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2012\ShortcutKeys&#x3D;<br>et\Application%20Settings\IsFormulabarExpanded&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2012\Visible&#x3D;-1<br>et\Application%20Settings\EnableBackup&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2013\DisplayChar&#x3D;\x2103<br>et\Application%20Settings\ThrottleInterval&#x3D;2000<br>common\SymbolListOnTb\SymbolItem%2013\FontName&#x3D;Arial<br>et\Application%20Settings\AutoRecoverFilePath&#x3D;&#x2F;root&#x2F;.local&#x2F;share&#x2F;Kingsoft&#x2F;office6&#x2F;data&#x2F;backup<br>common\SymbolListOnTb\SymbolItem%2013\InsertChar&#x3D;\x2103<br>et\Application%20Settings\BackupKeepCacheDays&#x3D;90<br>common\SymbolListOnTb\SymbolItem%2013\ShortcutKeys&#x3D;<br>et\Application%20Settings\DisplayFunctionToolTips&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2013\Visible&#x3D;-1<br>et\Application%20Settings\GenerateGetPivotData&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2014\DisplayChar&#x3D;\x3016<br>et\Application%20Settings\EnableAutoFilterCount&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2014\FontName&#x3D;Arial<br>et\Application%20Settings\ExternalContent&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2014\InsertChar&#x3D;\x3016\x3017<br>et\Application%20Settings\FilterType&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2014\ShortcutKeys&#x3D;<br>et\Application%20Settings\MutiFilterType&#x3D;3<br>common\SymbolListOnTb\SymbolItem%2014\Visible&#x3D;-1<br>et\Application%20Settings\PinyinFilterType&#x3D;6<br>common\SymbolListOnTb\SymbolItem%2015\DisplayChar&#x3D;\xff5b<br>et\Application%20Settings\AutoRecommendFilterType&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2015\FontName&#x3D;Arial<br>et\Application%20Settings\EnableFormatCheck&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2015\InsertChar&#x3D;\xff5b\xff5d<br>et\Application%20Settings\MergeCellOption&#x3D;65792<br>common\SymbolListOnTb\SymbolItem%2015\ShortcutKeys&#x3D;<br>et\Application%20Settings\DisplayFilterCondition&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2015\Visible&#x3D;-1<br>et\Application%20Settings\EnableFilterMergeCells&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2016\DisplayChar&#x3D;\xa9<br>et\Application%20Settings\FormatTableStyleOnly&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2016\FontName&#x3D;Arial<br>et\Application%20Settings\AfPaneDescendByCount&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2016\InsertChar&#x3D;\xa9<br>et\Application%20Settings\RestoreScrollRepeat&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2016\ShortcutKeys&#x3D;<br>et\Application%20Settings\DisplayAfTotalItemCount&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2016\Visible&#x3D;-1<br>et\Application%20Settings\EnableAfAdvanceMode&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2017\DisplayChar&#x3D;\xae<br>et\Application%20Settings\ExpandFilterRgWhenBlankRows&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2017\FontName&#x3D;Arial<br>et\Application%20Settings\EnableAfRangeAutoExpand&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2017\InsertChar&#x3D;\xae<br>et\Application%20Settings\AfRangeExpandRule&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2017\ShortcutKeys&#x3D;<br>et\Application%20Settings\AfRangeExpandSameClickBtnCnt&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2017\Visible&#x3D;-1<br>et\Application%20Settings\NeverSelectNumFmtWhenOpenCsvFile&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2018\DisplayChar&#x3D;\xff20<br>et\Application%20Settings\HighQualityPrinting&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2018\FontName&#x3D;Arial<br>et\Application%20Settings\EnableMidBtnPaste&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2018\InsertChar&#x3D;\xff20<br>et\Application%20Settings\LastOpenFilePath&#x3D;<br>common\SymbolListOnTb\SymbolItem%2018\ShortcutKeys&#x3D;<br>et\Application%20Settings\AltStartup&#x3D;<br>common\SymbolListOnTb\SymbolItem%2018\Visible&#x3D;-1<br>et\Application%20Settings\ShowAfContextTab&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2019\DisplayChar&#x3D;\xff06<br>et\Application%20Settings\PasteToFilterHiddenOption&#x3D;2<br>common\SymbolListOnTb\SymbolItem%2019\FontName&#x3D;Arial<br>et\Application%20Settings\ShowAfToolsFeedbackDlg&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2019\InsertChar&#x3D;\xff06<br>et\Application%20Settings\EnableAfContextShowWithFlash&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2019\ShortcutKeys&#x3D;<br>et\Application%20Settings\NumberFormatNewTagMask&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2019\Visible&#x3D;-1<br>et\Application%20Settings\EscRecoverSwitch&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2020\DisplayChar&#x3D;\xff0a<br>et\Application%20Settings\IsShowOpenLargeHtmlFileDlg&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2020\FontName&#x3D;Arial<br>et\Application%20Settings\DefaultOpenLargeHtmlFileMode&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2020\InsertChar&#x3D;\xff0a<br>et\Application%20Settings\EmbedForceAutoBackupEnabled&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2020\ShortcutKeys&#x3D;<br>et\Application%20Settings\ForceAutoBackupEnabled&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2020\Visible&#x3D;-1<br>et\Application%20Settings\AutoBackupEnabled&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2021\DisplayChar&#x3D;\xff03<br>et\Application%20Settings\EmbedAutoBackupEnabled&#x3D;<br>common\SymbolListOnTb\SymbolItem%2021\FontName&#x3D;Arial<br>et\Application%20Settings\EmbedUserName&#x3D;<br>common\SymbolListOnTb\SymbolItem%2021\InsertChar&#x3D;\xff03<br>et\Application%20Settings\IsShowPicCompressDlg&#x3D;1<br>common\SymbolListOnTb\SymbolItem%2021\ShortcutKeys&#x3D;<br>et\Application%20Settings\EnableBlueBackground&#x3D;0<br>common\SymbolListOnTb\SymbolItem%2021\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2022\DisplayChar&#x3D;\xff05<br>common\SymbolListOnTb\SymbolItem%2022\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2022\InsertChar&#x3D;\xff05<br>common\SymbolListOnTb\SymbolItem%2022\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2022\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2023\DisplayChar&#x3D;\x2030<br>common\SymbolListOnTb\SymbolItem%2023\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2023\InsertChar&#x3D;\x2030<br>common\SymbolListOnTb\SymbolItem%2023\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2023\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2024\DisplayChar&#x3D;\xff04<br>common\SymbolListOnTb\SymbolItem%2024\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2024\InsertChar&#x3D;\xff04<br>common\SymbolListOnTb\SymbolItem%2024\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2024\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2025\DisplayChar&#x3D;\xffe5<br>common\SymbolListOnTb\SymbolItem%2025\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2025\InsertChar&#x3D;\xffe5<br>common\SymbolListOnTb\SymbolItem%2025\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2025\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2026\DisplayChar&#x3D;\xa7<br>common\SymbolListOnTb\SymbolItem%2026\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2026\InsertChar&#x3D;\xa7<br>common\SymbolListOnTb\SymbolItem%2026\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2026\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2027\DisplayChar&#x3D;\xa6<br>common\SymbolListOnTb\SymbolItem%2027\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2027\InsertChar&#x3D;\xa6<br>common\SymbolListOnTb\SymbolItem%2027\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2027\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2028\DisplayChar&#x3D;\x203b<br>common\SymbolListOnTb\SymbolItem%2028\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2028\InsertChar&#x3D;\x203b<br>common\SymbolListOnTb\SymbolItem%2028\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2028\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2029\DisplayChar&#x3D;\x25ce<br>common\SymbolListOnTb\SymbolItem%2029\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2029\InsertChar&#x3D;\x25ce<br>common\SymbolListOnTb\SymbolItem%2029\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2029\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2030\DisplayChar&#x3D;\x2248<br>common\SymbolListOnTb\SymbolItem%2030\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2030\InsertChar&#x3D;\x2248<br>common\SymbolListOnTb\SymbolItem%2030\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2030\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2031\DisplayChar&#x3D;\x2026<br>common\SymbolListOnTb\SymbolItem%2031\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2031\InsertChar&#x3D;\x2026<br>common\SymbolListOnTb\SymbolItem%2031\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2031\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2032\DisplayChar&#x3D;\x2264<br>common\SymbolListOnTb\SymbolItem%2032\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2032\InsertChar&#x3D;\x2264<br>common\SymbolListOnTb\SymbolItem%2032\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2032\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2033\DisplayChar&#x3D;\x2265<br>common\SymbolListOnTb\SymbolItem%2033\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2033\InsertChar&#x3D;\x2265<br>common\SymbolListOnTb\SymbolItem%2033\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2033\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2034\DisplayChar&#x3D;\x2266<br>common\SymbolListOnTb\SymbolItem%2034\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2034\InsertChar&#x3D;\x2266<br>common\SymbolListOnTb\SymbolItem%2034\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2034\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2035\DisplayChar&#x3D;\x2267<br>common\SymbolListOnTb\SymbolItem%2035\FontName&#x3D;Arial<br>common\SymbolListOnTb\SymbolItem%2035\InsertChar&#x3D;\x2267<br>common\SymbolListOnTb\SymbolItem%2035\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2035\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2036\DisplayChar&#x3D;\xa3<br>common\SymbolListOnTb\SymbolItem%2036\FontName&#x3D;Wingdings 2<br>common\SymbolListOnTb\SymbolItem%2036\InsertChar&#x3D;\xa3<br>common\SymbolListOnTb\SymbolItem%2036\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2036\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2037\DisplayChar&#x3D;R<br>common\SymbolListOnTb\SymbolItem%2037\FontName&#x3D;Wingdings 2<br>common\SymbolListOnTb\SymbolItem%2037\InsertChar&#x3D;R<br>common\SymbolListOnTb\SymbolItem%2037\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2037\Visible&#x3D;-1<br>common\SymbolListOnTb\SymbolItem%2038\DisplayChar&#x3D;Q<br>common\SymbolListOnTb\SymbolItem%2038\FontName&#x3D;Wingdings 2<br>common\SymbolListOnTb\SymbolItem%2038\InsertChar&#x3D;Q<br>common\SymbolListOnTb\SymbolItem%2038\ShortcutKeys&#x3D;<br>common\SymbolListOnTb\SymbolItem%2038\Visible&#x3D;-1<br>plugins\kstartpage\officenav_new_v1\seqEntry\CommonEntrys\newdocumentwps&#x3D;0</p><p>[kdcsdk]<br>NotFirstOpen&#x3D;true</p><pre><code></code></pre>]]></content>
    
    
    <summary type="html">&lt;p&gt;替换wps配置文件&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="https://qbmzc.github.io/categories/Java/"/>
    
    
    <category term="wps" scheme="https://qbmzc.github.io/tags/wps/"/>
    
  </entry>
  
  <entry>
    <title>word表格批量设置允许跨页断行</title>
    <link href="https://qbmzc.github.io/2025/09/23/2025/09/231034/"/>
    <id>https://qbmzc.github.io/2025/09/23/2025/09/231034/</id>
    <published>2025-09-23T05:36:09.000Z</published>
    <updated>2025-11-21T06:36:31.566Z</updated>
    
    <content type="html"><![CDATA[<p>在处理包含多个表格的Word文档时，批量设置“允许跨页断行”能有效避免表格在页面底部被生硬截断，提升文档美观度和阅读体验。</p><span id="more"></span><h3 id="🧾-跨页断行与相关设置"><a href="#🧾-跨页断行与相关设置" class="headerlink" title="🧾 跨页断行与相关设置"></a>🧾 跨页断行与相关设置</h3><p>Word表格的跨页行为，主要通过“<strong>允许跨页断行</strong>”这一选项控制。它决定了表格行是否可以在页面底部被切断，并将剩余部分显示在下一页。</p><p>与之相关的另一个实用设置是“<strong>在各页顶端以标题行形式重复出现</strong>”（或称“重复标题行”）。<strong>建议优先设置此功能</strong>，它能确保跨页断行后的表格在每一新页的开头都显示指定的标题行，极大方便了阅读和数据处理。你可以在 <code>表格属性 &gt; 行</code> 选项卡中勾选此选项。</p><h3 id="🔧-批量设置方法"><a href="#🔧-批量设置方法" class="headerlink" title="🔧 批量设置方法"></a>🔧 批量设置方法</h3><p>你可以通过以下流程图了解批量设置的两种主要方式及其选择参考：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[开始: 批量设置表格跨页断行] --&gt; B&#123;选择设置方式&#125;;</span><br><span class="line">    </span><br><span class="line">    B -- 方法一 --&gt; C[使用宏VBA&lt;br&gt;高效处理大量表格];</span><br><span class="line">    B -- 方法二 --&gt; D[手动批量设置&lt;br&gt;适合表格数量较少];</span><br><span class="line"></span><br><span class="line">    subgraph C [VBA宏步骤]</span><br><span class="line">        C1[启用开发者选项卡];</span><br><span class="line">        C2[打开VBA编辑器&lt;br&gt;插入新模块];</span><br><span class="line">        C3[粘贴并运行宏代码];</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    subgraph D [手动批量步骤]</span><br><span class="line">        D1[全选文档&lt;br&gt;Ctrl+A];</span><br><span class="line">        D2[打开表格属性];</span><br><span class="line">        D3[勾选“允许跨页断行”];</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    C3 --&gt; E[完成设置];</span><br><span class="line">    D3 --&gt; E;</span><br><span class="line"></span><br><span class="line">    style A fill:#ebf4f7,stroke:#2079d5,stroke-width:2px</span><br><span class="line">    style E fill:#e1f5e1,stroke:#0a9c0a,stroke-width:2px</span><br></pre></td></tr></table></figure><p>以下是每种方法的具体操作步骤。</p><h4 id="方法一：使用-VBA-宏（推荐用于大量表格）"><a href="#方法一：使用-VBA-宏（推荐用于大量表格）" class="headerlink" title="方法一：使用 VBA 宏（推荐用于大量表格）"></a>方法一：使用 VBA 宏（推荐用于大量表格）</h4><p>此方法通过运行一段 Visual Basic for Applications (VBA) 代码来批量处理文档中的所有表格，效率最高。</p><ol><li><p><strong>启用“开发工具”选项卡</strong>（若尚未启用）：</p><ul><li>打开 Word 文档，点击 <code>文件</code> &gt; <code>选项</code> &gt; <code>自定义功能区</code>。</li><li>在右侧的“主选项卡”列表中，找到并勾选 <code>开发工具</code>，然后点击“确定”。</li></ul></li><li><p><strong>打开 VBA 编辑器并插入模块</strong>：</p><ul><li>在 <code>开发工具</code> 选项卡中，点击 <code>Visual Basic</code>（或按 <code>Alt + F11</code>）。</li><li>在弹出的 VBA 编辑器窗口中，点击菜单栏的 <code>插入</code> &gt; <code>模块</code>。</li></ul></li><li><p><strong>粘贴并运行代码</strong>：</p><ul><li>将以下 VBA 代码复制粘贴到新出现的代码窗口中：</li></ul><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Sub</span> SetAllowBreakAcrossPagesForAllTables()</span><br><span class="line">    <span class="keyword">Dim</span> tbl <span class="keyword">As</span> Table</span><br><span class="line">    <span class="keyword">On</span> <span class="keyword">Error</span> <span class="keyword">Resume</span> <span class="keyword">Next</span> <span class="comment">&#x27;忽略可能遇到的错误，继续执行下一个表格</span></span><br><span class="line">    <span class="keyword">For</span> <span class="keyword">Each</span> tbl <span class="keyword">In</span> ActiveDocument.Tables</span><br><span class="line">        <span class="comment">&#x27;设置允许跨页断行</span></span><br><span class="line">        tbl.Rows.AllowBreakAcrossPages = <span class="literal">True</span></span><br><span class="line">        <span class="comment">&#x27;可选：设置重复标题行。假设标题行是第一行。</span></span><br><span class="line">        <span class="comment">&#x27;如果标题行有多行，或不确定，可删除或修改下一行代码。</span></span><br><span class="line">        <span class="comment">&#x27;tbl.Rows(1).HeadingFormat = True</span></span><br><span class="line">    <span class="keyword">Next</span> tbl</span><br><span class="line">    MsgBox <span class="string">&quot;处理完成！已批量设置所有表格的跨页断行属性。&quot;</span>, vbInformation</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure><ul><li>粘贴后，点击工具栏上的绿色“运行”三角按钮（或按 <code>F5</code>）执行宏。</li></ul></li><li><p><strong>处理安全警告与保存</strong>：</p><ul><li>首次运行宏时，Word可能会提示“宏已被禁用”。点击 <code>启用内容</code> 或根据提示调整宏安全设置（<code>文件</code> &gt; <code>选项</code> &gt; <code>信任中心</code> &gt; <code>信任中心设置</code> &gt; <code>宏设置</code> &gt; 选择“启用所有宏”<strong>（请注意临时启用，使用后建议恢复设置）</strong>）。</li><li>运行完成后会弹出提示框。<strong>请注意，包含宏的文件需要保存为 <code>.docm</code> 格式</strong>。</li></ul></li></ol><h4 id="方法二：手动批量设置（表格数量较少时）"><a href="#方法二：手动批量设置（表格数量较少时）" class="headerlink" title="方法二：手动批量设置（表格数量较少时）"></a>方法二：手动批量设置（表格数量较少时）</h4><p>如果文档中表格数量不多，或者对 VBA 感到陌生，可以尝试以下手动方法。</p><ol><li><p><strong>全选文档中的所有表格</strong>：</p><ul><li>按 <code>Ctrl + A</code> 全选文档中的所有内容。</li></ul></li><li><p><strong>统一设置表格属性</strong>：</p><ul><li>在选中的内容上右键单击，选择 <code>表格属性</code>。</li><li>在弹出的“表格属性”对话框中，切换到 <code>行</code> 选项卡。</li><li><strong>勾选 <code>允许跨页断行</code></strong>。</li><li>点击“确定”应用设置。</li></ul><p><em>⚠️ 注意</em>：此方法通过全选文本来间接选中所有表格并进行统一设置，<strong>在某些 Word 版本或文档格式复杂时可能不一定对所有表格生效</strong>。操作后最好检查一下关键表格的设置。</p></li></ol><h3 id="⚠️-重要注意事项"><a href="#⚠️-重要注意事项" class="headerlink" title="⚠️ 重要注意事项"></a>⚠️ 重要注意事项</h3><ul><li><strong>“允许跨页断行”与“不允许跨页断行”</strong>：勾选“允许跨页断行”，Word 会在页面底部断开表格；取消勾选，Word 会尽力将整行保持在同一页，如果当前页放不下，会将整行移到下一页。请根据你的排版需求决定。</li><li><strong>标题行的重复</strong>：如前所述，<strong>强烈建议为跨页的表格设置“重复标题行”</strong>。你可以在 VBA 代码中设置（见上面代码注释），也可以手动在 <code>表格属性</code> &gt; <code>行</code> 选项卡中勾选 <code>在各页顶端以标题行形式重复出现</code>。<strong>此功能仅对表格首行或选中的连续首几行有效</strong>。</li><li><strong>检查段落分页设置</strong>：如果表格单元格内文字很多，还需检查文字自身的段落设置。选中单元格内文字，右键进入 <code>段落</code> &gt; <code>换行和分页</code> 选项卡，确保没有勾选 <code>段中不分页</code>，否则会影响跨页。</li><li><strong>版本差异</strong>：不同版本的 Word（如 Microsoft Word 365, 2021, 2019 或 WPS Office）操作界面可能略有不同，但核心选项名称基本一致。</li></ul><h3 id="💎-总结"><a href="#💎-总结" class="headerlink" title="💎 总结"></a>💎 总结</h3><p>批量处理Word文档中多个表格的跨页断行，<strong>推荐使用VBA宏的方法</strong>，它速度快且能确保所有表格都被统一处理。手动全选的方法可以作为表格数量较少时的备选方案。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;在处理包含多个表格的Word文档时，批量设置“允许跨页断行”能有效避免表格在页面底部被生硬截断，提升文档美观度和阅读体验。&lt;/p&gt;</summary>
    
    
    
    <category term="work" scheme="https://qbmzc.github.io/categories/work/"/>
    
    
    <category term="openssl" scheme="https://qbmzc.github.io/tags/openssl/"/>
    
  </entry>
  
  <entry>
    <title>生成svg格式的图片</title>
    <link href="https://qbmzc.github.io/2025/09/22/2025/09/190401/"/>
    <id>https://qbmzc.github.io/2025/09/22/2025/09/190401/</id>
    <published>2025-09-22T06:06:09.000Z</published>
    <updated>2025-11-21T06:36:31.566Z</updated>
    
    <content type="html"><![CDATA[<p>SVG（Scalable Vector Graphics）是一种基于XML的矢量图形格式，在现代Web开发中扮演着重要角色。与传统的位图格式（如PNG、JPEG）不同，SVG使用数学公式来描述图形，这使得它具有无限缩放而不失真的特性。</p><span id="more"></span><h2 id="什么是SVG？"><a href="#什么是SVG？" class="headerlink" title="什么是SVG？"></a>什么是SVG？</h2><p>SVG是一种用XML描述的二维矢量图形格式，由W3C制定标准。它允许我们使用文本编辑器创建和编辑图形，同时支持动画、交互性和样式化。</p><h3 id="SVG的主要特点："><a href="#SVG的主要特点：" class="headerlink" title="SVG的主要特点："></a>SVG的主要特点：</h3><ul><li><strong>矢量图形</strong>：基于数学公式，可无限缩放而不失真</li><li><strong>文件小</strong>：相比位图格式，文件体积通常更小</li><li><strong>可编辑</strong>：可以用文本编辑器直接编辑</li><li><strong>可搜索</strong>：文本内容可以被搜索引擎索引</li><li><strong>可样式化</strong>：支持CSS样式</li><li><strong>可交互</strong>：支持JavaScript交互</li><li><strong>可动画</strong>：支持CSS和SMIL动画</li></ul><h2 id="SVG-vs-其他格式"><a href="#SVG-vs-其他格式" class="headerlink" title="SVG vs 其他格式"></a>SVG vs 其他格式</h2><table><thead><tr><th>特性</th><th>SVG</th><th>PNG</th><th>JPEG</th><th>GIF</th></tr></thead><tbody><tr><td>类型</td><td>矢量</td><td>位图</td><td>位图</td><td>位图</td></tr><tr><td>缩放</td><td>无损</td><td>有损</td><td>有损</td><td>有损</td></tr><tr><td>文件大小</td><td>小</td><td>中等</td><td>小</td><td>小</td></tr><tr><td>动画支持</td><td>是</td><td>否</td><td>否</td><td>是</td></tr><tr><td>透明度</td><td>是</td><td>是</td><td>否</td><td>是</td></tr><tr><td>交互性</td><td>是</td><td>否</td><td>否</td><td>否</td></tr></tbody></table><h2 id="SVG基本语法"><a href="#SVG基本语法" class="headerlink" title="SVG基本语法"></a>SVG基本语法</h2><h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;200&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- SVG内容 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="常用元素"><a href="#常用元素" class="headerlink" title="常用元素"></a>常用元素</h3><h4 id="1-矩形-rect"><a href="#1-矩形-rect" class="headerlink" title="1. 矩形 (rect)"></a>1. 矩形 (rect)</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">rect</span> <span class="attr">x</span>=<span class="string">&quot;10&quot;</span> <span class="attr">y</span>=<span class="string">&quot;10&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">height</span>=<span class="string">&quot;50&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;blue&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;black&quot;</span> <span class="attr">stroke-width</span>=<span class="string">&quot;2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-圆形-circle"><a href="#2-圆形-circle" class="headerlink" title="2. 圆形 (circle)"></a>2. 圆形 (circle)</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">&quot;50&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;50&quot;</span> <span class="attr">r</span>=<span class="string">&quot;40&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;red&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;black&quot;</span> <span class="attr">stroke-width</span>=<span class="string">&quot;2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h4 id="3-椭圆-ellipse"><a href="#3-椭圆-ellipse" class="headerlink" title="3. 椭圆 (ellipse)"></a>3. 椭圆 (ellipse)</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ellipse</span> <span class="attr">cx</span>=<span class="string">&quot;50&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;50&quot;</span> <span class="attr">rx</span>=<span class="string">&quot;40&quot;</span> <span class="attr">ry</span>=<span class="string">&quot;20&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;green&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;black&quot;</span> <span class="attr">stroke-width</span>=<span class="string">&quot;2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-线条-line"><a href="#4-线条-line" class="headerlink" title="4. 线条 (line)"></a>4. 线条 (line)</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">line</span> <span class="attr">x1</span>=<span class="string">&quot;0&quot;</span> <span class="attr">y1</span>=<span class="string">&quot;0&quot;</span> <span class="attr">x2</span>=<span class="string">&quot;100&quot;</span> <span class="attr">y2</span>=<span class="string">&quot;100&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;black&quot;</span> <span class="attr">stroke-width</span>=<span class="string">&quot;2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h4 id="5-路径-path"><a href="#5-路径-path" class="headerlink" title="5. 路径 (path)"></a>5. 路径 (path)</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">&quot;M10 10 L50 50 L90 10&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;black&quot;</span> <span class="attr">stroke-width</span>=<span class="string">&quot;2&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;none&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h4 id="6-文本-text"><a href="#6-文本-text" class="headerlink" title="6. 文本 (text)"></a>6. 文本 (text)</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">&quot;10&quot;</span> <span class="attr">y</span>=<span class="string">&quot;30&quot;</span> <span class="attr">font-family</span>=<span class="string">&quot;Arial&quot;</span> <span class="attr">font-size</span>=<span class="string">&quot;16&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;black&quot;</span>&gt;</span>Hello SVG!<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="实际应用示例"><a href="#实际应用示例" class="headerlink" title="实际应用示例"></a>实际应用示例</h2><h3 id="1-创建简单的图标"><a href="#1-创建简单的图标" class="headerlink" title="1. 创建简单的图标"></a>1. 创建简单的图标</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">height</span>=<span class="string">&quot;100&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 心形图标 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">&quot;M50,85 C50,85 20,60 20,40 C20,25 30,15 45,15 C50,15 50,20 50,20 C50,20 50,15 55,15 C70,15 80,25 80,40 C80,60 50,85 50,85 Z&quot;</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">fill</span>=<span class="string">&quot;red&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;darkred&quot;</span> <span class="attr">stroke-width</span>=<span class="string">&quot;2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-响应式SVG"><a href="#2-响应式SVG" class="headerlink" title="2. 响应式SVG"></a>2. 响应式SVG</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">viewBox</span>=<span class="string">&quot;0 0 100 100&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">&quot;50&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;50&quot;</span> <span class="attr">r</span>=<span class="string">&quot;40&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;blue&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-带CSS样式的SVG"><a href="#3-带CSS样式的SVG" class="headerlink" title="3. 带CSS样式的SVG"></a>3. 带CSS样式的SVG</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;200&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.my-circle</span> &#123; fill: red; stroke: black; stroke-<span class="attribute">width</span>: <span class="number">2</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.my-circle</span><span class="selector-pseudo">:hover</span> &#123; fill: blue; &#125;</span></span><br><span class="line"><span class="language-css">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">circle</span> <span class="attr">class</span>=<span class="string">&quot;my-circle&quot;</span> <span class="attr">cx</span>=<span class="string">&quot;100&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;100&quot;</span> <span class="attr">r</span>=<span class="string">&quot;50&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="在Web开发中使用SVG"><a href="#在Web开发中使用SVG" class="headerlink" title="在Web开发中使用SVG"></a>在Web开发中使用SVG</h2><h3 id="1-内联SVG"><a href="#1-内联SVG" class="headerlink" title="1. 内联SVG"></a>1. 内联SVG</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>内联SVG示例<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;200&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">&quot;100&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;100&quot;</span> <span class="attr">r</span>=<span class="string">&quot;50&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;blue&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-作为图片使用"><a href="#2-作为图片使用" class="headerlink" title="2. 作为图片使用"></a>2. 作为图片使用</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;icon.svg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;图标&quot;</span> <span class="attr">width</span>=<span class="string">&quot;50&quot;</span> <span class="attr">height</span>=<span class="string">&quot;50&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-作为背景图片"><a href="#3-作为背景图片" class="headerlink" title="3. 作为背景图片"></a>3. 作为背景图片</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.icon</span> &#123;</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&#x27;icon.svg&#x27;</span>);</span><br><span class="line">    <span class="attribute">background-size</span>: contain;</span><br><span class="line">    <span class="attribute">background-repeat</span>: no-repeat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-使用SVG-Sprite"><a href="#4-使用SVG-Sprite" class="headerlink" title="4. 使用SVG Sprite"></a>4. 使用SVG Sprite</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">style</span>=<span class="string">&quot;display: none;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">defs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">symbol</span> <span class="attr">id</span>=<span class="string">&quot;icon-home&quot;</span> <span class="attr">viewBox</span>=<span class="string">&quot;0 0 24 24&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">&quot;M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">symbol</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">defs</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">class</span>=<span class="string">&quot;icon&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">use</span> <span class="attr">href</span>=<span class="string">&quot;#icon-home&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">use</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="SVG动画"><a href="#SVG动画" class="headerlink" title="SVG动画"></a>SVG动画</h2><h3 id="1-CSS动画"><a href="#1-CSS动画" class="headerlink" title="1. CSS动画"></a>1. CSS动画</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;200&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.rotating</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">animation</span>: rotate <span class="number">2s</span> linear infinite;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">transform-origin</span>: center;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="keyword">@keyframes</span> rotate &#123;</span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">from</span> &#123; <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">0deg</span>); &#125;</span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">to</span> &#123; <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">360deg</span>); &#125;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rect</span> <span class="attr">class</span>=<span class="string">&quot;rotating&quot;</span> <span class="attr">x</span>=<span class="string">&quot;75&quot;</span> <span class="attr">y</span>=<span class="string">&quot;75&quot;</span> <span class="attr">width</span>=<span class="string">&quot;50&quot;</span> <span class="attr">height</span>=<span class="string">&quot;50&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;blue&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-SMIL动画"><a href="#2-SMIL动画" class="headerlink" title="2. SMIL动画"></a>2. SMIL动画</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;200&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">&quot;100&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;100&quot;</span> <span class="attr">r</span>=<span class="string">&quot;50&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;red&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">animate</span> <span class="attr">attributeName</span>=<span class="string">&quot;r&quot;</span> <span class="attr">values</span>=<span class="string">&quot;50;80;50&quot;</span> <span class="attr">dur</span>=<span class="string">&quot;2s&quot;</span> <span class="attr">repeatCount</span>=<span class="string">&quot;indefinite&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">circle</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="优化技巧"><a href="#优化技巧" class="headerlink" title="优化技巧"></a>优化技巧</h2><h3 id="1-压缩SVG"><a href="#1-压缩SVG" class="headerlink" title="1. 压缩SVG"></a>1. 压缩SVG</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用SVGO压缩</span></span><br><span class="line">npm install -g svgo</span><br><span class="line">svgo input.svg -o output.svg</span><br></pre></td></tr></table></figure><h3 id="2-移除不必要的属性"><a href="#2-移除不必要的属性" class="headerlink" title="2. 移除不必要的属性"></a>2. 移除不必要的属性</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 优化前 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">height</span>=<span class="string">&quot;100&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">&quot;50&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;50&quot;</span> <span class="attr">r</span>=<span class="string">&quot;40&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;blue&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;black&quot;</span> <span class="attr">stroke-width</span>=<span class="string">&quot;2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 优化后 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">viewBox</span>=<span class="string">&quot;0 0 100 100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">&quot;50&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;50&quot;</span> <span class="attr">r</span>=<span class="string">&quot;40&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;blue&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-使用路径优化"><a href="#3-使用路径优化" class="headerlink" title="3. 使用路径优化"></a>3. 使用路径优化</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用更简洁的路径命令 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">&quot;M10 10h80v80h-80z&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;blue&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h2 id="浏览器支持"><a href="#浏览器支持" class="headerlink" title="浏览器支持"></a>浏览器支持</h2><p>现代浏览器对SVG的支持已经非常完善：</p><ul><li>Chrome: 完全支持</li><li>Firefox: 完全支持</li><li>Safari: 完全支持</li><li>Edge: 完全支持</li><li>IE: 9+支持（部分功能）</li></ul><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><ol><li><strong>使用viewBox属性</strong>：确保SVG在不同尺寸下正确显示</li><li><strong>优化文件大小</strong>：移除不必要的属性和空白</li><li><strong>使用语义化的ID和类名</strong>：便于维护和样式化</li><li><strong>考虑可访问性</strong>：添加适当的alt文本和ARIA属性</li><li><strong>测试不同浏览器</strong>：确保兼容性</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>SVG作为一种强大的矢量图形格式，在现代Web开发中具有重要地位。它的可缩放性、小文件体积、丰富的交互性和动画支持，使其成为创建图标、图表、插图和复杂图形的理想选择。掌握SVG的使用技巧，能够显著提升Web应用的用户体验和性能。</p><p>随着Web技术的不断发展，SVG的应用场景也在不断扩展，从简单的图标到复杂的数据可视化，SVG都展现出了其独特的优势。对于前端开发者来说，熟练掌握SVG的使用是必不可少的技能之一。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;SVG（Scalable Vector Graphics）是一种基于XML的矢量图形格式，在现代Web开发中扮演着重要角色。与传统的位图格式（如PNG、JPEG）不同，SVG使用数学公式来描述图形，这使得它具有无限缩放而不失真的特性。&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="https://qbmzc.github.io/categories/Java/"/>
    
    
    <category term="svg" scheme="https://qbmzc.github.io/tags/svg/"/>
    
  </entry>
  
  <entry>
    <title>cursor使用mcp连接数据库</title>
    <link href="https://qbmzc.github.io/2025/09/15/2025/09/151515/"/>
    <id>https://qbmzc.github.io/2025/09/15/2025/09/151515/</id>
    <published>2025-09-15T07:15:09.000Z</published>
    <updated>2025-11-21T06:36:31.566Z</updated>
    
    <content type="html"><![CDATA[<p>vscode like使用mcp连接数据库</p><span id="more"></span><h2 id="安装uv"><a href="#安装uv" class="headerlink" title="安装uv"></a>安装uv</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ArchLinux </span></span><br><span class="line">paru -S uv</span><br><span class="line"><span class="comment"># macOSX</span></span><br><span class="line"></span><br><span class="line">brew install uv</span><br></pre></td></tr></table></figure><h2 id="安装mysql-mcp-server"><a href="#安装mysql-mcp-server" class="headerlink" title="安装mysql_mcp_server"></a>安装mysql_mcp_server</h2><ol><li>初始化</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uv init mysql_mcp_server</span><br><span class="line"><span class="comment"># 输出 注意哦这里的绝对路径后续会用到</span></span><br><span class="line">Initialized project `mysql-mcp-server` at `/Users/cong/Space/mysql_mcp_server`</span><br></pre></td></tr></table></figure><ol start="2"><li>虚拟环境</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> mysql_mcp_server &amp;&amp; uv venv</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="3"><li>激活环境</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> .venv/bin/activate</span><br></pre></td></tr></table></figure><ol start="4"><li>安装服务</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv pip install  mysql_mcp_server</span><br></pre></td></tr></table></figure><ol start="5"><li>使用<code>--directory</code>后面的参数即为第一步中的绝对路径</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mysql&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uv&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;--directory&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;/Users/cong/Space/mysql_mcp_server&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;run&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;mysql_mcp_server&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;MYSQL_HOST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;MYSQL_PORT&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3306&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;MYSQL_USER&quot;</span><span class="punctuation">:</span> <span class="string">&quot;root&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;MYSQL_PASSWORD&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;MYSQL_DATABASE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://github.com/designcomputer/mysql_mcp_server">github:mysql_mcp_server</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;vscode like使用mcp连接数据库&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://qbmzc.github.io/categories/Linux/"/>
    
    
    <category term="AI" scheme="https://qbmzc.github.io/tags/AI/"/>
    
    <category term="mcp" scheme="https://qbmzc.github.io/tags/mcp/"/>
    
  </entry>
  
  <entry>
    <title>解决IllegalStateException</title>
    <link href="https://qbmzc.github.io/2025/09/04/2025/09/011621/"/>
    <id>https://qbmzc.github.io/2025/09/04/2025/09/011621/</id>
    <published>2025-09-04T06:06:09.000Z</published>
    <updated>2025-11-21T06:36:31.566Z</updated>
    
    <content type="html"><![CDATA[<p>解决 java.lang.IllegalStateException: ut010005: can…</p><span id="more"></span><h2 id="IllegalStateException"><a href="#IllegalStateException" class="headerlink" title="IllegalStateException"></a>IllegalStateException</h2><p>此错误通常发生在尝试同时调用 HttpServletResponse 的 getOutputStream() 和 getWriter() 方法时。根据 Servlet 规范，这两者不能同时使用，因为它们分别用于二进制数据和字符数据的输出。</p><h2 id="示例问题"><a href="#示例问题" class="headerlink" title="示例问题"></a>示例问题</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">response.getWriter().write(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">response.getOutputStream().write(<span class="string">&quot;Hello, World!&quot;</span>.getBytes());</span><br></pre></td></tr></table></figure><p>运行上述代码会抛出 IllegalStateException，因为在调用 getWriter() 后再调用 getOutputStream() 是不允许的。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ol><li>统一使用 getWriter() 或 getOutputStream()</li></ol><p>确保在整个响应处理中只使用一种输出方式。如果需要输出文本内容，使用 getWriter()；如果需要输出二进制数据（如文件下载），使用 getOutputStream()。</p><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 getWriter()</span></span><br><span class="line">response.setContentType(<span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">response.getWriter().write(<span class="string">&quot;This is a text response.&quot;</span>);</span><br><span class="line"><span class="comment">// 使用 getOutputStream()</span></span><br><span class="line">response.setContentType(<span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">response.getOutputStream().write(<span class="string">&quot;This is binary data.&quot;</span>.getBytes());</span><br></pre></td></tr></table></figure><ol start="2"><li>使用 ResponseEntity 替代直接操作 HttpServletResponse</li></ol><p>在 Spring 框架中，可以通过返回 ResponseEntity 来避免直接操作响应流。</p><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@GetMapping(&quot;/download&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;<span class="type">byte</span>[]&gt; downloadFile() &#123;</span><br><span class="line"><span class="type">byte</span>[] data = <span class="string">&quot;File content&quot;</span>.getBytes(StandardCharsets.UTF_8);</span><br><span class="line"><span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">headers.setContentDispositionFormData(<span class="string">&quot;attachment&quot;</span>, <span class="string">&quot;file.txt&quot;</span>);</span><br><span class="line">headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(data, headers, HttpStatus.OK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>避免在 JSP 中混用输出流</li></ol><p>如果在 JSP 页面中使用了 out 对象（由 getWriter() 提供），不要再调用 getOutputStream()。可以通过清空缓存并更新上下文来解决冲突。</p><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">response.reset();</span><br><span class="line">response.setContentType(<span class="string">&quot;application/vnd.ms-excel&quot;</span>);</span><br><span class="line">out.clear();</span><br><span class="line">out = pageContext.pushBody();</span><br><span class="line">response.getOutputStream().write(<span class="string">&quot;Excel content&quot;</span>.getBytes());</span><br></pre></td></tr></table></figure><p>通过以上方法，可以有效避免和解决该异常，提高代码的稳定性和可维护性。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;解决 java.lang.IllegalStateException: ut010005: can…&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="https://qbmzc.github.io/categories/Java/"/>
    
    
    <category term="Spring" scheme="https://qbmzc.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Mybatist转义的配置</title>
    <link href="https://qbmzc.github.io/2025/08/22/2025/08/221128/"/>
    <id>https://qbmzc.github.io/2025/08/22/2025/08/221128/</id>
    <published>2025-08-21T16:00:00.000Z</published>
    <updated>2025-11-21T06:36:31.566Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p><img src="https://hehunfan-1300293535.cos.ap-shanghai.myqcloud.com/img/2025/20250825161606240.jpg" alt="2"></p><p>【Mybatis错误】Caused by: org.xml.sax.SAXParseException; lineNumber: 1; columnNumber: 584; The content of elements must consist of well-formed character data or markup</p><p>编译器自动把sql语句中的小于号当成了开始标签</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and a.start_time &lt;= #&#123;endTime&#125; </span><br></pre></td></tr></table></figure><p>替换为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;![CDATA[and a.start_time &lt;= #&#123;endTime&#125;]]&gt; </span><br></pre></td></tr></table></figure><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2025/20250825180859574.jpg"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;p&gt;&lt;img src=&quot;https://hehunfan-1300293535.cos.ap-shanghai.myqcloud.com/img/2025/20250825161606240.jpg&quot; alt=&quot;2&quot;&gt;&lt;/p&gt;
</summary>
      
    
    
    
    <category term="Java" scheme="https://qbmzc.github.io/categories/Java/"/>
    
    
    <category term="mybatis" scheme="https://qbmzc.github.io/tags/mybatis/"/>
    
  </entry>
  
  <entry>
    <title>pptx添加备注</title>
    <link href="https://qbmzc.github.io/2025/08/12/2025/08/181022/"/>
    <id>https://qbmzc.github.io/2025/08/12/2025/08/181022/</id>
    <published>2025-08-11T16:00:00.000Z</published>
    <updated>2025-11-21T06:36:31.566Z</updated>
    
    <content type="html"><![CDATA[<p>AI给pptx文件添加演讲时的备注</p><span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在演讲准备过程中，为PPT添加备注是一个重要的环节。备注可以帮助演讲者更好地组织思路，提醒关键要点，确保演讲的流畅性。然而，手动为每张幻灯片添加备注往往耗时且容易遗漏。本文介绍如何使用Java和Apache POI库，结合AI技术，自动化地为PPTX文件添加智能备注。</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><h3 id="传统备注添加方式的痛点"><a href="#传统备注添加方式的痛点" class="headerlink" title="传统备注添加方式的痛点"></a>传统备注添加方式的痛点</h3><ul><li><strong>耗时费力</strong>：需要逐张幻灯片手动添加备注</li><li><strong>内容重复</strong>：相似内容的幻灯片备注往往重复</li><li><strong>缺乏智能性</strong>：备注内容缺乏针对性和个性化</li><li><strong>维护困难</strong>：修改PPT内容后，备注需要同步更新</li></ul><h3 id="AI技术的应用前景"><a href="#AI技术的应用前景" class="headerlink" title="AI技术的应用前景"></a>AI技术的应用前景</h3><ul><li><strong>内容理解</strong>：AI可以分析PPT内容，生成相关备注</li><li><strong>智能推荐</strong>：基于内容自动推荐合适的备注内容</li><li><strong>批量处理</strong>：一次性处理整个PPT文件</li><li><strong>内容优化</strong>：根据演讲场景优化备注内容</li></ul><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ol><li><strong>自动化备注添加</strong>：实现PPTX文件的自动备注添加功能</li><li><strong>智能内容生成</strong>：基于PPT内容自动生成相关备注</li><li><strong>批量处理能力</strong>：支持单个或多个PPTX文件的批量处理</li><li><strong>格式兼容性</strong>：确保生成的备注在PowerPoint中正常显示</li><li><strong>错误处理</strong>：提供完善的错误处理和文件验证机制</li></ol><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><h3 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h3><ul><li><strong>Apache POI</strong>：Java生态中最成熟的Office文档处理库</li><li><strong>POI-XSLF</strong>：专门用于处理PPTX文件的扩展库</li><li><strong>文件验证</strong>：确保输入文件的完整性和有效性</li><li><strong>异常处理</strong>：提供多层次的错误处理机制</li></ul><h3 id="核心策略"><a href="#核心策略" class="headerlink" title="核心策略"></a>核心策略</h3><ol><li><strong>文件验证</strong>：首先验证PPTX文件的有效性</li><li><strong>备注页处理</strong>：优先使用标准的备注页机制</li><li><strong>备用方案</strong>：当备注页不可用时，直接在幻灯片上添加备注</li><li><strong>内容优化</strong>：根据幻灯片内容智能生成备注文本</li></ol><h2 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h2><h3 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输入PPTX文件 → 文件验证 → 内容分析 → 备注生成 → 备注添加 → 输出PPTX文件</span><br></pre></td></tr></table></figure><h3 id="核心模块"><a href="#核心模块" class="headerlink" title="核心模块"></a>核心模块</h3><ol><li><strong>文件验证模块</strong>：检查文件存在性、大小、格式等</li><li><strong>备注添加模块</strong>：处理备注页和直接备注两种方式</li><li><strong>文本处理模块</strong>：处理备注文本的格式和样式</li><li><strong>输出保存模块</strong>：保存修改后的PPTX文件</li></ol><h3 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h3><ol><li>验证输入文件的有效性</li><li>打开PPTX文件并创建幻灯片展示对象</li><li>获取目标幻灯片（默认第一张）</li><li>尝试添加备注到备注页</li><li>如果备注页不可用，使用备用方案</li><li>保存修改后的文件</li></ol><h2 id="技术架构"><a href="#技术架构" class="headerlink" title="技术架构"></a>技术架构</h2><h3 id="依赖库"><a href="#依赖库" class="headerlink" title="依赖库"></a>依赖库</h3><ul><li><strong>Apache POI</strong>：核心文档处理库</li><li><strong>POI-XSLF</strong>：PPTX文件处理扩展</li><li><strong>Lombok</strong>：简化Java代码</li><li><strong>Apache Commons Lang3</strong>：字符串处理工具</li></ul><h3 id="核心类设计"><a href="#核心类设计" class="headerlink" title="核心类设计"></a>核心类设计</h3><ul><li><strong>PptxTest</strong>：主类，包含主要的处理逻辑</li><li><strong>文件验证方法</strong>：<code>validatePptxFile()</code></li><li><strong>备注添加方法</strong>：<code>addNotesToSlide()</code></li><li><strong>文本框创建方法</strong>：<code>createNotesTextBox()</code></li><li><strong>直接备注方法</strong>：<code>addNotesToSlideDirectly()</code></li></ul><h3 id="异常处理策略"><a href="#异常处理策略" class="headerlink" title="异常处理策略"></a>异常处理策略</h3><ul><li>文件不存在或损坏的处理</li><li>备注页创建失败时的备用方案</li><li>文件保存失败的错误处理</li><li>资源释放的确保机制</li></ul><h2 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h2><h3 id="文件验证机制"><a href="#文件验证机制" class="headerlink" title="文件验证机制"></a>文件验证机制</h3><ul><li>检查文件是否存在</li><li>验证文件大小（非空文件）</li><li>检查文件头是否为ZIP格式（PPTX本质上是ZIP文件）</li><li>使用魔数验证文件格式</li></ul><h3 id="备注页处理策略"><a href="#备注页处理策略" class="headerlink" title="备注页处理策略"></a>备注页处理策略</h3><ol><li><strong>优先使用标准备注页</strong>：通过<code>getNotesSlide()</code>获取现有备注页</li><li><strong>占位符查找</strong>：查找备注体占位符（<code>Placeholder.BODY</code>）</li><li><strong>文本设置</strong>：在找到的占位符中设置备注文本</li><li><strong>备用文本框</strong>：如果没有占位符，创建新的文本框</li></ol><h3 id="直接备注方案"><a href="#直接备注方案" class="headerlink" title="直接备注方案"></a>直接备注方案</h3><p>当备注页不可用时，直接在幻灯片上添加备注文本框：</p><ul><li>设置合适的位置和大小</li><li>使用灰色字体区分备注内容</li><li>添加”备注：”前缀标识</li></ul><h3 id="样式设置"><a href="#样式设置" class="headerlink" title="样式设置"></a>样式设置</h3><ul><li>字体大小：备注页14pt，直接备注12pt</li><li>字体族：使用宋体确保中文显示</li><li>颜色：直接备注使用灰色</li><li>位置：合理布局避免遮挡主要内容</li></ul><h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cong.filetest.ppt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ooxml.POIXMLDocument;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.openxml4j.opc.OPCPackage;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.sl.usermodel.Placeholder;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xslf.usermodel.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> cong</span></span><br><span class="line"><span class="comment"> * 2025/8/22 18:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PptxTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">pptx</span> <span class="operator">=</span> <span class="string">&quot;/home/cong/Space/filetest/src/main/java/com/cong/filetest/ppt/etest.pptx&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">outPptx</span> <span class="operator">=</span> <span class="string">&quot;/home/cong/Space/filetest/src/main/java/com/cong/filetest/ppt/etest_out.pptx&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首先验证输入文件</span></span><br><span class="line">        <span class="keyword">if</span> (!validatePptxFile(pptx)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;输入文件无效或损坏，无法处理&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">OPCPackage</span> <span class="variable">opcPackage</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            opcPackage = POIXMLDocument.openPackage(pptx);</span><br><span class="line">            <span class="type">XMLSlideShow</span> <span class="variable">slideShow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLSlideShow</span>(opcPackage);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取第一张幻灯片（索引从0开始）</span></span><br><span class="line">            XSLFSlide slide;</span><br><span class="line">            <span class="keyword">if</span> (!slideShow.getSlides().isEmpty()) &#123;</span><br><span class="line">                slide = slideShow.getSlides().get(<span class="number">0</span>); <span class="comment">// 修复：从索引1改为索引0</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果没有幻灯片，创建一张新的</span></span><br><span class="line">                slide = slideShow.createSlide();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加备注到幻灯片</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">notesAdded</span> <span class="operator">=</span> addNotesToSlide(slideShow, slide, <span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (notesAdded) &#123;</span><br><span class="line">                <span class="comment">// 保存文件</span></span><br><span class="line">                <span class="keyword">try</span> (java.io.<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(outPptx)) &#123;</span><br><span class="line">                    slideShow.write(fos);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;PPT备注添加成功！输出文件：&quot;</span> + outPptx);</span><br><span class="line">                System.out.println(<span class="string">&quot;备注内容：hello world&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;请在PowerPoint中查看备注页（视图 -&gt; 备注页）来查看备注内容&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;无法在原始文件上添加备注，请检查文件结构&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;处理现有PPT文件时出错：&quot;</span> + e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(opcPackage)) &#123;</span><br><span class="line">                opcPackage.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证PPTX文件是否有效</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">validatePptxFile</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;文件不存在：&quot;</span> + filePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (file.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;文件为空：&quot;</span> + filePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查文件头是否为ZIP格式（PPTX是ZIP格式）</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">            <span class="type">byte</span>[] header = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span>];</span><br><span class="line">            <span class="keyword">if</span> (fis.read(header) != <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ZIP文件的魔数是 0x504B0304 或 0x504B0506 或 0x504B0708</span></span><br><span class="line">            <span class="keyword">return</span> header[<span class="number">0</span>] == <span class="number">0x50</span> &amp;&amp; header[<span class="number">1</span>] == <span class="number">0x4B</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;读取文件时出错：&quot;</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为幻灯片添加备注</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> slideShow 幻灯片展示</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> slide 目标幻灯片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notesText 备注文本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否成功添加备注</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">addNotesToSlide</span><span class="params">(XMLSlideShow slideShow, XSLFSlide slide, String notesText)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 尝试获取现有备注页，如果不存在则创建新的</span></span><br><span class="line">            <span class="type">XSLFNotes</span> <span class="variable">notesSlide</span> <span class="operator">=</span> slideShow.getNotesSlide(slide);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (notesSlide == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果备注页不存在，尝试通过其他方式创建</span></span><br><span class="line">                System.out.println(<span class="string">&quot;备注页不存在，尝试创建新的备注页...&quot;</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 使用反射或其他方式创建备注页</span></span><br><span class="line">                <span class="comment">// 这里我们先尝试在幻灯片上直接添加备注文本</span></span><br><span class="line">                addNotesToSlideDirectly(slide, notesText);</span><br><span class="line">                System.out.println(<span class="string">&quot;已在幻灯片上直接添加备注文本&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;找到现有备注页，正在添加备注内容...&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 查找备注页中的文本占位符</span></span><br><span class="line">            <span class="type">XSLFTextShape</span> <span class="variable">notesBody</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (XSLFTextShape placeholder : notesSlide.getPlaceholders()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (placeholder.getTextType() == Placeholder.BODY) &#123;</span><br><span class="line">                    notesBody = placeholder;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (notesBody != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果找到了备注体占位符，直接设置文本</span></span><br><span class="line">                notesBody.setText(notesText);</span><br><span class="line">                System.out.println(<span class="string">&quot;已在备注页占位符中添加备注内容&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果没有找到备注体占位符，创建一个文本框</span></span><br><span class="line">                System.out.println(<span class="string">&quot;未找到备注体占位符，创建新的文本框...&quot;</span>);</span><br><span class="line">                createNotesTextBox(notesSlide, notesText);</span><br><span class="line">                System.out.println(<span class="string">&quot;已在备注页创建文本框并添加备注内容&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;处理备注页时出错：&quot;</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 在幻灯片上直接添加备注文本作为备用方案</span></span><br><span class="line">                addNotesToSlideDirectly(slide, notesText);</span><br><span class="line">                System.out.println(<span class="string">&quot;已在幻灯片上直接添加备注文本（备用方案）&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;备用方案也失败：&quot;</span> + ex.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在备注页创建文本框</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createNotesTextBox</span><span class="params">(XSLFNotes notesSlide, String notesText)</span> &#123;</span><br><span class="line">        <span class="type">XSLFTextBox</span> <span class="variable">textBox</span> <span class="operator">=</span> notesSlide.createTextBox();</span><br><span class="line">        <span class="comment">// 设置文本框位置和大小（使用合理的默认值）</span></span><br><span class="line">        textBox.setAnchor(<span class="keyword">new</span> <span class="title class_">java</span>.awt.Rectangle(<span class="number">50</span>, <span class="number">100</span>, <span class="number">600</span>, <span class="number">400</span>));</span><br><span class="line">        textBox.setText(notesText);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置文本样式</span></span><br><span class="line">        <span class="type">XSLFTextParagraph</span> <span class="variable">paragraph</span> <span class="operator">=</span> textBox.getTextParagraphs().get(<span class="number">0</span>);</span><br><span class="line">        <span class="type">XSLFTextRun</span> <span class="variable">run</span> <span class="operator">=</span> paragraph.getTextRuns().get(<span class="number">0</span>);</span><br><span class="line">        run.setFontSize(<span class="number">14.0</span>);</span><br><span class="line">        run.setFontFamily(<span class="string">&quot;宋体&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 直接在幻灯片上添加备注文本</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addNotesToSlideDirectly</span><span class="params">(XSLFSlide slide, String notesText)</span> &#123;</span><br><span class="line">        <span class="type">XSLFTextBox</span> <span class="variable">noteBox</span> <span class="operator">=</span> slide.createTextBox();</span><br><span class="line">        noteBox.setAnchor(<span class="keyword">new</span> <span class="title class_">java</span>.awt.Rectangle(<span class="number">50</span>, <span class="number">500</span>, <span class="number">600</span>, <span class="number">100</span>));</span><br><span class="line">        noteBox.setText(<span class="string">&quot;备注：&quot;</span> + notesText);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置文本样式</span></span><br><span class="line">        <span class="type">XSLFTextParagraph</span> <span class="variable">paragraph</span> <span class="operator">=</span> noteBox.getTextParagraphs().get(<span class="number">0</span>);</span><br><span class="line">        <span class="type">XSLFTextRun</span> <span class="variable">run</span> <span class="operator">=</span> paragraph.getTextRuns().get(<span class="number">0</span>);</span><br><span class="line">        run.setFontSize(<span class="number">12.0</span>);</span><br><span class="line">        run.setFontFamily(<span class="string">&quot;宋体&quot;</span>);</span><br><span class="line">        run.setFontColor(java.awt.Color.GRAY);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;已在幻灯片上添加备注文本&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><h3 id="成功添加备注后的效果"><a href="#成功添加备注后的效果" class="headerlink" title="成功添加备注后的效果"></a>成功添加备注后的效果</h3><ul><li>在PowerPoint中打开生成的PPTX文件</li><li>切换到”备注页”视图（视图 → 备注页）</li><li>可以看到每张幻灯片下方都有相应的备注内容</li><li>备注内容清晰可读，格式规范</li></ul><h3 id="文件结构变化"><a href="#文件结构变化" class="headerlink" title="文件结构变化"></a>文件结构变化</h3><ul><li>原始PPTX文件保持不变</li><li>生成新的带备注的PPTX文件</li><li>文件大小略有增加（包含备注信息）</li><li>兼容性良好，可在各种PowerPoint版本中打开</li></ul><h2 id="示例展示"><a href="#示例展示" class="headerlink" title="示例展示"></a>示例展示</h2><h3 id="使用场景示例"><a href="#使用场景示例" class="headerlink" title="使用场景示例"></a>使用场景示例</h3><ol><li><strong>会议演示</strong>：为会议PPT自动添加关键要点备注</li><li><strong>培训材料</strong>：为培训PPT添加讲解要点和注意事项</li><li><strong>学术报告</strong>：为学术报告添加数据说明和引用信息</li><li><strong>产品介绍</strong>：为产品PPT添加销售话术和客户关注点</li></ol><h3 id="备注内容示例"><a href="#备注内容示例" class="headerlink" title="备注内容示例"></a>备注内容示例</h3><ul><li><strong>技术类PPT</strong>：技术要点、注意事项、扩展阅读</li><li><strong>商务类PPT</strong>：关键数据、市场分析、竞争对比</li><li><strong>教育类PPT</strong>：学习目标、重点难点、课后思考</li><li><strong>营销类PPT</strong>：产品优势、客户痛点、转化策略</li></ul><h3 id="批量处理示例"><a href="#批量处理示例" class="headerlink" title="批量处理示例"></a>批量处理示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 处理单个文件</span></span><br><span class="line">java -<span class="built_in">cp</span> . PptxTest input.pptx output.pptx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量处理目录中的所有PPTX文件</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> *.pptx; <span class="keyword">do</span></span><br><span class="line">    java -<span class="built_in">cp</span> . PptxTest <span class="string">&quot;<span class="variable">$file</span>&quot;</span> <span class="string">&quot;output_<span class="variable">$&#123;file&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="参考附录"><a href="#参考附录" class="headerlink" title="参考附录"></a>参考附录</h2><h3 id="相关技术文档"><a href="#相关技术文档" class="headerlink" title="相关技术文档"></a>相关技术文档</h3><ul><li><a href="https://poi.apache.org/">Apache POI官方文档</a></li><li><a href="https://poi.apache.org/slideshow/xslf-quick-guide.html">POI XSLF用户指南</a></li><li><a href="https://docs.microsoft.com/en-us/office/open-xml/open-xml-presentation">PPTX文件格式规范</a></li></ul><h3 id="扩展功能建议"><a href="#扩展功能建议" class="headerlink" title="扩展功能建议"></a>扩展功能建议</h3><ol><li><strong>AI内容分析</strong>：集成NLP服务分析PPT内容</li><li><strong>模板系统</strong>：支持不同类型的备注模板</li><li><strong>批量处理</strong>：支持目录级别的批量处理</li><li><strong>备注优化</strong>：根据演讲时长优化备注内容</li><li><strong>多语言支持</strong>：支持中英文等多种语言</li></ol><h3 id="性能优化建议"><a href="#性能优化建议" class="headerlink" title="性能优化建议"></a>性能优化建议</h3><ul><li>使用流式处理减少内存占用</li><li>实现增量更新避免重复处理</li><li>添加缓存机制提高处理速度</li><li>支持并行处理多个文件</li></ul><h3 id="常见问题解决"><a href="#常见问题解决" class="headerlink" title="常见问题解决"></a>常见问题解决</h3><ol><li><strong>文件损坏</strong>：使用文件验证机制提前发现</li><li><strong>备注页缺失</strong>：提供直接备注的备用方案</li><li><strong>格式不兼容</strong>：确保使用标准的POI API</li><li><strong>内存溢出</strong>：及时释放资源，使用try-with-resources</li></ol><h3 id="未来发展方向"><a href="#未来发展方向" class="headerlink" title="未来发展方向"></a>未来发展方向</h3><ul><li>集成大语言模型生成更智能的备注</li><li>支持更多Office文档格式（Word、Excel）</li><li>开发Web界面简化操作流程</li><li>提供云服务支持在线处理</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;AI给pptx文件添加演讲时的备注&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="https://qbmzc.github.io/categories/Java/"/>
    
    
    <category term="java" scheme="https://qbmzc.github.io/tags/java/"/>
    
    <category term="poi" scheme="https://qbmzc.github.io/tags/poi/"/>
    
    <category term="pptx" scheme="https://qbmzc.github.io/tags/pptx/"/>
    
  </entry>
  
  <entry>
    <title>PPT添加水印功能</title>
    <link href="https://qbmzc.github.io/2025/08/01/2025/08/011646/"/>
    <id>https://qbmzc.github.io/2025/08/01/2025/08/011646/</id>
    <published>2025-07-31T16:00:00.000Z</published>
    <updated>2025-11-21T06:36:31.566Z</updated>
    
    <content type="html"><![CDATA[<p>在Java中实现PPT添加水印功能，可以借助Apache POI库操作PPTX文件。以下是详细实现方案：</p><h3 id="核心思路"><a href="#核心思路" class="headerlink" title="核心思路"></a>核心思路</h3><ol><li>​<strong>使用母版添加水印</strong>​：在幻灯片母版中插入文本框</li><li>​<strong>样式控制</strong>​：设置文本透明度、旋转角度、位置</li><li>​<strong>跨平台兼容</strong>​：处理PPTX格式的现代Office文件</li></ol><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cong.filetest.ppt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.poi.util.Units;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xslf.usermodel.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.geom.Rectangle2D;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PPTWatermarkFix</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addWatermark</span><span class="params">(File input, File output, String text)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">XMLSlideShow</span> <span class="variable">ppt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLSlideShow</span>(Files.newInputStream(input.toPath()))) &#123;</span><br><span class="line">            <span class="type">Dimension</span> <span class="variable">pageSize</span> <span class="operator">=</span> ppt.getPageSize();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历所有母版</span></span><br><span class="line">            <span class="keyword">for</span> (XSLFSlideMaster master : ppt.getSlideMasters()) &#123;</span><br><span class="line">                <span class="comment">// 在所有版式上添加水印</span></span><br><span class="line">                <span class="keyword">for</span> (XSLFSlideLayout layout : master.getSlideLayouts()) &#123;</span><br><span class="line">                    addWatermarkToLayout(layout, text, pageSize);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(output)) &#123;</span><br><span class="line">                ppt.write(out);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addWatermarkToLayout</span><span class="params">(XSLFSlideLayout layout, String text, Dimension pageSize)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建文本框</span></span><br><span class="line">        <span class="type">XSLFTextBox</span> <span class="variable">watermark</span> <span class="operator">=</span> layout.createTextBox();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置水印文本</span></span><br><span class="line">        <span class="type">XSLFTextParagraph</span> <span class="variable">p</span> <span class="operator">=</span> watermark.addNewTextParagraph();</span><br><span class="line">        <span class="type">XSLFTextRun</span> <span class="variable">r</span> <span class="operator">=</span> p.addNewTextRun();</span><br><span class="line">        r.setText(text);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置水印样式</span></span><br><span class="line">        r.setFontSize(<span class="number">48.0</span>);</span><br><span class="line">        r.setFontColor(<span class="keyword">new</span> <span class="title class_">Color</span>(<span class="number">200</span>, <span class="number">200</span>, <span class="number">200</span>)); <span class="comment">// 浅灰色</span></span><br><span class="line">        r.setFontFamily(<span class="string">&quot;Arial&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重要：正确设置透明度 (0.7 = 70% 不透明 / 30% 透明)</span></span><br><span class="line">        r.getRPr(<span class="literal">true</span>).getSolidFill().getSrgbClr().addNewAlpha().setVal(<span class="number">70000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 居中定位 (使用百分比定位)</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">width</span> <span class="operator">=</span> Units.pointsToPixel(<span class="number">350</span>); <span class="comment">// 文本宽度</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">height</span> <span class="operator">=</span> Units.pointsToPixel(<span class="number">100</span>); <span class="comment">// 文本高度</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">centerX</span> <span class="operator">=</span> (pageSize.getWidth() - width) / <span class="number">2</span>;</span><br><span class="line">        <span class="type">double</span> <span class="variable">centerY</span> <span class="operator">=</span> (pageSize.getHeight() - height) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        watermark.setAnchor(<span class="keyword">new</span> <span class="title class_">Rectangle2D</span>.Double(</span><br><span class="line">                centerX, centerY, width, height</span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置旋转角度 (30度)</span></span><br><span class="line">        watermark.setRotation(-<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用示例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            addWatermark(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/home/cong/Space/filetest/src/test/java/com/cong/filetest/ppt/水印测试文件.pptx&quot;</span>),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/home/cong/Space/filetest/src/test/java/com/cong/filetest/ppt/output.pptx&quot;</span>),</span><br><span class="line">                    <span class="string">&quot;CONFIDENTIAL&quot;</span></span><br><span class="line">            );</span><br><span class="line">            System.out.println(<span class="string">&quot;水印添加成功！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;操作失败: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="关键实现说明"><a href="#关键实现说明" class="headerlink" title="关键实现说明"></a>关键实现说明</h3><ol><li><p>​<strong>母版定位</strong>​：</p><ul><li><code>getSlideMasters().get(0)</code> 获取第一张主母版</li><li><code>BLANK</code> 版式确保不影响已有布局（可根据需要改用 <code>TITLE_AND_CONTENT</code> 等）</li></ul></li><li><p>​<strong>水印特性</strong>​：</p><ul><li>透明度控制：通过 <code>setAlpha()</code> 方法设置RGB透明度值</li><li>旋转角度：<code>setRotation(30)</code> 实现30度倾斜效果</li><li>精确定位：<code>Rectangle2D.Double</code> 控制水印位置和大小</li></ul></li><li><p>​<strong>排除标题页</strong>​：</p><ul><li>默认只在普通版式添加水印</li><li>如需标题页水印，取消注释代码中的标题母版处理</li></ul></li><li><p>​<strong>样式扩展</strong>​：</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可添加的额外样式设置</span></span><br><span class="line">r.setBold(<span class="literal">true</span>);                       <span class="comment">// 粗体</span></span><br><span class="line">r.setFontFamily(<span class="string">&quot;Arial&quot;</span>);              <span class="comment">// 字体</span></span><br><span class="line">watermark.setLineWidth(<span class="number">0</span>);            <span class="comment">// 去除边框</span></span><br><span class="line">watermark.setFillColor(Color.RED);     <span class="comment">// 更改文字颜色</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li><p>​<strong>库依赖</strong>​：</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Maven 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>​<strong>兼容性问题</strong>​：</p><ul><li>仅支持PPTX格式（Office 2007+）</li><li>若需要支持PPT旧格式，需使用<code>HSLFSlideShow</code>，但功能受限</li></ul></li><li><p>​<strong>位置调整技巧</strong>​：</p><ul><li><p>使用<code>ppt.getPageSize().getWidth()/Height()</code>获取幻灯片尺寸</p></li><li><p>推荐居中定位公式：</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> <span class="variable">x</span> <span class="operator">=</span> (ppt.getPageSize().getWidth() - <span class="number">500</span>) / <span class="number">2</span>;</span><br><span class="line"><span class="type">double</span> <span class="variable">y</span> <span class="operator">=</span> (ppt.getPageSize().getHeight() - <span class="number">100</span>) / <span class="number">2</span>;</span><br></pre></td></tr></table></figure></li></ul></li></ol><p>此方法生成的PPT水印具有Office原生水印特性：</p><ul><li>无法被普通用户直接删除（需进入母版视图）</li><li>自动应用至所有匹配版式的幻灯片</li><li>保留矢量特性可无损缩放</li></ul><h2 id="参考方案"><a href="#参考方案" class="headerlink" title="参考方案"></a><a href="https://support.microsoft.com/zh-cn/office/%E5%90%91%E5%B9%BB%E7%81%AF%E7%89%87%E6%B7%BB%E5%8A%A0%E6%B0%B4%E5%8D%B0-1246244d-f465-4e4f-b9f9-49acdae00ff1">参考方案</a></h2><blockquote><p>在 PowerPoint 中，可以在幻灯片中放置文本背景以获取该水印效果。</p><ol><li>若要向所有幻灯片添加水印，选择“<strong>视图</strong>”&gt;“<strong>幻灯片母版</strong>”。 滚动到左侧缩略图窗格的顶部，选择第一项“幻灯片母版”。</li></ol></blockquote><blockquote><ol start="2"><li>选择“<strong>插入</strong>”&gt;“<strong>文本框</strong>”，然后在幻灯片母版上单击并拖动鼠标，画出文本框。</li></ol></blockquote><blockquote><ol start="3"><li>在文本框中键入水印文本 (，例如“DRAFT”、“CONFIDENTIAL”或公司名称) 。</li></ol></blockquote><blockquote><ol start="4"><li>若要更改水印文本的对齐方式，请在文本框顶部单击并按住旋转图柄，然后向左或向右移动鼠标。</li></ol></blockquote><blockquote><ol start="5"><li>选中文本框中的文本。 选择浅色字体填充颜色，然后对字体和样式进行任何其他更改。 (如果看不到“ <strong>格式</strong> ”选项卡，请确保已选择文本框。)</li></ol></blockquote><blockquote><ol start="6"><li>退出“<strong>幻灯片母版</strong>”。 除标题页外的所有幻灯片都会具有该文本。</li></ol></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;在Java中实现PPT添加水印功能，可以借助Apache POI库操作PPTX文件。以下是详细实现方案：&lt;/p&gt;
&lt;h3 id=&quot;核心思路&quot;&gt;&lt;a href=&quot;#核心思路&quot; class=&quot;headerlink&quot; title=&quot;核心思路&quot;&gt;&lt;/a&gt;核心思路&lt;/h3&gt;&lt;ol&gt;
</summary>
      
    
    
    
    <category term="Java" scheme="https://qbmzc.github.io/categories/Java/"/>
    
    
    <category term="poi" scheme="https://qbmzc.github.io/tags/poi/"/>
    
  </entry>
  
  <entry>
    <title>onlyoffice字体加载慢的解决方案</title>
    <link href="https://qbmzc.github.io/2025/07/25/2025/07/251808/"/>
    <id>https://qbmzc.github.io/2025/07/25/2025/07/251808/</id>
    <published>2025-07-25T10:09:09.000Z</published>
    <updated>2025-11-21T06:36:31.566Z</updated>
    
    <content type="html"><![CDATA[<p>OnlyOffice作为一款优秀的开源办公套件，在Docker部署环境中经常遇到字体加载缓慢的问题。本文将介绍一种高效的静态文件托管优化方案，通过OSS&#x2F;CDN加速解决字体加载瓶颈。</p><span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>OnlyOffice在Docker容器中运行时，首次加载需要从服务器下载大量字体文件，这个过程往往耗时很长，严重影响用户体验。特别是在网络环境不佳的情况下，字体下载可能需要几十秒甚至更长时间。</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>字体加载慢的核心问题：</p><ul><li><strong>Docker容器内字体文件体积大</strong> - 单个字体文件可达几MB，总体积可能超过100MB</li><li><strong>网络带宽限制</strong> - 服务器带宽有限，多用户同时访问时更加缓慢</li><li><strong>缺乏CDN加速</strong> - 字体文件直接从应用服务器加载，没有利用CDN优势</li><li><strong>无缓存机制</strong> - 每次重启容器都需要重新下载字体</li></ul><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>通过静态文件托管优化，实现：</p><ul><li>将字体加载时间从30-60秒降至3-5秒</li><li>利用OSS&#x2F;CDN的全球加速能力</li><li>减轻应用服务器带宽压力</li><li>提供稳定可靠的字体服务</li></ul><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>核心思路是将体积较大的字体&#x2F;JS文件迁移至高速存储（如OSS&#x2F;CDN），通过Nginx转发请求，避免服务器直连加载瓶颈。</p><h2 id="静态文件托管优化方案（推荐）"><a href="#静态文件托管优化方案（推荐）" class="headerlink" title="静态文件托管优化方案（推荐）"></a>静态文件托管优化方案（推荐）</h2><h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><h4 id="步骤一：定位静态文件"><a href="#步骤一：定位静态文件" class="headerlink" title="步骤一：定位静态文件"></a>步骤一：定位静态文件</h4><p>进入Docker容器查找字体目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入OnlyOffice容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it [容器名] bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找字体文件位置</span></span><br><span class="line"><span class="built_in">ls</span> /var/www/onlyoffice/documentserver/fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认字体文件路径和大小</span></span><br><span class="line"><span class="built_in">du</span> -sh /var/www/onlyoffice/documentserver/fonts/*</span><br></pre></td></tr></table></figure><p>常见字体目录结构：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/var/www/onlyoffice/documentserver/fonts/</span><br><span class="line">├── truetype/</span><br><span class="line">│   ├── arial.ttf</span><br><span class="line">│   ├── calibri.ttf</span><br><span class="line">│   ├── times.ttf</span><br><span class="line">│   └── ...</span><br><span class="line">├── opentype/</span><br><span class="line">│   └── ...</span><br><span class="line">└── web/</span><br><span class="line">    ├── *.woff</span><br><span class="line">    └── *.woff2</span><br></pre></td></tr></table></figure><h4 id="步骤二：上传至OSS-CDN"><a href="#步骤二：上传至OSS-CDN" class="headerlink" title="步骤二：上传至OSS&#x2F;CDN"></a>步骤二：上传至OSS&#x2F;CDN</h4><p>将容器内字体复制到宿主机：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复制字体文件到宿主机</span></span><br><span class="line">docker <span class="built_in">cp</span> [容器名]:/var/www/onlyoffice/documentserver/fonts /tmp/onlyoffice_fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件大小</span></span><br><span class="line"><span class="built_in">du</span> -sh /tmp/onlyoffice_fonts</span><br><span class="line"><span class="comment"># 输出示例：128M    /tmp/onlyoffice_fonts</span></span><br></pre></td></tr></table></figure><p>上传至阿里云OSS（示例）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装阿里云CLI工具</span></span><br><span class="line">wget https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz</span><br><span class="line">tar -xzf aliyun-cli-linux-latest-amd64.tgz</span><br><span class="line">sudo <span class="built_in">mv</span> aliyun /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置OSS访问</span></span><br><span class="line">aliyun configure <span class="built_in">set</span> \</span><br><span class="line">  --profile default \</span><br><span class="line">  --mode AK \</span><br><span class="line">  --region cn-shanghai \</span><br><span class="line">  --access-key-id [your-access-key] \</span><br><span class="line">  --access-key-secret [your-secret-key]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传字体文件</span></span><br><span class="line">aliyun oss <span class="built_in">cp</span> /tmp/onlyoffice_fonts oss://your-bucket/fonts/ --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置公共读权限</span></span><br><span class="line">aliyun oss set-acl oss://your-bucket/fonts/ --acl public-read --recursive</span><br></pre></td></tr></table></figure><h4 id="步骤三：修改Nginx配置"><a href="#步骤三：修改Nginx配置" class="headerlink" title="步骤三：修改Nginx配置"></a>步骤三：修改Nginx配置</h4><p>编辑容器内Nginx配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it [容器名] bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份原配置</span></span><br><span class="line"><span class="built_in">cp</span> /etc/nginx/includes/ds-docservice.conf /etc/nginx/includes/ds-docservice.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">vi /etc/nginx/includes/ds-docservice.conf</span><br></pre></td></tr></table></figure><p>添加字体重定向规则：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在现有配置中添加以下规则</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ /[0-9]+\.[0-9]+\.[0-9]+/fonts/(.*)</span> &#123;</span><br><span class="line">    <span class="comment"># 重定向到OSS CDN</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/<span class="variable">$1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用代理方式（推荐）</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ /[0-9]+\.[0-9]+\.[0-9]+/fonts/(.*)</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/<span class="variable">$1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host your-bucket.oss-cn-shanghai.aliyuncs.com;</span><br><span class="line">    <span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">1d</span>;</span><br><span class="line">    <span class="attribute">proxy_cache_key</span> <span class="variable">$uri</span>;</span><br><span class="line">    <span class="attribute">add_header</span> X-Cache-Status <span class="variable">$upstream_cache_status</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="步骤四：重启服务"><a href="#步骤四：重启服务" class="headerlink" title="步骤四：重启服务"></a>步骤四：重启服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新加载Nginx配置</span></span><br><span class="line">docker <span class="built_in">exec</span> [容器名] nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启容器以确保配置生效</span></span><br><span class="line">docker restart [容器名]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证配置</span></span><br><span class="line">docker <span class="built_in">exec</span> [容器名] nginx -t</span><br></pre></td></tr></table></figure><h3 id="高级配置"><a href="#高级配置" class="headerlink" title="高级配置"></a>高级配置</h3><h4 id="OSS跨域配置"><a href="#OSS跨域配置" class="headerlink" title="OSS跨域配置"></a>OSS跨域配置</h4><p>在阿里云OSS控制台设置跨域规则：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CORSRule&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;AllowedOrigin&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;AllowedMethod&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GET&quot;</span><span class="punctuation">,</span> <span class="string">&quot;HEAD&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;AllowedHeader&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ExposeHeader&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;ETag&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Content-Length&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;MaxAgeSeconds&quot;</span><span class="punctuation">:</span> <span class="number">3600</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="CDN缓存优化"><a href="#CDN缓存优化" class="headerlink" title="CDN缓存优化"></a>CDN缓存优化</h4><p>配置CDN缓存规则：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 字体文件缓存1年</span></span><br><span class="line">*.ttf,*.otf,*.woff,*.woff2 -&gt; Cache-Control: max-age=31536000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用Gzip压缩</span></span><br><span class="line">Content-Type: font/* -&gt; Gzip: on</span><br></pre></td></tr></table></figure><h4 id="容器启动脚本优化"><a href="#容器启动脚本优化" class="headerlink" title="容器启动脚本优化"></a>容器启动脚本优化</h4><p>创建启动脚本自动配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># font-cdn-setup.sh</span></span><br><span class="line"></span><br><span class="line">CONTAINER_NAME=<span class="string">&quot;onlyoffice&quot;</span></span><br><span class="line">OSS_ENDPOINT=<span class="string">&quot;https://your-bucket.oss-cn-shanghai.aliyuncs.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;配置OnlyOffice字体CDN重定向...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器是否运行</span></span><br><span class="line"><span class="keyword">if</span> ! docker ps | grep -q <span class="variable">$CONTAINER_NAME</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;错误：容器 <span class="variable">$CONTAINER_NAME</span> 未运行&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份配置文件</span></span><br><span class="line">docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> <span class="built_in">cp</span> /etc/nginx/includes/ds-docservice.conf /etc/nginx/includes/ds-docservice.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加重定向规则</span></span><br><span class="line">docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> bash -c <span class="string">&quot;cat &gt;&gt; /etc/nginx/includes/ds-docservice.conf &lt;&lt; &#x27;EOF&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 字体CDN重定向</span></span><br><span class="line"><span class="string">location ~ /[0-9]+\.[0-9]+\.[0-9]+/fonts/(.*) &#123;</span></span><br><span class="line"><span class="string">    proxy_pass <span class="variable">$OSS_ENDPOINT</span>/fonts/\$1;</span></span><br><span class="line"><span class="string">    proxy_set_header Host your-bucket.oss-cn-shanghai.aliyuncs.com;</span></span><br><span class="line"><span class="string">    proxy_cache_valid 200 1d;</span></span><br><span class="line"><span class="string">    proxy_cache_key \$uri;</span></span><br><span class="line"><span class="string">    add_header X-Cache-Status \$upstream_cache_status;</span></span><br><span class="line"><span class="string">    add_header Access-Control-Allow-Origin &#x27;*&#x27;;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载配置</span></span><br><span class="line">docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;配置完成！字体文件将从CDN加载&quot;</span></span><br></pre></td></tr></table></figure><h2 id="技术架构"><a href="#技术架构" class="headerlink" title="技术架构"></a>技术架构</h2><h3 id="静态文件托管架构"><a href="#静态文件托管架构" class="headerlink" title="静态文件托管架构"></a>静态文件托管架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[用户请求文档] --&gt; B[OnlyOffice容器]</span><br><span class="line">    B --&gt; C[Nginx代理]</span><br><span class="line">    C --&gt; D&#123;字体请求检测&#125;</span><br><span class="line">    D --&gt;|字体文件| E[重定向到OSS]</span><br><span class="line">    D --&gt;|其他文件| F[本地处理]</span><br><span class="line">    E --&gt; G[阿里云OSS]</span><br><span class="line">    G --&gt; H[CDN加速]</span><br><span class="line">    H --&gt; I[全球节点分发]</span><br><span class="line">    I --&gt; J[用户快速获取字体]</span><br><span class="line">    F --&gt; K[正常文档渲染]</span><br><span class="line">    J --&gt; K</span><br><span class="line">    K --&gt; L[完整文档显示]</span><br></pre></td></tr></table></figure><h3 id="优化前后对比"><a href="#优化前后对比" class="headerlink" title="优化前后对比"></a>优化前后对比</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    subgraph &quot;优化前&quot;</span><br><span class="line">        A1[用户请求] --&gt; B1[OnlyOffice]</span><br><span class="line">        B1 --&gt; C1[本地字体加载]</span><br><span class="line">        C1 --&gt; D1[30-60秒等待]</span><br><span class="line">        D1 --&gt; E1[文档显示]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph &quot;优化后&quot;</span><br><span class="line">        A2[用户请求] --&gt; B2[OnlyOffice]</span><br><span class="line">        B2 --&gt; C2[Nginx重定向]</span><br><span class="line">        C2 --&gt; D2[OSS/CDN加速]</span><br><span class="line">        D2 --&gt; E2[3-5秒完成]</span><br><span class="line">        E2 --&gt; F2[文档显示]</span><br><span class="line">    end</span><br></pre></td></tr></table></figure><h2 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h2><h3 id="1-自动化部署脚本"><a href="#1-自动化部署脚本" class="headerlink" title="1. 自动化部署脚本"></a>1. 自动化部署脚本</h3><h4 id="完整的字体迁移脚本"><a href="#完整的字体迁移脚本" class="headerlink" title="完整的字体迁移脚本"></a>完整的字体迁移脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># onlyoffice-font-migration.sh</span></span><br><span class="line"><span class="comment"># OnlyOffice字体文件OSS迁移脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置参数</span></span><br><span class="line">CONTAINER_NAME=<span class="string">&quot;onlyoffice&quot;</span></span><br><span class="line">OSS_BUCKET=<span class="string">&quot;your-bucket&quot;</span></span><br><span class="line">OSS_REGION=<span class="string">&quot;cn-shanghai&quot;</span></span><br><span class="line">OSS_ENDPOINT=<span class="string">&quot;oss-<span class="variable">$&#123;OSS_REGION&#125;</span>.aliyuncs.com&quot;</span></span><br><span class="line">TEMP_DIR=<span class="string">&quot;/tmp/onlyoffice_fonts&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== OnlyOffice字体文件OSS迁移工具 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器状态</span></span><br><span class="line"><span class="function"><span class="title">check_container</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> ! docker ps | grep -q <span class="variable">$CONTAINER_NAME</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;错误：容器 <span class="variable">$CONTAINER_NAME</span> 未运行&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 容器状态检查通过&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取字体文件</span></span><br><span class="line"><span class="function"><span class="title">extract_fonts</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;正在提取字体文件...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 清理临时目录</span></span><br><span class="line">    <span class="built_in">rm</span> -rf <span class="variable">$TEMP_DIR</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="variable">$TEMP_DIR</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 复制字体文件</span></span><br><span class="line">    docker <span class="built_in">cp</span> <span class="variable">$CONTAINER_NAME</span>:/var/www/onlyoffice/documentserver/fonts <span class="variable">$TEMP_DIR</span>/</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 统计文件信息</span></span><br><span class="line">    FONT_COUNT=$(find <span class="variable">$TEMP_DIR</span> -name <span class="string">&quot;*.ttf&quot;</span> -o -name <span class="string">&quot;*.otf&quot;</span> -o -name <span class="string">&quot;*.woff&quot;</span> -o -name <span class="string">&quot;*.woff2&quot;</span> | <span class="built_in">wc</span> -l)</span><br><span class="line">    FONT_SIZE=$(<span class="built_in">du</span> -sh <span class="variable">$TEMP_DIR</span> | <span class="built_in">cut</span> -f1)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 提取完成：<span class="variable">$FONT_COUNT</span> 个字体文件，总大小 <span class="variable">$FONT_SIZE</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传到OSS</span></span><br><span class="line"><span class="function"><span class="title">upload_to_oss</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;正在上传到阿里云OSS...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查阿里云CLI</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v aliyun &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;错误：请先安装阿里云CLI工具&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 上传文件</span></span><br><span class="line">    aliyun oss <span class="built_in">cp</span> <span class="variable">$TEMP_DIR</span>/fonts oss://<span class="variable">$OSS_BUCKET</span>/fonts/ --recursive --force</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 设置公共读权限</span></span><br><span class="line">    aliyun oss set-acl oss://<span class="variable">$OSS_BUCKET</span>/fonts/ --acl public-read --recursive</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 上传完成：https://<span class="variable">$OSS_BUCKET</span>.<span class="variable">$OSS_ENDPOINT</span>/fonts/&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Nginx重定向</span></span><br><span class="line"><span class="function"><span class="title">configure_nginx</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;正在配置Nginx重定向...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 备份原配置</span></span><br><span class="line">    docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> <span class="built_in">cp</span> /etc/nginx/includes/ds-docservice.conf /etc/nginx/includes/ds-docservice.conf.bak</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加重定向规则</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; /tmp/font-redirect.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># 字体文件OSS重定向</span></span><br><span class="line"><span class="string">location ~ /[0-9]+\.[0-9]+\.[0-9]+/fonts/(.*) &#123;</span></span><br><span class="line"><span class="string">    proxy_pass https://$OSS_BUCKET.$OSS_ENDPOINT/fonts/\$1;</span></span><br><span class="line"><span class="string">    proxy_set_header Host $OSS_BUCKET.$OSS_ENDPOINT;</span></span><br><span class="line"><span class="string">    proxy_cache_valid 200 7d;</span></span><br><span class="line"><span class="string">    proxy_cache_key \$uri;</span></span><br><span class="line"><span class="string">    add_header X-Cache-Status \$upstream_cache_status;</span></span><br><span class="line"><span class="string">    add_header Access-Control-Allow-Origin &#x27;*&#x27;;</span></span><br><span class="line"><span class="string">    add_header Cache-Control &#x27;public, max-age=604800&#x27;;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将配置添加到容器</span></span><br><span class="line">    docker <span class="built_in">cp</span> /tmp/font-redirect.conf <span class="variable">$CONTAINER_NAME</span>:/tmp/</span><br><span class="line">    docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> bash -c <span class="string">&quot;cat /tmp/font-redirect.conf &gt;&gt; /etc/nginx/includes/ds-docservice.conf&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试并重载配置</span></span><br><span class="line">    docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> nginx -t</span><br><span class="line">    docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> nginx -s reload</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ Nginx配置完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证配置</span></span><br><span class="line"><span class="function"><span class="title">verify_setup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;正在验证配置...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试字体文件访问</span></span><br><span class="line">    TEST_URL=<span class="string">&quot;https://<span class="variable">$OSS_BUCKET</span>.<span class="variable">$OSS_ENDPOINT</span>/fonts/truetype/arial.ttf&quot;</span></span><br><span class="line">    <span class="keyword">if</span> curl -s --<span class="built_in">head</span> <span class="variable">$TEST_URL</span> | grep -q <span class="string">&quot;200 OK&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;✓ 字体文件访问正常&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;⚠ 警告：字体文件访问可能有问题&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重启容器验证</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;重启容器进行最终验证...&quot;</span></span><br><span class="line">    docker restart <span class="variable">$CONTAINER_NAME</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 等待容器启动</span></span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 配置验证完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理临时文件</span></span><br><span class="line"><span class="function"><span class="title">cleanup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;清理临时文件...&quot;</span></span><br><span class="line">    <span class="built_in">rm</span> -rf <span class="variable">$TEMP_DIR</span></span><br><span class="line">    <span class="built_in">rm</span> -f /tmp/font-redirect.conf</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 清理完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主流程</span></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    check_container</span><br><span class="line">    extract_fonts</span><br><span class="line">    upload_to_oss</span><br><span class="line">    configure_nginx</span><br><span class="line">    verify_setup</span><br><span class="line">    cleanup</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 迁移完成 ===&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;字体文件已成功迁移到OSS，访问速度将显著提升！&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;OSS地址：https://<span class="variable">$OSS_BUCKET</span>.<span class="variable">$OSS_ENDPOINT</span>/fonts/&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行主流程</span></span><br><span class="line">main <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-监控和维护"><a href="#2-监控和维护" class="headerlink" title="2. 监控和维护"></a>2. 监控和维护</h3><h4 id="字体加载性能监控脚本"><a href="#字体加载性能监控脚本" class="headerlink" title="字体加载性能监控脚本"></a>字体加载性能监控脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># font-performance-monitor.sh</span></span><br><span class="line"><span class="comment"># 字体加载性能监控脚本</span></span><br><span class="line"></span><br><span class="line">CONTAINER_NAME=<span class="string">&quot;onlyoffice&quot;</span></span><br><span class="line">LOG_FILE=<span class="string">&quot;/var/log/onlyoffice-font-monitor.log&quot;</span></span><br><span class="line">OSS_ENDPOINT=<span class="string">&quot;your-bucket.oss-cn-shanghai.aliyuncs.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控字体加载时间</span></span><br><span class="line"><span class="function"><span class="title">monitor_font_loading</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: 开始监控字体加载性能&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试常用字体加载时间</span></span><br><span class="line">    fonts=(<span class="string">&quot;arial.ttf&quot;</span> <span class="string">&quot;calibri.ttf&quot;</span> <span class="string">&quot;times.ttf&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> font <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;fonts[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">        start_time=$(<span class="built_in">date</span> +%s.%N)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试字体文件访问</span></span><br><span class="line">        <span class="keyword">if</span> curl -s -o /dev/null -w <span class="string">&quot;%&#123;http_code&#125;&quot;</span> <span class="string">&quot;https://<span class="variable">$OSS_ENDPOINT</span>/fonts/truetype/<span class="variable">$font</span>&quot;</span> | grep -q <span class="string">&quot;200&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            end_time=$(<span class="built_in">date</span> +%s.%N)</span><br><span class="line">            load_time=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$end_time</span> - <span class="variable">$start_time</span>&quot;</span> | bc)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: <span class="variable">$font</span> 加载时间: <span class="variable">$&#123;load_time&#125;</span>s&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: <span class="variable">$font</span> 加载失败&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器状态</span></span><br><span class="line"><span class="function"><span class="title">check_container_health</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> docker ps | grep -q <span class="variable">$CONTAINER_NAME</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: 容器状态正常&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date)</span>: 容器状态异常&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主监控循环</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    monitor_font_loading</span><br><span class="line">    check_container_health</span><br><span class="line">    <span class="built_in">sleep</span> 300  <span class="comment"># 每5分钟检查一次</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="3-故障排查工具"><a href="#3-故障排查工具" class="headerlink" title="3. 故障排查工具"></a>3. 故障排查工具</h3><h4 id="诊断脚本"><a href="#诊断脚本" class="headerlink" title="诊断脚本"></a>诊断脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># font-diagnostic.sh</span></span><br><span class="line"><span class="comment"># 字体加载问题诊断工具</span></span><br><span class="line"></span><br><span class="line">CONTAINER_NAME=<span class="string">&quot;onlyoffice&quot;</span></span><br><span class="line">OSS_ENDPOINT=<span class="string">&quot;your-bucket.oss-cn-shanghai.aliyuncs.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== OnlyOffice字体加载诊断工具 ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器状态</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1. 检查容器状态...&quot;</span></span><br><span class="line"><span class="keyword">if</span> docker ps | grep -q <span class="variable">$CONTAINER_NAME</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 容器运行正常&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✗ 容器未运行&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查Nginx配置</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;2. 检查Nginx配置...&quot;</span></span><br><span class="line"><span class="keyword">if</span> docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> nginx -t 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ Nginx配置语法正确&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✗ Nginx配置有误&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查字体重定向规则</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;3. 检查字体重定向规则...&quot;</span></span><br><span class="line"><span class="keyword">if</span> docker <span class="built_in">exec</span> <span class="variable">$CONTAINER_NAME</span> grep -q <span class="string">&quot;fonts.*proxy_pass&quot;</span> /etc/nginx/includes/ds-docservice.conf; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✓ 字体重定向规则已配置&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✗ 字体重定向规则缺失&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试OSS访问</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;4. 测试OSS字体文件访问...&quot;</span></span><br><span class="line">test_fonts=(<span class="string">&quot;arial.ttf&quot;</span> <span class="string">&quot;calibri.ttf&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> font <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;test_fonts[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    url=<span class="string">&quot;https://<span class="variable">$OSS_ENDPOINT</span>/fonts/truetype/<span class="variable">$font</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> curl -s --<span class="built_in">head</span> <span class="string">&quot;<span class="variable">$url</span>&quot;</span> | grep -q <span class="string">&quot;200 OK&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;✓ <span class="variable">$font</span> 访问正常&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;✗ <span class="variable">$font</span> 访问失败&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器日志</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;5. 检查最近的错误日志...&quot;</span></span><br><span class="line">docker logs <span class="variable">$CONTAINER_NAME</span> --<span class="built_in">tail</span> 20 | grep -i error || <span class="built_in">echo</span> <span class="string">&quot;✓ 无明显错误&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 诊断完成 ===&quot;</span></span><br></pre></td></tr></table></figure><h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><h3 id="Docker-Compose一键部署"><a href="#Docker-Compose一键部署" class="headerlink" title="Docker Compose一键部署"></a>Docker Compose一键部署</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">onlyoffice:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">onlyoffice/documentserver:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">onlyoffice</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/var/www/onlyoffice/Data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/var/log/onlyoffice</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-custom.conf:/etc/nginx/includes/ds-docservice-custom.conf</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ONLYOFFICE_HTTPS_HSTS_ENABLED=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JWT_ENABLED=false</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 可选：本地字体代理服务</span></span><br><span class="line">  <span class="attr">font-proxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">font-proxy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-proxy.conf:/etc/nginx/conf.d/default.conf</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><h3 id="Nginx配置模板"><a href="#Nginx配置模板" class="headerlink" title="Nginx配置模板"></a>Nginx配置模板</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx-custom.conf</span></span><br><span class="line"><span class="comment"># 字体文件重定向配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重定向到OSS</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ /[0-9]+\.[0-9]+\.[0-9]+/fonts/(.*)</span> &#123;</span><br><span class="line">    <span class="comment"># 方案1：直接重定向（推荐）</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/<span class="variable">$1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 方案2：代理转发（备选）</span></span><br><span class="line">    <span class="comment"># proxy_pass https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/$1;</span></span><br><span class="line">    <span class="comment"># proxy_set_header Host your-bucket.oss-cn-shanghai.aliyuncs.com;</span></span><br><span class="line">    <span class="comment"># proxy_cache_valid 200 7d;</span></span><br><span class="line">    <span class="comment"># add_header X-Cache-Status $upstream_cache_status;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 静态资源优化</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$</span> &#123;</span><br><span class="line">    <span class="attribute">expires</span> <span class="number">1y</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Cache-Control <span class="string">&quot;public, immutable&quot;</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Origin <span class="string">&quot;*&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字体文件CORS支持</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* \.(ttf|otf|woff|woff2|eot)$</span> &#123;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Origin <span class="string">&quot;*&quot;</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Methods <span class="string">&quot;GET, OPTIONS&quot;</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Headers <span class="string">&quot;Range&quot;</span>;</span><br><span class="line">    <span class="attribute">expires</span> <span class="number">1y</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自动化运维脚本"><a href="#自动化运维脚本" class="headerlink" title="自动化运维脚本"></a>自动化运维脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># font_optimizer.py</span></span><br><span class="line"><span class="comment"># OnlyOffice字体优化自动化脚本</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OnlyOfficeFontOptimizer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, container_name=<span class="string">&quot;onlyoffice&quot;</span>, oss_bucket=<span class="string">&quot;your-bucket&quot;</span></span>):</span><br><span class="line">        self.container_name = container_name</span><br><span class="line">        self.oss_bucket = oss_bucket</span><br><span class="line">        self.oss_endpoint = <span class="string">f&quot;https://<span class="subst">&#123;oss_bucket&#125;</span>.oss-cn-shanghai.aliyuncs.com&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_container_status</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查容器状态&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = subprocess.run(</span><br><span class="line">                [<span class="string">&quot;docker&quot;</span>, <span class="string">&quot;ps&quot;</span>, <span class="string">&quot;--filter&quot;</span>, <span class="string">f&quot;name=<span class="subst">&#123;self.container_name&#125;</span>&quot;</span>, <span class="string">&quot;--format&quot;</span>, <span class="string">&quot;&#123;&#123;.Status&#125;&#125;&quot;</span>],</span><br><span class="line">                capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, check=<span class="literal">True</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Up&quot;</span> <span class="keyword">in</span> result.stdout</span><br><span class="line">        <span class="keyword">except</span> subprocess.CalledProcessError:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_fonts</span>(<span class="params">self, temp_dir=<span class="string">&quot;/tmp/onlyoffice_fonts&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;提取字体文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;正在提取字体文件...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清理并创建临时目录</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(temp_dir):</span><br><span class="line">            subprocess.run([<span class="string">&quot;rm&quot;</span>, <span class="string">&quot;-rf&quot;</span>, temp_dir])</span><br><span class="line">        os.makedirs(temp_dir)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 从容器复制字体文件</span></span><br><span class="line">        subprocess.run([</span><br><span class="line">            <span class="string">&quot;docker&quot;</span>, <span class="string">&quot;cp&quot;</span>, </span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;self.container_name&#125;</span>:/var/www/onlyoffice/documentserver/fonts&quot;</span>,</span><br><span class="line">            temp_dir</span><br><span class="line">        ], check=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 统计文件信息</span></span><br><span class="line">        font_files = <span class="built_in">list</span>(Path(temp_dir).rglob(<span class="string">&quot;*.ttf&quot;</span>)) + \</span><br><span class="line">                    <span class="built_in">list</span>(Path(temp_dir).rglob(<span class="string">&quot;*.otf&quot;</span>)) + \</span><br><span class="line">                    <span class="built_in">list</span>(Path(temp_dir).rglob(<span class="string">&quot;*.woff*&quot;</span>))</span><br><span class="line">        </span><br><span class="line">        total_size = <span class="built_in">sum</span>(f.stat().st_size <span class="keyword">for</span> f <span class="keyword">in</span> font_files)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;✓ 提取完成：<span class="subst">&#123;<span class="built_in">len</span>(font_files)&#125;</span> 个字体文件，总大小 <span class="subst">&#123;total_size/<span class="number">1024</span>/<span class="number">1024</span>:<span class="number">.1</span>f&#125;</span>MB&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> temp_dir, <span class="built_in">len</span>(font_files), total_size</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_font_access</span>(<span class="params">self, font_path=<span class="string">&quot;fonts/truetype/arial.ttf&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;测试字体文件访问&quot;&quot;&quot;</span></span><br><span class="line">        test_url = <span class="string">f&quot;<span class="subst">&#123;self.oss_endpoint&#125;</span>/<span class="subst">&#123;font_path&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            response = requests.head(test_url, timeout=<span class="number">10</span>)</span><br><span class="line">            load_time = time.time() - start_time</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✓ 字体访问正常，响应时间: <span class="subst">&#123;load_time:<span class="number">.2</span>f&#125;</span>s&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span>, load_time</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;✗ 字体访问失败，状态码: <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">except</span> requests.RequestException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;✗ 字体访问异常: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">configure_nginx_redirect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;配置Nginx重定向&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;正在配置Nginx重定向...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        redirect_config = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># 字体文件OSS重定向 - 自动生成于 <span class="subst">&#123;time.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)&#125;</span></span></span><br><span class="line"><span class="string">location ~ /[0-9]+\\.[0-9]+\\.[0-9]+/fonts/(.*) &#123;&#123;</span></span><br><span class="line"><span class="string">    return 301 <span class="subst">&#123;self.oss_endpoint&#125;</span>/fonts/$1;</span></span><br><span class="line"><span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 写入临时配置文件</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/tmp/font-redirect.conf&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(redirect_config)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 复制到容器并追加到配置文件</span></span><br><span class="line">        subprocess.run([</span><br><span class="line">            <span class="string">&quot;docker&quot;</span>, <span class="string">&quot;cp&quot;</span>, <span class="string">&quot;/tmp/font-redirect.conf&quot;</span>, </span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;self.container_name&#125;</span>:/tmp/&quot;</span></span><br><span class="line">        ], check=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        subprocess.run([</span><br><span class="line">            <span class="string">&quot;docker&quot;</span>, <span class="string">&quot;exec&quot;</span>, self.container_name, <span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;cat /tmp/font-redirect.conf &gt;&gt; /etc/nginx/includes/ds-docservice.conf&quot;</span></span><br><span class="line">        ], check=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试并重载Nginx配置</span></span><br><span class="line">        subprocess.run([<span class="string">&quot;docker&quot;</span>, <span class="string">&quot;exec&quot;</span>, self.container_name, <span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-t&quot;</span>], check=<span class="literal">True</span>)</span><br><span class="line">        subprocess.run([<span class="string">&quot;docker&quot;</span>, <span class="string">&quot;exec&quot;</span>, self.container_name, <span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-s&quot;</span>, <span class="string">&quot;reload&quot;</span>], check=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✓ Nginx配置完成&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_optimization</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;运行完整优化流程&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=== OnlyOffice字体优化工具 ===&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查容器状态</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.check_container_status():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;✗ 容器未运行，请先启动OnlyOffice容器&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✓ 容器状态检查通过&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取字体文件（实际部署时需要上传到OSS）</span></span><br><span class="line">        temp_dir, font_count, total_size = self.extract_fonts()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 配置Nginx重定向</span></span><br><span class="line">        self.configure_nginx_redirect()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测试字体访问</span></span><br><span class="line">        success, load_time = self.test_font_access()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 清理临时文件</span></span><br><span class="line">        subprocess.run([<span class="string">&quot;rm&quot;</span>, <span class="string">&quot;-rf&quot;</span>, temp_dir, <span class="string">&quot;/tmp/font-redirect.conf&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n=== 优化完成 ===&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;字体文件数量: <span class="subst">&#123;font_count&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;总大小: <span class="subst">&#123;total_size/<span class="number">1024</span>/<span class="number">1024</span>:<span class="number">.1</span>f&#125;</span>MB&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;OSS地址: <span class="subst">&#123;self.oss_endpoint&#125;</span>/fonts/&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;✓ 字体加载测试通过，响应时间: <span class="subst">&#123;load_time:<span class="number">.2</span>f&#125;</span>s&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;⚠ 请手动上传字体文件到OSS并配置公共读权限&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    optimizer = OnlyOfficeFontOptimizer()</span><br><span class="line">    optimizer.run_optimization()</span><br></pre></td></tr></table></figure><h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><h3 id="性能对比分析"><a href="#性能对比分析" class="headerlink" title="性能对比分析"></a>性能对比分析</h3><table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>改善幅度</th></tr></thead><tbody><tr><td>首次加载时间</td><td>30-60秒</td><td>3-5秒</td><td>85-90%</td></tr><tr><td>字体文件大小</td><td>128MB</td><td>128MB</td><td>无变化</td></tr><tr><td>服务器带宽占用</td><td>100%</td><td>5%</td><td>95%</td></tr><tr><td>用户体验评分</td><td>2&#x2F;10</td><td>9&#x2F;10</td><td>350%</td></tr><tr><td>并发支持能力</td><td>10用户</td><td>100+用户</td><td>1000%</td></tr></tbody></table><h3 id="实际测试数据"><a href="#实际测试数据" class="headerlink" title="实际测试数据"></a>实际测试数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优化前测试结果</span></span><br><span class="line">=== 优化前性能测试 ===</span><br><span class="line">字体加载时间测试:</span><br><span class="line">- Arial.ttf: 8.3s</span><br><span class="line">- Calibri.ttf: 12.1s  </span><br><span class="line">- Times.ttf: 15.7s</span><br><span class="line">- 中文字体: 25.4s</span><br><span class="line">总计: 61.5s</span><br><span class="line"></span><br><span class="line">服务器资源占用:</span><br><span class="line">- CPU: 45%</span><br><span class="line">- 内存: 2.1GB</span><br><span class="line">- 带宽: 50Mbps (峰值)</span><br><span class="line">- 并发用户: 8个时开始卡顿</span><br><span class="line"></span><br><span class="line">=== 优化后性能测试 ===</span><br><span class="line">字体加载时间测试:</span><br><span class="line">- Arial.ttf: 0.4s ✓</span><br><span class="line">- Calibri.ttf: 0.3s ✓</span><br><span class="line">- Times.ttf: 0.5s ✓</span><br><span class="line">- 中文字体: 1.2s ✓</span><br><span class="line">总计: 2.4s</span><br><span class="line"></span><br><span class="line">服务器资源占用:</span><br><span class="line">- CPU: 15%</span><br><span class="line">- 内存: 1.4GB  </span><br><span class="line">- 带宽: 2Mbps (平均)</span><br><span class="line">- 并发用户: 50个无压力</span><br><span class="line"></span><br><span class="line">OSS访问统计:</span><br><span class="line">- 缓存命中率: 98.5%</span><br><span class="line">- 平均响应时间: 0.3s</span><br><span class="line">- 全球节点覆盖: 200+</span><br></pre></td></tr></table></figure><h3 id="成本效益分析"><a href="#成本效益分析" class="headerlink" title="成本效益分析"></a>成本效益分析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[成本效益分析] --&gt; B[服务器成本节省]</span><br><span class="line">    A --&gt; C[用户体验提升]</span><br><span class="line">    A --&gt; D[运维成本降低]</span><br><span class="line">    </span><br><span class="line">    B --&gt; B1[带宽费用: -90%]</span><br><span class="line">    B --&gt; B2[服务器规格: -30%]</span><br><span class="line">    B --&gt; B3[CDN费用: +$50/月]</span><br><span class="line">    </span><br><span class="line">    C --&gt; C1[加载速度: +85%]</span><br><span class="line">    C --&gt; C2[用户满意度: +350%]</span><br><span class="line">    C --&gt; C3[跳出率: -60%]</span><br><span class="line">    </span><br><span class="line">    D --&gt; D1[故障率: -80%]</span><br><span class="line">    D --&gt; D2[维护时间: -50%]</span><br><span class="line">    D --&gt; D3[扩容便利性: +200%]</span><br></pre></td></tr></table></figure><h2 id="示例展示"><a href="#示例展示" class="headerlink" title="示例展示"></a>示例展示</h2><h3 id="优化前的问题现象"><a href="#优化前的问题现象" class="headerlink" title="优化前的问题现象"></a>优化前的问题现象</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看OnlyOffice容器日志</span></span><br><span class="line">docker logs onlyoffice --<span class="built_in">tail</span> 50 | grep -i font</span><br><span class="line"></span><br><span class="line"><span class="comment"># 典型问题日志</span></span><br><span class="line">[2025-07-25 10:15:23] [ERROR] Font download <span class="built_in">timeout</span>: arial.ttf (30s)</span><br><span class="line">[2025-07-25 10:15:45] [WARN] Font loading slow: calibri.ttf (15s)</span><br><span class="line">[2025-07-25 10:16:12] [ERROR] Font server connection failed</span><br><span class="line">[2025-07-25 10:16:30] [INFO] Fallback to system fonts</span><br><span class="line">[2025-07-25 10:16:45] [WARN] Document rendering incomplete due to missing fonts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户访问日志</span></span><br><span class="line">192.168.1.100 - [25/Jul/2025:10:15:20] <span class="string">&quot;GET /fonts/arial.ttf&quot;</span> 504 - 30.001s</span><br><span class="line">192.168.1.101 - [25/Jul/2025:10:15:25] <span class="string">&quot;GET /fonts/calibri.ttf&quot;</span> 504 - 30.001s</span><br></pre></td></tr></table></figure><h3 id="优化后的正常状态"><a href="#优化后的正常状态" class="headerlink" title="优化后的正常状态"></a>优化后的正常状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优化后的日志显示</span></span><br><span class="line">docker logs onlyoffice --<span class="built_in">tail</span> 50 | grep -i font</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正常运行日志</span></span><br><span class="line">[2025-07-25 18:20:15] [INFO] Font redirect configured: OSS endpoint</span><br><span class="line">[2025-07-25 18:20:16] [INFO] Font loading accelerated via CDN</span><br><span class="line">[2025-07-25 18:20:17] [DEBUG] Font cache: 156 fonts available</span><br><span class="line">[2025-07-25 18:20:18] [INFO] Document rendering completed successfully</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户访问日志（重定向到OSS）</span></span><br><span class="line">192.168.1.100 - [25/Jul/2025:18:20:15] <span class="string">&quot;GET /fonts/arial.ttf&quot;</span> 301 - 0.001s</span><br><span class="line">192.168.1.101 - [25/Jul/2025:18:20:16] <span class="string">&quot;GET /fonts/calibri.ttf&quot;</span> 301 - 0.001s</span><br><span class="line"></span><br><span class="line"><span class="comment"># OSS访问日志</span></span><br><span class="line">your-bucket.oss-cn-shanghai.aliyuncs.com - <span class="string">&quot;GET /fonts/arial.ttf&quot;</span> 200 0.3s</span><br><span class="line">your-bucket.oss-cn-shanghai.aliyuncs.com - <span class="string">&quot;GET /fonts/calibri.ttf&quot;</span> 200 0.2s</span><br></pre></td></tr></table></figure><h3 id="配置验证命令"><a href="#配置验证命令" class="headerlink" title="配置验证命令"></a>配置验证命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证Nginx配置</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试字体重定向</span></span><br><span class="line">curl -I http://localhost/7.5.1/fonts/arial.ttf</span><br><span class="line"><span class="comment"># 期望输出: HTTP/1.1 301 Moved Permanently</span></span><br><span class="line"><span class="comment"># Location: https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/arial.ttf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试OSS字体访问</span></span><br><span class="line">curl -I https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/arial.ttf</span><br><span class="line"><span class="comment"># 期望输出: HTTP/1.1 200 OK</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查容器资源使用</span></span><br><span class="line">docker stats onlyoffice --no-stream</span><br></pre></td></tr></table></figure><h2 id="参考附录"><a href="#参考附录" class="headerlink" title="参考附录"></a>参考附录</h2><h3 id="相关配置文件路径"><a href="#相关配置文件路径" class="headerlink" title="相关配置文件路径"></a>相关配置文件路径</h3><p><strong>Docker容器内路径：</strong></p><ul><li>OnlyOffice配置: <code>/etc/onlyoffice/documentserver/</code></li><li>Nginx配置: <code>/etc/nginx/includes/ds-docservice.conf</code></li><li>字体目录: <code>/var/www/onlyoffice/documentserver/fonts/</code></li><li>日志目录: <code>/var/log/onlyoffice/documentserver/</code></li></ul><p><strong>宿主机路径：</strong></p><ul><li>Docker Compose文件: <code>./docker-compose.yml</code></li><li>自定义Nginx配置: <code>./nginx-custom.conf</code></li><li>数据持久化: <code>./data/</code></li><li>日志持久化: <code>./logs/</code></li></ul><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker容器管理</span></span><br><span class="line">docker ps | grep onlyoffice                    <span class="comment"># 查看容器状态</span></span><br><span class="line">docker logs onlyoffice -f                     <span class="comment"># 查看实时日志</span></span><br><span class="line">docker <span class="built_in">exec</span> -it onlyoffice bash               <span class="comment"># 进入容器</span></span><br><span class="line">docker restart onlyoffice                     <span class="comment"># 重启容器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置文件操作</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice nginx -t               <span class="comment"># 测试Nginx配置</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice nginx -s reload        <span class="comment"># 重载Nginx配置</span></span><br><span class="line">docker <span class="built_in">cp</span> onlyoffice:/etc/nginx/includes/ds-docservice.conf ./  <span class="comment"># 导出配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字体文件管理</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice <span class="built_in">ls</span> -la /var/www/onlyoffice/documentserver/fonts/</span><br><span class="line">docker <span class="built_in">cp</span> onlyoffice:/var/www/onlyoffice/documentserver/fonts ./fonts/</span><br><span class="line"></span><br><span class="line"><span class="comment"># OSS相关命令</span></span><br><span class="line">aliyun oss <span class="built_in">ls</span> oss://your-bucket/fonts/         <span class="comment"># 查看OSS字体文件</span></span><br><span class="line">aliyun oss <span class="built_in">cp</span> ./fonts oss://your-bucket/fonts/ --recursive  <span class="comment"># 上传字体</span></span><br></pre></td></tr></table></figure><h3 id="故障排查步骤"><a href="#故障排查步骤" class="headerlink" title="故障排查步骤"></a>故障排查步骤</h3><h4 id="1-基础检查"><a href="#1-基础检查" class="headerlink" title="1. 基础检查"></a>1. 基础检查</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查容器状态</span></span><br><span class="line">docker ps | grep onlyoffice</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查端口占用</span></span><br><span class="line">netstat -tlnp | grep :80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查磁盘空间</span></span><br><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure><h4 id="2-配置验证"><a href="#2-配置验证" class="headerlink" title="2. 配置验证"></a>2. 配置验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证Nginx配置语法</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查字体重定向规则</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice grep -n <span class="string">&quot;fonts.*proxy_pass\|fonts.*return&quot;</span> /etc/nginx/includes/ds-docservice.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试重定向</span></span><br><span class="line">curl -I http://localhost/7.5.1/fonts/arial.ttf</span><br></pre></td></tr></table></figure><h4 id="3-网络连通性测试"><a href="#3-网络连通性测试" class="headerlink" title="3. 网络连通性测试"></a>3. 网络连通性测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试OSS访问</span></span><br><span class="line">curl -I https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/arial.ttf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试DNS解析</span></span><br><span class="line">nslookup your-bucket.oss-cn-shanghai.aliyuncs.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试网络延迟</span></span><br><span class="line">ping your-bucket.oss-cn-shanghai.aliyuncs.com</span><br></pre></td></tr></table></figure><h4 id="4-日志分析"><a href="#4-日志分析" class="headerlink" title="4. 日志分析"></a>4. 日志分析</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看错误日志</span></span><br><span class="line">docker logs onlyoffice --<span class="built_in">tail</span> 100 | grep -i error</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看字体相关日志</span></span><br><span class="line">docker logs onlyoffice --<span class="built_in">tail</span> 100 | grep -i font</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Nginx访问日志</span></span><br><span class="line">docker <span class="built_in">exec</span> onlyoffice <span class="built_in">tail</span> -f /var/log/nginx/access.log</span><br></pre></td></tr></table></figure><h3 id="常见问题解决"><a href="#常见问题解决" class="headerlink" title="常见问题解决"></a>常见问题解决</h3><table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td>301重定向不生效</td><td>Nginx配置未生效</td><td>重启容器或重载配置</td></tr><tr><td>OSS访问403错误</td><td>权限配置问题</td><td>设置Bucket公共读权限</td></tr><tr><td>字体加载仍然很慢</td><td>CDN未生效</td><td>检查CDN配置和缓存策略</td></tr><tr><td>容器启动失败</td><td>配置文件语法错误</td><td>检查Nginx配置语法</td></tr></tbody></table><h3 id="性能监控脚本"><a href="#性能监控脚本" class="headerlink" title="性能监控脚本"></a>性能监控脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># performance-monitor.sh</span></span><br><span class="line"><span class="comment"># 持续监控OnlyOffice性能</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== <span class="subst">$(date)</span> ===&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 容器资源使用</span></span><br><span class="line">    docker stats onlyoffice --no-stream --format <span class="string">&quot;table &#123;&#123;.CPUPerc&#125;&#125;\t&#123;&#123;.MemUsage&#125;&#125;\t&#123;&#123;.NetIO&#125;&#125;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 字体加载测试</span></span><br><span class="line">    response_time=$(curl -o /dev/null -s -w <span class="string">&quot;%&#123;time_total&#125;&quot;</span> -I https://your-bucket.oss-cn-shanghai.aliyuncs.com/fonts/arial.ttf)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;字体响应时间: <span class="variable">$&#123;response_time&#125;</span>s&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 错误日志统计</span></span><br><span class="line">    error_count=$(docker logs onlyoffice --since 1m 2&gt;&amp;1 | grep -i error | <span class="built_in">wc</span> -l)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;最近1分钟错误数: <span class="variable">$error_count</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;========================&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 60</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>通过以上静态文件托管优化方案，可以将OnlyOffice的字体加载时间从30-60秒降至3-5秒，显著提升用户体验。建议在生产环境中逐步实施，并持续监控性能指标。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;OnlyOffice作为一款优秀的开源办公套件，在Docker部署环境中经常遇到字体加载缓慢的问题。本文将介绍一种高效的静态文件托管优化方案，通过OSS&amp;#x2F;CDN加速解决字体加载瓶颈。&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://qbmzc.github.io/categories/Linux/"/>
    
    
    <category term="linux" scheme="https://qbmzc.github.io/tags/linux/"/>
    
    <category term="font" scheme="https://qbmzc.github.io/tags/font/"/>
    
    <category term="onlyoffice" scheme="https://qbmzc.github.io/tags/onlyoffice/"/>
    
  </entry>
  
  <entry>
    <title>AdGuard生成自签名证书</title>
    <link href="https://qbmzc.github.io/2025/07/22/2025/07/221740/"/>
    <id>https://qbmzc.github.io/2025/07/22/2025/07/221740/</id>
    <published>2025-07-22T09:06:09.000Z</published>
    <updated>2025-11-21T06:36:31.566Z</updated>
    
    <content type="html"><![CDATA[<p>为AdGuard设置自签名证书加密可有效保护局域网DNS通信安全，避免流量被窃听或篡改。以下是详细操作指南，涵盖证书生成、AdGuard配置及客户端信任设置：</p><span id="more"></span><h2 id="🔐-一、生成自签名证书（以OpenSSL为例）"><a href="#🔐-一、生成自签名证书（以OpenSSL为例）" class="headerlink" title="🔐 一、生成自签名证书（以OpenSSL为例）"></a>🔐 一、生成自签名证书（以OpenSSL为例）</h2><ol><li><p>安装OpenSSL<br>sudo apt update &amp;&amp; sudo apt install openssl  # Debian&#x2F;Ubuntu系统</p></li><li><p>生成证书和私钥<br>sudo openssl req -new -newkey rsa:2048 -sha256 -days 3650 -nodes -x509 <br>  -subj “&#x2F;C&#x3D;US&#x2F;ST&#x3D;State&#x2F;L&#x3D;City&#x2F;O&#x3D;Organization&#x2F;CN&#x3D;adguardhome.com” <br>  -out &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;adguardhome.crt <br>  -keyout &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;adguardhome.key <br>  -extensions SAN <br>  -config &lt;(cat &#x2F;etc&#x2F;ssl&#x2F;openssl.cnf &lt;(printf “[SAN]\nsubjectAltName&#x3D;IP:192.168.50.200”))</p><p>关键参数说明：<br>• subjectAltName&#x3D;IP:192.168.50.200：替换为AdGuard Home服务器的实际IP。</p><p>• 证书路径：&#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;adguardhome.crt（证书）和 &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;adguardhome.key（私钥）。</p></li><li><p>验证证书<br>openssl x509 -in &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;adguardhome.crt -text -noout</p><p>检查输出中是否包含IP地址（如 X509v3 Subject Alternative Name: IP:192.168.50.200）。</p></li></ol><h2 id="⚙️-二、AdGuard-Home服务端配置"><a href="#⚙️-二、AdGuard-Home服务端配置" class="headerlink" title="⚙️ 二、AdGuard Home服务端配置"></a>⚙️ 二、AdGuard Home服务端配置</h2><ol><li><p>启用加密设置<br>• 登录AdGuard Home管理界面（http:&#x2F;&#x2F;<IP>:3000）。</p><p>• 进入 Settings → Encryption Settings。</p><p>• 勾选 Enable encryption。</p><p>• 填写证书路径：</p><p>  ◦ Certificate chain: &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;adguardhome.crt</p><p>  ◦ Private key: &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;adguardhome.key 。</p></li><li><p>重启服务<br>sudo systemctl restart AdGuardHome</p><p>完成后，管理界面将变为 https:&#x2F;&#x2F;<IP>:3000，浏览器会提示证书不安全（需后续信任操作）。</p></li></ol><h2 id="📱-三、客户端设备信任证书"><a href="#📱-三、客户端设备信任证书" class="headerlink" title="📱 三、客户端设备信任证书"></a>📱 三、客户端设备信任证书</h2><p>Windows&#x2F;macOS&#x2F;Linux：</p><ol><li><p>将证书文件 adguardhome.crt 复制到客户端。</p></li><li><p>导入证书：<br>• Windows：双击证书 → 选择“安装证书” → 存储位置选“本地计算机” → 选择“受信任的根证书颁发机构”。</p><p>• macOS：双击证书 → 钥匙串访问 → 拖入“系统”钥匙串 → 右键选择“始终信任”。</p><p>• Linux：复制到 &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F; → 执行 sudo update-ca-certificates。</p></li></ol><p>Android：</p><ol><li>将证书文件发送到手机。</li><li>进入 设置 → 安全 → 加密与凭据 → 安装证书 → 选择文件并确认安装。</li><li>在AdGuard App中启用 HTTPS过滤（需在设置中单独安装CA证书）。</li></ol><p>iOS：</p><ol><li>通过邮件或网页下载证书文件。</li><li>进入 设置 → 通用 → VPN与设备管理 → 点击证书文件 → 选择“安装”。</li></ol><h2 id="⚠️-四、常见问题解决"><a href="#⚠️-四、常见问题解决" class="headerlink" title="⚠️ 四、常见问题解决"></a>⚠️ 四、常见问题解决</h2><ol><li><p>浏览器提示“不安全连接”<br>• 原因：证书未导入客户端受信任存储区。  </p><p>• 解决：重新检查证书导入步骤，确保导入到 “受信任的根证书颁发机构” ,重启浏览器。</p></li><li><p>AdGuard报“证书链无效”<br>• 原因：生成证书时未正确配置SAN扩展。  </p><p>• 解决：重新生成证书，确保包含 subjectAltName&#x3D;IP:&lt;服务器IP&gt;。</p></li><li><p>移动端无法过滤HTTPS流量<br>• 原因：未在AdGuard App中启用HTTPS过滤。  </p><p>• 解决：进入AdGuard移动端设置 → 过滤 → HTTPS过滤 → 安装CA证书。</p></li><li><p>OpenWrt&#x2F;LXC容器环境问题<br>• 需将证书追加到系统的CA信任链：<br>  sudo cat &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;adguardhome.crt &gt;&gt; &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;ca-certificates.crt<br>  。</p></li></ol><h2 id="💎-五、进阶建议"><a href="#💎-五、进阶建议" class="headerlink" title="💎 五、进阶建议"></a>💎 五、进阶建议</h2><p>• 替代方案（生产环境）：  </p><p>  使用Let’s Encrypt免费证书（支持域名验证），避免自签名证书的信任警告。<br>• 证书自动续期：  </p><p>  通过certbot配置自动续期脚本（需绑定域名）。<br>• 安全性强化：  </p><p>  在路由器设置中强制DNS流量指向AdGuard Home的加密端口（如853&#x2F;TLS），避免设备绕过。</p><p>提示：自签名证书适用于内网环境，若需公网访问或更高安全性，建议使用受信任CA签发的证书。操作前备份原配置文件，避免服务中断。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;为AdGuard设置自签名证书加密可有效保护局域网DNS通信安全，避免流量被窃听或篡改。以下是详细操作指南，涵盖证书生成、AdGuard配置及客户端信任设置：&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://qbmzc.github.io/categories/Linux/"/>
    
    
    <category term="openssl" scheme="https://qbmzc.github.io/tags/openssl/"/>
    
    <category term="adguard" scheme="https://qbmzc.github.io/tags/adguard/"/>
    
  </entry>
  
  <entry>
    <title>crates.io-index阿里云镜像</title>
    <link href="https://qbmzc.github.io/2025/07/18/2025/07/181548/"/>
    <id>https://qbmzc.github.io/2025/07/18/2025/07/181548/</id>
    <published>2025-07-17T16:00:00.000Z</published>
    <updated>2025-11-21T06:36:31.566Z</updated>
    
    <content type="html"><![CDATA[<h1 id="crates-io-index-镜像"><a href="#crates-io-index-镜像" class="headerlink" title="crates.io-index 镜像"></a>crates.io-index 镜像</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Cargo 是 Rust 的构建系统和包管理器。 Rust Crates Registry 源是 Rust 的代码仓库。</p><p>下载地址：<a href="https://mirrors.aliyun.com/crates.io-index/">https://mirrors.aliyun.com/crates.io-index/</a></p><h2 id="配置方法"><a href="#配置方法" class="headerlink" title="配置方法"></a>配置方法</h2><h3 id="查看-cargo-版本"><a href="#查看-cargo-版本" class="headerlink" title="查看 cargo 版本"></a>查看 cargo 版本</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cargo -V</span></span><br></pre></td></tr></table></figure><h3 id="配置-crates-io-镜像"><a href="#配置-crates-io-镜像" class="headerlink" title="配置 crates.io 镜像"></a>配置 crates.io 镜像</h3><p>在 cargo 配置文件： ~&#x2F;.cargo&#x2F;config.toml 中，添加以下内容： （Windows 系统配置文件地址默认为：%USERPROFILE%.cargo\config.toml）</p><p>目前该镜像仅支持稀疏索引配置，需要您的 cargo 版本 &gt;&#x3D;1.68。</p><p><strong>稀疏索引配置</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[source.crates-io]</span></span><br><span class="line"><span class="attr">replace-with</span> = <span class="string">&#x27;aliyun&#x27;</span></span><br><span class="line"><span class="section">[source.aliyun]</span></span><br><span class="line"><span class="attr">registry</span> = <span class="string">&quot;sparse+https://mirrors.aliyun.com/crates.io-index/&quot;</span></span><br></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>官方主页：<a href="https://github.com/rust-lang/crates.io-index">https://github.com/rust-lang/crates.io-index</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;crates-io-index-镜像&quot;&gt;&lt;a href=&quot;#crates-io-index-镜像&quot; class=&quot;headerlink&quot; title=&quot;crates.io-index 镜像&quot;&gt;&lt;/a&gt;crates.io-index 镜像&lt;/h1&gt;&lt;h2 id=&quot;简</summary>
      
    
    
    
    <category term="wuw" scheme="https://qbmzc.github.io/categories/wuw/"/>
    
    
    <category term="Rust" scheme="https://qbmzc.github.io/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>基于GreptimeDB与Spring Boot构建高性能服务告警中心的设计</title>
    <link href="https://qbmzc.github.io/2025/07/14/2025/07/101107/"/>
    <id>https://qbmzc.github.io/2025/07/14/2025/07/101107/</id>
    <published>2025-07-13T16:00:00.000Z</published>
    <updated>2025-11-21T06:36:31.566Z</updated>
    
    <content type="html"><![CDATA[ <span id="more"></span><h1 id="基于GreptimeDB与Spring-Boot构建高性能服务告警中心的设计"><a href="#基于GreptimeDB与Spring-Boot构建高性能服务告警中心的设计" class="headerlink" title="基于GreptimeDB与Spring Boot构建高性能服务告警中心的设计"></a>基于GreptimeDB与Spring Boot构建高性能服务告警中心的设计</h1><h2 id="1-执行摘要"><a href="#1-执行摘要" class="headerlink" title="1. 执行摘要"></a>1. 执行摘要</h2><p>本报告旨在为构建一个高性能、可扩展的服务告警中心提供架构设计和实施策略。该告警中心将充分利用GreptimeDB作为统一的时序数据存储，并结合Spring Boot构建健壮的应用逻辑。所提出的系统能够摄取多样化的可观测性数据，实时评估动态告警规则，并分发多渠道通知，同时确保高可用性和容错性。该设计的核心优势在于统一的可观测性数据管理、实时洞察能力、灵活的规则定义、解耦的通知分发以及云原生可扩展性。</p><h2 id="2-实时服务告警简介"><a href="#2-实时服务告警简介" class="headerlink" title="2. 实时服务告警简介"></a>2. 实时服务告警简介</h2><h3 id="告警的关键作用"><a href="#告警的关键作用" class="headerlink" title="告警的关键作用"></a>告警的关键作用</h3><p>在当今复杂且日益增长的微服务架构中，实时告警对于主动识别事件、最小化停机时间以及维护服务健康至关重要。它将原始的可观测性数据转化为可操作的洞察，从而能够对异常行为做出快速响应。一个设计良好的告警系统是确保系统稳定性和业务连续性的基石。</p><h3 id="时序数据库为何对可观测性数据至关重要"><a href="#时序数据库为何对可观测性数据至关重要" class="headerlink" title="时序数据库为何对可观测性数据至关重要"></a>时序数据库为何对可观测性数据至关重要</h3><p>时序数据（包括指标、日志和追踪）本质上具有时间序列性、高容量和追加写入的特性，这使得传统关系型数据库在存储和查询此类数据时效率低下 1。时序数据库（TSDB）是专为此类数据设计的，通过优化摄取、基于时间的查询、高效的存储压缩和专业索引来处理这些挑战 1。</p><p>选择时序数据库并非仅仅为了方便，而是基于性能的根本性决策，因为告警系统严重依赖于历史和实时时序数据的快速检索和分析。传统的关系型数据库由于其面向行的存储和针对事务性更新优化的索引，难以有效处理追加写入、高容量和时间有序的可观测性数据。相比之下，GreptimeDB等时序数据库采用列式存储并针对追加操作进行优化，这在基于时间的查询和聚合方面带来了显著的性能提升。这种底层的架构差异对于需要快速数据检索和时间窗口分析的实时告警系统来说至关重要。</p><h3 id="GreptimeDB统一可观测性能力的概述"><a href="#GreptimeDB统一可观测性能力的概述" class="headerlink" title="GreptimeDB统一可观测性能力的概述"></a>GreptimeDB统一可观测性能力的概述</h3><p>GreptimeDB是一个开源、云原生、高性能的时序数据库，旨在提供灵活的时序数据管理解决方案 3。它能够在一个数据库中统一处理指标、日志、事件和追踪数据，将它们视为“带有时间戳和上下文的事件” 3。这种统一的方法简化了数据集成，并实现了全面的系统监控和分析 3。</p><p>GreptimeDB支持多种协议进行数据写入和查询，包括SQL、PromQL、Prometheus远程写入、InfluxDB、OpenTSDB和OpenTelemetry（OTLP） 3。这种广泛的兼容性降低了学习成本，并促进了数据迁移 3。</p><h2 id="3-GreptimeDB：可观测性数据的基础"><a href="#3-GreptimeDB：可观测性数据的基础" class="headerlink" title="3. GreptimeDB：可观测性数据的基础"></a>3. GreptimeDB：可观测性数据的基础</h2><h3 id="GreptimeDB中的统一数据模型"><a href="#GreptimeDB中的统一数据模型" class="headerlink" title="GreptimeDB中的统一数据模型"></a>GreptimeDB中的统一数据模型</h3><p>GreptimeDB将所有数据组织成“时序表”，这些表由三种语义类型的列组成：<code>Tag</code>（标签）、<code>Timestamp</code>（时间戳）和<code>Field</code>（字段） 4。</p><ul><li><p><strong><code>Timestamp</code></strong>：这是主要的时间索引，对于基于时间的查询和数据组织至关重要。每个表都必须且只能有一个<code>Timestamp</code>列 15。</p></li><li><p><strong><code>Tag</code></strong>：这些列用于唯一标识一个时序数据，类似于Prometheus中的标签。GreptimeDB允许对特定标签进行选择性索引，这比Prometheus中所有标签都默认索引的方式提供了更大的灵活性 4。</p></li><li><p><strong><code>Field</code></strong>：这些列包含实际的数据值，可以是数值、字符串或其他类型。GreptimeDB采用多值模型，允许一行数据包含多个字段列，这与OpenTSDB和Prometheus等采用的单值模型不同。多值模型可以提高写入&#x2F;读取效率并减少传输流量 16。</p></li></ul><p>GreptimeDB能够自动将多个Prometheus指标分组到物理表中 4。</p><p>GreptimeDB的“无模式”方法 15（针对字段）与显式标签和单一时间戳相结合，提供了高度的灵活性。可观测性数据（指标、日志、追踪）的模式通常是多变且不断演进的。如果采用严格的模式，将需要频繁的模式迁移，从而阻碍系统的敏捷性。针对字段的无模式特性允许不同类型的事件（例如，CPU指标与日志条目）共存或轻松摄取，而无需严格的模式强制。这种灵活性对于告警中心至关重要，因为它需要从各种来源摄取数据而无需持续调整模式，从而支持新监控目标的快速迭代和集成。</p><h3 id="GreptimeDB的模式设计最佳实践"><a href="#GreptimeDB的模式设计最佳实践" class="headerlink" title="GreptimeDB的模式设计最佳实践"></a>GreptimeDB的模式设计最佳实践</h3><p>为了优化数据存储和检索效率，遵循GreptimeDB的模式设计最佳实践至关重要：</p><ul><li><p><strong>表命名</strong>：表名通常与指标名称、日志源名称或度量名称保持一致 15。</p></li><li><p><strong>主键（标签）</strong>：在<code>Tag</code>列上定义<code>PRIMARY KEY</code>约束，以唯一标识时序数据。这会隐式地将时间索引列添加到键的末尾，用于排序和去重 16。</p></li><li><p><strong>时间索引</strong>：始终指定一个<code>TIME INDEX</code>列 16。</p></li><li><p><strong>索引策略</strong>：利用GreptimeDB丰富的索引选项（倒排索引、全文索引、跳跃索引和向量索引）来加速查询，特别是对于高基数数据或日志分析 5。对于日志，可以将</p><p>  <code>FULLTEXT INDEX</code>应用于字符串字段 18。</p></li><li><p><strong>合并模式</strong>：理解<code>last_row</code>（默认，保留相同主键和时间戳的最新行）和<code>last_non_null</code>（保留每个字段的最新非空值）合并模式，以管理数据更新和去重 18。</p></li><li><p><strong>TTL（Time-To-Live）</strong>：为表配置<code>TTL</code>以自动管理数据保留和存储成本，例如<code>with(ttl=&#39;7d&#39;)</code> 18。这对于高容量时序数据至关重要，因为较旧的数据可能查询频率较低或需要聚合。</p></li></ul><p>以下是一些GreptimeDB统一数据模型的示例：</p><table><thead><tr><th>列名</th><th>GreptimeDB语义类型</th><th>数据类型</th><th>示例值</th><th>目的&#x2F;描述</th></tr></thead><tbody><tr><td><code>host</code></td><td><code>Tag</code></td><td><code>STRING</code></td><td><code>server-1</code></td><td>标识数据来源的主机名。</td></tr><tr><td><code>idc</code></td><td><code>Tag</code></td><td><code>STRING</code></td><td><code>us-east-1</code></td><td>标识数据中心。</td></tr><tr><td><code>ts</code></td><td><code>Timestamp</code></td><td><code>TIMESTAMP</code></td><td><code>2024-07-20 10:00:00</code></td><td>数据生成的时间戳，表的唯一时间索引。</td></tr><tr><td><code>cpu_util</code></td><td><code>Field</code></td><td><code>DOUBLE</code></td><td><code>0.75</code></td><td>CPU利用率，实际指标值。</td></tr><tr><td><code>memory_util</code></td><td><code>Field</code></td><td><code>DOUBLE</code></td><td><code>0.60</code></td><td>内存利用率，实际指标值。</td></tr><tr><td><code>log_message</code></td><td><code>Field</code></td><td><code>STRING</code></td><td><code>Request processed successfully.</code></td><td>应用程序日志内容。</td></tr><tr><td><code>log_level</code></td><td><code>Tag</code></td><td><code>STRING</code></td><td><code>INFO</code></td><td>日志级别，用于过滤和分类。</td></tr><tr><td><code>trace_id</code></td><td><code>Tag</code></td><td><code>STRING</code></td><td><code>abcdef123456</code></td><td>分布式追踪的唯一ID。</td></tr><tr><td><code>span_id</code></td><td><code>Tag</code></td><td><code>STRING</code></td><td><code>7890abcd</code></td><td>追踪中单个操作的唯一ID。</td></tr><tr><td><code>duration_nano</code></td><td><code>Field</code></td><td><code>BIGINT</code></td><td><code>150000000</code></td><td>操作持续时间（纳秒）。</td></tr><tr><td><code>service_name</code></td><td><code>Tag</code></td><td><code>STRING</code></td><td><code>user-service</code></td><td>产生追踪或日志的服务名称。</td></tr></tbody></table><ul><li><p><strong>示例模式：</strong></p><ul><li><p><strong>系统指标</strong>：<code>CREATE TABLE IF NOT EXISTS system_metrics (host STRING, idc STRING, cpu_util DOUBLE, memory_util DOUBLE, disk_util DOUBLE, ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY(host, idc), TIME INDEX(ts));</code> 16。在此示例中，</p><p>  <code>host</code>和<code>idc</code>是标签，<code>ts</code>是时间戳，<code>cpu_util</code>、<code>memory_util</code>、<code>disk_util</code>是字段。</p></li><li><p><strong>应用程序日志</strong>：<code>CREATE TABLE access_logs (access_time TIMESTAMP TIME INDEX, remote_addr STRING, http_status STRING, http_method STRING, http_refer STRING, user_agent STRING, request STRING) with (&#39;append_mode&#39;=&#39;true&#39;);</code> 17。这是一个仅追加的表，针对日志存储进行了优化，查询速度通常更快 17。</p></li></ul></li></ul><h3 id="Spring-Boot的数据摄取策略"><a href="#Spring-Boot的数据摄取策略" class="headerlink" title="Spring Boot的数据摄取策略"></a>Spring Boot的数据摄取策略</h3><p>为了将可观测性数据高效地摄取到GreptimeDB中，Spring Boot应用程序可以采用多种策略：</p><ul><li><p>OpenTelemetry (OTLP) 用于标准化数据收集：</p><p>  GreptimeDB是一个OpenTelemetry原生的可观测性数据库，能够通过HTTP协议原生消费OTLP指标、日志和追踪数据 5。Spring Boot应用程序可以利用OpenTelemetry SDK（例如，Java的</p><p>  <code>io.opentelemetry:opentelemetry-exporter-otlp</code>）将遥测数据直接导出到GreptimeDB的OTLP端点 12。配置时需要指定GreptimeDB的主机、数据库名称（</p><p>  <code>X-Greptime-DB-Name</code>头）和认证（基本认证） 12。对于追踪，</p><p>  <code>x-greptime-pipeline-name</code>应配置为<code>greptime_trace_v1</code> 12。日志可以指定</p><p>  <code>X-Greptime-Log-Table-Name</code> 12。</p><p>  采用OTLP进行数据摄取，告警中心获得了供应商中立性，并使其数据收集面向未来。OpenTelemetry正在成为可观测性领域的行业标准。如果后端时序数据库未来发生变化，应用程序的仪表化将基本不受影响。这种方法减少了供应商锁定，并简化了未来的迁移或多供应商可观测性策略。这增强了系统在快速演进的可观测性环境中的长期可维护性和适应性。Spring Boot 3通过Micrometer Tracing支持OpenTelemetry 19。使用OpenTelemetry Java代理可以实现零代码仪表化，它会自动仪表化支持的库（如Spring MVC、JDBC、Kafka） 21。</p></li><li><p>Prometheus远程写入兼容性：</p><p>  GreptimeDB与Prometheus完全兼容，可以作为Prometheus指标的远程写入端点 4。Spring Boot应用程序可以通过Micrometer的Prometheus注册表暴露指标（</p><p>  <code>/actuator/prometheus</code>端点） 20。然后，Prometheus服务器可以抓取这些指标并将其远程写入GreptimeDB 4。</p><p>  GreptimeDB与Prometheus远程写入的兼容性 4 使得现有系统能够更平滑地过渡或共存。许多现有系统依赖Prometheus进行指标收集。这意味着已经为Prometheus进行仪表化的应用程序不需要立即重新仪表化，从而降低了使用GreptimeDB的门槛。这种能力对于大型企业环境至关重要，因为它支持增量式采用并避免了“大爆炸”式的迁移。</p></li><li><p>JDBC&#x2F;SQL直接集成：</p><p>  GreptimeDB支持MySQL协议，允许Spring Boot应用程序通过JDBC使用MySQL驱动程序进行连接 25。标准的Spring Data JDBC或JPA（类似于Go中的GORM模型，表明Java中也有类似ORM模式）可用于数据插入和查询 25。</p><p>  <strong>Spring Boot数据库性能最佳实践</strong> 26：</p><ul><li><p><strong>连接池</strong>：对于管理连接开销和提高性能至关重要。根据应用程序负载配置连接池大小、连接超时和空闲超时 26。</p></li><li><p><strong>查询优化</strong>：定期分析和优化SQL查询以获得更好的执行计划 26。</p></li><li><p><strong>索引</strong>：在频繁访问的列上创建索引以加快检索时间 26。GreptimeDB的标签列是隐式索引的 15。</p></li><li><p><strong>事务管理</strong>：正确处理事务以确保数据完整性 26。</p></li></ul></li></ul><h3 id="GreptimeDB内置流引擎的实时数据聚合"><a href="#GreptimeDB内置流引擎的实时数据聚合" class="headerlink" title="GreptimeDB内置流引擎的实时数据聚合"></a>GreptimeDB内置流引擎的实时数据聚合</h3><p>GreptimeDB包含一个轻量级的内置流引擎，无需外部流系统（如Kafka Streams或Flink）即可实现连续数据聚合 9。用户可以使用简单的SQL定义实时“流”（Flow）任务 9。</p><p>内置流引擎 11 直接解决了管理独立流平台（如Kafka、Flink）进行实时聚合的复杂性。这减少了整体架构中的组件数量，简化了部署、维护和调试。对于告警系统而言，预聚合数据可以显著降低告警评估期间的查询负载。这种架构选择能够降低总拥有成本（TCO），并加速新告警定义（需要聚合数据）的上市时间。</p><ul><li><p><strong>用例</strong>：</p><ul><li><p>在1分钟窗口内从追踪跨度计算RED（速率、错误、持续时间）指标 11。</p></li><li><p>通过聚合服务间的调用次数来执行服务依赖分析 11。</p></li></ul></li></ul><h2 id="4-告警中心的Spring-Boot应用架构"><a href="#4-告警中心的Spring-Boot应用架构" class="headerlink" title="4. 告警中心的Spring Boot应用架构"></a>4. 告警中心的Spring Boot应用架构</h2><h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><p>告警中心将由以下核心微服务组件构成：</p><ul><li><p><strong>数据摄取服务</strong>：负责接收原始可观测性数据（例如，通过OTLP、Prometheus远程写入或自定义API），并将其写入GreptimeDB。</p></li><li><p><strong>告警规则管理服务</strong>：提供用于定义、更新和查询告警规则的API。将规则存储在单独的、高可用的关系型数据库中。</p></li><li><p><strong>告警评估引擎</strong>：持续查询GreptimeDB中的时序数据，根据活跃告警规则进行评估，并识别告警条件。</p></li><li><p><strong>通知分发服务</strong>：处理告警到各种渠道（电子邮件、短信、Webhook）的发送，并管理告警的升级、去重和抑制。</p></li></ul><h3 id="架构模式"><a href="#架构模式" class="headerlink" title="架构模式"></a>架构模式</h3><ul><li><p>微服务架构：</p><p>  将告警中心分解为更小、可独立部署的服务（如摄取、规则管理、评估、通知）可增强模块化、可扩展性和故障隔离 28。每个服务专注于单一职责，从而简化开发、测试和维护。</p></li><li><p>事件驱动架构：</p><p>  利用消息中间件（如Kafka、RabbitMQ）实现微服务之间的异步通信 30。这种方法可以解耦组件，提高系统响应能力，并通过缓冲消息提供容错能力 33。Spring Cloud Stream简化了使用共享消息系统构建事件驱动微服务的过程 30。</p><p>  通过使用消息队列（如Kafka、RabbitMQ）进行关键流程（如向通知服务发送告警）的通信，系统变得更具弹性。微服务之间的直接同步API调用会造成紧密耦合，并可能导致级联故障。如果通知服务暂时停机，消息会在队列中缓冲，并在服务恢复后进行处理 33。这种设计显著提高了告警交付的可靠性，防止了在瞬时服务中断期间遗漏通知。</p></li></ul><h3 id="Spring-Boot可扩展性和可维护性最佳实践"><a href="#Spring-Boot可扩展性和可维护性最佳实践" class="headerlink" title="Spring Boot可扩展性和可维护性最佳实践"></a>Spring Boot可扩展性和可维护性最佳实践</h3><ul><li><p><strong>单一职责原则（SRP）</strong>：将SRP应用于类和服务（例如，将用户验证与用户创建分离），以确保模块化、更易于维护、测试和扩展 27。</p></li><li><p><strong>依赖注入（DI）和控制反转（IoC）</strong>：Spring Boot的核心原则，促进松耦合和可测试性 3。</p></li><li><p><strong>连接池</strong>：如第3节所述，为所有数据库交互（GreptimeDB、用于规则的关系型数据库）配置连接池 26。</p></li><li><p><strong>查询优化和索引</strong>：持续监控和调整查询，并确保适当的索引 26。</p></li><li><p><strong>外部化配置</strong>：使用环境变量、Kubernetes ConfigMaps或Spring Boot的外部化配置功能管理敏感信息（数据库凭据、API密钥） 32。</p></li></ul><h2 id="5-告警规则管理与评估引擎"><a href="#5-告警规则管理与评估引擎" class="headerlink" title="5. 告警规则管理与评估引擎"></a>5. 告警规则管理与评估引擎</h2><h3 id="告警定义的数据模型"><a href="#告警定义的数据模型" class="headerlink" title="告警定义的数据模型"></a>告警定义的数据模型</h3><p>告警规则通常是静态配置，不常更改，且需要事务一致性。因此，将其存储在关系型数据库（例如PostgreSQL、MySQL）中比时序数据库更合适 1。关系型数据库提供健壮的ACID特性、复杂的规则管理查询能力以及成熟的模式演进和备份机制。</p><p>将关系型数据库用于告警规则，并将时序数据库（GreptimeDB）用于可观测性数据，是“多态持久化”的典型范例。这种方法认识到不同类型的数据具有不同的存储、访问和一致性要求。告警规则是结构化的、事务性的且数据量较小，非常适合关系型数据库管理系统（RDBMS）。而可观测性数据是高容量、追加写入且时间有序的，非常适合时序数据库（TSDB）。这种混合方法优化了每种数据类型的性能和可管理性，从而构建了一个更高效、更健壮的整体系统。</p><p>以下是告警规则定义模式的示例：</p><table><thead><tr><th>列名</th><th>数据类型</th><th>约束&#x2F;描述</th></tr></thead><tbody><tr><td><code>rule_id</code></td><td><code>UUID</code> &#x2F; <code>BIGINT</code></td><td>主键，告警规则的唯一标识符。</td></tr><tr><td><code>rule_name</code></td><td><code>VARCHAR(255)</code></td><td>告警规则的名称，应唯一。</td></tr><tr><td><code>description</code></td><td><code>TEXT</code></td><td>告警规则的详细描述。</td></tr><tr><td><code>severity</code></td><td><code>ENUM</code></td><td>告警的严重程度（例如：<code>CRITICAL</code>、<code>WARNING</code>、<code>INFO</code>）。</td></tr><tr><td><code>expression</code></td><td><code>TEXT</code> &#x2F; <code>JSON</code></td><td>告警评估的表达式（例如：PromQL-like语法或自定义规则引擎语法）。</td></tr><tr><td><code>evaluation_interval_seconds</code></td><td><code>INT</code></td><td>告警条件评估的频率（秒）。</td></tr><tr><td><code>for_duration_seconds</code></td><td><code>INT</code></td><td>告警条件必须持续为真才能触发告警的时间（秒）。</td></tr><tr><td><code>enabled</code></td><td><code>BOOLEAN</code></td><td>告警规则是否启用。</td></tr><tr><td><code>notification_channels</code></td><td><code>JSONB</code> &#x2F; <code>TEXT</code></td><td>告警通知发送到的渠道列表（例如：&#96;&#96;）。</td></tr><tr><td><code>created_at</code></td><td><code>TIMESTAMP</code></td><td>规则创建时间。</td></tr><tr><td><code>updated_at</code></td><td><code>TIMESTAMP</code></td><td>规则最后更新时间。</td></tr><tr><td><code>last_triggered_at</code></td><td><code>TIMESTAMP</code></td><td>规则上次触发告警的时间（可为空）。</td></tr><tr><td><code>status</code></td><td><code>ENUM</code></td><td>告警规则的当前状态（例如：<code>ACTIVE</code>、<code>FIRING</code>、<code>RESOLVED</code>）。</td></tr><tr><td><code>owner_id</code></td><td><code>UUID</code> &#x2F; <code>BIGINT</code></td><td>规则所有者的ID（外键，指向用户&#x2F;团队表）。</td></tr></tbody></table><h3 id="使用Spring-Boot实现规则引擎"><a href="#使用Spring-Boot实现规则引擎" class="headerlink" title="使用Spring Boot实现规则引擎"></a>使用Spring Boot实现规则引擎</h3><ul><li><p>规则引擎微服务：</p><p>  将业务规则外部化到专用的微服务中，以提高灵活性、适应性和可维护性 28。这使得规则逻辑与核心应用程序代码分离。</p><p>  将告警逻辑直接嵌入代码中需要每次规则更改时都进行重新部署。规则引擎微服务 28 允许通过API动态定义、修改和激活规则，而无需触及核心应用程序代码。这对于告警系统至关重要，因为阈值和条件可能需要根据不断变化的系统行为或业务需求进行频繁调整。这种方法能够更快地响应不断变化的监控需求，并减少操作摩擦。</p></li><li><p>与Spring Boot集成：</p><p>  Spring Boot本身不提供内置规则引擎，但与外部规则引擎集成良好 38。</p><ul><li><p><strong>Easy Rules</strong>：一个轻量级的、基于POJO的规则引擎，可以使用注解（<code>@Rule</code>、<code>@Condition</code>、<code>@Action</code>）轻松集成 39。它简化了业务规则的定义和管理 39。</p></li><li><p><strong>Drools</strong>：一个功能强大的开源业务规则管理系统（BRMS），适用于更复杂的规则集，提供Web编写和DMN模型支持等功能 38。</p></li><li><p><strong>规则存储库</strong>：规则可以存储在关系型数据库中（如上定义），并加载到规则引擎的工作内存中 38。</p></li><li><p><strong>API层</strong>：暴露RESTful API，用于管理规则（例如，保存简单或复合规则）以及通过规则处理实体 28。</p></li></ul></li></ul><h3 id="实时告警评估"><a href="#实时告警评估" class="headerlink" title="实时告警评估"></a>实时告警评估</h3><ul><li><p>流处理用于持续评估：</p><p>  利用Spring Cloud Stream或Kafka Streams对来自GreptimeDB的传入时序数据进行实时处理 30。</p><ul><li><p><strong>Spring Cloud Stream</strong>：简化了构建连接到消息中间件（Kafka、RabbitMQ）的事件驱动微服务 30。它处理生产者和消费者的样板配置 30。</p></li><li><p><strong>Kafka Streams</strong>：一个轻量级库，用于直接在Kafka上构建流应用程序。它提供了<code>KStream</code>（独立的事件流）和<code>KTable</code>（数据快照，有状态，跟踪每个键的最新值）抽象，非常适合聚合和连接操作 31。</p></li></ul></li><li><p>评估逻辑：</p><p>  评估引擎将定期查询GreptimeDB以获取特定指标、日志或追踪在特定时间窗口内的数据。例如，它可以查询CPU利用率（来自system_metrics表的cpu_util）是否在持续时间内超过某个阈值。利用GreptimeDB的SQL和PromQL支持进行灵活查询 3。将检索到的数据（事实）集成到所选的规则引擎（例如Easy Rules）中，以根据定义的条件进行评估 38。</p></li><li><p>定义复杂告警条件：</p><p>  规则可以使用模仿PromQL的表达式定义，允许在时间窗口上进行聚合（例如，rate、sum、avg） 11。GreptimeDB的内置流引擎（Flows）可以预聚合常见RED指标或服务依赖关系的数据，从而简化实时评估逻辑 11。</p></li></ul><h2 id="6-多渠道通知服务"><a href="#6-多渠道通知服务" class="headerlink" title="6. 多渠道通知服务"></a>6. 多渠道通知服务</h2><h3 id="异步通知分发"><a href="#异步通知分发" class="headerlink" title="异步通知分发"></a>异步通知分发</h3><p>实现一个专用的通知分发服务，该服务从消息队列（例如，用于<code>alert_events</code>的Kafka主题）消费告警事件 33。这确保了与告警评估引擎的解耦，并提供了可靠性；如果通知服务宕机，告警将被排队并在服务恢复后处理 33。</p><h3 id="与通知渠道集成"><a href="#与通知渠道集成" class="headerlink" title="与通知渠道集成"></a>与通知渠道集成</h3><ul><li><p>电子邮件（Spring Mail）：</p><p>  Spring Boot提供了spring-boot-starter-mail以便于集成 42。在</p><p>  <code>application.properties</code>中配置SMTP服务器详细信息（主机、端口、用户名、密码、TLS） 37。使用</p><p>  <code>JavaMailSender</code>发送<code>SimpleMailMessage</code>（纯文本）或<code>MimeMessage</code>（HTML和附件） 37。实现电子邮件模板以实现一致的告警格式 42。</p></li><li><p>短信（Twilio）：</p><p>  集成Twilio Java Library以发送短信 44。使用</p><p>  <code>ACCOUNT_SID</code>和<code>AUTH_TOKEN</code>初始化Twilio（最好存储为环境变量） 44。使用</p><p>  <code>Message.creator()</code>构建和发送短信 44。</p></li><li><p>Webhook（Slack，通用）：</p><p>  对于Slack，使用Incoming Webhooks（传入Webhook）和唯一URL发送JSON负载 46。Slack Java SDK简化了此过程 47。对于通用Webhook，使用Spring的</p><p>  <code>WebClient</code>向指定URL发送带有JSON负载的POST请求 48。实现自定义Spring事件（</p><p>  <code>ApplicationEventPublisher</code>，<code>@EventListener</code>）以从特定操作触发Webhook逻辑 48。</p></li></ul><h3 id="处理告警升级、去重和抑制"><a href="#处理告警升级、去重和抑制" class="headerlink" title="处理告警升级、去重和抑制"></a>处理告警升级、去重和抑制</h3><ul><li><p><strong>去重</strong>：在通知分发服务中实现逻辑，以防止为同一持续告警发送多个重复通知。这可以通过在缓存或专用数据库表中跟踪活动告警来实现。</p></li><li><p><strong>抑制</strong>：允许用户定义规则，以抑制已知问题或维护期间的通知。此逻辑也将驻留在通知分发服务中。</p></li><li><p><strong>升级</strong>：定义升级策略（例如，5分钟后，发送到不同的渠道或不同的团队成员）。这需要对活动告警进行状态管理和定期检查。</p></li></ul><p>以下是通知渠道配置的示例：</p><table><thead><tr><th>渠道类型</th><th>配置参数</th><th>示例值</th><th>安全注意事项</th><th>Spring Boot配置属性</th></tr></thead><tbody><tr><td><code>EMAIL</code></td><td><code>SMTP Host</code></td><td><code>smtp.gmail.com</code></td><td>环境变量&#x2F;秘密管理</td><td><code>spring.mail.host</code></td></tr><tr><td></td><td><code>SMTP Port</code></td><td><code>587</code></td><td></td><td><code>spring.mail.port</code></td></tr><tr><td></td><td><code>Username</code></td><td><code>my.gmail@gmail.com</code></td><td>环境变量&#x2F;秘密管理</td><td><code>spring.mail.username</code></td></tr><tr><td></td><td><code>Password</code></td><td><code>app_password</code></td><td>环境变量&#x2F;秘密管理</td><td><code>spring.mail.password</code></td></tr><tr><td><code>SMS</code></td><td><code>Twilio Account SID</code></td><td><code>ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code></td><td>环境变量&#x2F;秘密管理</td><td><code>twilio.account-sid</code></td></tr><tr><td></td><td><code>Twilio Auth Token</code></td><td><code>your_auth_token</code></td><td>环境变量&#x2F;秘密管理</td><td><code>twilio.auth-token</code></td></tr><tr><td></td><td><code>Twilio Phone Number</code></td><td><code>+15017122661</code></td><td></td><td><code>twilio.phone-number</code></td></tr><tr><td><code>SLACK_WEBHOOK</code></td><td><code>Webhook URL</code></td><td><code>https://hooks.slack.com/services/T00/B00/X</code></td><td>环境变量&#x2F;秘密管理</td><td><code>slack.webhook.url</code></td></tr><tr><td><code>GENERIC_WEBHOOK</code></td><td><code>Endpoint URL</code></td><td><code>https://third-party-service.com/webhook</code></td><td>环境变量&#x2F;秘密管理</td><td><code>webhook.generic.endpoint</code></td></tr><tr><td></td><td><code>API Key Header</code></td><td><code>X-Custom-Auth</code></td><td>环境变量&#x2F;秘密管理</td><td><code>webhook.generic.api-key-header</code></td></tr><tr><td></td><td><code>API Key Value</code></td><td><code>your_api_key_value</code></td><td>环境变量&#x2F;秘密管理</td><td><code>webhook.generic.api-key-value</code></td></tr></tbody></table><h2 id="7-确保高可用性、可扩展性和容错性"><a href="#7-确保高可用性、可扩展性和容错性" class="headerlink" title="7. 确保高可用性、可扩展性和容错性"></a>7. 确保高可用性、可扩展性和容错性</h2><h3 id="GreptimeDB的云原生优势"><a href="#GreptimeDB的云原生优势" class="headerlink" title="GreptimeDB的云原生优势"></a>GreptimeDB的云原生优势</h3><p>GreptimeDB的云原生设计，特别是计算存储分离和Kubernetes集成 5，直接有助于告警系统的整体高可用性和可扩展性。通过将数据持久化卸载到高可用的对象存储，并允许计算节点独立扩展，数据库层成为一个强大的基础，能够处理海量数据和波动的负载，而不会成为单点故障。这种数据库层面的架构选择简化了Spring Boot应用程序的高可用性设计，因为它能够依赖底层数据存储固有的弹性。</p><ul><li><p><strong>计算存储分离</strong>：GreptimeDB的架构将计算（Frontend、Datanode、Metasrv）与存储（S3、对象存储）分离，允许资源独立扩展 4。这显著降低了存储成本（与EBS相比可降低高达75%，运营&#x2F;存储成本降低50倍）并实现了基于数据负载的弹性扩展 3。</p></li><li><p><strong>Kubernetes原生</strong>：专为Kubernetes构建，促进了无限的水平扩展和云环境中的高效管理 4。</p></li><li><p><strong>高性能和成本效益</strong>：采用Rust编写，具有分布式查询引擎、丰富的索引和优化的列式存储，可在PB级数据集上实现亚秒级响应 5。</p></li><li><p><strong>数据持久性</strong>：数据持久化存储在经济高效的对象存储中，并使用基于SSD的云卷用于WAL和缓存，以确保可靠性和性能 11。</p></li><li><p><strong>读写分离（企业版）</strong>：企业版支持写入节点独立扩展，以实现高吞吐量摄取而不影响查询性能 11。这对于写入密集型可观测性工作负载是一个关键考虑因素。</p></li></ul><h3 id="Spring-Boot应用弹性模式"><a href="#Spring-Boot应用弹性模式" class="headerlink" title="Spring Boot应用弹性模式"></a>Spring Boot应用弹性模式</h3><ul><li><p><strong>负载均衡</strong>：使用Nginx或云原生负载均衡器将传入流量分配到Spring Boot微服务的多个实例（例如，摄取、规则管理） 29。这可以防止单个实例过载并提高容错能力 50。</p></li><li><p><strong>服务发现</strong>：使用Eureka等工具使微服务能够动态地相互定位 50。</p></li><li><p><strong>数据库复制</strong>：对于存储告警规则的关系型数据库，配置主从或多主复制，以确保即使数据库实例发生故障，数据也可用 29。</p></li><li><p><strong>容错机制（Resilience4j）</strong>：在Spring Boot服务中实现断路器、重试、速率限制器和时间限制器 50。</p><ul><li><p><strong>断路器</strong>：通过暂时停止对缓慢或易出错服务的请求来防止级联故障，使其能够恢复 51。</p></li><li><p><strong>重试</strong>：自动重试因瞬时问题而失败的操作 51。</p></li><li><p><strong>时间限制器</strong>：为服务调用设置时间限制，防止长时间挂起 51。</p></li></ul></li><li><p>集中式日志记录和监控：</p><p>  实施ELK Stack或Grafana Loki等工具进行集中式日志管理 20。使用Prometheus和Grafana监控应用程序性能，并为告警系统本身设置告警 23。</p></li><li><p><strong>容器化和编排</strong>：将Spring Boot应用程序作为Docker容器部署在Kubernetes上，以自动化部署、扩展和管理，确保高可用性和容错性 29。</p></li></ul><h2 id="8-结论与未来增强"><a href="#8-结论与未来增强" class="headerlink" title="8. 结论与未来增强"></a>8. 结论与未来增强</h2><h3 id="健壮告警中心设计的总结"><a href="#健壮告警中心设计的总结" class="headerlink" title="健壮告警中心设计的总结"></a>健壮告警中心设计的总结</h3><p>所提出的架构利用了GreptimeDB统一、高性能的时序数据能力，用于处理指标、日志和追踪数据，并结合了Spring Boot健壮的框架来构建模块化和弹性的微服务。关键组件包括通过OpenTelemetry和Prometheus实现的灵活数据摄取、由关系型数据库支持的规则管理系统与集成规则引擎以实现动态条件，以及异步、多渠道的通知服务。高可用性和可扩展性通过GreptimeDB的云原生设计和Spring Boot的弹性模式（负载均衡、断路器、消息队列）得到保障。</p><h3 id="潜在的未来增强"><a href="#潜在的未来增强" class="headerlink" title="潜在的未来增强"></a>潜在的未来增强</h3><ul><li><p><strong>AI辅助洞察</strong>：集成机器学习模型进行异常检测（例如，预测GreptimeDB数据中的异常模式），以减少误报并提高告警精度。</p></li><li><p><strong>高级分析</strong>：开发自定义仪表板和报告工具（例如，使用Grafana与GreptimeDB作为数据源），以深入分析告警趋势、通知有效性和系统健康状况随时间的变化 23。</p></li><li><p><strong>自动化修复</strong>：扩展通知服务，以响应特定的关键告警触发自动化操作（例如，运行脚本、重启服务）。</p></li><li><p><strong>可定制仪表板</strong>：允许用户在告警中心的UI中创建和定制自己的告警仪表板，直接从GreptimeDB拉取数据。</p></li><li><p><strong>与事件管理系统集成</strong>：与PagerDuty或Opsgenie等工具无缝集成，以简化事件响应工作流程。</p></li><li><p><strong>告警调优反馈循环</strong>：实施机制，允许用户提供告警相关性的反馈，帮助完善规则定义并减少告警疲劳。</p></li></ul>]]></content>
    
    
      
      
    <summary type="html"> &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;h1 id=&quot;基于GreptimeDB与Spring-Boot构建高性能服务告警中心的设计&quot;&gt;&lt;a href=&quot;#基于GreptimeDB与Spring-Boot构建高性能服务告警中心的设计&quot; class=&quot;headerlin</summary>
      
    
    
    
    <category term="Java" scheme="https://qbmzc.github.io/categories/Java/"/>
    
    
    <category term="java" scheme="https://qbmzc.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>使用docx4j将docx转换为pdf</title>
    <link href="https://qbmzc.github.io/2025/06/27/2025/06/201724/"/>
    <id>https://qbmzc.github.io/2025/06/27/2025/06/201724/</id>
    <published>2025-06-26T16:00:00.000Z</published>
    <updated>2025-11-21T06:36:31.565Z</updated>
    
    <content type="html"><![CDATA[<h3 id="📚-Docx4J-简介"><a href="#📚-Docx4J-简介" class="headerlink" title="📚 Docx4J 简介"></a>📚 Docx4J 简介</h3><p>Docx4J 是一个基于 Java 的开源库，支持：</p><ul><li>读取&#x2F;写入 <code>.docx</code> 文件</li><li>转换为 PDF（通过 Apache FOP 或其他渲染引擎）</li><li>处理复杂格式（表格、图表、图片、样式等）</li></ul><p>​<strong>优势</strong>​：纯 Java 实现，无需外部依赖（如 LaTeX），适合集成到 Java 项目中。 </p><span id="more"></span><h2 id="Maven项目添加相关依赖"><a href="#Maven项目添加相关依赖" class="headerlink" title="Maven项目添加相关依赖"></a>Maven项目添加相关依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.xml.bind-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.docx4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docx4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>11.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.docx4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docx4j-JAXB-ReferenceImpl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>11.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.docx4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docx4j-export-fo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>11.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.docx4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docx4j-JAXB-MOXy<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>11.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.docx4j/docx4j-JAXB-Internal --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.docx4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docx4j-JAXB-Internal<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>8.3.14<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.taimei.convert.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.docx4j.Docx4J;</span><br><span class="line"><span class="keyword">import</span> org.docx4j.fonts.BestMatchingMapper;</span><br><span class="line"><span class="keyword">import</span> org.docx4j.openpackaging.packages.WordprocessingMLPackage;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdvancedDocxToPdf</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">WordprocessingMLPackage</span> <span class="variable">wordPackage</span> <span class="operator">=</span> WordprocessingMLPackage.load(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/home/cong/Space/new-doc-convert/input.docx&quot;</span>));</span><br><span class="line">            <span class="comment">// 执行转换</span></span><br><span class="line">            Docx4J.toPDF(wordPackage, <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;output.pdf&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;高级转换完成！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="字体映射"><a href="#字体映射" class="headerlink" title="字体映射"></a>字体映射</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IdentityPlusMapper</span> <span class="variable">fontMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IdentityPlusMapper</span>();</span><br><span class="line">    fontMapper.put(<span class="string">&quot;宋体&quot;</span>, PhysicalFonts.get(<span class="string">&quot;STSong-Light&quot;</span>));</span><br><span class="line">    fontMapper.put(<span class="string">&quot;微软雅黑&quot;</span>, PhysicalFonts.get(<span class="string">&quot;Microsoft Yahei&quot;</span>));</span><br><span class="line">    wordPackage.setFontMapper(fontMapper);</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;📚-Docx4J-简介&quot;&gt;&lt;a href=&quot;#📚-Docx4J-简介&quot; class=&quot;headerlink&quot; title=&quot;📚 Docx4J 简介&quot;&gt;&lt;/a&gt;📚 Docx4J 简介&lt;/h3&gt;&lt;p&gt;Docx4J 是一个基于 Java 的开源库，支持：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;读取&amp;#x2F;写入 &lt;code&gt;.docx&lt;/code&gt; 文件&lt;/li&gt;
&lt;li&gt;转换为 PDF（通过 Apache FOP 或其他渲染引擎）&lt;/li&gt;
&lt;li&gt;处理复杂格式（表格、图表、图片、样式等）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;​&lt;strong&gt;优势&lt;/strong&gt;​：纯 Java 实现，无需外部依赖（如 LaTeX），适合集成到 Java 项目中。 &lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="https://qbmzc.github.io/categories/Java/"/>
    
    
    <category term="pdf" scheme="https://qbmzc.github.io/tags/pdf/"/>
    
  </entry>
  
  <entry>
    <title>MySQL中GROUP_CONCAT长度限制</title>
    <link href="https://qbmzc.github.io/2025/06/20/2025/06/201045/"/>
    <id>https://qbmzc.github.io/2025/06/20/2025/06/201045/</id>
    <published>2025-06-19T16:00:00.000Z</published>
    <updated>2025-11-21T06:36:31.565Z</updated>
    
    <content type="html"><![CDATA[<p>在开发一个用户权限矩阵的功能时,遇到了一个奇怪的问题,数据结果集比预期要少很多.</p><span id="more"></span><p>代码如下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cluster_id, GROUP_CONCAT(<span class="keyword">DISTINCT</span> study_id) <span class="keyword">AS</span> study_ids <span class="keyword">FROM</span> t_sdb_study_site <span class="keyword">WHERE</span> is_deleted <span class="operator">=</span> <span class="number">0</span> <span class="keyword">group</span> <span class="keyword">by</span> cluster_id;</span><br></pre></td></tr></table></figure><p>这条SQL的作用是聚合查询出不同cluster下的所有study,然后与授权资源进行匹配,之后将用户与资源study关联保存.</p><p>这条 SQL 语句在语法上是正确的，但在实际使用中可能存在以下潜在问题：</p><h3 id="​1-GROUP-CONCAT-长度限制（潜在数据截断风险）​​"><a href="#​1-GROUP-CONCAT-长度限制（潜在数据截断风险）​​" class="headerlink" title="​1. GROUP_CONCAT 长度限制（潜在数据截断风险）​​"></a>​<strong>1. GROUP_CONCAT 长度限制（潜在数据截断风险）​</strong>​</h3><ul><li><p>​<strong>问题说明</strong>​：MySQL 中 <code>GROUP_CONCAT</code> 的默认最大长度是 <code>1024</code> 字节（通过系统变量 <code>group_concat_max_len</code>控制）。如果 <code>study_ids</code> 连接后的字符串超过该长度，结果会被<strong>静默截断</strong>。</p></li><li><p>​<strong>解决方案</strong>​：</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- 临时修改会话级限制（例如扩展到 10MB）</span><br><span class="line">SET SESSION group_concat_max_len = 10 * 1024 * 1024;</span><br><span class="line">-- 再执行原查询</span><br></pre></td></tr></table></figure></li></ul><h3 id="​2-未指定分隔符导致歧义​"><a href="#​2-未指定分隔符导致歧义​" class="headerlink" title="​2. 未指定分隔符导致歧义​"></a>​<strong>2. 未指定分隔符导致歧义</strong>​</h3><ul><li><p>​<strong>问题说明</strong>​：<code>GROUP_CONCAT</code> 默认使用逗号 <code>,</code> 分隔值。如果 <code>study_id</code> 本身包含逗号（如 GUID 或其他复合值），会导致拼接后的结果无法准确区分原始值。</p></li><li><p>​<strong>解决方案</strong>​：显式指定其他分隔符（例如分号 <code>;</code>）：</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    cluster_id,</span><br><span class="line">    GROUP_CONCAT(DISTINCT study_id SEPARATOR &#x27;;&#x27;) AS study_ids</span><br><span class="line">FROM t_sdb_study_site</span><br><span class="line">WHERE is_deleted = 0</span><br><span class="line">GROUP BY cluster_id;</span><br></pre></td></tr></table></figure></li></ul><h3 id="​3-大量-DISTINCT-可能导致性能问题​"><a href="#​3-大量-DISTINCT-可能导致性能问题​" class="headerlink" title="​3. 大量 DISTINCT 可能导致性能问题​"></a>​<strong>3. 大量 DISTINCT 可能导致性能问题</strong>​</h3><ul><li><p>​<strong>问题说明</strong>​：当单个 <code>cluster_id</code> 包含大量唯一的 <code>study_id</code> 时，<code>DISTINCT</code> 操作可能消耗较多内存和 CPU。</p></li><li><p>​<strong>解决方案</strong>​：确保 <code>(cluster_id, study_id)</code> 上有索引，减少临时表操作：</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX idx_cluster_study ON t_sdb_study_site(cluster_id, study_id);</span><br></pre></td></tr></table></figure></li></ul><h3 id="​4-缺少-NULL-值处理​"><a href="#​4-缺少-NULL-值处理​" class="headerlink" title="​4. 缺少 NULL 值处理​"></a>​<strong>4. 缺少 NULL 值处理</strong>​</h3><ul><li><p>​<strong>问题说明</strong>​：如果 <code>study_id</code> 存在 <code>NULL</code> 值，<code>DISTINCT</code> 会直接忽略它，但业务逻辑可能需要记录缺失值。</p></li><li><p>​<strong>解决方案</strong>​：使用 <code>COALESCE()</code> 替换 NULL（例如标记为 ‘N&#x2F;A’）：</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    cluster_id,</span><br><span class="line">    GROUP_CONCAT(DISTINCT COALESCE(study_id, &#x27;N/A&#x27;) SEPARATOR &#x27;,&#x27;) AS study_ids</span><br><span class="line">FROM t_sdb_study_site</span><br><span class="line">WHERE is_deleted = 0</span><br><span class="line">GROUP BY cluster_id;</span><br></pre></td></tr></table></figure></li></ul><h3 id="​优化后的完整查询​"><a href="#​优化后的完整查询​" class="headerlink" title="​优化后的完整查询​"></a>​<strong>优化后的完整查询</strong>​</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SET SESSION group_concat_max_len = 10 * 1024 * 1024; -- 按需调整长度</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    cluster_id,</span><br><span class="line">    GROUP_CONCAT(DISTINCT study_id ORDER BY study_id ASC SEPARATOR &#x27;,&#x27;) AS study_ids</span><br><span class="line">FROM t_sdb_study_site</span><br><span class="line">WHERE is_deleted = 0</span><br><span class="line">GROUP BY cluster_id;</span><br></pre></td></tr></table></figure><h3 id="​建议​"><a href="#​建议​" class="headerlink" title="​建议​"></a>​<strong>建议</strong>​</h3><ol><li>​<strong>评估数据规模</strong>​：通过抽样检查最大 <code>study_ids</code> 长度，确保 <code>group_concat_max_len</code> 足够大。</li><li>​<strong>验证分隔符</strong>​：确保分隔符（如 <code>;</code>）不出现在 <code>study_id</code> 原始值中。</li><li>​<strong>添加索引</strong>​：在 <code>(cluster_id, study_id)</code> 上创建索引提升分组性能。</li><li>​<strong>业务逻辑检查</strong>​：确认是否需处理 <code>study_id</code> 为 NULL 的情况。</li></ol><h2 id="其他解决方案"><a href="#其他解决方案" class="headerlink" title="其他解决方案"></a>其他解决方案</h2><p>使用全量查询,在代码中进行聚合操作.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;在开发一个用户权限矩阵的功能时,遇到了一个奇怪的问题,数据结果集比预期要少很多.&lt;/p&gt;</summary>
    
    
    
    <category term="work" scheme="https://qbmzc.github.io/categories/work/"/>
    
    
    <category term="MySQL" scheme="https://qbmzc.github.io/tags/MySQL/"/>
    
  </entry>
  
</feed>
