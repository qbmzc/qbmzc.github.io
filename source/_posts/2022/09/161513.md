---
title: Mac M1 删除文件提示"operation not permitted"解决方案
date: 2022-09-16
categories:
  - work
tags:
  - m1
  - macos
  - troubleshooting
prev: 141646.md
next: 231021.md
---

在 Mac M1 上遇到某些监控软件无法通过常规方式卸载的问题，使用 `rm` 命令删除时提示"operation not permitted"错误。本文记录了几种解决方案的尝试过程。

<!-- more -->

## 问题描述

在尝试删除某些系统级应用时遇到权限问题：

```bash
sudo rm -rf /opt/LV*
# 错误信息
# rm: /opt/LVUAAgentInstBaseRoot: Operation not permitted
```

## 方案一：禁用 SIP（系统完整性保护）❌

### 进入 macOS 恢复模式

**M1 芯片 Mac 进入恢复模式步骤：**

1. **关机**：选择苹果菜单 > 关机，等待 Mac 完全关机（屏幕全黑，所有指示灯关闭）

2. **进入恢复模式**：按住电源按钮直到出现"正在载入启动选项"

3. **选择选项**：点击"选项" → "继续"

4. **身份验证**：
   - 选择要恢复的宗卷 → "下一步"
   - 选择管理员账户 → "下一步"  
   - 输入管理员密码 → "继续"

5. **打开终端**：在恢复模式下，选择"实用工具" → "终端"

### SIP 相关命令

```bash
# 查看 SIP 状态
csrutil status

# 禁用 SIP（不推荐）
csrutil disable

# 重启系统
reboot

# 重新启用 SIP（推荐在操作完成后执行）
csrutil enable
```

**结果**：此方案无法解决问题，文件仍然无法删除。

## 方案二：完全磁盘访问权限 ❌

通过系统偏好设置 → 安全性与隐私 → 隐私 → 完全磁盘访问权限，为终端添加权限。

![完全磁盘访问权限设置](https://fastly.jsdelivr.net/gh/qbmzc/images/2022/202209161521088.png)

**结果**：此方案同样无法解决问题。

## 方案三：移除 schg 标志 ✅

### 解决步骤

1. **禁用相关权限**：在系统设置中禁用目标应用的启动项、磁盘访问等相关权限

2. **移除文件保护标志**：

```bash
cd /opt

# 移除 schg（system immutable）标志
sudo chflags -hv noschg target_app.app

# 删除文件/文件夹
sudo rm -rf target_app.app
```

**参数说明**：
- `chflags`：修改文件标志的命令
- `-h`：如果文件是符号链接，修改链接本身而不是目标
- `-v`：显示详细输出
- `noschg`：移除 system immutable 标志
- `schg`：system immutable 标志，防止文件被修改或删除

### 批量处理

如果有多个文件夹需要处理：

```bash
cd /opt
for dir in LV*; do
    sudo chflags -hv noschg "$dir"
    sudo rm -rf "$dir"
done
```

## 总结

对于 Mac M1 上"operation not permitted"错误：

1. **SIP 禁用**和**完全磁盘访问权限**方案均无效
2. **移除 schg 标志**是有效解决方案
3. 某些系统级应用使用了文件保护标志来防止被删除
4. 操作前建议先在系统设置中禁用相关应用的权限

## 参考资料

- [Apple Developer Forums - rm results in "operation not permitted"](https://developer.apple.com/forums/thread/115632)
- [macOS File Flags Documentation](https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man1/chflags.1.html)