---
title: DNS解析异常导致视频播放缓慢问题排查与解决
date: 2025-10-13 13:42:34
tags:
  - dns
  - 网络排查
  - 视频播放
categories:
  - Linux
toc: true
---

## 问题描述

测试环境HLS视频播放出现严重延迟问题，用户反馈视频需要多次重试才能正常播放。通过排查发现是DNS解析异常导致的网络延迟问题。

<!-- more -->


### 问题现象

业务线同学反馈测试环境的m3u8文件访问异常缓慢，视频播放需要多次重试才能成功。

**问题URL：**
```bash
http://hls.itaimei.test.taimei.com/resources/hls/8ac0804d99eb075b019a0495da090003/8ac0804d99eb075b019a0495da090003_1080p.m3u8
```

## 排查过程

### 1. 初步验证

- **本地播放器测试**：使用IINA或VLC播放器无法复现问题
- **命令行测试**：使用curl访问速度正常

```bash
# 模拟浏览器请求测试
curl -o a.m3u8 -v 'http://hls.itaimei.test.taimei.com/resources/hls/8ac0804d99eb075b019a0495da090003/8ac0804d99eb075b019a0495da090003_1080p.m3u8' \
  -H 'Accept: */*' \
  -H 'Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6' \
  -H 'Cache-Control: no-cache' \
  -H 'Connection: keep-alive' \
  -H 'DNT: 1' \
  -H 'Origin: http://trialos.test.com' \
  -H 'Pragma: no-cache' \
  -H 'Referer: http://trialos.test.com/' \
  -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36 Edg/141.0.0.0' \
  --insecure
```

### 2. 网络层排查

- **Ping测试**：`ping -c 5 hls.itaimei.test.taimei.com` 速度正常
- **关键发现**：不同环境返回的解析IP不一致，怀疑DNS解析问题

### 3. 浏览器性能分析

![](https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2025/20251022134836170.png)

**性能分析结果：**
- **DNS 查找**：0 μs（正常）
- **初始连接**：40.56秒 ⚠️
- **请求/响应**：40.56秒 ⚠️

**问题定位**：DNS解析耗时过长，导致整个请求延迟。

## DNS问题排查

### 1. DNS解析测试

```bash
# 检查 DNS 解析时间
nslookup hls.itaimei.test.taimei.com

# 使用dig获取更详细信息
dig hls.itaimei.test.taimei.com

# 检查解析时间
dig +trace hls.itaimei.test.taimei.com
```

### 2. 问题确认

通过DNS解析测试发现：
- 不同DNS服务器返回不同的IP地址
- 部分DNS服务器解析速度极慢
- 存在异常的DNS记录

### 3. 解决方案

**临时解决**：修改本地hosts文件，直接指定IP地址
```bash
# 编辑 /etc/hosts
echo "10.64.11.116 hls.itaimei.test.taimei.com" >> /etc/hosts
```

**根本解决**：联系运维团队清理异常的DNS记录

## 问题总结

### 根本原因
DNS服务器配置异常，存在多个解析记录，其中部分记录指向了不可达或响应缓慢的服务器。

### 影响范围
- 主要影响浏览器访问
- 命令行工具（curl）和本地播放器不受影响
- 不同网络环境表现不一致

### 预防措施

1. **DNS监控**：建立DNS解析时间监控
2. **多环境测试**：在不同网络环境下进行测试
3. **DNS记录管理**：定期清理无效DNS记录
4. **备用方案**：配置CDN或负载均衡

### 排查经验

1. **分层排查**：从应用层到网络层逐步排查
2. **对比测试**：使用不同工具验证问题
3. **环境差异**：关注不同环境下的表现差异
4. **性能分析**：利用浏览器开发者工具分析网络性能
