---
title: dig命令使用详解
date: 2025-10-23 09:46:09
tags:
  - DNS
categories:
  - Linux
toc: true
---

dig（Domain Information Groper）是一个强大的命令行工具，用于查询 DNS 域名系统。它是网络管理员和开发人员诊断 DNS 问题的首选工具之一。本文将从基础到高级，全面介绍 dig 命令的使用方法。

## 什么是 dig 命令

dig 是 BIND DNS 服务器软件包提供的 DNS 查询工具，可以用来查询 DNS 服务器的响应信息。相比传统的 nslookup 工具，dig 提供更详细的输出和更灵活的功能。

## 基础用法

### 最简单的查询

查询域名的 A 记录：

```bash
dig baidu.com
```

这个命令会返回有关 baidu.com 域名的详细信息，包括：
- DNS 查询头部信息
- ANSWER 部分（查询结果）
- AUTHORITY 部分（权威 DNS 服务器）
- ADDITIONAL 部分（额外信息）

### 查询特定记录类型

```bash
dig baidu.com A      # 查询 A 记录（IPv4 地址）
dig baidu.com AAAA   # 查询 AAAA 记录（IPv6 地址）
dig baidu.com MX     # 查询邮件交换记录
dig baidu.com NS     # 查询名称服务器记录
dig baidu.com CNAME  # 查询别名记录
dig baidu.com TXT    # 查询文本记录
```

## 常见参数详解

### -@ 指定 DNS 服务器

```bash
dig @8.8.8.8 baidu.com
dig @1.1.1.1 baidu.com
dig @ns1.google.com baidu.com
```

使用 `-@` 参数可以指定 DNS 服务器进行查询，这对于测试特定 DNS 服务器的响应非常有用。

### +short 简短输出

默认情况下，dig 会输出很多详细信息。如果只想要 IP 地址：

```bash
dig +short baidu.com
# 输出：220.181.38.148
# 输出：39.156.66.10
```

### +noall +answer 只显示答案

```bash
dig +noall +answer baidu.com
```

这个组合参数只显示查询结果，不显示头部和统计信息。

### +trace 跟踪查询过程

```bash
dig +trace baidu.com
```

从根域名服务器开始，完整显示 DNS 查询的完整路径，包括每一步的查询过程。

### +recurse 递归查询

```bash
dig +recurse baidu.com
```

这是默认行为，让本地 DNS 服务器递归查询。

### +norecurse 非递归查询

```bash
dig +norecurse baidu.com
```

只查询指定的 DNS 服务器，不进行递归查询。

### -x 反向查询

查询 IP 地址对应的域名：

```bash
dig -x 8.8.8.8
# 输出 dns.google
```

### -p 指定端口

```bash
dig -p 5353 baidu.com
```

指定 DNS 查询使用的端口号（默认是 53）。

### +time= 设置超时

```bash
dig +time=1 baidu.com
```

设置查询超时时间（秒）。

### +tries 设置重试次数

```bash
dig +tries=3 baidu.com
```

设置查询重试次数。

## 实用技巧

### 1. 批量查询多个域名

```bash
for domain in baidu.com google.com github.com; do
    dig +short $domain
done
```

### 2. 监控 DNS 响应时间

```bash
dig baidu.com | grep "Query time:"
```

### 3. 只获取 IPv4 地址

```bash
dig +short baidu.com A
```

### 4. 只获取 IPv6 地址

```bash
dig +short baidu.com AAAA
```

### 5. 查询 TXT 记录（常用于验证域名所有权）

```bash
dig +short baidu.com TXT
```

### 6. 查询 MX 记录（邮件服务器）

```bash
dig +short baidu.com MX
# 输出优先级和邮件服务器
```

### 7. 测试 DNS 解析速度

```bash
dig @1.1.1.1 baidu.com | grep "Query time"
dig @8.8.8.8 baidu.com | grep "Query time"
```

### 8. 查看详细统计信息

```bash
dig baidu.com +stats
```

## 高级用法

### 查找域名解析的完整路径

```bash
dig +trace google.com
```

这显示了从根服务器到权威服务器的完整解析路径。

### 查询 SOA 记录

```bash
dig +short baidu.com SOA
```

获取域名的起始授权机构记录，包含管理邮箱、序列号等信息。

### 使用 dig 调试 DNS

```bash
dig -4 baidu.com      # 只使用 IPv4
dig -6 baidu.com      # 只使用 IPv6
dig baidu.com +cdflag # 设置检查禁用标志
```

### 保存查询结果到文件

```bash
dig baidu.com > result.txt
```

### 组合多个选项

```bash
dig +noall +answer +short baidu.com A
```

这个命令结合了 `+noall`（不显示标题）、`+answer`（显示答案）、`+short`（简短输出），只返回 IP 地址。

## 实际应用场景

### 场景 1：DNS 故障排查

```bash
# 1. 查询本地 DNS 能否解析
dig baidu.com

# 2. 查询公共 DNS 能否解析
dig @8.8.8.8 baidu.com

# 3. 对比结果找出问题
```

### 场景 2：CDN 节点测试

```bash
# 测试不同 DNS 服务器返回的 IP 是否不同
dig @8.8.8.8 baidu.com +short
dig @1.1.1.1 baidu.com +short
dig @223.5.5.5 baidu.com +short
```

### 场景 3：验证 DNS 记录修改

```bash
# 查询修改后的 DNS 记录是否生效
dig newrecord.example.com

# 如果本地有缓存，指定权威 DNS 服务器查询
dig @ns1.example.com newrecord.example.com
```

### 场景 4：检查邮件服务器配置

```bash
# 查询 MX 记录
dig example.com MX

# 查询 A 记录和 CNAME 记录
dig mail.example.com
dig mail.example.com CNAME
```

## 输出信息解读

理解 dig 的输出信息很重要：

- **QUESTION SECTION**：查询的问题
- **ANSWER SECTION**：DNS 服务器的回答
- **AUTHORITY SECTION**：权威 DNS 服务器信息
- **ADDITIONAL SECTION**：额外的记录
- **Query time**：查询耗时
- **SERVER**：查询的 DNS 服务器
- **WHEN**：查询时间

## 常见问题排查

### 1. DNS 解析缓慢

```bash
dig baidu.com +stats
```

查看各个阶段的耗时，定位瓶颈。

### 2. DNS 污染检测

```bash
dig baidu.com @8.8.8.8
dig baidu.com @1.1.1.1
dig baidu.com @114.114.114.114
```

对比不同 DNS 服务器返回的结果。

### 3. 解析异常

```bash
dig +trace baidu.com
```

使用 trace 模式查看完整的解析路径，找出在哪一步出现问题。

## dig vs 其他工具

### dig vs nslookup

- dig：输出更详细，更适合调试
- nslookup：交互式，但输出不够详细

### dig vs host

```bash
host baidu.com
dig baidu.com
```

dig 提供更详细的信息，host 输出更简洁。

## 总结

dig 命令是 DNS 查询的强大工具，掌握它可以：

- 快速诊断 DNS 问题
- 测试 DNS 配置
- 分析网络性能
- 调试 DNS 相关故障

通过本文的介绍，相信你已经掌握了 dig 命令的基础和高级用法。在日常工作中，灵活运用这些技巧，能够大大提高 DNS 故障排查的效率。

