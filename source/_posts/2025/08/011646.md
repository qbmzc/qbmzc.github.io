---
title: PPT添加水印功能
date: 2025-08-01
tags:
  - poi
categories: Java
toc: true
---

在Java中实现PPT添加水印功能，可以借助Apache POI库操作PPTX文件。以下是详细实现方案：

### 核心思路

1. ​**使用母版添加水印**​：在幻灯片母版中插入文本框
2. ​**样式控制**​：设置文本透明度、旋转角度、位置
3. ​**跨平台兼容**​：处理PPTX格式的现代Office文件

### 代码实现

```java
package com.cong.filetest.ppt;

import org.apache.poi.util.Units;
import org.apache.poi.xslf.usermodel.*;

import java.awt.*;
import java.awt.geom.Rectangle2D;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.nio.file.Files;

public class PPTWatermarkFix {

    public static void addWatermark(File input, File output, String text) throws IOException {
        try (XMLSlideShow ppt = new XMLSlideShow(Files.newInputStream(input.toPath()))) {
            Dimension pageSize = ppt.getPageSize();

            // 遍历所有母版
            for (XSLFSlideMaster master : ppt.getSlideMasters()) {
                // 在所有版式上添加水印
                for (XSLFSlideLayout layout : master.getSlideLayouts()) {
                    addWatermarkToLayout(layout, text, pageSize);
                }
            }

            try (FileOutputStream out = new FileOutputStream(output)) {
                ppt.write(out);
            }
        }
    }

    private static void addWatermarkToLayout(XSLFSlideLayout layout, String text, Dimension pageSize) {
        // 创建文本框
        XSLFTextBox watermark = layout.createTextBox();

        // 设置水印文本
        XSLFTextParagraph p = watermark.addNewTextParagraph();
        XSLFTextRun r = p.addNewTextRun();
        r.setText(text);

        // 设置水印样式
        r.setFontSize(48.0);
        r.setFontColor(new Color(200, 200, 200)); // 浅灰色
        r.setFontFamily("Arial");

        // 重要：正确设置透明度 (0.7 = 70% 不透明 / 30% 透明)
        r.getRPr(true).getSolidFill().getSrgbClr().addNewAlpha().setVal(70000);

        // 居中定位 (使用百分比定位)
        double width = Units.pointsToPixel(350); // 文本宽度
        double height = Units.pointsToPixel(100); // 文本高度
        double centerX = (pageSize.getWidth() - width) / 2;
        double centerY = (pageSize.getHeight() - height) / 2;

        watermark.setAnchor(new Rectangle2D.Double(
                centerX, centerY, width, height
        ));

        // 设置旋转角度 (30度)
        watermark.setRotation(-30);

    }



    // 使用示例
    public static void main(String[] args) {
        try {
            addWatermark(
                    new File("/home/cong/Space/filetest/src/test/java/com/cong/filetest/ppt/水印测试文件.pptx"),
                    new File("/home/cong/Space/filetest/src/test/java/com/cong/filetest/ppt/output.pptx"),
                    "CONFIDENTIAL"
            );
            System.out.println("水印添加成功！");
        } catch (IOException e) {
            System.err.println("操作失败: " + e.getMessage());
        }
    }
}

```

### 关键实现说明

1. ​**母版定位**​：
    
    - `getSlideMasters().get(0)` 获取第一张主母版
    - `BLANK` 版式确保不影响已有布局（可根据需要改用 `TITLE_AND_CONTENT` 等）
2. ​**水印特性**​：
    
    - 透明度控制：通过 `setAlpha()` 方法设置RGB透明度值
    - 旋转角度：`setRotation(30)` 实现30度倾斜效果
    - 精确定位：`Rectangle2D.Double` 控制水印位置和大小
3. ​**排除标题页**​：
    
    - 默认只在普通版式添加水印
    - 如需标题页水印，取消注释代码中的标题母版处理
4. ​**样式扩展**​：
    
    ```java
    // 可添加的额外样式设置
    r.setBold(true);                       // 粗体
    r.setFontFamily("Arial");              // 字体
    watermark.setLineWidth(0);            // 去除边框
    watermark.setFillColor(Color.RED);     // 更改文字颜色
    ```
    

### 注意事项

1. ​**库依赖**​：
    
    ```xml
    <!-- Maven 依赖 -->
    <dependency>
        <groupId>org.apache.poi</groupId>
        <artifactId>poi</artifactId>
        <version>5.2.0</version>
    </dependency>
    <dependency>
        <groupId>org.apache.poi</groupId>
        <artifactId>poi-ooxml</artifactId>
        <version>5.2.0</version>
    </dependency>
    ```
    
2. ​**兼容性问题**​：
    
    - 仅支持PPTX格式（Office 2007+）
    - 若需要支持PPT旧格式，需使用`HSLFSlideShow`，但功能受限
3. ​**位置调整技巧**​：
    
    - 使用`ppt.getPageSize().getWidth()/Height()`获取幻灯片尺寸
    - 推荐居中定位公式：
        
        ```java
        double x = (ppt.getPageSize().getWidth() - 500) / 2;
        double y = (ppt.getPageSize().getHeight() - 100) / 2;
        ```
        

此方法生成的PPT水印具有Office原生水印特性：

- 无法被普通用户直接删除（需进入母版视图）
- 自动应用至所有匹配版式的幻灯片
- 保留矢量特性可无损缩放

## [参考方案](https://support.microsoft.com/zh-cn/office/%E5%90%91%E5%B9%BB%E7%81%AF%E7%89%87%E6%B7%BB%E5%8A%A0%E6%B0%B4%E5%8D%B0-1246244d-f465-4e4f-b9f9-49acdae00ff1)
> 在 PowerPoint 中，可以在幻灯片中放置文本背景以获取该水印效果。
> 
> 1. 若要向所有幻灯片添加水印，选择“**视图**”>“**幻灯片母版**”。 滚动到左侧缩略图窗格的顶部，选择第一项“幻灯片母版”。
    
> 2. 选择“**插入**”>“**文本框**”，然后在幻灯片母版上单击并拖动鼠标，画出文本框。
    
> 3. 在文本框中键入水印文本 (，例如“DRAFT”、“CONFIDENTIAL”或公司名称) 。
    
> 4. 若要更改水印文本的对齐方式，请在文本框顶部单击并按住旋转图柄，然后向左或向右移动鼠标。
    
> 5. 选中文本框中的文本。 选择浅色字体填充颜色，然后对字体和样式进行任何其他更改。 (如果看不到“ **格式** ”选项卡，请确保已选择文本框。)
    
> 6. 退出“**幻灯片母版**”。 除标题页外的所有幻灯片都会具有该文本。