---
title: 解决IllegalStateException
date: 2025-09-04 14:06:09
tags:
  - Spring
categories:
  - Java
toc: true
---

解决 java.lang.IllegalStateException: ut010005: can…


<!-- more -->


## IllegalStateException


此错误通常发生在尝试同时调用 HttpServletResponse 的 getOutputStream() 和 getWriter() 方法时。根据 Servlet 规范，这两者不能同时使用，因为它们分别用于二进制数据和字符数据的输出。

## 示例问题

```java
response.getWriter().write("Hello, World!");
response.getOutputStream().write("Hello, World!".getBytes());
```



运行上述代码会抛出 IllegalStateException，因为在调用 getWriter() 后再调用 getOutputStream() 是不允许的。

## 解决方案

1. 统一使用 getWriter() 或 getOutputStream()

确保在整个响应处理中只使用一种输出方式。如果需要输出文本内容，使用 getWriter()；如果需要输出二进制数据（如文件下载），使用 getOutputStream()。

示例：

```java
// 使用 getWriter()
response.setContentType("text/plain");
response.getWriter().write("This is a text response.");
// 使用 getOutputStream()
response.setContentType("application/octet-stream");
response.getOutputStream().write("This is binary data.".getBytes());
```

2. 使用 ResponseEntity 替代直接操作 HttpServletResponse

在 Spring 框架中，可以通过返回 ResponseEntity 来避免直接操作响应流。

示例：

```java
 @GetMapping("/download")
public ResponseEntity<byte[]> downloadFile() {
	byte[] data = "File content".getBytes(StandardCharsets.UTF_8);
	HttpHeaders headers = new HttpHeaders();
	headers.setContentDispositionFormData("attachment", "file.txt");
	headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);
	return new ResponseEntity<>(data, headers, HttpStatus.OK);
}	
```

3. 避免在 JSP 中混用输出流

如果在 JSP 页面中使用了 out 对象（由 getWriter() 提供），不要再调用 getOutputStream()。可以通过清空缓存并更新上下文来解决冲突。

示例：

```java
response.reset();
response.setContentType("application/vnd.ms-excel");
out.clear();
out = pageContext.pushBody();
response.getOutputStream().write("Excel content".getBytes());
```

通过以上方法，可以有效避免和解决该异常，提高代码的稳定性和可维护性。

