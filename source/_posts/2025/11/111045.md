---
title: 一次修复 PDF 中文乱码的排查记录
date: 2025-11-11 10:46:09
tags:
  - PDF
  - 编码问题
  - 故障排查
categories:
  - 技术笔记
toc: true
---

最近遇到一个有趣的问题：客户反馈 PDF 文件预览时出现中文乱码，无论使用 WPS 还是浏览器都无法正常显示。经过一番排查，最终定位到是字符编码问题。

<!-- more -->

## 问题描述

客户提供的 PDF 文件在多个阅读器中都显示为乱码：
- WPS Office：中文显示异常
- 浏览器（Chrome/Edge）：中文显示异常
- 其他 PDF 阅读器：同样存在问题

## 排查过程

### 1. 验证文件类型

首先怀疑文件本身可能不是标准的 PDF 格式，或者文件损坏。

```shell
# 使用 file 命令检查文件类型
file a.pdf
# 输出：a.pdf: PDF document, version 1.x

# 也可以使用 Apache Tika 进行更详细的类型检测
```

**结论**：文件类型正常，是标准的 PDF 文档。

### 2. 检查字体缺失

考虑到可能是 PDF 中使用的中文字体在系统中不存在，导致无法正常渲染。

**测试方法**：
- 在不同操作系统（Windows、macOS、Linux）上测试
- 使用不同的 PDF 阅读器打开

**结论**：问题依然存在，排除字体缺失的可能性。

### 3. 定位编码问题

最后怀疑是字符编码问题，PDF 内部的文本流编码与阅读器预期不一致。

#### 3.1 检查 PDF 结构

使用文本编辑器（如 Vim、Notepad++）以二进制模式打开 PDF：

```
%PDF-1.4
...
%%EOF
```

文件头和文件尾都正常，说明 PDF 结构完整。

#### 3.2 尝试修复

**操作步骤**：
1. **备份原文件**（重要！避免数据丢失）
2. 使用支持编码转换的文本编辑器打开 PDF
3. 将文件编码从 UTF-8 转换为 GBK
4. 保存后重新用 PDF 阅读器打开

**结果**：✅ 中文显示正常！

## 问题原因

经过分析，问题的根本原因是：

**PDF 生成时的编码不一致**：
- PDF 内部用于存储中文文本的字符流使用了 **GBK**（或 GB2312）编码
- 但 PDF 阅读器默认按照 **UTF-8** 或其他编码方式解析
- 导致中文字符无法正确映射，显示为乱码

## 解决方案

### 临时方案
对于已经生成的乱码 PDF：
1. 备份原文件
2. 使用文本编辑器转换编码为 GBK
3. 验证修复效果

### 根本方案
从源头避免问题：
1. **统一编码标准**：在生成 PDF 时明确指定使用 UTF-8 编码
2. **嵌入字体**：在 PDF 中嵌入所需的中文字体，避免依赖系统字体
3. **使用标准库**：使用成熟的 PDF 生成库（如 iText、PDFBox、wkhtmltopdf）并正确配置编码参数

## 经验总结

1. **编码问题是中文环境下的常见坑**：UTF-8、GBK、GB2312 等编码混用容易导致乱码
2. **排查要有条理**：从文件完整性 → 字体 → 编码，逐步缩小问题范围
3. **备份很重要**：在尝试修复前一定要备份原文件
4. **预防胜于治疗**：在开发阶段就应该规范编码标准，避免后期出现问题

## 相关工具

- `file`：Linux 文件类型检测工具
- Apache Tika：文件类型和元数据提取工具
- PDFBox：Java PDF 处理库
- iText：强大的 PDF 生成和处理库

---

*如果你也遇到类似的 PDF 乱码问题，希望这篇文章能帮到你！*




