<!DOCTYPE html>
<html lang="zh">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/favicon.ico">
  
  <title>定时任务技术调研 | 沐曦留曳</title>
  <meta name="author" content="cong" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="job" />
  
  <meta name="description" content="定时任务技术调研">
<meta property="og:type" content="article">
<meta property="og:title" content="定时任务技术调研">
<meta property="og:url" content="https://qbmzc.github.io/2024/02/18/2024/02/0418462/index.html">
<meta property="og:site_name" content="沐曦留曳">
<meta property="og:description" content="定时任务技术调研">
<meta property="og:locale">
<meta property="og:image" content="https://qbmzc.github.io/images/favicon.ico">
<meta property="article:published_time" content="2024-02-17T16:00:00.000Z">
<meta property="article:modified_time" content="2025-10-27T10:42:24.238Z">
<meta property="article:author" content="cong">
<meta property="article:tag" content="job">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qbmzc.github.io/images/favicon.ico">
  <link rel="alternate" href="rss.xml" type="application/atom+xml">
  <!-- 站点验证相关 -->
  
    
      <meta name="google-site-verification" content="lV4cead5YlJ8KpODToP7dvzi-ihrxSqU0yYStYKj2ao" />
    
    
      <meta name="baidu-site-verification" content="codeva-Zr6WlkDupK" />
    
    
      <meta name="msvalidate.01" content="2D2197DEE362D193B3EC29AFD3306341" />
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/banner.webp');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/bg.webp');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 7.3.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">沐曦留曳</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>沐曦留曳</h2> <br />
                        <span></span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://qbmzc.github.io/2024/02/18/2024/02/0418462/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">定时任务技术调研</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2024-02-17T16:00:00.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2024-02-18</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">cong</span>
                </li>
                <li>
                    <i class="fa fa-edit"></i> 
                    
                    
                        ~52.02K
                    
                    字
                </li>
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1761561744238"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
                <div class="kratos-post-inner-toc">
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Quartz-%E9%9B%86%E7%BE%A4"><span class="toc-number">2.</span> <span class="toc-text">Quartz(集群)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">2.1.</span> <span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8BJob"><span class="toc-number">2.2.</span> <span class="toc-text">示例Job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Quartz%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">2.4.</span> <span class="toc-text">Quartz表结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DataSourceConfiguration"><span class="toc-number">2.5.</span> <span class="toc-text">DataSourceConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">2.6.</span> <span class="toc-text">定时任务配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%96%B9%E5%BC%8F%E8%BF%90%E8%A1%8C"><span class="toc-number">2.7.</span> <span class="toc-text">集群方式运行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">2.7.1.</span> <span class="toc-text">集群任务调度的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%97%B6%E6%89%A7%E8%A1%8C%E7%9A%84%E6%9C%80%E5%A4%A7%E4%BB%BB%E5%8A%A1%E6%95%B0"><span class="toc-number">2.7.2.</span> <span class="toc-text">同时执行的最大任务数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Quartz%E5%A4%84%E7%90%86%E8%80%97%E6%97%B6%E8%BE%83%E9%95%BF%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.7.3.</span> <span class="toc-text">Quartz处理耗时较长的任务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">2.8.</span> <span class="toc-text">集群故障转移</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E4%BB%BB%E5%8A%A1%E5%86%B2%E7%AA%81%E5%92%8C%E5%AE%B9%E9%94%99"><span class="toc-number">2.8.1.</span> <span class="toc-text">处理集群环境下的任务冲突和容错</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XXL-JOB"><span class="toc-number">3.</span> <span class="toc-text">XXL-JOB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">3.1.</span> <span class="toc-text">初始化数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%83%A8%E7%BD%B2%E2%80%9C%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83%E2%80%9D"><span class="toc-number">3.2.</span> <span class="toc-text">配置部署“调度中心”</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83%E9%9B%86%E7%BE%A4"><span class="toc-number">3.2.1.</span> <span class="toc-text">调度中心集群</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%99%A8%E9%A1%B9%E7%9B%AE"><span class="toc-number">3.3.</span> <span class="toc-text">执行器项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="toc-number">3.3.2.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%99%A8%E7%BB%84%E4%BB%B6%EF%BC%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.3.</span> <span class="toc-text">执行器组件，配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%99%A8%E9%9B%86%E7%BE%A4"><span class="toc-number">3.3.4.</span> <span class="toc-text">执行器集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Job-BEAN"><span class="toc-number">3.3.5.</span> <span class="toc-text">Job(BEAN)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">3.4.</span> <span class="toc-text">架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-number">3.4.1.</span> <span class="toc-text">设计思想</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%BB%84%E6%88%90"><span class="toc-number">3.4.2.</span> <span class="toc-text">系统组成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">3.4.3.</span> <span class="toc-text">架构图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E7%A0%94%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97"><span class="toc-number">3.4.4.</span> <span class="toc-text">自研调度模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83HA%EF%BC%88%E9%9B%86%E7%BE%A4%EF%BC%89"><span class="toc-number">3.4.5.</span> <span class="toc-text">调度中心HA（集群）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">3.4.6.</span> <span class="toc-text">调度线程池</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B6%E8%A1%8C%E8%B0%83%E5%BA%A6"><span class="toc-number">3.4.7.</span> <span class="toc-text">并行调度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%9C%9F%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-number">3.4.8.</span> <span class="toc-text">过期处理策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1HA%EF%BC%88Failover%EF%BC%89"><span class="toc-number">3.4.9.</span> <span class="toc-text">任务HA（Failover）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9D%87%E8%A1%A1%E8%B0%83%E5%BA%A6"><span class="toc-number">3.4.10.</span> <span class="toc-text">均衡调度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB-%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95"><span class="toc-number">3.4.11.</span> <span class="toc-text">故障转移 &amp; 失败重试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%99%A8%E7%81%B0%E5%BA%A6%E4%B8%8A%E7%BA%BF"><span class="toc-number">3.4.12.</span> <span class="toc-text">执行器灰度上线</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E4%BB%BB%E5%8A%A1%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C"><span class="toc-number">3.4.13.</span> <span class="toc-text">避免任务重复执行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PowerJob"><span class="toc-number">4.</span> <span class="toc-text">PowerJob</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83%EF%BC%88docker%E7%89%88%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">部署调度中心（docker版）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%BA%94%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">注册应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95"><span class="toc-number">4.3.</span> <span class="toc-text">登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">4.4.</span> <span class="toc-text">官方处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%88Processor%EF%BC%89%E5%BC%80%E5%8F%91"><span class="toc-number">4.5.</span> <span class="toc-text">处理器（Processor）开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84-1"><span class="toc-number">4.6.</span> <span class="toc-text">架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">4.6.1.</span> <span class="toc-text">Server 启动流程分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-number">4.6.2.</span> <span class="toc-text">集群</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E5%8C%96%E8%B0%83%E5%BA%A6%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.7.</span> <span class="toc-text">无锁化调度的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%8F%E5%85%B8%E8%B0%83%E5%BA%A6%E5%8E%9F%E7%90%86"><span class="toc-number">4.7.1.</span> <span class="toc-text">经典调度原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%A4%8D%E8%B0%83%E5%BA%A6"><span class="toc-number">4.7.2.</span> <span class="toc-text">重复调度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E5%8C%96%E8%B0%83%E5%BA%A6"><span class="toc-number">4.7.3.</span> <span class="toc-text">无锁化调度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">4.8.</span> <span class="toc-text">任务配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E9%9D%A0%E8%B0%83%E5%BA%A6%E2%80%94%E2%80%94WAL"><span class="toc-number">4.8.1.</span> <span class="toc-text">可靠调度——WAL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A7%92%E7%BA%A7%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.8.2.</span> <span class="toc-text">秒级任务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Apache-DolphinScheduler"><span class="toc-number">5.</span> <span class="toc-text">Apache DolphinScheduler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E9%94%99%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.0.1.</span> <span class="toc-text">容错设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.0.2.</span> <span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA%EF%BC%88%E5%8A%A0%E6%9D%83%EF%BC%89"><span class="toc-number">5.0.3.</span> <span class="toc-text">随机（加权）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B3%E6%BB%91%E8%BD%AE%E8%AF%A2%EF%BC%88%E5%8A%A0%E6%9D%83%EF%BC%89"><span class="toc-number">5.0.4.</span> <span class="toc-text">平滑轮询（加权）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E6%80%A7%E5%8A%A0%E6%9D%83-%E9%BB%98%E8%AE%A4%E7%AE%97%E6%B3%95"><span class="toc-number">5.0.5.</span> <span class="toc-text">线性加权(默认算法)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Elastic-Job"><span class="toc-number">6.</span> <span class="toc-text">Elastic-Job</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="toc-number">6.1.</span> <span class="toc-text">快速开始</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87"><span class="toc-number">6.2.</span> <span class="toc-text">分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">6.3.</span> <span class="toc-text">高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">6.3.1.</span> <span class="toc-text">实现原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%BF%87%E4%BB%BB%E5%8A%A1%E9%87%8D%E6%89%A7%E8%A1%8C"><span class="toc-number">6.4.</span> <span class="toc-text">错过任务重执行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E5%90%AF%E5%8A%A8"><span class="toc-number">6.4.1.</span> <span class="toc-text">作业启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C"><span class="toc-number">6.4.2.</span> <span class="toc-text">作业执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ej%E5%A4%B1%E6%95%88%E8%BD%AC%E7%A7%BB"><span class="toc-number">6.4.3.</span> <span class="toc-text">ej失效转移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%AD%96%E7%95%A5"><span class="toc-number">6.4.4.</span> <span class="toc-text">线程池策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%90%88%E7%90%86%E7%9A%84%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="toc-number">6.4.5.</span> <span class="toc-text">设置合理的超时时间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%BB%B4%E5%B9%B3%E5%8F%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">6.5.</span> <span class="toc-text">运维平台配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-number">6.5.1.</span> <span class="toc-text">启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E5%BC%80%E5%8F%91"><span class="toc-number">6.6.</span> <span class="toc-text">作业开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#zookeeper%E6%95%B0%E6%8D%AE"><span class="toc-number">6.6.1.</span> <span class="toc-text">zookeeper数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94"><span class="toc-number">7.</span> <span class="toc-text">对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E5%88%86%E9%85%8D%E7%BB%86%E8%8A%82%E8%B0%83%E7%A0%94%E6%AF%94%E8%BE%83"><span class="toc-number">8.</span> <span class="toc-text">任务分配细节调研比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">9.</span> <span class="toc-text">参考资料</span></a></li></ol>
                </div>
            
            <hr />
            <div itemprop="articleBody"><p>定时任务技术调研</p>
<span id="more"></span>

<hr>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>目前job-service因为使用的quartz调度，存在以下问题：</p>
<p>1、每次只能单副本运行，无法发挥集群分布式的优势，后期定时任务多起来以后单副本压力会很大</p>
<p>2、每隔十分钟需要从数据库中重新捞一遍定时任务数据加载到quartz中，在重新加载过程中有几率导致本次某个任务丢失不执行</p>
<ul>
<li>需要考虑引入新的分布式调度组件（PowerJob、xxl-job等）</li>
</ul>
<p>NICE TO HAVE（重要）：</p>
<p>1、可以提高稳定性</p>
<p>2、可以提供服务性能</p>
<h2 id="Quartz-集群"><a href="#Quartz-集群" class="headerlink" title="Quartz(集群)"></a>Quartz(集群)</h2><ul>
<li>Scheduler:调度器</li>
<li>Trigger:触发器</li>
<li>Job:任务</li>
</ul>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">优点</th>
<th align="left">缺点</th>
</tr>
</thead>
<tbody><tr>
<td align="left">RAMJobStore</td>
<td align="left">不要外部数据库，配置容易，运行速度快</td>
<td align="left">因为调度程序信息是存储在被分配给 JVM 的内存里面，所以，当应用程序停止运行时，所有调度信息将被丢失。另外因为存储到JVM内存里面，所以可以存储多少个 Job 和 Trigger 将会受到限制</td>
</tr>
<tr>
<td align="left">JDBC 作业存储</td>
<td align="left">支持集群，因为所有的任务信息都会保存到数据库中，可以控制事物，还有就是如果应用服务器关闭或者重启，任务信息都不会丢失，并且可以恢复因服务器关闭或者重启而导致执行失败的任务</td>
<td align="left">运行速度的快慢取决与连接数据库的快慢</td>
</tr>
</tbody></table>
<h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cong<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>job-demo1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>job-demo1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>21<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="示例Job"><a href="#示例Job" class="headerlink" title="示例Job"></a>示例Job</h3><ul>
<li>Job1</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cong.jobdemo1.config.job;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.DisallowConcurrentExecution;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.QuartzJobBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cong.jobdemo1.service.DemoService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 添加了 Quartz 的 <span class="doctag">@DisallowConcurrentExecution</span> 注解，保证相同 JobDetail 在多个 JVM 进程中，有且仅有一个节点在执行。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@DisallowConcurrentExecution</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoJob01</span> <span class="keyword">extends</span> <span class="title class_">QuartzJobBean</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DemoService demoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">      <span class="comment">//自定义的定时任务逻辑</span></span><br><span class="line">        log.info(<span class="string">&quot;[executeInternal][我开始执行了, demoService 为 (&#123;&#125;)]&quot;</span>, demoService);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>job2</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cong.jobdemo1.config.job;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.DisallowConcurrentExecution;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.QuartzJobBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@DisallowConcurrentExecution</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoJob02</span> <span class="keyword">extends</span> <span class="title class_">QuartzJobBean</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;[executeInternal][我开始执行了]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>DisallowConcurrentExecution</code> 保证在多个JVM中有且仅有一个节点在执行，是以 <em><strong>JobDetail</strong></em> 为依据的</p>
<p>而 JobDetail 的<strong>唯一标识</strong>是 JobKey ，使用 <code>name</code> + <code>group</code> 两个属性。一般情况下，我们只需要设置 <code>name</code> 即可，而 Quartz 会默认 <code>group = DEFAULT</code> 。</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">13002</span></span><br><span class="line">  <span class="attr">shutdown:</span> <span class="string">graceful</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.70.58:3307/job?useSSL=false&amp;allowPublicKeyRetrieval=true&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">quartz:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.70.58:3307/quartz?useSSL=false&amp;allowPublicKeyRetrieval=true&amp;useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Quartz 的配置，对应 QuartzProperties 配置类</span></span><br><span class="line">  <span class="attr">quartz:</span></span><br><span class="line">    <span class="attr">scheduler-name:</span> <span class="string">clusteredScheduler</span> <span class="comment"># Scheduler 名字。默认为 schedulerName，相同 Scheduler 名字的节点，形成一个 Quartz 集群。</span></span><br><span class="line">    <span class="attr">job-store-type:</span> <span class="string">jdbc</span> <span class="comment"># Job 存储器类型。默认为 memory 表示内存，可选 jdbc 使用数据库。</span></span><br><span class="line">    <span class="attr">auto-startup:</span> <span class="literal">true</span> <span class="comment"># Quartz 是否自动启动</span></span><br><span class="line">    <span class="attr">startup-delay:</span> <span class="number">0</span> <span class="comment"># 延迟 N 秒启动</span></span><br><span class="line">    <span class="attr">wait-for-jobs-to-complete-on-shutdown:</span> <span class="literal">true</span> <span class="comment"># 应用关闭时，是否等待定时任务执行完成。默认为 false ，建议设置为 true</span></span><br><span class="line">    <span class="attr">overwrite-existing-jobs:</span> <span class="literal">false</span> <span class="comment"># 是否覆盖已有 Job 的配置</span></span><br><span class="line">    <span class="attr">properties:</span> <span class="comment"># 添加 Quartz Scheduler 附加属性，更多可以看 http://www.quartz-scheduler.org/documentation/2.4.0-SNAPSHOT/configuration.html 文档</span></span><br><span class="line">      <span class="attr">org:</span></span><br><span class="line">        <span class="attr">quartz:</span></span><br><span class="line">          <span class="attr">scheduler:</span></span><br><span class="line">            <span class="comment"># 调度器实例名称</span></span><br><span class="line">            <span class="attr">instanceName:</span> <span class="string">QuartzScheduler</span></span><br><span class="line">            <span class="comment"># 分布式节点ID自动生成</span></span><br><span class="line">            <span class="attr">instanceId:</span> <span class="string">AUTO</span></span><br><span class="line">          <span class="comment"># JobStore 相关配置</span></span><br><span class="line">          <span class="attr">jobStore:</span></span><br><span class="line">            <span class="comment"># 数据源名称</span></span><br><span class="line">            <span class="attr">dataSource:</span> <span class="string">quartzDataSource</span> <span class="comment"># 使用的数据源</span></span><br><span class="line"></span><br><span class="line">            <span class="attr">class:</span> <span class="string">org.springframework.scheduling.quartz.LocalDataSourceJobStore</span></span><br><span class="line">            <span class="attr">driverDelegateClass:</span> <span class="string">org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span></span><br><span class="line">            <span class="attr">tablePrefix:</span> <span class="string">QRTZ_</span> <span class="comment"># Quartz 表前缀</span></span><br><span class="line">            <span class="attr">isClustered:</span> <span class="literal">true</span> <span class="comment"># 是集群模式</span></span><br><span class="line">            <span class="attr">clusterCheckinInterval:</span> <span class="number">1000</span></span><br><span class="line">            <span class="attr">useProperties:</span> <span class="literal">false</span></span><br><span class="line">          <span class="comment"># 线程池相关配置</span></span><br><span class="line">          <span class="attr">threadPool:</span></span><br><span class="line">            <span class="attr">threadCount:</span> <span class="number">25</span> <span class="comment"># 线程池大小。默认为 10 。</span></span><br><span class="line">            <span class="attr">threadPriority:</span> <span class="number">5</span> <span class="comment"># 线程优先级</span></span><br><span class="line">            <span class="attr">class:</span> <span class="string">org.quartz.simpl.SimpleThreadPool</span> <span class="comment"># 线程池类型</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">jdbc:</span> <span class="comment"># 使用 JDBC 的 JobStore 的时候，JDBC 的配置</span></span><br><span class="line">      <span class="attr">initialize-schema:</span> <span class="string">always</span> <span class="comment"># 是否自动使用 SQL 初始化 Quartz 表结构。设置成 never ，需要手动创建表结构。</span></span><br></pre></td></tr></table></figure>

<h3 id="Quartz表结构"><a href="#Quartz表结构" class="headerlink" title="Quartz表结构"></a>Quartz表结构</h3><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/202402011526256.png" alt="image-20240201152631029"></p>
<p>每个表都有一个 SCHED_NAME 字段，Quartz Scheduler 名字。这样，实现每个 Quartz 集群，数据层面的拆分</p>
<h3 id="DataSourceConfiguration"><a href="#DataSourceConfiguration" class="headerlink" title="DataSourceConfiguration"></a>DataSourceConfiguration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cong.jobdemo1.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.quartz.QuartzDataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zaxxer.hikari.HikariDataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 user 数据源的配置对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(&quot;userDataSourceProperties&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.user&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceProperties <span class="title function_">userDataSourceProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceProperties</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 user 数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;userDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.user.hikari&quot;)</span> <span class="comment">// 读取 spring.datasource.user 配置到 HikariDataSource</span></span><br><span class="line">                                                                       <span class="comment">// 对象</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">userDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 获得 DataSourceProperties 对象</span></span><br><span class="line">        <span class="type">DataSourceProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="built_in">this</span>.userDataSourceProperties();</span><br><span class="line">        <span class="comment">// 创建 HikariDataSource 对象</span></span><br><span class="line">        <span class="keyword">return</span> createHikariDataSource(properties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 quartz 数据源的配置对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;quartzDataSourceProperties&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.quartz&quot;)</span> <span class="comment">// 读取 spring.datasource.quartz 配置到</span></span><br><span class="line">                                                                  <span class="comment">// DataSourceProperties 对象</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceProperties <span class="title function_">quartzDataSourceProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceProperties</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 quartz 数据源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@QuartzDataSource</span> 注解为我们配置和初始化 Quartz 数据库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;quartzDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.quartz.hikari&quot;)</span></span><br><span class="line">    <span class="meta">@QuartzDataSource</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">quartzDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 获得 DataSourceProperties 对象</span></span><br><span class="line">        <span class="type">DataSourceProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="built_in">this</span>.quartzDataSourceProperties();</span><br><span class="line">        <span class="comment">// 创建 HikariDataSource 对象</span></span><br><span class="line">        <span class="keyword">return</span> createHikariDataSource(properties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HikariDataSource <span class="title function_">createHikariDataSource</span><span class="params">(DataSourceProperties properties)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建 HikariDataSource 对象</span></span><br><span class="line">        <span class="type">HikariDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> properties.initializeDataSourceBuilder().type(HikariDataSource.class).build();</span><br><span class="line">        <span class="comment">// 设置线程池名</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(properties.getName())) &#123;</span><br><span class="line">            dataSource.setPoolName(properties.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="定时任务配置"><a href="#定时任务配置" class="headerlink" title="定时任务配置"></a>定时任务配置</h3><ul>
<li>Bean自动设置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cong.jobdemo1.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.CronScheduleBuilder;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobBuilder;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobDetail;</span><br><span class="line"><span class="keyword">import</span> org.quartz.SimpleScheduleBuilder;</span><br><span class="line"><span class="keyword">import</span> org.quartz.Trigger;</span><br><span class="line"><span class="keyword">import</span> org.quartz.TriggerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cong.jobdemo1.config.job.DemoJob01;</span><br><span class="line"><span class="keyword">import</span> com.cong.jobdemo1.config.job.DemoJob02;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduleConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DemoJob01Configuration</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> JobDetail <span class="title function_">demoJob01</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> JobBuilder.newJob(DemoJob01.class)</span><br><span class="line">                    .withIdentity(<span class="string">&quot;demoJob01&quot;</span>) <span class="comment">// 名字为 demoJob01</span></span><br><span class="line">                    .storeDurably() <span class="comment">// 没有 Trigger 关联的时候任务是否被保留。因为创建 JobDetail 时，还没 Trigger 指向它，所以需要设置为 true ，表示保留。</span></span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Trigger <span class="title function_">demoJob01Trigger</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 简单的调度计划的构造器</span></span><br><span class="line">            <span class="type">SimpleScheduleBuilder</span> <span class="variable">scheduleBuilder</span> <span class="operator">=</span> SimpleScheduleBuilder.simpleSchedule()</span><br><span class="line">                    .withIntervalInSeconds(<span class="number">5</span>) <span class="comment">// 频率。</span></span><br><span class="line">                    .repeatForever(); <span class="comment">// 次数。</span></span><br><span class="line">            <span class="comment">// Trigger 构造器</span></span><br><span class="line">            <span class="keyword">return</span> TriggerBuilder.newTrigger()</span><br><span class="line">                    .forJob(demoJob01()) <span class="comment">// 对应 Job 为 demoJob01</span></span><br><span class="line">                    .withIdentity(<span class="string">&quot;demoJob01Trigger&quot;</span>) <span class="comment">// 名字为 demoJob01Trigger</span></span><br><span class="line">                    .withSchedule(scheduleBuilder) <span class="comment">// 对应 Schedule 为 scheduleBuilder</span></span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DemoJob02Configuration</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> JobDetail <span class="title function_">demoJob02</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> JobBuilder.newJob(DemoJob02.class)</span><br><span class="line">                    .withIdentity(<span class="string">&quot;demoJob02&quot;</span>) <span class="comment">// 名字为 demoJob02</span></span><br><span class="line">                    .storeDurably() <span class="comment">// 没有 Trigger 关联的时候任务是否被保留。因为创建 JobDetail 时，还没 Trigger 指向它，所以需要设置为 true ，表示保留。</span></span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Trigger <span class="title function_">demoJob02Trigger</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 简单的调度计划的构造器</span></span><br><span class="line">            <span class="type">CronScheduleBuilder</span> <span class="variable">scheduleBuilder</span> <span class="operator">=</span> CronScheduleBuilder.cronSchedule(<span class="string">&quot;0/10 * * * * ? *&quot;</span>);</span><br><span class="line">            <span class="comment">// Trigger 构造器</span></span><br><span class="line">            <span class="keyword">return</span> TriggerBuilder.newTrigger()</span><br><span class="line">                    .forJob(demoJob02()) <span class="comment">// 对应 Job 为 demoJob02</span></span><br><span class="line">                    .withIdentity(<span class="string">&quot;demoJob02Trigger&quot;</span>) <span class="comment">// 名字为 demoJob02Trigger</span></span><br><span class="line">                    .withSchedule(scheduleBuilder) <span class="comment">// 对应 Schedule 为 scheduleBuilder</span></span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Quartz 调度器启动的时候，会根据该配置，自动调用如下方法：</p>
<p>​	 <code>Scheduler#addJob(JobDetail jobDetail, boolean replace)</code> 方法，将 JobDetail 持久化到数据库。</p>
<pre><code>	`Scheduler#scheduleJob(Trigger trigger)` 方法，将 Trigger 持久化到数据库。
</code></pre>
<ul>
<li>Scheduler手动设置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cong.jobdemo1.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.JobBuilder;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobDetail;</span><br><span class="line"><span class="keyword">import</span> org.quartz.Scheduler;</span><br><span class="line"><span class="keyword">import</span> org.quartz.SimpleScheduleBuilder;</span><br><span class="line"><span class="keyword">import</span> org.quartz.SimpleTrigger;</span><br><span class="line"><span class="keyword">import</span> org.quartz.TriggerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cong.jobdemo1.config.job.DemoJob03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;task&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getMethodName</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;添加❤️的任务&quot;</span>);</span><br><span class="line">        <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> JobBuilder.newJob(DemoJob03.class)</span><br><span class="line">                .withIdentity(UUID.randomUUID().toString())</span><br><span class="line">                .storeDurably()</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">SimpleScheduleBuilder</span> <span class="variable">repeatForever</span> <span class="operator">=</span> SimpleScheduleBuilder.simpleSchedule()</span><br><span class="line">                .withIntervalInSeconds(<span class="number">10</span>)</span><br><span class="line">                .repeatForever();</span><br><span class="line"></span><br><span class="line">        <span class="type">SimpleTrigger</span> <span class="variable">simpleTrigger</span> <span class="operator">=</span> TriggerBuilder.newTrigger().forJob(jobDetail)</span><br><span class="line">                .withIdentity(UUID.randomUUID().toString())</span><br><span class="line">                .withSchedule(repeatForever)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 如果想要覆盖数据库中的 Quartz 定时任务的配置，</span></span><br><span class="line"><span class="comment">         * 可以调用 Scheduler#scheduleJob(JobDetail jobDetail, Set&lt;? extends Trigger&gt;</span></span><br><span class="line"><span class="comment">         * triggersForJob, boolean replace) 方法，</span></span><br><span class="line"><span class="comment">         * 传入 replace = true 进行覆盖配置。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        scheduler.scheduleJob(jobDetail, simpleTrigger);</span><br><span class="line">        <span class="keyword">if</span> (!scheduler.isShutdown()) &#123;</span><br><span class="line">            scheduler.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="集群方式运行"><a href="#集群方式运行" class="headerlink" title="集群方式运行"></a>集群方式运行</h3><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403041014543.webp"></p>
<h4 id="集群任务调度的原理"><a href="#集群任务调度的原理" class="headerlink" title="集群任务调度的原理"></a>集群任务调度的原理</h4><p>在集群模式下，Quartz通过数据库行锁来确保同一个任务不会被多个节点同时执行。当一个调度器实例尝试执行一个任务时，它会先在数据库中对该任务加锁。如果加锁成功，该实例就会执行任务；否则，意味着有其他实例已经在执行该任务，当前实例就会放弃执行。</p>
<p>BTW，分布式部署时需要保证各个节点的系统时间一致。</p>
<p>Quartz数据库核心表如下：</p>
<table>
<thead>
<tr>
<th align="left">Table Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">QRTZ_CALENDARS</td>
<td align="left">存储Quartz的Calendar信息</td>
</tr>
<tr>
<td align="left">QRTZ_CRON_TRIGGERS</td>
<td align="left">存储CronTrigger，包括Cron表达式和时区信息</td>
</tr>
<tr>
<td align="left">QRTZ_FIRED_TRIGGERS</td>
<td align="left">存储与已触发的Trigger相关的状态信息，以及相联Job的执行信息</td>
</tr>
<tr>
<td align="left">QRTZ_PAUSED_TRIGGER_GRPS</td>
<td align="left">存储已暂停的Trigger组的信息</td>
</tr>
<tr>
<td align="left">QRTZ_SCHEDULER_STATE</td>
<td align="left">存储少量的有关Scheduler的状态信息，和别的Scheduler实例</td>
</tr>
<tr>
<td align="left"><strong>QRTZ_LOCKS</strong></td>
<td align="left"><strong>存储程序的悲观锁的信息</strong></td>
</tr>
<tr>
<td align="left">QRTZ_JOB_DETAILS</td>
<td align="left">存储每一个已配置的Job的详细信息</td>
</tr>
<tr>
<td align="left">QRTZ_JOB_LISTENERS</td>
<td align="left">存储有关已配置的JobListener的信息</td>
</tr>
<tr>
<td align="left">QRTZ_SIMPLE_TRIGGERS</td>
<td align="left">存储简单的Trigger，包括重复次数、间隔、以及已触的次数</td>
</tr>
<tr>
<td align="left">QRTZ_BLOG_TRIGGERS</td>
<td align="left">Trigger作为Blob类型存储</td>
</tr>
<tr>
<td align="left">QRTZ_TRIGGER_LISTENERS</td>
<td align="left">存储已配置的TriggerListener的信息</td>
</tr>
<tr>
<td align="left">QRTZ_TRIGGERS</td>
<td align="left">存储已配置的Trigger的信息</td>
</tr>
</tbody></table>
<p>一个scheduler实例在集群模式下首先获取{0}LOCKS表中的行锁；</p>
<p>向Mysql获取杭锁的语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> &#123;<span class="number">0</span>&#125;LOCKS <span class="keyword">where</span> sched_name <span class="operator">=</span> ? <span class="keyword">and</span> lock_name <span class="operator">=</span> ? <span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>

<p>{0}会替换为配置文件默认配置的**<code>QRTZ_</code>**。sched_name为应用集群的实例名，lock_name就是行级锁名。Quartz主要由两个行级锁。</p>
<table>
<thead>
<tr>
<th align="left">lock_name</th>
<th align="left">desc</th>
</tr>
</thead>
<tbody><tr>
<td align="left">STATE_ACCESS</td>
<td align="left">状态访问锁</td>
</tr>
<tr>
<td align="left">TRIGGER_ACCESS</td>
<td align="left">触发器访问锁</td>
</tr>
</tbody></table>
<p>Quartz集群争用触发器行锁，锁被占用只能等待，获取触发器行锁之后，先获取需要等待触发的其他触发器信息。数据库更新触发器状态信息，及时是否触发器行锁，供其他调度实例获取，然后在进行触发器任务调度操作，对数据库操作就要先获取行锁。</p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403041049320.png" alt="Quartz集群基于锁的同步方案"></p>
<h4 id="同时执行的最大任务数"><a href="#同时执行的最大任务数" class="headerlink" title="同时执行的最大任务数"></a>同时执行的最大任务数</h4><p>在Quartz任务调度框架中，并没有直接定义每个执行器（Executor）的容量上限这一概念。Quartz主要关注的是任务调度和管理，而非线程池大小或并发执行任务的数量这样的执行细节。</p>
<p>不过，如果指的是在Quartz中执行作业时的并发处理能力，那么可以通过配置调度器（Scheduler）使用的线程池来间接控制并发执行任务的数量。Quartz内部可以配置ThreadPool来管理执行作业的线程资源，默认实现是<code>org.quartz.simpl.SimpleThreadPool</code>。</p>
<p>在<code>SimpleThreadPool</code>中，你可以设置如下的参数来控制线程池的行为：</p>
<ol>
<li><code>threadCount</code>：线程池中的线程数量，这可视为“容量上限”之一。</li>
<li><code>threadPriority</code>：线程的优先级。</li>
<li><code>makeThreadsDaemons</code>：是否将线程设为守护线程。</li>
<li><code>threadKeepAliveTime</code>：空闲线程等待新任务的时间，在此时间过后若无新任务则会终止线程。</li>
</ol>
<p>配置示例：</p>
<p>#java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Properties props = new Properties();</span><br><span class="line">props.setProperty(&quot;org.quartz.threadPool.class&quot;, &quot;org.quartz.simpl.SimpleThreadPool&quot;);</span><br><span class="line">props.setProperty(&quot;org.quartz.threadPool.threadCount&quot;, &quot;10&quot;);  // 设置线程池容量上限为10</span><br><span class="line">schedulerFactoryBean.setSchedulerProperties(props);</span><br></pre></td></tr></table></figure>



<p>通过调整这些参数，可以控制调度器能够同时执行的最大任务数，但这并不是对单个执行器的容量上限进行限制，而是整个调度器层面的并发控制。</p>
<h4 id="Quartz处理耗时较长的任务"><a href="#Quartz处理耗时较长的任务" class="headerlink" title="Quartz处理耗时较长的任务"></a>Quartz处理耗时较长的任务</h4><p>会出现<code>Handling 2 trigger(s) that missed their scheduled fire-time.</code>任务会丢失，需要手动设置处理。</p>
<p>Quartz Scheduler 可能会面临一些挑战和问题，具体取决于任务的性质、Quartz Scheduler 的配置以及环境条件等因素。以下是一些可能出现的问题和解决方法：</p>
<ol>
<li><strong>任务执行超时：</strong> 如果任务的执行时间超过了预期，Quartz Scheduler 可能会超出预定的调度间隔，导致调度的不稳定性。可以通过调整任务的执行时间、调度间隔或者使用并行执行来解决这个问题。</li>
<li><strong>资源竞争：</strong> 长时间运行的任务可能会导致资源（如线程、内存）的竞争和耗尽，影响其他任务的执行。可以通过限制任务的并发数量、合理分配资源或者使用异步执行等方式来解决。</li>
<li><strong>数据库连接问题：</strong> 如果任务涉及到数据库操作，长时间的任务可能会导致数据库连接的泄漏或者超时，影响其他任务的执行。可以通过使用连接池、合理管理数据库连接、优化数据库操作等方式来解决。</li>
<li><strong>任务重复执行：</strong> 如果任务在执行期间发生异常或者执行时间超过了预期，Quartz Scheduler 可能会重新调度该任务，导致任务的重复执行。可以通过合理捕获异常、设置任务的状态、使用分布式锁等方式来避免任务的重复执行。</li>
<li><strong>任务状态管理：</strong> 长时间运行的任务可能需要额外的状态管理，以便在执行期间进行监控、中断或者重新调度。可以通过设置任务的状态、使用监控工具、合理设计任务的执行逻辑等方式来管理任务的状态。</li>
</ol>
<h3 id="集群故障转移"><a href="#集群故障转移" class="headerlink" title="集群故障转移"></a>集群故障转移</h3><p>每个服务器会定时（org.quartz.jobStore.clusterCheckinInterval这个时间）更新SCHEDULER_STATE表中的LAST_CHECK_TIME（<strong>将服务器的当前时刻更新为最后更新时刻</strong>）字段，遍历集群各兄弟节点的实例状态，检测集群各个兄弟节点的健康状态。</p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403041023141.png" alt="image-20240304102313076"></p>
<p>Quartz使用了一个随机的负载均衡算法，Job以随机的方式由不同的实例执行。</p>
<h4 id="处理集群环境下的任务冲突和容错"><a href="#处理集群环境下的任务冲突和容错" class="headerlink" title="处理集群环境下的任务冲突和容错"></a>处理集群环境下的任务冲突和容错</h4><p>为了有效地在集群环境下管理任务调度，需要考虑到任务冲突和容错的问题。任务冲突通常发生在两个或两个以上的调度器实例尝试同时执行同一个任务的情况。如前所述，Quartz通过数据库锁机制来避免这种情况的发生。</p>
<p>容错机制是指当一个调度器实例失败时，集群中的其他实例能够接管未完成的任务。Quartz通过持续检查数据库中的锁和任务状态来实现这一点。如果一个实例在执行任务时失败，数据库中的锁将被释放，其他实例就可以接管并执行该任务。</p>
<p>通过部署Quartz到集群环境，能够提高任务调度的可靠性和可用性，确保即使在部分节点出现故障的情况下，任务调度也能正常进行。这对于构建高可用的大规模应用至关重要。</p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403011813806.png" alt="image-20240301181312744"></p>
<p>启动多个实例，本地启动 注意端口不能重复</p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/202402011617651.png" alt="image-20240201161729611"></p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/202402011631693.png" alt="image-20240201163159666"></p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/202402011633120.png" alt="image-20240201163324093"></p>
<hr>
<h2 id="XXL-JOB"><a href="#XXL-JOB" class="headerlink" title="XXL-JOB"></a><a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job/">XXL-JOB</a></h2><blockquote>
<p>XXL-JOB 是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。</p>
</blockquote>
<h3 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载项目源码 “调度数据库初始化SQL脚本” 位置为:</span></span><br><span class="line">/xxl-job/doc/db/tables_xxl_job.sql</span><br></pre></td></tr></table></figure>

<ol>
<li><code>- xxl_job_lock：任务调度锁表；</code></li>
<li><code>- xxl_job_group：执行器信息表，维护任务执行器信息；</code></li>
<li><code>- xxl_job_info：调度扩展信息表： 用于保存XXL-JOB调度任务的扩展信息，如任务分组、任务名、机器地址、执行器、执行入参和报警邮件等等；</code></li>
<li><code>- xxl_job_log：调度日志表： 用于保存XXL-JOB任务调度的历史信息，如调度结果、执行结果、调度入参、调度机器和执行器等等；</code></li>
<li><code>- xxl_job_log_report：调度日志报表：用户存储XXL-JOB任务调度日志的报表，调度中心报表功能页面会用到；</code></li>
<li><code>- xxl_job_logglue：任务GLUE日志：用于保存GLUE更新历史，用于支持GLUE的版本回溯功能；</code></li>
<li><code>- xxl_job_registry：执行器注册表，维护在线的执行器和调度中心机器地址信息；</code></li>
<li><code>- xxl_job_user：系统用户表</code></li>
</ol>
<h3 id="配置部署“调度中心”"><a href="#配置部署“调度中心”" class="headerlink" title="配置部署“调度中心”"></a>配置部署“调度中心”</h3><p><strong>xxl-job-admin</strong> 统一管理任务调度平台上调度任务，负责触发调度执行，并且提供任务管理平台。</p>
<ol>
<li>修改配置文件<code>/xxl-job/xxl-job-admin/src/main/resources/application.properties</code>,修改数据连接地址</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># /xxl-job/xxl-job-admin/src/main/resources/application.properties</span><br><span class="line">### xxl-job, datasource</span><br><span class="line">spring.datasource.url=jdbc:mysql://127.0.0.1:3307/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=123456</span><br><span class="line">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br></pre></td></tr></table></figure>

<p>调度中心访问地址：<a target="_blank" rel="noopener" href="http://localhost:8080/xxl-job-admin">http://localhost:8080/xxl-job-admin</a> (该地址执行器将会使用到，作为回调地址)</p>
<p>默认登录账号 <code>admin/123456</code>, 登录后运行界面如下图所示。</p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/202402011658442.png" alt="image-20240201165810413"></p>
<h4 id="调度中心集群"><a href="#调度中心集群" class="headerlink" title="调度中心集群"></a>调度中心集群</h4><p>调度中心支持集群部署，提升调度系统容灾和可用性。</p>
<p>调度中心集群部署时，几点要求和建议：</p>
<ul>
<li>DB配置保持一致；</li>
<li>集群机器时钟保持一致（单机集群忽视）；</li>
<li>建议：推荐通过nginx为调度中心集群做负载均衡，分配域名。调度中心访问、执行器回调配置、调用API服务等操作均通过该域名进行。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker 方式</span></span><br><span class="line">/**</span><br><span class="line">* 如需自定义 mysql 等配置，可通过 <span class="string">&quot;-e PARAMS&quot;</span> 指定，参数格式 PARAMS=<span class="string">&quot;--key=value  --key2=value2&quot;</span> ；</span><br><span class="line">* 配置项参考文件：/xxl-job/xxl-job-admin/src/main/resources/application.properties</span><br><span class="line">* 如需自定义 JVM内存参数 等配置，可通过 <span class="string">&quot;-e JAVA_OPTS&quot;</span> 指定，参数格式 JAVA_OPTS=<span class="string">&quot;-Xmx512m&quot;</span> ；</span><br><span class="line">*/</span><br><span class="line">docker run -e PARAMS=<span class="string">&quot;--spring.datasource.url=jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai&quot;</span> -p 8080:8080 -v /tmp:/data/applogs --name xxl-job-admin  -d xuxueli/xxl-job-admin:&#123;指定版本&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行器项目"><a href="#执行器项目" class="headerlink" title="执行器项目"></a>执行器项目</h3><h4 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h4><p>确认pom文件中引入了 “xxl-job-core” 的maven依赖；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- xxl-job-core --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.parent.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 调度中心部署根地址 [选填]：如调度中心集群部署存在多个地址则用逗号分隔。执行器将会使用该地址进行&quot;执行器心跳注册&quot;和&quot;任务结果回调&quot;；为空则关闭自动注册；</span></span><br><span class="line"><span class="attr">xxl.job.admin.addresses</span>=<span class="string">http://127.0.0.1:8080/xxl-job-admin </span></span><br><span class="line"><span class="comment">### 执行器通讯TOKEN [选填]：非空时启用；</span></span><br><span class="line"><span class="attr">xxl.job.accessToken</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器AppName [选填]：执行器心跳注册分组依据；为空则关闭自动注册</span></span><br><span class="line"><span class="attr">xxl.job.executor.appname</span>=<span class="string">xxl-job-executor-sample</span></span><br><span class="line"><span class="comment">### 执行器注册 [选填]：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</span></span><br><span class="line"><span class="attr">xxl.job.executor.address</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器IP [选填]：默认为空表示自动获取IP，多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 &quot;执行器注册&quot; 和 &quot;调度中心请求并触发任务&quot;；</span></span><br><span class="line"><span class="attr">xxl.job.executor.ip</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器端口号 [选填]：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；</span></span><br><span class="line"><span class="attr">xxl.job.executor.port</span>=<span class="string">9999</span></span><br><span class="line"><span class="comment">### 执行器运行日志文件存储磁盘路径 [选填] ：需要对该路径拥有读写权限；为空则使用默认路径；</span></span><br><span class="line"><span class="attr">xxl.job.executor.logpath</span>=<span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line"><span class="comment">### 执行器日志文件保存天数 [选填] ： 过期日志自动清理, 限制值大于等于3时生效; 否则, 如-1, 关闭自动清理功能；</span></span><br><span class="line"><span class="attr">xxl.job.executor.logretentiondays</span>=<span class="string">30</span></span><br></pre></td></tr></table></figure>

<h4 id="执行器组件，配置文件"><a href="#执行器组件，配置文件" class="headerlink" title="执行器组件，配置文件"></a>执行器组件，配置文件</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxl.job.executor.core.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xxl-job config</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xuxueli 2017-04-28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> logRetentionDays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> XxlJobSpringExecutor <span class="title function_">xxlJobExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">        <span class="type">XxlJobSpringExecutor</span> <span class="variable">xxlJobSpringExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobSpringExecutor</span>();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setAddress(address);</span><br><span class="line">        xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">        xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对多网卡、容器内部署等情况，可借助 &quot;spring-cloud-commons&quot; 提供的 &quot;InetUtils&quot; 组件灵活定制注册IP；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      1、引入依赖：</span></span><br><span class="line"><span class="comment">     *          &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span></span><br><span class="line"><span class="comment">     *         &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      2、配置文件，或者容器启动变量</span></span><br><span class="line"><span class="comment">     *          spring.cloud.inetutils.preferred-networks: &#x27;xxx.xxx.xxx.&#x27;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      3、获取IP</span></span><br><span class="line"><span class="comment">     *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="执行器集群"><a href="#执行器集群" class="headerlink" title="执行器集群"></a>执行器集群</h4><ol>
<li>执行器回调地址（xxl.job.admin.addresses）需要保持一致；执行器根据该配置进行执行器自动注册等操作。</li>
<li>同一个执行器集群内AppName（xxl.job.executor.appname）需要保持一致；调度中心根据该配置动态发现不同集群的在线执行器列表。</li>
</ol>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202402291615574.png" alt="image-20240229161548398"></p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061834791.jpg" alt="xxl-job"></p>
<h4 id="Job-BEAN"><a href="#Job-BEAN" class="headerlink" title="Job(BEAN)"></a>Job(BEAN)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxl.job.executor.service.jobhandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.DataOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * XxlJob开发示例（Bean模式）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 开发步骤：</span></span><br><span class="line"><span class="comment"> *      1、任务开发：在Spring Bean实例中，开发Job方法；</span></span><br><span class="line"><span class="comment"> *      2、注解配置：为Job方法添加注解 &quot;<span class="doctag">@XxlJob</span>(value=&quot;自定义jobhandler名称&quot;, init = &quot;JobHandler初始化方法&quot;, destroy = &quot;JobHandler销毁方法&quot;)&quot;，注解value值对应的是调度中心新建任务的JobHandler属性的值。</span></span><br><span class="line"><span class="comment"> *      3、执行日志：需要通过 &quot;XxlJobHelper.log&quot; 打印执行日志；</span></span><br><span class="line"><span class="comment"> *      4、任务结果：默认任务结果为 &quot;成功&quot; 状态，不需要主动设置；如有诉求，比如设置任务结果为失败，可以通过 &quot;XxlJobHelper.handleFail/handleSuccess&quot; 自主设置任务结果；</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xuxueli 2019-12-11 21:52:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SampleXxlJob</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(SampleXxlJob.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demoJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        XxlJobHelper.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            XxlJobHelper.log(<span class="string">&quot;beat at:&quot;</span> + i);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// default success</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2、分片广播任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;shardingJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分片参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">        <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line"></span><br><span class="line">        XxlJobHelper.log(<span class="string">&quot;分片参数：当前分片序号 = &#123;&#125;, 总分片数 = &#123;&#125;&quot;</span>, shardIndex, shardTotal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 业务逻辑</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; shardTotal; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == shardIndex) &#123;</span><br><span class="line">                XxlJobHelper.log(<span class="string">&quot;第 &#123;&#125; 片, 命中分片开始处理&quot;</span>, i);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                XxlJobHelper.log(<span class="string">&quot;第 &#123;&#125; 片, 忽略&quot;</span>, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3、命令行任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;commandJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commandJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> XxlJobHelper.getJobParam();</span><br><span class="line">        <span class="type">int</span> <span class="variable">exitValue</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// command process</span></span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>();</span><br><span class="line">            processBuilder.command(command);</span><br><span class="line">            processBuilder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">            <span class="comment">//Process process = Runtime.getRuntime().exec(command);</span></span><br><span class="line"></span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">bufferedInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(process.getInputStream());</span><br><span class="line">            bufferedReader = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(bufferedInputStream));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// command log</span></span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                XxlJobHelper.log(line);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// command exit</span></span><br><span class="line">            process.waitFor();</span><br><span class="line">            exitValue = process.exitValue();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            XxlJobHelper.log(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (bufferedReader != <span class="literal">null</span>) &#123;</span><br><span class="line">                bufferedReader.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (exitValue == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// default success</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            XxlJobHelper.handleFail(<span class="string">&quot;command exit value(&quot;</span>+exitValue+<span class="string">&quot;) is failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4、跨平台Http任务</span></span><br><span class="line"><span class="comment">     *  参数示例：</span></span><br><span class="line"><span class="comment">     *      &quot;url: http://www.baidu.com\n&quot; +</span></span><br><span class="line"><span class="comment">     *      &quot;method: get\n&quot; +</span></span><br><span class="line"><span class="comment">     *      &quot;data: content\n&quot;;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;httpJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">httpJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// param parse</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">param</span> <span class="operator">=</span> XxlJobHelper.getJobParam();</span><br><span class="line">        <span class="keyword">if</span> (param==<span class="literal">null</span> || param.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">            XxlJobHelper.log(<span class="string">&quot;param[&quot;</span>+ param +<span class="string">&quot;] invalid.&quot;</span>);</span><br><span class="line"></span><br><span class="line">            XxlJobHelper.handleFail();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String[] httpParams = param.split(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (String httpParam: httpParams) &#123;</span><br><span class="line">            <span class="keyword">if</span> (httpParam.startsWith(<span class="string">&quot;url:&quot;</span>)) &#123;</span><br><span class="line">                url = httpParam.substring(httpParam.indexOf(<span class="string">&quot;url:&quot;</span>) + <span class="number">4</span>).trim();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (httpParam.startsWith(<span class="string">&quot;method:&quot;</span>)) &#123;</span><br><span class="line">                method = httpParam.substring(httpParam.indexOf(<span class="string">&quot;method:&quot;</span>) + <span class="number">7</span>).trim().toUpperCase();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (httpParam.startsWith(<span class="string">&quot;data:&quot;</span>)) &#123;</span><br><span class="line">                data = httpParam.substring(httpParam.indexOf(<span class="string">&quot;data:&quot;</span>) + <span class="number">5</span>).trim();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// param valid</span></span><br><span class="line">        <span class="keyword">if</span> (url==<span class="literal">null</span> || url.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">            XxlJobHelper.log(<span class="string">&quot;url[&quot;</span>+ url +<span class="string">&quot;] invalid.&quot;</span>);</span><br><span class="line"></span><br><span class="line">            XxlJobHelper.handleFail();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (method==<span class="literal">null</span> || !Arrays.asList(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>).contains(method)) &#123;</span><br><span class="line">            XxlJobHelper.log(<span class="string">&quot;method[&quot;</span>+ method +<span class="string">&quot;] invalid.&quot;</span>);</span><br><span class="line"></span><br><span class="line">            XxlJobHelper.handleFail();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isPostMethod</span> <span class="operator">=</span> method.equals(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// request</span></span><br><span class="line">        <span class="type">HttpURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// connection</span></span><br><span class="line">            <span class="type">URL</span> <span class="variable">realUrl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line">            connection = (HttpURLConnection) realUrl.openConnection();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// connection setting</span></span><br><span class="line">            connection.setRequestMethod(method);</span><br><span class="line">            connection.setDoOutput(isPostMethod);</span><br><span class="line">            connection.setDoInput(<span class="literal">true</span>);</span><br><span class="line">            connection.setUseCaches(<span class="literal">false</span>);</span><br><span class="line">            connection.setReadTimeout(<span class="number">5</span> * <span class="number">1000</span>);</span><br><span class="line">            connection.setConnectTimeout(<span class="number">3</span> * <span class="number">1000</span>);</span><br><span class="line">            connection.setRequestProperty(<span class="string">&quot;connection&quot;</span>, <span class="string">&quot;Keep-Alive&quot;</span>);</span><br><span class="line">            connection.setRequestProperty(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            connection.setRequestProperty(<span class="string">&quot;Accept-Charset&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// do connection</span></span><br><span class="line">            connection.connect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// data</span></span><br><span class="line">            <span class="keyword">if</span> (isPostMethod &amp;&amp; data!=<span class="literal">null</span> &amp;&amp; data.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">DataOutputStream</span> <span class="variable">dataOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(connection.getOutputStream());</span><br><span class="line">                dataOutputStream.write(data.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                dataOutputStream.flush();</span><br><span class="line">                dataOutputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// valid StatusCode</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">statusCode</span> <span class="operator">=</span> connection.getResponseCode();</span><br><span class="line">            <span class="keyword">if</span> (statusCode != <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Http Request StatusCode(&quot;</span> + statusCode + <span class="string">&quot;) Invalid.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// result</span></span><br><span class="line">            bufferedReader = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(connection.getInputStream(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                result.append(line);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">responseMsg</span> <span class="operator">=</span> result.toString();</span><br><span class="line"></span><br><span class="line">            XxlJobHelper.log(responseMsg);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            XxlJobHelper.log(e);</span><br><span class="line"></span><br><span class="line">            XxlJobHelper.handleFail();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (bufferedReader != <span class="literal">null</span>) &#123;</span><br><span class="line">                    bufferedReader.close();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">                    connection.disconnect();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e2) &#123;</span><br><span class="line">                XxlJobHelper.log(e2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 5、生命周期任务示例：任务初始化与销毁时，支持自定义相关逻辑；</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(value = &quot;demoJobHandler2&quot;, init = &quot;init&quot;, destroy = &quot;destroy&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demoJobHandler2</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        XxlJobHelper.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;destroy&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><h4 id="设计思想"><a href="#设计思想" class="headerlink" title="设计思想"></a>设计思想</h4><p>将调度行为抽象形成“调度中心”公共平台，而平台自身并不承担业务逻辑，“调度中心”负责发起调度请求。</p>
<p>将任务抽象成分散的JobHandler，交由“执行器”统一管理，“执行器”负责接收调度请求并执行对应的JobHandler中业务逻辑。</p>
<p>因此，“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性；</p>
<h4 id="系统组成"><a href="#系统组成" class="headerlink" title="系统组成"></a>系统组成</h4><ul>
<li><strong>调度模块（调度中心）</strong>：<br>负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码。调度系统与任务解耦，提高了系统可用性和稳定性，同时调度系统性能不再受限于任务模块；<br>支持可视化、简单且动态的管理调度信息，包括任务新建，更新，删除，GLUE开发和任务报警等，所有上述操作都会实时生效，同时支持监控调度结果以及执行日志，支持执行器Failover。</li>
<li><strong>执行模块（执行器）</strong>：<br>负责接收调度请求并执行任务逻辑。任务模块专注于任务的执行等操作，开发和维护更加简单和高效；<br>接收“调度中心”的执行请求、终止请求和日志请求等。</li>
</ul>
<h4 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h4><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403041329391.png" alt="img_Qohm"></p>
<h4 id="自研调度模块"><a href="#自研调度模块" class="headerlink" title="自研调度模块"></a>自研调度模块</h4><p>XXL-JOB最终选择自研调度组件（早期调度组件基于Quartz）；一方面是为了精简系统降低冗余依赖，另一方面是为了提供系统的可控度与稳定性；</p>
<p>XXL-JOB中“调度模块”和“任务模块”完全解耦，调度模块进行任务调度时，将会解析不同的任务参数发起远程调用，调用各自的远程执行器服务。这种调用模型类似RPC调用，调度中心提供调用代理的功能，而执行器提供远程服务的功能。</p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061754115.png" alt="image-20240306175447044"></p>
<p>当调度中心启动后，会启动以下两个线程：</p>
<ol>
<li>schedulerThread <code>scheudlerThread</code>主要做如下两件事情：</li>
</ol>
<ul>
<li><p>从数据中心（db），也就是 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxl_job_info</span><br></pre></td></tr></table></figure>

<p>表中扫描出符合 <code>条件 1</code>的任务， </p>
<p><code>条件1</code></p>
<p> 限制如下：</p>
<ul>
<li>任务执行时间 <strong>小于</strong>（当前时间 + 5 s）</li>
<li>限制扫描个数， 这个值是动态的，会根据后面的提到的 <strong>快慢线程池</strong> 中线程数量有关系。</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">count = treadpool-size * trigger-qps  (each trigger cost 50ms, qps = 1000/50 = 20) </span><br><span class="line"></span><br><span class="line">treadpool-size = (getTriggerPoolFastMax() + getTriggerPoolSlowMax()) * 20</span><br></pre></td></tr></table></figure>

<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061757022.png" alt="image-20240306175757971"></p>
<ol start="2">
<li>ringThread</li>
</ol>
<p><code>ringThread</code>的作用就是不断从 <strong>容器</strong> 中读取 <strong>当前时间点需要执行</strong> 的任务， 读取出来的任务会交给一个叫 <strong>快慢线程池</strong> 的东西去将任务传递给<strong>调度器</strong>去执行。</p>
<p>快慢线程池</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span>&#123;</span><br><span class="line">       fastTriggerPool = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">               <span class="number">10</span>,</span><br><span class="line">               XxlJobAdminConfig.getAdminConfig().getTriggerPoolFastMax(),</span><br><span class="line">               <span class="number">60L</span>,</span><br><span class="line">               TimeUnit.SECONDS,</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="number">1000</span>),</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">                       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;xxl-job, admin JobTriggerPoolHelper-fastTriggerPool-&quot;</span> + r.hashCode());</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line"></span><br><span class="line">       slowTriggerPool = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">               <span class="number">10</span>,</span><br><span class="line">               XxlJobAdminConfig.getAdminConfig().getTriggerPoolSlowMax(),</span><br><span class="line">               <span class="number">60L</span>,</span><br><span class="line">               TimeUnit.SECONDS,</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="number">2000</span>),</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">                       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;xxl-job, admin JobTriggerPoolHelper-slowTriggerPool-&quot;</span> + r.hashCode());</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>





<h4 id="调度中心HA（集群）"><a href="#调度中心HA（集群）" class="headerlink" title="调度中心HA（集群）"></a>调度中心HA（集群）</h4><p>基于数据库的集群方案，数据库选用Mysql；集群分布式并发环境中进行定时任务调度时，会在各个节点会上报任务，存到数据库中，执行时会从数据库中取出触发器来执行，如果触发器的名称和执行时间相同，则只有一个节点去执行此任务。</p>
<h4 id="调度线程池"><a href="#调度线程池" class="headerlink" title="调度线程池"></a>调度线程池</h4><p>调度采用线程池方式实现，避免单线程因阻塞而引起任务调度延迟。</p>
<h4 id="并行调度"><a href="#并行调度" class="headerlink" title="并行调度"></a>并行调度</h4><p>XXL-JOB调度模块默认采用并行机制，在多线程调度的情况下，调度模块被阻塞的几率很低，大大提高了调度系统的承载量。</p>
<p>XXL-JOB的不同任务之间并行调度、并行执行。 XXL-JOB的单个任务，针对多个执行器是并行运行的，针对单个执行器是串行执行的。同时支持任务终止。</p>
<h4 id="过期处理策略"><a href="#过期处理策略" class="headerlink" title="过期处理策略"></a>过期处理策略</h4><p>任务调度错过触发时间时的处理策略：</p>
<ul>
<li>可能原因：服务重启；调度线程被阻塞，线程被耗尽；上次调度持续阻塞，下次调度被错过；</li>
<li>处理策略：<ul>
<li>过期超5s：本次忽略，当前时间开始计算下次触发时间</li>
<li>过期5s内：立即触发一次，当前时间开始计算下次触发时间</li>
</ul>
</li>
</ul>
<h4 id="任务HA（Failover）"><a href="#任务HA（Failover）" class="headerlink" title="任务HA（Failover）"></a>任务HA（Failover）</h4><p>执行器如若集群部署，调度中心将会感知到在线的所有执行器，如“127.0.0.1:9997, 127.0.0.1:9998, 127.0.0.1:9999”。</p>
<p>当任务”路由策略”选择”故障转移(FAILOVER)”时，当调度中心每次发起调度请求时，会按照顺序对执行器发出心跳检测请求，第一个检测为存活状态的执行器将会被选定并发送调度请求。</p>
<h4 id="均衡调度"><a href="#均衡调度" class="headerlink" title="均衡调度"></a>均衡调度</h4><p>调度中心在集群部署时会自动进行任务平均分配，触发组件每次获取与线程池数量（调度中心支持自定义调度线程池大小）相关数量的任务，避免大量任务集中在单个调度中心集群节点</p>
<h4 id="故障转移-失败重试"><a href="#故障转移-失败重试" class="headerlink" title="故障转移 &amp; 失败重试"></a>故障转移 &amp; 失败重试</h4><p>一次完整任务流程包括”调度（调度中心） + 执行（执行器）”两个阶段。</p>
<ul>
<li>“故障转移”发生在调度阶段，在执行器集群部署时，如果某一台执行器发生故障，该策略支持自动进行Failover切换到一台正常的执行器机器并且完成调度请求流程。</li>
<li>“失败重试”发生在”调度 + 执行”两个阶段，支持通过自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</li>
</ul>
<h4 id="执行器灰度上线"><a href="#执行器灰度上线" class="headerlink" title="执行器灰度上线"></a>执行器灰度上线</h4><p>调度中心与业务解耦，只需部署一次后常年不需要维护。但是，执行器中托管运行着业务作业，作业上线和变更需要重启执行器，尤其是Bean模式任务。<br>执行器重启可能会中断运行中的任务。但是，XXL-JOB得益于自建执行器与自建注册中心，可以通过灰度上线的方式，避免因重启导致的任务中断的问题。</p>
<p>步骤如下：</p>
<ul>
<li>1、执行器改为手动注册，下线一半机器列表（A组），线上运行另一半机器列表（B组）；</li>
<li>2、等待A组机器任务运行结束并编译上线；执行器注册地址替换为A组；</li>
<li>3、等待B组机器任务运行结束并编译上线；执行器注册地址替换为A组+B组；<br>操作结束；</li>
</ul>
<h4 id="避免任务重复执行"><a href="#避免任务重复执行" class="headerlink" title="避免任务重复执行"></a>避免任务重复执行</h4><p>调度密集或者耗时任务可能会导致任务阻塞，集群情况下调度组件小概率情况下会重复触发；<br>针对上述情况，可以通过结合 “单机路由策略（如：第一台、一致性哈希）” + “阻塞策略（如：单机串行、丢弃后续调度）” 来规避，最终避免任务重复执行。</p>
<hr>
<h2 id="PowerJob"><a href="#PowerJob" class="headerlink" title="PowerJob"></a>PowerJob</h2><h3 id="部署调度中心（docker版）"><a href="#部署调度中心（docker版）" class="headerlink" title="部署调度中心（docker版）"></a>部署调度中心（docker版）</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d \</span></span><br><span class="line"><span class="language-bash"> 			 --restart=always \</span></span><br><span class="line"><span class="language-bash">       --name powerjob-server \</span></span><br><span class="line"><span class="language-bash">       -p 7700:7700 -p 10086:10086 -p 10010:10010 \</span></span><br><span class="line"><span class="language-bash">       -e TZ=<span class="string">&quot;Asia/Shanghai&quot;</span> \</span></span><br><span class="line"><span class="language-bash">       -e JVMOPTIONS=<span class="string">&quot;&quot;</span> \</span></span><br><span class="line"><span class="language-bash">       -e PARAMS=<span class="string">&quot;--spring.profiles.active=product --spring.datasource.core.jdbc-url=jdbc:mysql://192.168.70.58:3307/powerjob-product?useUnicode=true&amp;characterEncoding=UTF-8 --spring.datasource.core.username=root --spring.datasource.core.password=123456 --spring.data.mongodb.uri=mongodb://192.168.70.58:27017/powerjob-product&quot;</span> \</span></span><br><span class="line"><span class="language-bash">       -v ~/Space/powerjob-server:/root/powerjob/server -v ~/.m2:/root/.m2 \</span></span><br><span class="line"><span class="language-bash">       powerjob/powerjob-server:latest</span></span><br></pre></td></tr></table></figure>

<h3 id="注册应用"><a href="#注册应用" class="headerlink" title="注册应用"></a>注册应用</h3><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/202402281639216.png" alt="image-20240228163908967"></p>
<h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><p>Username:应用名称</p>
<p>password：应用密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试帐号密码</span></span><br><span class="line">cong/123456</span><br></pre></td></tr></table></figure>

<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/202402281641820.png" alt="image-20240228164121786"></p>
<h3 id="官方处理器"><a href="#官方处理器" class="headerlink" title="官方处理器"></a><strong><a target="_blank" rel="noopener" href="https://www.yuque.com/powerjob/guidence/official_processor">官方处理器</a></strong></h3><p><strong>PowerJob 支持 Python、Shell、HTTP、SQL 等众多通用任务的处理，只需要引入依赖，在控制台配置好相关参数即可</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 官方处理器 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>tech.powerjob<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>powerjob-official-processors<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;powerjob.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Shell 处理器</span></span><br><span class="line">全限定类名 tech.powerjob.official.processors.impl.script.ShellProcessor</span><br><span class="line"><span class="comment"># Python 处理器</span></span><br><span class="line">全限定类名 tech.powerjob.official.processors.impl.script.PythonProcessor</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP 处理器</span></span><br><span class="line">全限定类名 tech.powerjob.official.processors.impl.HttpProcessor</span><br><span class="line">任务参数（JSON）</span><br><span class="line">● method【必填字段】：GET / POST / DELETE / PUT</span><br><span class="line">● url【必填字段】：请求地址</span><br><span class="line">● <span class="built_in">timeout</span>【可选字段】：超时时间，单位为秒</span><br><span class="line">● mediaType【可选字段】：使用非 GET 请求时，需要传递的数据类型，如 `application/json`</span><br><span class="line">● body【可选字段】：使用非 GET 请求时的 body 内容，后端使用 String 接收，如果为 JSON 请注意转义</span><br><span class="line">● headers【可选字段】：请求头，后端使用 Map&lt;String, String&gt; 接收</span><br><span class="line"><span class="comment"># 其他更多参见官方文档</span></span><br></pre></td></tr></table></figure>





<h3 id="处理器（Processor）开发"><a href="#处理器（Processor）开发" class="headerlink" title="处理器（Processor）开发"></a>处理器（Processor）开发</h3><ul>
<li>引入依赖，最新稳定版本为<code>4.3.8</code>，对应的spring boot版本为<code>2.7.18</code></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/tech.powerjob/powerjob-worker-spring-boot-starter --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>tech.powerjob<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>powerjob-worker-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;powerjob.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      </span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">11714</span></span><br><span class="line"><span class="comment"># akka 工作端口，可选，默认 27777</span></span><br><span class="line"><span class="attr">powerjob.worker.port</span>=<span class="string">27777</span></span><br><span class="line"><span class="comment"># 接入应用名称，用于分组隔离，推荐填写 本 Java 项目名称</span></span><br><span class="line"><span class="attr">powerjob.worker.app-name</span>=<span class="string">cong</span></span><br><span class="line"><span class="comment"># 调度服务器地址，IP:Port 或 域名，多值逗号分隔</span></span><br><span class="line"><span class="attr">powerjob.worker.server-address</span>=<span class="string">192.168.70.58:7700</span></span><br><span class="line"><span class="comment"># 通讯协议，4.3.0 开始支持 HTTP 和 AKKA 两种协议，官方推荐使用 HTTP 协议（注意 server 和 worker 都要开放相应端口）</span></span><br><span class="line"><span class="attr">powerjob.worker.protocol</span>=<span class="string">http</span></span><br><span class="line"><span class="comment"># 持久化方式，可选，默认 disk</span></span><br><span class="line"><span class="attr">powerjob.worker.store-strategy</span>=<span class="string">disk</span></span><br><span class="line"><span class="comment"># 任务返回结果信息的最大长度，超过这个长度的信息会被截断，默认值 8192</span></span><br><span class="line"><span class="attr">powerjob.worker.max-result-length</span>=<span class="string">4096</span></span><br><span class="line"><span class="comment"># 单个任务追加的工作流上下文最大长度，超过这个长度的会被直接丢弃，默认值 8192</span></span><br><span class="line"><span class="attr">powerjob.worker.max-appended-wf-context-length</span>=<span class="string">4096</span></span><br><span class="line"><span class="comment"># 同时运行的轻量级任务数量上限</span></span><br><span class="line"><span class="attr">powerjob.worker.max-lightweight-task-num</span>=<span class="string">1024</span></span><br><span class="line"><span class="comment"># 同时运行的重量级任务数量上限</span></span><br><span class="line"><span class="attr">powerjob.worker.max-heavy-task-num</span>=<span class="string">64</span></span><br></pre></td></tr></table></figure>

<ul>
<li>启动服务 观察日志</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">024-02-28 17:31:36.017  INFO 20958 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 11714 (http) with context path <span class="string">&#x27;&#x27;</span></span><br><span class="line">2024-02-28 17:31:36.022  INFO 20958 --- [           main] c.c.p.PowerjobWorkerApplication          : Started PowerjobWorkerApplication <span class="keyword">in</span> 7.763 seconds (JVM running <span class="keyword">for</span> 8.083)</span><br><span class="line">2024-02-28 17:31:46.013  INFO 20958 --- [b-worker-core-0] t.p.w.background.WorkerHealthReporter    : [WorkerHealthReporter] report health status,appId:1,appName:cong,isOverload:<span class="literal">false</span>,maxLightweightTaskNum:1024,currentLightweightTaskNum:0,maxHeavyweightTaskNum:64,currentHeavyweightTaskNum:0</span><br><span class="line">2024-02-28 17:31:56.021  INFO 20958 --- [b-worker-core-0] t.p.w.background.WorkerHealthReporter    : [WorkerHealthReporter] report health status,appId:1,appName:cong,isOverload:<span class="literal">false</span>,maxLightweightTaskNum:1024,currentLightweightTaskNum:0,maxHeavyweightTaskNum:64,currentHeavyweightTaskNum:0</span><br><span class="line">2024-02-28 17:32:06.031  INFO 20958 --- [b-worker-core-0] t.p.w.background.WorkerHealthReporter    : [WorkerHealthReporter] report health status,appId:1,appName:cong,isOverload:<span class="literal">false</span>,maxLightweightTaskNum:1024,currentLightweightTaskNum:0,maxHeavyweightTaskNum:64,currentHeavyweightTaskNum:0</span><br></pre></td></tr></table></figure>

<ul>
<li><p>管理界面</p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/202402281733946.png" alt="image-20240228173324858"></p>
<ul>
<li>配置任务</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://192.168.70.58:7700/">演示地址</a></p>
</li>
<li><p>单机处理器：BasicProcessor</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 支持 SpringBean 的形式</span></span><br><span class="line"><span class="comment">//单机执行的策略下，server 会在所有可用 worker 中选取健康度最佳的机器进行执行。</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasicProcessorDemo</span> <span class="keyword">implements</span> <span class="title class_">BasicProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MysteryService mysteryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProcessResult <span class="title function_">process</span><span class="params">(TaskContext context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在线日志功能，可以直接在控制台查看任务日志，非常便捷</span></span><br><span class="line">        <span class="type">OmsLogger</span> <span class="variable">omsLogger</span> <span class="operator">=</span> context.getOmsLogger();</span><br><span class="line">        omsLogger.info(<span class="string">&quot;BasicProcessorDemo start to process, current JobParams is &#123;&#125;.&quot;</span>, context.getJobParams());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// TaskContext为任务的上下文信息，包含了在控制台录入的任务元数据，常用字段为</span></span><br><span class="line">        <span class="comment">// jobParams（任务参数，在控制台录入），instanceParams（任务实例参数，通过 OpenAPI 触发的任务实例才可能存在该参数）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 进行实际处理...</span></span><br><span class="line">        mysteryService.hasaki();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回结果，该结果会被持久化到数据库，在前端页面直接查看，极为方便</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProcessResult</span>(<span class="literal">true</span>, <span class="string">&quot;result is xxx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>广播处理器：BroadcastProcessor</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//广播执行的策略下，所有机器都会被调度执行该任务。为了便于资源的准备和释放，</span></span><br><span class="line"><span class="comment">//广播处理器在BasicProcessor 的基础上额外增加了 preProcess 和 postProcess 方法，分别在整个集群开始之前/结束之后选一台机器执行相关方法。</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BroadcastProcessorDemo</span> <span class="keyword">implements</span> <span class="title class_">BroadcastProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProcessResult <span class="title function_">preProcess</span><span class="params">(TaskContext taskContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 预执行，会在所有 worker 执行 process 方法前调用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProcessResult</span>(<span class="literal">true</span>, <span class="string">&quot;init success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProcessResult <span class="title function_">process</span><span class="params">(TaskContext context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 撰写整个worker集群都会执行的代码逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProcessResult</span>(<span class="literal">true</span>, <span class="string">&quot;release resource success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProcessResult <span class="title function_">postProcess</span><span class="params">(TaskContext taskContext, List&lt;TaskResult&gt; taskResults)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// taskResults 存储了所有worker执行的结果（包括preProcess）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 收尾，会在所有 worker 执行完毕 process 方法后调用，该结果将作为最终的执行结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProcessResult</span>(<span class="literal">true</span>, <span class="string">&quot;process success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="架构-1"><a href="#架构-1" class="headerlink" title="架构"></a>架构</h3><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403050921697.png" alt="image-20240305092119644"></p>
<h4 id="Server-启动流程分析"><a href="#Server-启动流程分析" class="headerlink" title="Server 启动流程分析"></a>Server 启动流程分析</h4><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061656796.png" alt="2024030117428701"></p>
<h4 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h4><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061658564.png" alt="2024030117428701"></p>
<h3 id="无锁化调度的实现"><a href="#无锁化调度的实现" class="headerlink" title="无锁化调度的实现"></a>无锁化调度的实现</h3><h4 id="经典调度原理"><a href="#经典调度原理" class="headerlink" title="经典调度原理"></a>经典调度原理</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 师承老祖宗 quartz：</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> job_info <span class="keyword">where</span> next_trigger_time <span class="operator">&lt;</span> now() <span class="operator">+</span> <span class="number">15</span>s</span><br></pre></td></tr></table></figure>

<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403050949302.png" alt="img"></p>
<h4 id="重复调度"><a href="#重复调度" class="headerlink" title="重复调度"></a>重复调度</h4><p>为了解决重复调度，当前开源调度框架的解决方案：锁</p>
<ul>
<li>select for update</li>
<li>分布式锁</li>
</ul>
<blockquote>
<p>本质上只有一台 server 在真正提供服务！集群部署只获得了 高可用能力，并没有获取性能的提升，不具备水平扩展性</p>
</blockquote>
<h4 id="无锁化调度"><a href="#无锁化调度" class="headerlink" title="无锁化调度"></a>无锁化调度</h4><ul>
<li>引入分组依据  AppName，以应用集群作为 server 调度的单位。 </li>
<li>每一个 worker 集群在运行时只会连接到某一台 server。 </li>
<li>每一个 server 实例只会调度当前与自己保持心跳的 worker 关联的 AppName 下的所有任务。</li>
<li>时区next_trigger_time</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> job_info <span class="keyword">where</span> app_name <span class="operator">=</span> xxx <span class="keyword">and</span>  next_trigger_time <span class="operator">&lt;</span> now() <span class="operator">+</span> <span class="number">15</span>s</span><br></pre></td></tr></table></figure>

<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061700771.png" alt="img"></p>
<blockquote>
<p>worker 因为没办法获取 server 的准确状态，所以不能由 worker 来决定连接哪一台 server。因此，worker 需要做的，只是<strong>服务发现</strong>。即定时使用 HTTP 请求任意一台 server，请求获取当前该分组（appName）对应的 server。</p>
<p>而 server 收到来自 worker 的服务发现请求后，其实就是进行了一场小型的分布式选主：server 依赖的数据库中存在着 server_info 表，其中记录了每一个分组（appName）所对应的 server 信息。如果该 server 发现表中存在记录，那就说明该 worker 集群中已经有别的 worker 事先请求 server 进行选举，那么此时只需要发送 PING 请求检测该 server 是否存活。如果发现该 server 存活，那么直接返回该 server 的信息作为该分组的 server。否则就完成篡位，将自己的信息写入数据库表中，成为该分组的 server。</p>
<p>细心的小伙伴可能又要问了？发送 PING 请求检测该 server 是否存活，不还是有和刚才一样的问题吗？请求不同，发送方和接收方都有可能出问题，凭什么认为是原先的 server 挂了呢？</p>
<p>确实，在这个方案下，依旧没办法解决 server 到底挂没挂这个堪比“真假美猴王”的玄学问题。但是，这还重要吗？我们的目标是某个分组下所有的 worker 都连接到同一台 server，因此，即便产生那种误打误撞篡位的情况，在服务发现机制的加持下，整个集群最终还是会连接到同一台 server，完美实现我们的需求。</p>
</blockquote>
<h3 id="任务配置"><a href="#任务配置" class="headerlink" title="任务配置"></a>任务配置</h3><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403051359180.png" alt="image.png"></p>
<h4 id="可靠调度——WAL"><a href="#可靠调度——WAL" class="headerlink" title="可靠调度——WAL"></a>可靠调度——WAL</h4><blockquote>
<p> <strong>WAL（Write-Ahead Logging，预写式日志）</strong>，这是主流关系型数据库（MS SQLServer、MySQL、Oracle）用来确保了事务原子性和持久性的关键技术。WAL 的核心思想是：**在数据写入到数据库之前，先写入到日志中。**这样，在硬盘数据不损坏的情况下，预写式日志允许存储系统在崩溃后能够在日志的指导下恢复到崩溃前的状态，避免数据丢失。</p>
<p>PowerJob 为了实现任务的可靠调度，也借鉴了该思想。每一个任务被调度执行时，系统都会为其生成一条记录，这条记录包含了该任务实例（任务的一次运行叫任务实例）的预期调度时间。之后，PowerJob 会首先将该记录持久化到数据库中，只有持久化成功后，该任务才会被正式推入时间轮进行调度。</p>
<p>一旦这一台 server 宕机，任务没有被准时执行。其他 server 就能根据已经写入数据库中的任务实例记录将其恢复，做到可靠调度～</p>
<p>也就是说，只要你的系统中还有一台 powerjob-server 活着，就不会有缺失调度的情况。</p>
</blockquote>
<h4 id="秒级任务"><a href="#秒级任务" class="headerlink" title="秒级任务"></a>秒级任务</h4><blockquote>
<p>每一个秒级任务，都会直接被投递到集群中的某一台 powerjob-worker 上，由 powerjob-worker 全权负责执行。而 powerjob-server 此时只需要负责故障恢复即可。</p>
<p>这样一来，server 的压力进一步减轻，同时，由于秒级任务的调度与执行全部落在了 worker 身上，调度的精度也会上升（至少能省下通讯的网络延迟）</p>
</blockquote>
<hr>
<h2 id="Apache-DolphinScheduler"><a href="#Apache-DolphinScheduler" class="headerlink" title="Apache DolphinScheduler"></a>Apache DolphinScheduler</h2><p>主要面向大数据处理领域，其核心需求是按照规定流程（ DAG ）跑一堆脚本去完成一些数据任务。</p>
<p><a target="_blank" rel="noopener" href="http://192.168.70.58:12345/dolphinscheduler/ui/home">试用地址</a></p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061652048.png" alt="image-20240306165251004"></p>
<h4 id="容错设计"><a href="#容错设计" class="headerlink" title="容错设计"></a>容错设计</h4><p>服务容错设计依赖于ZooKeeper的Watcher机制，实现原理如图</p>
<p>其中Master监控其他Master和Worker的目录，如果监听到remove事件，则会根据具体的业务逻辑进行流程实例容错或者任务实例容错。</p>
<ul>
<li>Master容错流程</li>
</ul>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403051716004.jpg" alt="容错流程"></p>
<p>容错范围：从host的维度来看，Master的容错范围包括：自身host+注册中心上不存在的节点host，容错的整个过程会加锁；</p>
<p>容错内容：Master的容错内容包括：容错工作流实例和任务实例，在容错前会比较实例的开始时间和服务节点的启动时间，在服务启动时间之后的则跳过容错；</p>
<p>容错后处理：ZooKeeper Master容错完成之后则重新由DolphinScheduler中Scheduler线程调度，遍历 DAG 找到”正在运行”和“提交成功”的任务，对”正在运行”的任务监控其任务实例的状态，对”提交成功”的任务需要判断Task Queue中是否已经存在，如果存在则同样监控任务实例的状态，如果不存在则重新提交任务实例。</p>
<p>Worker容错流程</p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403051724743.jpg" alt="容错流程"></p>
<p>容错范围：从工作流实例的维度看，每个Worker只负责容错自己的工作流实例；只有在<code>handleDeadServer</code>时会加锁；</p>
<p>容错内容：当发送Worker节点的remove事件时，Master只容错任务实例，在容错前会比较实例的开始时间和服务节点的启动时间，在服务启动时间之后的则跳过容错；</p>
<p>容错后处理：Master Scheduler线程一旦发现任务实例为” 需要容错”状态，则接管任务并进行重新提交。</p>
<p>注意：由于” 网络抖动”可能会使得节点短时间内失去和ZooKeeper的心跳，从而发生节点的remove事件。对于这种情况，我们使用最简单的方式，那就是节点一旦和ZooKeeper发生超时连接，则直接将Master或Worker服务停掉。</p>
<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><ul>
<li>预热</li>
</ul>
<p>考虑到 JIT 优化，会让 worker 在启动后低功率的运行一段时间，使其逐渐达到最佳状态，这段过程称之为预热。</p>
<ul>
<li><h4 id="随机（加权）"><a href="#随机（加权）" class="headerlink" title="随机（加权）"></a>随机（加权）</h4></li>
</ul>
<p>在符合的 worker 中随机选取一台（权重会影响他的比重）</p>
<ul>
<li><h4 id="平滑轮询（加权）"><a href="#平滑轮询（加权）" class="headerlink" title="平滑轮询（加权）"></a>平滑轮询（加权）</h4></li>
</ul>
<p>加权轮询算法一个明显的缺陷。即在某些特殊的权重下，加权轮询调度会生成不均匀的实例序列，这种不平滑的负载可能会使某些实例出现瞬时高负载的现象，导致系统存在宕机的风险。为了解决这个调度缺陷，我们提供了平滑加权轮询算法。</p>
<p>每台 worker 都有两个权重，即 weight（预热完成后保持不变），current_weight（动态变化），每次路由。都会遍历所有的 worker，使其 current_weight+weight，同时累加所有 worker 的 weight，计为 total_weight，然后挑选 current_weight 最大的作为本次执行任务的 worker，与此同时，将这台 worker 的 current_weight-total_weight。</p>
<ul>
<li><h4 id="线性加权-默认算法"><a href="#线性加权-默认算法" class="headerlink" title="线性加权(默认算法)"></a>线性加权(默认算法)</h4></li>
</ul>
<p>该算法每隔一段时间会向注册中心上报自己的负载信息。我们主要根据两个信息来进行判断</p>
<ul>
<li>load 平均值（默认是 CPU 核数 *2）</li>
<li>可用物理内存（默认是 0.3，单位是 G）</li>
</ul>
<p>如果两者任何一个低于配置项，那么这台 worker 将不参与负载。（即不分配流量）</p>
<p>可以在 worker.properties 修改下面的属性来自定义配置</p>
<ul>
<li>worker.max.cpu.load.avg&#x3D;-1 (worker最大cpu load均值，只有高于系统cpu load均值时，worker服务才能被派发任务. 默认值为-1: cpu cores * 2)</li>
<li>worker.reserved.memory&#x3D;0.3 (worker预留内存，只有低于系统可用内存时，worker服务才能被派发任务，单位为百分比)</li>
</ul>
<hr>
<h2 id="Elastic-Job"><a href="#Elastic-Job" class="headerlink" title="Elastic-Job"></a>Elastic-Job</h2><ul>
<li>支持分布式部署；不同节点上执行的是不一样的任务(代码是同一套)；对于一个大任务，可以用分片策略，让他在多节点上执行；</li>
<li>能够保证高可用；</li>
<li>利用zk实现分布式环境管理；</li>
<li>水平扩展（核心）</li>
</ul>
<h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a><strong>快速开始</strong></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere.elasticjob<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticjob-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;latest.release.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyJob</span> <span class="keyword">implements</span> <span class="title class_">SimpleJob</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(ShardingContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (context.getShardingItem()) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>: </span><br><span class="line">        <span class="comment">// do something by sharding item 0</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>: </span><br><span class="line">        <span class="comment">// do something by sharding item 1</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>: </span><br><span class="line">        <span class="comment">// do something by sharding item 2</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// case n: ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//作业调度</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyJobDemo</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ScheduleJobBootstrap</span>(createRegistryCenter(), <span class="keyword">new</span> <span class="title class_">MyJob</span>(), createJobConfiguration()).schedule();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> CoordinatorRegistryCenter <span class="title function_">createRegistryCenter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">CoordinatorRegistryCenter</span> <span class="variable">regCenter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZookeeperRegistryCenter</span>(<span class="keyword">new</span> <span class="title class_">ZookeeperConfiguration</span>(<span class="string">&quot;zk_host:2181&quot;</span>, <span class="string">&quot;my-job&quot;</span>));</span><br><span class="line">    regCenter.init();</span><br><span class="line">    <span class="keyword">return</span> regCenter;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> JobConfiguration <span class="title function_">createJobConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建作业配置</span></span><br><span class="line">   </span><br><span class="line">    <span class="type">JobConfiguration</span> <span class="variable">jobConfig</span> <span class="operator">=</span> JobConfiguration.newBuilder(<span class="string">&quot;MyJob&quot;</span>, <span class="number">3</span>).cron(<span class="string">&quot;0/5 * * * * ?&quot;</span>).build();</span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="分片"><a href="#分片" class="headerlink" title="分片"></a><strong>分片</strong></h3><p>ElasticJob 中任务分片项的概念，使得任务可以在分布式的环境下运行，每台任务服务器只运行分配给该服务器的分片。 随着服务器的增加或宕机，ElasticJob 会近乎实时的感知服务器数量的变更，从而重新为分布式的任务服务器分配更加合理的任务分片项，使得任务可以随着资源的增加而提升效率。</p>
<p>任务的分布式执行，需要将一个任务拆分为多个独立的任务项，然后由分布式的服务器分别执行某一个或几个分片项。</p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061057770.png" alt="image-20240306105742699"></p>
<p>当新增加作业服务器时，ElasticJob 会通过注册中心的临时节点的变化感知到新服务器的存在，并在下次任务调度的时候重新分片，新的服 务器会承载一部分作业分片</p>
<h3 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a><strong>高可用</strong></h3><p>当作业服务器在运行中宕机时，注册中心同样会通过临时节点感知，并将在下次运行时将分片转移至仍存活的服务器，以达到作业高可用的效果。 本次由于服务器宕机而未执行完的作业，则可以通过失效转移的方式继续执行。</p>
<p>将分片总数设置为 1，并使用多于 1 台的服务器执行作业，作业将会以 1 主 n 从的方式执行。 一旦执行作业的服务器宕机，等待执行的服务器将会在下次作业启动时替补执行。开启失效转移功能效果更好，如果本次作业在执行过程中宕机，备机会立即替补执行。</p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061105712.png" alt="image-20240306110506655"></p>
<h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h4><p> ElasticJob 并无作业调度中心节点，而是基于部署作业框架的程序在到达相应时间点时各自触发调度。注 册中心仅用于作业注册和监控信息存储。而主作业节点仅用于处理分片和清理等功能。 </p>
<p>弹性分布式实现 </p>
<p>• 第一台服务器上线触发主服务器选举。主服务器一旦下线，则重新触发选举，选举过程中阻塞，只 有主服务器选举完成，才会执行其他任务。 </p>
<p>• 某作业服务器上线时会自动将服务器信息注册到注册中心，下线时会自动更新服务器状态。 </p>
<p>• 主节点选举，服务器上下线，分片总数变更均更新重新分片标记。</p>
<p> • 定时任务触发时，如需重新分片，则通过主服务器分片，分片过程中阻塞，分片结束后才可执行任 务。如分片过程中主服务器下线，则先选举主服务器，再分片。 </p>
<p>• 通过上一项说明可知，为了维持作业运行时的稳定性，运行过程中只会标记分片状态，不会重新分 片。分片仅可能发生在下次任务触发前。 • 每次分片都会按服务器 IP 排序，保证分片结果不会产生较大波动。 </p>
<p>• 实现失效转移功能，在某台服务器执行完毕后主动抓取未分配的分片，并且在某台服务器下线后主 动寻找可用的服务器执行任务。</p>
<h3 id="错过任务重执行"><a href="#错过任务重执行" class="headerlink" title="错过任务重执行"></a><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/elasticjob/current/cn/features/misfire/"><strong>错过任务重执行</strong></a></h3><p>ElasticJob 不允许作业在同一时间内叠加执行。 当作业的执行时长超过其运行间隔，错过任务重执行能够保证作业在完成上次的任务后继续执行逾期的作业。</p>
<h4 id="作业启动"><a href="#作业启动" class="headerlink" title="作业启动"></a>作业启动</h4><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061115367.jpg" alt="作业启动"></p>
<h4 id="作业执行"><a href="#作业执行" class="headerlink" title="作业执行"></a>作业执行</h4><p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061116217.jpg" alt="作业执行"></p>
<h4 id="ej失效转移"><a href="#ej失效转移" class="headerlink" title="ej失效转移"></a>ej失效转移</h4><p>ElasticJob 不会在本次执行过程中进行重新分片，而是等待下次调度之前才开启重新分片流程。 当作业执行过程中服务器宕机，失效转移允许将该次未完成的任务在另一作业节点上补偿执行。</p>
<h4 id="线程池策略"><a href="#线程池策略" class="headerlink" title="线程池策略"></a>线程池策略</h4><p>线程池策略，用于执行作业的线程池创建。</p>
<table>
<thead>
<tr>
<th align="left"><em>SPI 名称</em></th>
<th align="left"><em>详细说明</em></th>
</tr>
</thead>
<tbody><tr>
<td align="left">JobExecutorThreadPoolSizeProvider</td>
<td align="left">作业执行线程数量提供策略</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left"><em>已知实现类</em></th>
<th align="left"><em>详细说明</em></th>
</tr>
</thead>
<tbody><tr>
<td align="left">CPUUsageJobExecutorThreadPoolSizeProvider</td>
<td align="left">根据 CPU 核数 * 2 创建作业处理线程池</td>
</tr>
<tr>
<td align="left">SingleThreadJobExecutorThreadPoolSizeProvider</td>
<td align="left">使用单线程处理作业</td>
</tr>
</tbody></table>
<h4 id="设置合理的超时时间"><a href="#设置合理的超时时间" class="headerlink" title="设置合理的超时时间"></a>设置合理的超时时间</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http 类型任务</span></span><br><span class="line"> <span class="type">JobConfiguration</span> <span class="variable">jobConfiguration</span> <span class="operator">=</span> JobConfiguration.newBuilder(<span class="string">&quot;javaHttpJob&quot;</span>, <span class="number">1</span>)</span><br><span class="line">                .setProperty(HttpJobProperties.URI_KEY, <span class="string">&quot;http://192.168.70.58:8080/job/test&quot;</span>)</span><br><span class="line">                .setProperty(HttpJobProperties.METHOD_KEY, <span class="string">&quot;GET&quot;</span>)</span><br><span class="line">                .setProperty(HttpJobProperties.DATA_KEY, <span class="string">&quot;source=ejob&quot;</span>)</span><br><span class="line">   							<span class="comment">//超时时间</span></span><br><span class="line">                .setProperty(HttpJobProperties.READ_TIMEOUT_KEY, <span class="string">&quot;120000&quot;</span>)</span><br><span class="line">                .setProperty(HttpJobProperties.CONNECT_TIMEOUT_KEY, <span class="string">&quot;60000&quot;</span>)</span><br><span class="line">                .cron(<span class="string">&quot;0/15 * * * * ? *&quot;</span>)</span><br><span class="line">                .shardingItemParameters(<span class="string">&quot;0=test0,1=test1, 2=test2, 3=test3&quot;</span>)</span><br><span class="line">                .failover(<span class="literal">true</span>)</span><br><span class="line">                .misfire(<span class="literal">true</span>)</span><br><span class="line">                .overwrite(<span class="literal">true</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">ScheduleJobBootstrap</span> <span class="variable">scheduleJobBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScheduleJobBootstrap</span>(zookeeperRegistryCenter, <span class="string">&quot;HTTP&quot;</span>,</span><br><span class="line">                jobConfiguration);</span><br><span class="line">        scheduleJobBootstrap.schedule();</span><br></pre></td></tr></table></figure>



<h3 id="运维平台配置"><a href="#运维平台配置" class="headerlink" title="运维平台配置"></a>运维平台配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://dlcdn.apache.org/shardingsphere/elasticjob-ui-3.0.2/apache-shardingsphere-elasticjob-3.0.2-lite-ui-bin.tar.gz</span><br></pre></td></tr></table></figure>

<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./shart.sh</span><br></pre></td></tr></table></figure>

<p>浏览器打开 <a target="_blank" rel="noopener" href="http://localhost:8088/%EF%BC%8C%E7%94%A8%E6%88%B7%E5%90%8D/%E5%AF%86%E7%A0%81%EF%BC%9Aroot/root">http://localhost:8088/，用户名/密码：root/root</a></p>
<p>连接zookeeper</p>
<p><img src="https://test-fsservice.oss-cn-shanghai.aliyuncs.com/fs/test/2024/202403061624510.png" alt="image-20240301113136175"></p>
<h3 id="作业开发"><a href="#作业开发" class="headerlink" title="作业开发"></a>作业开发</h3><p>ElasticJob 目前提供 Simple、Dataflow 这两种基于 class 的作业类型，并提供 Script、HTTP 这两种基于 type 的作业类型，用户可通过实现 SPI 接口自行扩展作业类型。</p>
<ul>
<li>http</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpJobMain</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ScheduleJobBootstrap</span>(regCenter, <span class="string">&quot;HTTP&quot;</span>, JobConfiguration.newBuilder(<span class="string">&quot;javaHttpJob&quot;</span>, <span class="number">1</span>)</span><br><span class="line">                .setProperty(HttpJobProperties.URI_KEY, <span class="string">&quot;http://xxx.com/execute&quot;</span>)</span><br><span class="line">                .setProperty(HttpJobProperties.METHOD_KEY, <span class="string">&quot;POST&quot;</span>)</span><br><span class="line">                .setProperty(HttpJobProperties.DATA_KEY, <span class="string">&quot;source=ejob&quot;</span>)</span><br><span class="line">                .cron(<span class="string">&quot;0/5 * * * * ?&quot;</span>).shardingItemParameters(<span class="string">&quot;0=Beijing&quot;</span>).build()).schedule();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="zookeeper数据"><a href="#zookeeper数据" class="headerlink" title="zookeeper数据"></a>zookeeper数据</h4><p><img src="/Users/cong/Downloads/202403061108369.png" alt="image-20240306110814324"></p>
<hr>
<h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">quartz</th>
<th align="left">elastic-job-lite</th>
<th align="left">xxl-job</th>
<th>PowerJob</th>
</tr>
</thead>
<tbody><tr>
<td align="left">依赖</td>
<td align="left">MySQL、jdk</td>
<td align="left">jdk、zookeeper</td>
<td align="left">mysql、jdk</td>
<td>MySQL、JDK、MongoDB(可选)</td>
</tr>
<tr>
<td align="left">高可用</td>
<td align="left">多节点部署，通过竞争数据库锁来保证只有一个节点执行任务</td>
<td align="left">通过zookeeper的注册与发现，可以动态的添加服务器</td>
<td align="left">基于竞争数据库锁保证只有一个节点执行任务，支持水平扩容。可以手动增加定时任务，启动和暂停任务，有监控</td>
<td></td>
</tr>
<tr>
<td align="left">任务分片</td>
<td align="left">×</td>
<td align="left">√</td>
<td align="left">√</td>
<td>MapReduce动态分片</td>
</tr>
<tr>
<td align="left">管理界面</td>
<td align="left">×</td>
<td align="left">√</td>
<td align="left">√</td>
<td>√</td>
</tr>
<tr>
<td align="left">难易程度</td>
<td align="left">简单</td>
<td align="left">简单</td>
<td align="left">简单</td>
<td>简单</td>
</tr>
<tr>
<td align="left">高级功能</td>
<td align="left">-</td>
<td align="left">弹性扩容，多种作业模式，失效转移，运行状态收集，多线程处理数据，幂等性，容错处理，spring命名空间支持</td>
<td align="left">弹性扩容，分片广播，故障转移，Rolling实时日志，GLUE（支持在线编辑代码，免发布）,任务进度监控，任务依赖，数据加密，邮件报警，运行报表，国际化</td>
<td>DAG工作流</td>
</tr>
<tr>
<td align="left">版本更新</td>
<td align="left">半年没更新</td>
<td align="left">2023-10-14 3.0.4</td>
<td align="left">最近有更新</td>
<td>最近有更新</td>
</tr>
</tbody></table>
<h2 id="任务分配细节调研比较"><a href="#任务分配细节调研比较" class="headerlink" title="任务分配细节调研比较"></a>任务分配细节调研比较</h2><table>
<thead>
<tr>
<th>项目\方案</th>
<th align="left">qz</th>
<th>Xxl-job</th>
<th>p-j</th>
<th>e-j</th>
<th>d-s</th>
</tr>
</thead>
<tbody><tr>
<td>任务分配的方式如何保证公平</td>
<td align="left"><a href="#%E9%9B%86%E7%BE%A4%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%9A%84%E5%8E%9F%E7%90%86">集群任务调度的原理</a></td>
<td><a href="#%E5%9D%87%E8%A1%A1%E8%B0%83%E5%BA%A6">均衡调度</a></td>
<td><a href="#%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE">任务配置</a></td>
<td><a href="#%E5%88%86%E7%89%87%EF%BC%89">分片</a></td>
<td><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">负载均衡</a></td>
</tr>
<tr>
<td>每个执行器的容量上限</td>
<td align="left"><a href="#%E5%90%8C%E6%97%B6%E6%89%A7%E8%A1%8C%E7%9A%84%E6%9C%80%E5%A4%A7%E4%BB%BB%E5%8A%A1%E6%95%B0">同时执行的最大任务数</a></td>
<td>线程池</td>
<td>线程池</td>
<td><a href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%AD%96%E7%95%A5">线程池策略</a></td>
<td>负载状况决定,和硬件相关</td>
</tr>
<tr>
<td>当pod重启时被分配的任务会怎么处理（如果有任务正在执行时会怎么样）</td>
<td align="left"><a href="#%E5%A4%84%E7%90%86%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E4%BB%BB%E5%8A%A1%E5%86%B2%E7%AA%81%E5%92%8C%E5%AE%B9%E9%94%99">处理集群环境下的任务冲突和容错</a></td>
<td><a href="#%E8%BF%87%E6%9C%9F%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5">过期处理策略</a>,<a href="#%E7%81%B0%E5%BA%A6%E4%B8%8A%E7%BA%BF">灰度上线</a></td>
<td><a href="#%E5%8F%AF%E9%9D%A0%E8%B0%83%E5%BA%A6%E2%80%94%E2%80%94WAL">可靠调度WAL</a></td>
<td><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8">高可用</a></td>
<td><a href="#%E5%AE%B9%E9%94%99%E8%AE%BE%E8%AE%A1">容错设计</a></td>
</tr>
<tr>
<td>长事务的任务执行会不会有问题</td>
<td align="left"><a href="#Quartz%E5%A4%84%E7%90%86%E8%80%97%E6%97%B6%E8%BE%83%E9%95%BF%E7%9A%84%E4%BB%BB%E5%8A%A1">Quartz处理耗时较长的任务</a></td>
<td><a href="#%E9%81%BF%E5%85%8D%E4%BB%BB%E5%8A%A1%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C">避免任务重复执行</a></td>
<td>设置合适的间隔时间和运行时间限制</td>
<td><a href="#%E8%AE%BE%E7%BD%AE%E5%90%88%E7%90%86%E7%9A%84%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4">超时时间</a></td>
<td>设置超时时间</td>
</tr>
</tbody></table>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.yuque.com/powerjob">PowerJob</a></li>
<li><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/elasticjob/index_zh.html">elastic-job</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">xxl-job</a></li>
<li><a target="_blank" rel="noopener" href="https://dolphinscheduler.apache.org/zh-cn/docs/3.1.5/guide/start/docker">DolphinScheduler</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/163487886">PowerJob源码分析-分组隔离设计</a></li>
</ul>
</div>
        </div>
        
        <footer class="kratos-entry-footer clearfix">
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/job/" rel="tag">job</a>
                </div>
                <div class="pull-date">
                    <time datetime="2025-10-27T10:42:24.238Z" itemprop="dateModified">最后编辑：2025-10-27</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" 当爸爸了" href="/2024/02/03/2024/02/02031500/">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" 特殊的日子" href="/2024/02/29/2024/02/292333/">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
        <link rel="stylesheet" href="/vendors/gitalk@1.7.2/dist/gitalk.css"></script>
<div id="gitalk-container" class="post-comments lazy-load" style="padding-left:2rem; padding-right:2rem;"></div>
<script>
    var load_comm = () => {
        const init = () => {
            console.log('Gitalk loading...');
            const gitalk = new Gitalk(Object.assign({
                id: '/2024/02/18/2024/02/0418462/',
                path: '/2024/02/18/2024/02/0418462/'
            }, JSON.parse('{"clientID":"56e6a743c63b9c4faa93","clientSecret":"888b7234051c5c2ed6ea7bdf18e8b5a2678775f1","repo":"gitalk-comments","owner":"qbmzc","admin":["qbmzc"]}')));

            gitalk.render('gitalk-container');
        }
        if (typeof Gitalk === 'undefined') {
            const src = '/vendors/gitalk@1.7.2/dist/gitalk.min.js';
            $.getScript(src, init);
        } else {
            init();
        }
    };
</script>
<noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://github.com/gitalk/gitalk">comments powered by Gitalk.</a></noscript>
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/avatar.webp" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center">流云与风，苍穹游牧</p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                496
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                6
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                223
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                    <aside id="krw-toc" class="widget widget-kratos-toc clearfix">
    <div class="photo-background"></div>
    <h4 class="widget-title no-after">
        <i class="fa fa-compass"></i>
        文章目录
        <span class="toc-progress-bar" role="progressbar" aria-label="阅读进度："></span>
    </h4>
    <div class="textwidget">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Quartz-%E9%9B%86%E7%BE%A4"><span class="toc-text">Quartz(集群)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8BJob"><span class="toc-text">示例Job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Quartz%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-text">Quartz表结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DataSourceConfiguration"><span class="toc-text">DataSourceConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-text">定时任务配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%96%B9%E5%BC%8F%E8%BF%90%E8%A1%8C"><span class="toc-text">集群方式运行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-text">集群任务调度的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%97%B6%E6%89%A7%E8%A1%8C%E7%9A%84%E6%9C%80%E5%A4%A7%E4%BB%BB%E5%8A%A1%E6%95%B0"><span class="toc-text">同时执行的最大任务数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Quartz%E5%A4%84%E7%90%86%E8%80%97%E6%97%B6%E8%BE%83%E9%95%BF%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-text">Quartz处理耗时较长的任务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-text">集群故障转移</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E4%BB%BB%E5%8A%A1%E5%86%B2%E7%AA%81%E5%92%8C%E5%AE%B9%E9%94%99"><span class="toc-text">处理集群环境下的任务冲突和容错</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XXL-JOB"><span class="toc-text">XXL-JOB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">初始化数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%83%A8%E7%BD%B2%E2%80%9C%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83%E2%80%9D"><span class="toc-text">配置部署“调度中心”</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83%E9%9B%86%E7%BE%A4"><span class="toc-text">调度中心集群</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%99%A8%E9%A1%B9%E7%9B%AE"><span class="toc-text">执行器项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-1"><span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%99%A8%E7%BB%84%E4%BB%B6%EF%BC%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">执行器组件，配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%99%A8%E9%9B%86%E7%BE%A4"><span class="toc-text">执行器集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Job-BEAN"><span class="toc-text">Job(BEAN)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-text">架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-text">设计思想</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%BB%84%E6%88%90"><span class="toc-text">系统组成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">架构图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E7%A0%94%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97"><span class="toc-text">自研调度模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83HA%EF%BC%88%E9%9B%86%E7%BE%A4%EF%BC%89"><span class="toc-text">调度中心HA（集群）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">调度线程池</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B6%E8%A1%8C%E8%B0%83%E5%BA%A6"><span class="toc-text">并行调度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%9C%9F%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-text">过期处理策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1HA%EF%BC%88Failover%EF%BC%89"><span class="toc-text">任务HA（Failover）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9D%87%E8%A1%A1%E8%B0%83%E5%BA%A6"><span class="toc-text">均衡调度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB-%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95"><span class="toc-text">故障转移 &amp; 失败重试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%99%A8%E7%81%B0%E5%BA%A6%E4%B8%8A%E7%BA%BF"><span class="toc-text">执行器灰度上线</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E4%BB%BB%E5%8A%A1%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C"><span class="toc-text">避免任务重复执行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PowerJob"><span class="toc-text">PowerJob</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83%EF%BC%88docker%E7%89%88%EF%BC%89"><span class="toc-text">部署调度中心（docker版）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%BA%94%E7%94%A8"><span class="toc-text">注册应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95"><span class="toc-text">登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-text">官方处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%88Processor%EF%BC%89%E5%BC%80%E5%8F%91"><span class="toc-text">处理器（Processor）开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84-1"><span class="toc-text">架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">Server 启动流程分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-text">集群</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E5%8C%96%E8%B0%83%E5%BA%A6%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-text">无锁化调度的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%8F%E5%85%B8%E8%B0%83%E5%BA%A6%E5%8E%9F%E7%90%86"><span class="toc-text">经典调度原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%A4%8D%E8%B0%83%E5%BA%A6"><span class="toc-text">重复调度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E5%8C%96%E8%B0%83%E5%BA%A6"><span class="toc-text">无锁化调度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-text">任务配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E9%9D%A0%E8%B0%83%E5%BA%A6%E2%80%94%E2%80%94WAL"><span class="toc-text">可靠调度——WAL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A7%92%E7%BA%A7%E4%BB%BB%E5%8A%A1"><span class="toc-text">秒级任务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Apache-DolphinScheduler"><span class="toc-text">Apache DolphinScheduler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E9%94%99%E8%AE%BE%E8%AE%A1"><span class="toc-text">容错设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA%EF%BC%88%E5%8A%A0%E6%9D%83%EF%BC%89"><span class="toc-text">随机（加权）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B3%E6%BB%91%E8%BD%AE%E8%AF%A2%EF%BC%88%E5%8A%A0%E6%9D%83%EF%BC%89"><span class="toc-text">平滑轮询（加权）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E6%80%A7%E5%8A%A0%E6%9D%83-%E9%BB%98%E8%AE%A4%E7%AE%97%E6%B3%95"><span class="toc-text">线性加权(默认算法)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Elastic-Job"><span class="toc-text">Elastic-Job</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="toc-text">快速开始</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87"><span class="toc-text">分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-text">高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">实现原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%BF%87%E4%BB%BB%E5%8A%A1%E9%87%8D%E6%89%A7%E8%A1%8C"><span class="toc-text">错过任务重执行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E5%90%AF%E5%8A%A8"><span class="toc-text">作业启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E6%89%A7%E8%A1%8C"><span class="toc-text">作业执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ej%E5%A4%B1%E6%95%88%E8%BD%AC%E7%A7%BB"><span class="toc-text">ej失效转移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%AD%96%E7%95%A5"><span class="toc-text">线程池策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%90%88%E7%90%86%E7%9A%84%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="toc-text">设置合理的超时时间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%BB%B4%E5%B9%B3%E5%8F%B0%E9%85%8D%E7%BD%AE"><span class="toc-text">运维平台配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-text">启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E5%BC%80%E5%8F%91"><span class="toc-text">作业开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#zookeeper%E6%95%B0%E6%8D%AE"><span class="toc-text">zookeeper数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94"><span class="toc-text">对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E5%88%86%E9%85%8D%E7%BB%86%E8%8A%82%E8%B0%83%E7%A0%94%E6%AF%94%E8%BE%83"><span class="toc-text">任务分配细节调研比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text">参考资料</span></a></li></ol>
    </div>
</aside>
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">137</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">150</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/congco/">congco</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/work/">work</a><span class="category-list-count">118</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/wuw/">wuw</a><span class="category-list-count">48</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/AES/" style="font-size: 0.6em;">AES</a> <a href="/tags/AI/" style="font-size: 0.7em;">AI</a> <a href="/tags/AWS/" style="font-size: 0.7em;">AWS</a> <a href="/tags/Arch/" style="font-size: 0.6em;">Arch</a> <a href="/tags/Arch-Linux/" style="font-size: 0.8em;">Arch Linux</a> <a href="/tags/ArchLinux/" style="font-size: 0.8em;">ArchLinux</a> <a href="/tags/CAS/" style="font-size: 0.6em;">CAS</a> <a href="/tags/Caffeine/" style="font-size: 0.6em;">Caffeine</a> <a href="/tags/CompletableFuture/" style="font-size: 0.7em;">CompletableFuture</a> <a href="/tags/DNS/" style="font-size: 0.8em;">DNS</a> <a href="/tags/Flask/" style="font-size: 0.6em;">Flask</a> <a href="/tags/Future/" style="font-size: 0.7em;">Future</a> <a href="/tags/GC/" style="font-size: 0.6em;">GC</a> <a href="/tags/GPT/" style="font-size: 0.6em;">GPT</a> <a href="/tags/GraalVM/" style="font-size: 0.8em;">GraalVM</a> <a href="/tags/HashMap/" style="font-size: 0.6em;">HashMap</a> <a href="/tags/InputStream/" style="font-size: 0.6em;">InputStream</a> <a href="/tags/JDK/" style="font-size: 0.6em;">JDK</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2025/10/23/2025/10/221500/"><i class="fa  fa-book"></i> dig命令使用详解</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/10/13/2025/10/131645/"><i class="fa  fa-book"></i> DNS解析异常导致视频播放缓慢问题排查与解决</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/10/11/2025/10/091335/"><i class="fa  fa-book"></i> 图片添加alpha通道&设置透明度</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/09/26/2025/09/261010/"><i class="fa  fa-book"></i> 替换wps配置文件</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/09/23/2025/09/231034/"><i class="fa  fa-book"></i> word表格批量设置允许跨页断行</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        
                        <li><a href="mailto:congco@foxmail.com"><i class="fa fa-envelope"></i></a></li>
                        
                        
                        
                        
                        
                        <li><a target="_blank" rel="nofollow" href="https://github.com/qbmzc"><i class="fa fa-github"></i></a></li>
                        <li><a target="_blank" rel="nofollow" href="/rss.xml"><i class="fa fa-rss"></i></a></li>
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2025 沐曦留曳 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by cong.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>


    <script async src="/js/candy.min.js"></script>




    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/vendors/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>